[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "Daily",
  "modified": "2025-10-07 11:05:20.027266",
  "module": null,
  "name": "notification",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Lead",
  "script": "if doc.custom_call_again == frappe.utils.nowdate():\r\n    # üîî Notification Log\r\n    frappe.get_doc({\r\n        \"doctype\": \"Notification Log\",\r\n        \"subject\": f\"Follow-up Reminder for {doc.lead_name}\",\r\n        \"email_content\": f\"Follow-up task for Lead {doc.lead_name}\",\r\n        \"for_user\": doc.owner,\r\n        \"document_type\": \"Lead\",\r\n        \"document_name\": doc.name,\r\n        \"type\": \"Alert\"\r\n    }).insert(ignore_permissions=True)\r\n\r\n    # ‚úÖ Task Create\r\n    task = frappe.get_doc({\r\n        \"doctype\": \"Task\",\r\n        \"subject\": f\"Follow-up for {doc.lead_name}\",\r\n        \"status\": \"Open\",\r\n        \"priority\": \"Medium\",\r\n        \"exp_start_date\": frappe.utils.nowdate(),\r\n        \"exp_end_date\": doc.custom_call_again,\r\n        \"reference_type\": \"Lead\",\r\n        \"reference_name\": doc.name,\r\n        \"description\": f\"Follow-up task for Lead {doc.lead_name}\"\r\n    })\r\n    task.insert(ignore_permissions=True)\r\n\r\n    # ‚úÖ Assign Task to Lead Owner (ToDo Entry with Description)\r\n    frappe.get_doc({\r\n        \"doctype\": \"ToDo\",\r\n        \"owner\": doc.owner,\r\n        \"description\": f\"Follow-up task for Lead {doc.lead_name}\",\r\n        \"reference_type\": \"Task\",\r\n        \"reference_name\": task.name,\r\n        \"assigned_by\": frappe.session.user\r\n    }).insert(ignore_permissions=True)\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-06 11:04:36.978195",
  "module": "galaxynext",
  "name": "company event",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Subcontracting Order",
  "script": "# # Script Type: Document Event\r\n# # Ref Doctype: Purchase Order\r\n# # Event: on_submit\r\n\r\n# if doc.is_internal_supplier:\r\n#     # Customer mapping\r\n#     customer = frappe.db.get_value(\"Customer\", {\"represents_company\": doc.company}, \"name\")\r\n#     if customer:\r\n#         so = frappe.new_doc(\"Sales Order\")\r\n#         so.customer = customer\r\n#         so.company = doc.represents_company\r\n#         so.transaction_date = doc.transaction_date\r\n#         so.delivery_date = doc.schedule_date\r\n\r\n#         # add items\r\n#         for item in doc.items:\r\n#             so.append(\"items\", {\r\n#                 \"item_code\": item.item_code,\r\n#                 \"qty\": item.qty,\r\n#                 \"rate\": item.rate,\r\n#                 \"warehouse\": frappe.db.get_value(\r\n#                     \"Item Default\",\r\n#                     {\"parent\": item.item_code, \"company\": doc.represents_company},\r\n#                     \"default_warehouse\"\r\n#                 )\r\n#             })\r\n\r\n#         so.flags.ignore_permissions = True\r\n#         so.insert()\r\n#         so.submit()\r\n\r\n#         frappe.msgprint(f\"Inter Company Sales Order {so.name} created for {customer}\")\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n# warehouse error\r\n\r\n\r\n\r\n# # Auto create Sales Order when Subcontracting Order is submitted\r\n# if doc.supplier:\r\n#     # find customer linked to this company\r\n#     customer = frappe.db.get_value(\r\n#         \"Customer\",\r\n#         {\"represents_company\": doc.company},\r\n#         \"name\"\r\n#     )\r\n\r\n#     if not customer:\r\n#         frappe.msgprint(f\"No Internal Customer found for Company: {doc.company}\")\r\n#     else:\r\n#         # find supplier's company\r\n#         supplier_company = frappe.db.get_value(\"Supplier\", doc.supplier, \"represents_company\")\r\n\r\n#         if not supplier_company:\r\n#             frappe.msgprint(\"Supplier is not linked to any company.\")\r\n#         else:\r\n#             # create Sales Order\r\n#             so = frappe.new_doc(\"Sales Order\")\r\n#             so.customer = customer\r\n#             so.company = supplier_company\r\n#             so.transaction_date = doc.transaction_date\r\n#             so.delivery_date = doc.schedule_date\r\n\r\n#             # map items from subcontracting order\r\n#             for item in doc.items:\r\n#                 so.append(\"items\", {\r\n#                     \"item_code\": item.item_code,\r\n#                     \"qty\": item.qty,\r\n#                     \"rate\": item.rate,\r\n#                     \"warehouse\": item.warehouse\r\n#                 })\r\n\r\n#             so.flags.ignore_permissions = True\r\n#             so.insert(ignore_permissions=True)\r\n#             so.submit()\r\n\r\n#             frappe.msgprint(f\"‚úÖ Sales Order {so.name} auto-created from Subcontracting Order {doc.name}\")\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n# pefect code\r\n\r\n\r\n\r\n# # Auto create Sales Order when Subcontracting Order is submitted\r\n# if doc.supplier:\r\n#     # find customer linked to this company\r\n#     customer = frappe.db.get_value(\r\n#         \"Customer\",\r\n#         {\"represents_company\": doc.company},\r\n#         \"name\"\r\n#     )\r\n\r\n#     if not customer:\r\n#         frappe.msgprint(f\"No Internal Customer found for Company: {doc.company}\")\r\n#     else:\r\n#         # find supplier's company\r\n#         supplier_company = frappe.db.get_value(\"Supplier\", doc.supplier, \"represents_company\")\r\n\r\n#         if not supplier_company:\r\n#             frappe.msgprint(\"Supplier is not linked to any company.\")\r\n#         else:\r\n#             # create Sales Order\r\n#             so = frappe.new_doc(\"Sales Order\")\r\n#             so.customer = customer\r\n#             so.company = supplier_company\r\n#             so.transaction_date = doc.transaction_date\r\n#             so.delivery_date = doc.schedule_date\r\n\r\n#             for item in doc.items:\r\n#                 # check if warehouse belongs to correct company\r\n#                 wh_company = frappe.db.get_value(\"Warehouse\", item.warehouse, \"company\")\r\n\r\n#                 if wh_company != supplier_company:\r\n#                     # find default warehouse for supplier company\r\n#                     default_wh = frappe.db.get_value(\r\n#                         \"Warehouse\",\r\n#                         {\"company\": supplier_company, \"is_group\": 0},\r\n#                         \"name\"\r\n#                     )\r\n#                     frappe.msgprint(\r\n#                         f\"‚ö†Ô∏è Warehouse {item.warehouse} belongs to {wh_company}, \"\r\n#                         f\"auto-changed to {default_wh} for company {supplier_company}\"\r\n#                     )\r\n#                     warehouse_to_use = default_wh\r\n#                 else:\r\n#                     warehouse_to_use = item.warehouse\r\n\r\n#                 # append item with corrected warehouse\r\n#                 so.append(\"items\", {\r\n#                     \"item_code\": item.item_code,\r\n#                     \"qty\": item.qty,\r\n#                     \"rate\": item.rate,\r\n#                     \"warehouse\": warehouse_to_use\r\n#                 })\r\n\r\n#             so.flags.ignore_permissions = True\r\n#             so.insert(ignore_permissions=True)\r\n#             so.submit()\r\n\r\n#             frappe.msgprint(f\"‚úÖ Sales Order {so.name} auto-created from Subcontracting Order {doc.name}\")\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n# # Auto create Sales Order when Subcontracting Order is submitted\r\n# if doc.supplier:\r\n#     # find customer linked to this company\r\n#     customer = frappe.db.get_value(\r\n#         \"Customer\",\r\n#         {\"represents_company\": doc.company},\r\n#         \"name\"\r\n#     )\r\n#     if not customer:\r\n#         frappe.msgprint(f\"No Internal Customer found for Company: {doc.company}\")\r\n#     else:\r\n#         # find supplier's company\r\n#         supplier_company = frappe.db.get_value(\"Supplier\", doc.supplier, \"represents_company\")\r\n#         if not supplier_company:\r\n#             frappe.msgprint(\"Supplier is not linked to any company.\")\r\n#         else:\r\n#             # create Sales Order\r\n#             so = frappe.new_doc(\"Sales Order\")\r\n#             so.customer = customer\r\n#             so.company = supplier_company\r\n#             so.transaction_date = doc.transaction_date\r\n#             so.delivery_date = doc.schedule_date\r\n            \r\n#             # Add items with correct warehouse for supplier company\r\n#             for item in doc.items:\r\n#                 # Get item's default warehouse for supplier company\r\n#                 item_default_wh = frappe.db.get_value(\r\n#                     \"Item Default\",\r\n#                     {\r\n#                         \"parent\": item.item_code,\r\n#                         \"company\": supplier_company\r\n#                     },\r\n#                     \"default_warehouse\"\r\n#                 )\r\n                \r\n#                 # Use item default warehouse if found, otherwise use original\r\n#                 warehouse_to_usew = item_default_wh if item_default_wh else item.warehouse\r\n                \r\n#                 so.append(\"items\", {\r\n#                     \"item_code\": item.item_code,\r\n#                     \"qty\": item.qty,\r\n#                     \"rate\": item.rate,\r\n#                     \"warehouse\": warehouse_to_use\r\n#                 })\r\n            \r\n#             so.flags.ignore_permissions = True\r\n#             so.insert(ignore_permissions=True)\r\n#             so.submit()\r\n#             frappe.msgprint(f\"‚úÖ Sales Order {so.name} auto-created from Subcontracting Order {doc.name}\")\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n# Auto create Sales Order when Subcontracting Order is submitted\r\nif doc.supplier:\r\n    # find customer linked to this company\r\n    customer = frappe.db.get_value(\r\n        \"Customer\",\r\n        {\"represents_company\": doc.company},\r\n        \"name\"\r\n    )\r\n    if not customer:\r\n        frappe.msgprint(f\"No Internal Customer found for Company: {doc.company}\")\r\n    else:\r\n        # find supplier's company\r\n        supplier_company = frappe.db.get_value(\"Supplier\", doc.supplier, \"represents_company\")\r\n        if not supplier_company:\r\n            frappe.msgprint(\"Supplier is not linked to any company.\")\r\n        else:\r\n            # create Sales Order\r\n            so = frappe.new_doc(\"Sales Order\")\r\n            so.customer = customer\r\n            so.company = supplier_company\r\n            so.transaction_date = doc.transaction_date\r\n            so.delivery_date = doc.schedule_date\r\n            \r\n            # Add items with correct warehouse for supplier company\r\n            for item in doc.items:\r\n                # Get item's default warehouse for supplier company\r\n                item_default_wh = frappe.db.get_value(\r\n                    \"Item Default\",\r\n                    {\r\n                        \"parent\": item.item_code,\r\n                        \"company\": supplier_company\r\n                    },\r\n                    \"default_warehouse\"\r\n                )\r\n                \r\n                # ‚úÖ Correct variable name (no extra 'w')\r\n                warehouse_to_use = item_default_wh if item_default_wh else item.warehouse\r\n                \r\n                # Append item to Sales Order\r\n                so.append(\"items\", {\r\n                    \"item_code\": item.item_code,\r\n                    \"qty\": item.qty,\r\n                    \"rate\": item.rate,\r\n                    \"warehouse\": warehouse_to_use\r\n                })\r\n            \r\n            so.flags.ignore_permissions = True\r\n            so.insert(ignore_permissions=True)\r\n            so.submit()\r\n            frappe.msgprint(f\"‚úÖ Sales Order {so.name} auto-created from Subcontracting Order {doc.name}\")\r\n\r\n\r\n\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-08 17:40:58.138957",
  "module": "galaxynext",
  "name": "auto create work order",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Order",
  "script": "# try:\r\n#     work_orders_created = []\r\n\r\n#     # ----- Company defaults -----\r\n#     company_name = doc.get(\"company\")\r\n#     if not company_name:\r\n#         frappe.throw(\"Sales Order Company not set.\")\r\n\r\n#     # Get default warehouses - search for WIP warehouse by name pattern\r\n#     default_wip_warehouse = \"\"\r\n#     default_fg_warehouse = \"\"\r\n#     default_source_warehouse = \"\"\r\n    \r\n#     # Try to find WIP warehouse for this company\r\n#     try:\r\n#         wip_warehouses = frappe.get_all(\r\n#             \"Warehouse\",\r\n#             filters={\r\n#                 \"company\": company_name,\r\n#                 \"is_group\": 0,\r\n#                 \"disabled\": 0\r\n#             },\r\n#             fields=[\"name\"],\r\n#             or_filters=[\r\n#                 {\"warehouse_name\": [\"like\", \"%Work In Progress%\"]},\r\n#                 {\"warehouse_name\": [\"like\", \"%WIP%\"]},\r\n#                 {\"name\": [\"like\", \"%Work In Progress%\"]},\r\n#                 {\"name\": [\"like\", \"%WIP%\"]}\r\n#             ],\r\n#             limit=1\r\n#         )\r\n#         if wip_warehouses:\r\n#             default_wip_warehouse = wip_warehouses[0].name\r\n#     except:\r\n#         pass\r\n    \r\n#     # Try to find Finished Goods warehouse\r\n#     try:\r\n#         fg_warehouses = frappe.get_all(\r\n#             \"Warehouse\",\r\n#             filters={\r\n#                 \"company\": company_name,\r\n#                 \"is_group\": 0,\r\n#                 \"disabled\": 0\r\n#             },\r\n#             fields=[\"name\"],\r\n#             or_filters=[\r\n#                 {\"warehouse_name\": [\"like\", \"%Finished Goods%\"]},\r\n#                 {\"warehouse_name\": [\"like\", \"%FG%\"]},\r\n#                 {\"name\": [\"like\", \"%Finished Goods%\"]},\r\n#                 {\"warehouse_name\": [\"like\", \"%Finish%\"]}\r\n#             ],\r\n#             limit=1\r\n#         )\r\n#         if fg_warehouses:\r\n#             default_fg_warehouse = fg_warehouses[0].name\r\n#     except:\r\n#         pass\r\n    \r\n#     # Try to find Stores/Raw Material warehouse\r\n#     try:\r\n#         source_warehouses = frappe.get_all(\r\n#             \"Warehouse\",\r\n#             filters={\r\n#                 \"company\": company_name,\r\n#                 \"is_group\": 0,\r\n#                 \"disabled\": 0\r\n#             },\r\n#             fields=[\"name\"],\r\n#             or_filters=[\r\n#                 {\"warehouse_name\": [\"like\", \"%Stores%\"]},\r\n#                 {\"warehouse_name\": [\"like\", \"%Raw Material%\"]},\r\n#                 {\"name\": [\"like\", \"%Stores%\"]},\r\n#                 {\"name\": [\"like\", \"%Raw%\"]}\r\n#             ],\r\n#             limit=1\r\n#         )\r\n#         if source_warehouses:\r\n#             default_source_warehouse = source_warehouses[0].name\r\n#     except:\r\n#         pass\r\n\r\n#     # ----- Loop through Sales Order items -----\r\n#     for so_item in doc.get(\"items\") or []:\r\n#         bom_no = so_item.get(\"bom_no\") or so_item.get(\"bom\") or so_item.get(\"custom_bom\")\r\n#         if not bom_no:\r\n#             continue\r\n\r\n#         # Fetch BOM doc\r\n#         try:\r\n#             bom_doc = frappe.get_doc(\"BOM\", bom_no)\r\n#         except Exception as bom_err:\r\n#             frappe.log_error(message=f\"BOM not found: {bom_no} for SO {doc.name}\", title=\"Auto WO Error\")\r\n#             continue\r\n\r\n#         # Create Work Order\r\n#         wo = frappe.get_doc({\r\n#             \"doctype\": \"Work Order\",\r\n#             \"company\": company_name,\r\n#             \"production_item\": so_item.get(\"item_code\"),\r\n#             \"item_name\": so_item.get(\"item_name\"),\r\n#             \"description\": so_item.get(\"description\"),\r\n#             \"qty\": so_item.get(\"qty\") or 0,\r\n#             \"bom_no\": bom_no,\r\n#             \"sales_order\": doc.name,\r\n#             \"sales_order_item\": so_item.get(\"name\"),\r\n#             \"fg_warehouse\": so_item.get(\"warehouse\") or default_fg_warehouse,\r\n#             \"wip_warehouse\": default_wip_warehouse,\r\n#             \"source_warehouse\": default_source_warehouse,\r\n#             \"use_multi_level_bom\": 1,\r\n#             \"skip_transfer\": 0,\r\n#             \"transfer_material_against\": \"Work Order\",\r\n#             \"expected_delivery_date\": so_item.get(\"delivery_date\") or doc.get(\"delivery_date\"),\r\n#             \"project\": doc.get(\"project\")\r\n#         })\r\n\r\n#         # ----- Append Required Items -----\r\n#         for b_item in bom_doc.get(\"items\") or []:\r\n#             required_qty = (b_item.get(\"qty\") or 0) * (so_item.get(\"qty\") or 0)\r\n#             wo.append(\"required_items\", {\r\n#                 \"item_code\": b_item.get(\"item_code\"),\r\n#                 \"item_name\": b_item.get(\"item_name\"),\r\n#                 \"description\": b_item.get(\"description\"),\r\n#                 \"required_qty\": required_qty,\r\n#                 \"source_warehouse\": b_item.get(\"source_warehouse\") or default_source_warehouse,\r\n#                 \"rate\": b_item.get(\"rate\") or 0,\r\n#                 \"amount\": (b_item.get(\"rate\") or 0) * required_qty\r\n#             })\r\n\r\n#         # ----- Append Operations with correct BOM mapping -----\r\n#         if bom_doc.get(\"with_operations\") and bom_doc.get(\"operations\"):\r\n#             for op in bom_doc.get(\"operations\"):\r\n#                 wo.append(\"operations\", {\r\n#                     \"operation\": op.get(\"operation\"),\r\n#                     \"bom\": bom_no,  # BOM field - link to main BOM\r\n#                     \"bom_operation\": op.get(\"name\"),  # Link to specific BOM operation row\r\n#                     \"description\": op.get(\"description\"),\r\n#                     \"workstation\": op.get(\"workstation\"),\r\n#                     \"workstation_type\": op.get(\"workstation_type\"),\r\n#                     \"time_in_mins\": op.get(\"time_in_mins\") or 0,\r\n#                     \"operating_cost\": op.get(\"operating_cost\") or 0,\r\n#                     \"hour_rate\": op.get(\"hour_rate\") or 0,\r\n#                     \"batch_size\": op.get(\"batch_size\") or 1,\r\n#                     \"sequence_id\": op.get(\"sequence_id\") or op.get(\"idx\"),\r\n#                     \"status\": \"Pending\",\r\n#                     \"completed_qty\": 0\r\n#                 })\r\n\r\n#         # ----- Insert Work Order -----\r\n#         try:\r\n#             wo.insert(ignore_permissions=True)\r\n#             work_orders_created.append(wo.name)\r\n            \r\n#             # Auto-submit the Work Order\r\n#             wo.submit()\r\n            \r\n#         except Exception as ins_err:\r\n#             frappe.log_error(\r\n#                 message=f\"Failed to insert WO for SO {doc.name}, item {so_item.get('item_code')}: {str(ins_err)}\", \r\n#                 title=\"Auto WO Insert Error\"\r\n#             )\r\n\r\n#     # ----- Show success message -----\r\n#     if work_orders_created:\r\n#         frappe.msgprint(f\"‚úì Work Orders Created: {', '.join(work_orders_created)}\")\r\n\r\n# except Exception as e:\r\n#     frappe.log_error(message=str(e), title=\"Work Order Auto Creation Error\")\r\n#     frappe.throw(f\"Error creating Work Order: {str(e)}\")\r\n\r\n\r\n\r\n\r\n\r\ntry:\r\n    work_orders_created = []\r\n\r\n    # -----------------------------------------------------------\r\n    # 1Ô∏è‚É£ Get Company and Validate\r\n    # -----------------------------------------------------------\r\n    company_name = doc.get(\"company\")\r\n    if not company_name:\r\n        frappe.throw(\"Sales Order Company not set.\")\r\n\r\n    # -----------------------------------------------------------\r\n    # 2Ô∏è‚É£ Detect Company-wise Default Warehouses Automatically\r\n    #    (Search based on warehouse name patterns)\r\n    # -----------------------------------------------------------\r\n    default_wip_warehouse = \"\"\r\n    default_fg_warehouse = \"\"\r\n    default_source_warehouse = \"\"\r\n    \r\n    # ----- Auto-detect WIP (Work In Progress) Warehouse -----\r\n    try:\r\n        wip_warehouses = frappe.get_all(\r\n            \"Warehouse\",\r\n            filters={\r\n                \"company\": company_name,\r\n                \"is_group\": 0,\r\n                \"disabled\": 0\r\n            },\r\n            fields=[\"name\"],\r\n            or_filters=[\r\n                {\"warehouse_name\": [\"like\", \"%Work In Progress%\"]},\r\n                {\"warehouse_name\": [\"like\", \"%WIP%\"]},\r\n                {\"name\": [\"like\", \"%Work In Progress%\"]},\r\n                {\"name\": [\"like\", \"%WIP%\"]}\r\n            ],\r\n            limit=1\r\n        )\r\n        if wip_warehouses:\r\n            default_wip_warehouse = wip_warehouses[0].name\r\n    except:\r\n        pass\r\n    \r\n    # ----- Auto-detect Finished Goods Warehouse -----\r\n    try:\r\n        fg_warehouses = frappe.get_all(\r\n            \"Warehouse\",\r\n            filters={\r\n                \"company\": company_name,\r\n                \"is_group\": 0,\r\n                \"disabled\": 0\r\n            },\r\n            fields=[\"name\"],\r\n            or_filters=[\r\n                {\"warehouse_name\": [\"like\", \"%Finished Goods%\"]},\r\n                {\"warehouse_name\": [\"like\", \"%FG%\"]},\r\n                {\"name\": [\"like\", \"%Finished Goods%\"]},\r\n                {\"warehouse_name\": [\"like\", \"%Finish%\"]}\r\n            ],\r\n            limit=1\r\n        )\r\n        if fg_warehouses:\r\n            default_fg_warehouse = fg_warehouses[0].name\r\n    except:\r\n        pass\r\n    \r\n    # ----- Auto-detect Source / Raw Material Warehouse -----\r\n    try:\r\n        source_warehouses = frappe.get_all(\r\n            \"Warehouse\",\r\n            filters={\r\n                \"company\": company_name,\r\n                \"is_group\": 0,\r\n                \"disabled\": 0\r\n            },\r\n            fields=[\"name\"],\r\n            or_filters=[\r\n                {\"warehouse_name\": [\"like\", \"%Stores%\"]},\r\n                {\"warehouse_name\": [\"like\", \"%Raw Material%\"]},\r\n                {\"name\": [\"like\", \"%Stores%\"]},\r\n                {\"name\": [\"like\", \"%Raw%\"]}\r\n            ],\r\n            limit=1\r\n        )\r\n        if source_warehouses:\r\n            default_source_warehouse = source_warehouses[0].name\r\n    except:\r\n        pass\r\n\r\n    # -----------------------------------------------------------\r\n    # 3Ô∏è‚É£ Loop through Sales Order Items\r\n    # -----------------------------------------------------------\r\n    for so_item in doc.get(\"items\") or []:\r\n\r\n        # Fetch BOM from different possible fields\r\n        bom_no = so_item.get(\"bom_no\") or so_item.get(\"bom\") or so_item.get(\"custom_bom\")\r\n        if not bom_no:\r\n            continue\r\n\r\n        # Fetch BOM document safely\r\n        try:\r\n            bom_doc = frappe.get_doc(\"BOM\", bom_no)\r\n        except Exception as bom_err:\r\n            frappe.log_error(message=f\"BOM not found: {bom_no} for SO {doc.name}\", title=\"Auto WO Error\")\r\n            continue\r\n\r\n        # -----------------------------------------------------------\r\n        # 4Ô∏è‚É£ Create new Work Order\r\n        # -----------------------------------------------------------\r\n        wo = frappe.get_doc({\r\n            \"doctype\": \"Work Order\",\r\n            \"company\": company_name,\r\n\r\n            # Production details\r\n            \"production_item\": so_item.get(\"item_code\"),\r\n            \"item_name\": so_item.get(\"item_name\"),\r\n            \"description\": so_item.get(\"description\"),\r\n            \"qty\": so_item.get(\"qty\") or 0,\r\n            \"bom_no\": bom_no,\r\n\r\n            # Linking to Sales Order\r\n            \"sales_order\": doc.name,\r\n            \"sales_order_item\": so_item.get(\"name\"),\r\n\r\n            # Auto-set warehouses\r\n            \"fg_warehouse\": so_item.get(\"warehouse\") or default_fg_warehouse,\r\n            \"wip_warehouse\": default_wip_warehouse,\r\n            \"source_warehouse\": default_source_warehouse,\r\n\r\n            # Configuration\r\n            \"use_multi_level_bom\": 1,\r\n            \"skip_transfer\": 0,\r\n            \"transfer_material_against\": \"Work Order\",\r\n\r\n            # Dates\r\n            \"expected_delivery_date\": so_item.get(\"delivery_date\") or doc.get(\"delivery_date\"),\r\n            \"project\": doc.get(\"project\")\r\n        })\r\n\r\n        # -----------------------------------------------------------\r\n        # 5Ô∏è‚É£ Add Required Items (Raw Materials)\r\n        # -----------------------------------------------------------\r\n        for b_item in bom_doc.get(\"items\") or []:\r\n            required_qty = (b_item.get(\"qty\") or 0) * (so_item.get(\"qty\") or 0)\r\n            \r\n            wo.append(\"required_items\", {\r\n                \"item_code\": b_item.get(\"item_code\"),\r\n                \"item_name\": b_item.get(\"item_name\"),\r\n                \"description\": b_item.get(\"description\"),\r\n                \"required_qty\": required_qty,\r\n                \"source_warehouse\": b_item.get(\"source_warehouse\") or default_source_warehouse,\r\n                \"rate\": b_item.get(\"rate\") or 0,\r\n                \"amount\": (b_item.get(\"rate\") or 0) * required_qty\r\n            })\r\n\r\n        # -----------------------------------------------------------\r\n        # 6Ô∏è‚É£ Add Operations from BOM\r\n        # -----------------------------------------------------------\r\n        if bom_doc.get(\"with_operations\") and bom_doc.get(\"operations\"):\r\n            for op in bom_doc.get(\"operations\"):\r\n                wo.append(\"operations\", {\r\n                    \"operation\": op.get(\"operation\"),\r\n                    \"bom\": bom_no,                  # Link to main BOM\r\n                    \"bom_operation\": op.get(\"name\"),  # Link to BOM Operation row\r\n                    \"description\": op.get(\"description\"),\r\n                    \"workstation\": op.get(\"workstation\"),\r\n                    \"workstation_type\": op.get(\"workstation_type\"),\r\n                    \"time_in_mins\": op.get(\"time_in_mins\") or 0,\r\n                    \"operating_cost\": op.get(\"operating_cost\") or 0,\r\n                    \"hour_rate\": op.get(\"hour_rate\") or 0,\r\n                    \"batch_size\": op.get(\"batch_size\") or 1,\r\n                    \"sequence_id\": op.get(\"sequence_id\") or op.get(\"idx\"),\r\n                    \"status\": \"Pending\",\r\n                    \"completed_qty\": 0\r\n                })\r\n\r\n        # -----------------------------------------------------------\r\n        # 7Ô∏è‚É£ Insert and Auto-submit Work Order\r\n        # -----------------------------------------------------------\r\n        try:\r\n            wo.insert(ignore_permissions=True)\r\n            work_orders_created.append(wo.name)\r\n\r\n            # Auto-submit Work Order\r\n            wo.submit()\r\n\r\n        except Exception as ins_err:\r\n            frappe.log_error(\r\n                message=f\"Failed to insert WO for SO {doc.name}, item {so_item.get('item_code')}: {str(ins_err)}\", \r\n                title=\"Auto WO Insert Error\"\r\n            )\r\n\r\n    # -----------------------------------------------------------\r\n    # 8Ô∏è‚É£ Success Message\r\n    # -----------------------------------------------------------\r\n    if work_orders_created:\r\n        frappe.msgprint(f\"‚úì Work Orders Created: {', '.join(work_orders_created)}\")\r\n\r\nexcept Exception as e:\r\n    frappe.log_error(message=str(e), title=\"Work Order Auto Creation Error\")\r\n    frappe.throw(f\"Error creating Work Order: {str(e)}\")\r\n",
  "script_type": "DocType Event"
 }
]