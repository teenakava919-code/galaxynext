[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-08-26 11:42:12.470903",
  "module": null,
  "name": "Stock Effect For JobInward",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Job Inward_In-House Job",
  "script": "# Helper: Get leaf warehouse if given is group\r\ndef get_leaf_warehouse(warehouse):\r\n    if frappe.db.get_value(\"Warehouse\", warehouse, \"is_group\"):\r\n        child = frappe.db.get_value(\r\n            \"Warehouse\",\r\n            {\"parent_warehouse\": warehouse, \"is_group\": 0},\r\n            \"name\"\r\n        )\r\n        return child\r\n    return warehouse\r\n\r\n# Main logic\r\nif not doc.get(\"stock_entry_ref\"):\r\n    try:\r\n        se = frappe.new_doc(\"Stock Entry\")\r\n        se.stock_entry_type = \"Material Receipt\"\r\n        se.purpose = \"Material Receipt\"\r\n        se.company = doc.company or frappe.defaults.get_default(\"company\")\r\n        se.posting_date = doc.get(\"inward_date\") or frappe.utils.nowdate()\r\n\r\n        # Main warehouse (if present in parent)\r\n        se.to_warehouse = get_leaf_warehouse(doc.get(\"warehouse_name\")) if doc.get(\"warehouse_name\") else None\r\n        se.set(\"items\", [])\r\n        \r\n        for row in doc.get(\"table_duni\") or []:\r\n            total_qty = frappe.utils.flt(row.get(\"total_quantity\") or row.get(\"total_quant\") or 0)\r\n            pcs = int(row.get(\"total_pcs\") or 1)\r\n            item_code = row.get(\"product_name\") or row.get(\"item_code\")\r\n            warehouse = get_leaf_warehouse(row.get(\"warehouse_name\")) if row.get(\"warehouse_name\") else None\r\n            uom = row.get(\"unit\") or row.get(\"uom\") or \"\"\r\n            basic_rate = frappe.utils.flt(row.get(\"rate\") or 0)\r\n\r\n            # Calculate quantity per piece\r\n            if pcs > 0:\r\n                qty_per_piece = total_qty / pcs\r\n            else:\r\n                qty_per_piece = total_qty  # fallback\r\n            \r\n            for row_sub in doc.get(\"job_inward_item_detail\") or []:\r\n                qty=frappe.utils.flt(row_sub.get(\"quantity\") or 0)\r\n            product_name = f\"{row.get('product_type') or ''} - {item_code}\"\r\n            matching_sub_rows = [\r\n                r for r in (doc.get(\"job_inward_item_detail\") or [])\r\n                if r.get(\"reference_item\") == product_name\r\n            ]\r\n            if not matching_sub_rows:\r\n                se.append(\"items\", {\r\n                    \"item_code\": item_code,\r\n                    \"item_name\": item_code,\r\n                    \"description\": f\"{row.get('product_type') or ''} - {item_code}\",\r\n                    \"qty\": total_qty,\r\n                    \"uom\": uom,\r\n                    \"basic_rate\": basic_rate,\r\n                    \"t_warehouse\": warehouse\r\n                })\r\n            else:\r\n                # Append each sub row separately\r\n                for sub in matching_sub_rows:\r\n                    se.append(\"items\", {\r\n                        \"item_code\": item_code,\r\n                        \"item_name\": item_code,\r\n                        \"description\": f\"{row.get('product_type') or ''} - {item_code} - {sub.get('sub_item') or ''}\",\r\n                        \"qty\": frappe.utils.flt(sub.get(\"quantity\") or 0),\r\n                        \"uom\": sub.get(\"uom\") or uom,\r\n                        \"basic_rate\": basic_rate,\r\n                        \"t_warehouse\": warehouse\r\n                    })\r\n        se.insert()\r\n        se.submit()\r\n\r\n        # Link back to Job Inward\r\n        frappe.db.set_value(doc.doctype, doc.name, \"stock_entry_ref\", se.name, update_modified=False)\r\n\r\n        # --- Batch Update Logic ---\r\n        job_inward_no = doc.get(\"jobinward_no\")\r\n        if job_inward_no:\r\n            sle_list = frappe.get_all(\r\n                \"Stock Ledger Entry\",\r\n                filters={\"voucher_no\": se.name},\r\n                fields=[\"name\"]\r\n            )\r\n            for sle in sle_list:\r\n                frappe.db.set_value(\"Stock Ledger Entry\", sle.name, \"batch_no\", job_inward_no)\r\n\r\n    except Exception as e:\r\n        frappe.log_error(message=str(e), title=\"Job Inward -> create Stock Entry error\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Cancel",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-08-23 14:56:53.792043",
  "module": null,
  "name": "Stock k liye hai",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Job Inward_In-House Job",
  "script": "# Job Inward -> Cancel linked Stock Entry and clean SLE\r\nif doc.stock_entry_ref:\r\n    try:\r\n        se = frappe.get_doc(\"Stock Entry\", doc.stock_entry_ref)\r\n\r\n        # 1. If submitted, cancel first\r\n        if se.docstatus == 1:\r\n            se.cancel()\r\n            frappe.db.commit()\r\n\r\n        # 2. Delete related Stock Ledger Entries\r\n        frappe.db.sql(\"\"\"\r\n            DELETE FROM `tabStock Ledger Entry` \r\n            WHERE voucher_no = %s\r\n        \"\"\", se.name)\r\n\r\n        # 3. Delete Stock Entry itself (force delete)\r\n        frappe.delete_doc(\"Stock Entry\", se.name, force=1, ignore_permissions=True)\r\n\r\n        # 4. Unlink from Job Inward\r\n        frappe.db.set_value(doc.doctype, doc.name, \"stock_entry_ref\", None, update_modified=False)\r\n\r\n        frappe.db.commit()\r\n\r\n    except Exception as e:\r\n        frappe.log_error(message=str(e), title=\"Job Inward -> Cancel/Delete Stock Entry\")\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Cancel",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-08-23 14:57:23.950413",
  "module": null,
  "name": "Cancel Stock Entry on Job Inward Cancel",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Job Inward_In-House Job",
  "script": "ste = (doc.stock_entry_ref or \"\").strip()\r\n\r\nif ste:\r\n    try:\r\n        # 1) First clear link from Job Inward\r\n        frappe.db.set_value(doc.doctype, doc.name, \"stock_entry_ref\", \"\")\r\n        doc.stock_entry_ref = \"\"\r\n\r\n        # 2) Load Stock Entry\r\n        se = frappe.get_doc(\"Stock Entry\", ste)\r\n\r\n        # 3) If submitted, cancel first\r\n        if se.docstatus == 1:\r\n            se.cancel()\r\n\r\n        # 4) Now force delete ignoring links\r\n        se.delete(force=True, ignore_permissions=True, delete_permanently=True)\r\n\r\n        frappe.msgprint(f\"Stock Entry {ste} cancelled and hard-deleted.\")\r\n\r\n    except Exception as e:\r\n        frappe.throw(f\"Error while deleting Stock Entry {ste}: {e}\")\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-03 10:46:17.724471",
  "module": null,
  "name": "Query",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Item",
  "script": "# def get_query():\r\n#     import frappe\r\n\r\n#     # Get branches user is allowed to access\r\n#     allowed_branches = frappe.get_all(\r\n#         \"User Permission\",\r\n#         filters={\"user\": frappe.session.user, \"allow\": \"Branch\"},\r\n#         pluck=\"for_value\"\r\n#     )\r\n\r\n#     if not allowed_branches:\r\n#         return {\"filters\": [[\"Item\", \"name\", \"=\", \"___NO_ITEM___\"]]}\r\n\r\n#     # Filter using custom child table\r\n#     return {\r\n#         \"filters\": [\r\n#             [\"Custom Item Branch Link\", \"branch\", \"in\", allowed_branches]\r\n#         ]\r\n#     }\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-03 10:45:39.217643",
  "module": null,
  "name": "Permission",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Item",
  "script": "# import frappe\r\n\r\n# def has_permission(doc, ptype, user):\r\n#     if user == \"Administrator\":\r\n#         return True\r\n\r\n#     # Get allowed branches\r\n#     allowed_branches = frappe.get_all(\r\n#         \"User Permission\",\r\n#         filters={\"user\": user, \"allow\": \"Branch\"},\r\n#         pluck=\"for_value\"\r\n#     )\r\n\r\n#     # Get branches from custom table\r\n#     item_branches = [d.branch for d in doc.get(\"branch_selection\")]\r\n\r\n#     # Allow if there is at least one match\r\n#     if set(item_branches) & set(allowed_branches):\r\n#         return True\r\n\r\n#     return False\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-03 10:46:24.052059",
  "module": null,
  "name": "Permission Server Script",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Item",
  "script": "# import frappe\r\n\r\n# def has_permission(doc, ptype, user):\r\n#     if user == \"Administrator\":\r\n#         return True\r\n\r\n#     allowed_branches = frappe.get_all(\r\n#         \"User Permission\",\r\n#         filters={\"user\": user, \"allow\": \"Branch\"},\r\n#         pluck=\"for_value\"\r\n#     )\r\n\r\n#     # Get branches from our custom child table\r\n#     item_branches = [d.branch for d in doc.get(\"branch_selection\")]\r\n\r\n#     if set(item_branches) & set(allowed_branches):  # intersection check\r\n#         return True\r\n#     return False\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-09-15 10:04:32.207800",
  "module": null,
  "name": "Portal User",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Company",
  "script": "if frappe.session.user != \"Administrator\":\r\n    user = frappe.get_doc(\"User\", frappe.session.user)\r\n    if user.default_company:\r\n        doc.company = user.default_company\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "get_customers_for_portal_user",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-09-17 11:17:39.788051",
  "module": null,
  "name": "get_customers_for_portal_user",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "@frappe.whitelist(allow_guest=True)\ndef get_customer_data(customer):\n    return frappe.get_doc(\"Customer\",customer)",
  "script_type": "API"
 },
 {
  "allow_guest": 1,
  "api_method": "test_message",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-09-17 11:23:20.824703",
  "module": null,
  "name": "test_message",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "def execute():\r\n    return {\"message\": \"Hello from ERPNext API! ðŸŽ‰\"}\r\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-04 12:07:10.419291",
  "module": null,
  "name": "PURCHASE ORDER PORTAL USER",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Purchase Receipt",
  "script": "# Auto apply GST Template for Purchase Receipt (especially from Portal-created PO)\r\n\r\nif not doc.taxes_and_charges:\r\n    # Try to copy tax template from linked Purchase Order\r\n    if doc.items and doc.items[0].purchase_order:\r\n        po_name = doc.items[0].purchase_order\r\n        po_template = frappe.db.get_value(\"Purchase Order\", po_name, \"taxes_and_charges\")\r\n        if po_template:\r\n            doc.taxes_and_charges = po_template\r\n            doc.set_taxes()\r\n    \r\n    # If still no taxes, fallback to default company template\r\n    if not doc.taxes_and_charges:\r\n        from erpnext.accounts.doctype.purchase_taxes_and_charges_template.purchase_taxes_and_charges_template import get_default_tax_template\r\n        template = get_default_tax_template(company=doc.company)\r\n        if template:\r\n            doc.taxes_and_charges = template\r\n            doc.set_taxes()\r\n",
  "script_type": "DocType Event"
 }
]