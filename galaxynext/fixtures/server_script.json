[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-09-19 15:07:34.432640",
  "module": null,
  "name": "itemcode_edit_tab",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Item",
  "script": "# # Server Script: Item Auto Code Generator\n# # Doctype: Item\n# # Event: Before Save\n\n# parts = []\n\n# # Add Item Name\n# if doc.item_name:\n#     parts.append(doc.item_name.strip().upper())\n\n# # Add custom parameters\n# if doc.custom_item_parameters:\n#     for row in doc.custom_item_parameters:\n#         if row.value:\n#             parts.append(row.value.strip().upper())\n\n# # Final Code\n# new_code = \"-\".join(parts)\n\n# # Update fields\n# doc.item_code = new_code\n# doc.description = new_code\n\n# # If Item Name blank then set from code\n# if not doc.item_name:\n#     doc.item_name = new_code\n\n# ------------------------------------------------------------------------\n\n# Server Script: Item Auto Code Generator\n# Doctype: Item\n# Event: Before Save\n\nparts = []\n\n# Add Item Name\nif doc.item_name:\n    parts.append(doc.item_name.strip().upper())\n\n# Add custom parameters\nif doc.custom_item_parameters:\n    for row in doc.custom_item_parameters:\n        if row.value:\n            parts.append(row.value.strip().upper())\n\n# Final Code\nnew_code = \"-\".join(parts)\n\nif new_code:\n    # Update fields\n    doc.item_code = new_code\n    doc.description = new_code\n\n    if not doc.item_name:\n        doc.item_name = new_code\n\n    # âœ… Auto-fill Barcode (first row only)\n    if doc.barcodes and len(doc.barcodes) > 0:\n        doc.barcodes[0].barcode = new_code\n\n\n\n\n# ===============================================================================\n\n# # Build the new item_code from child table\n# parts = []\n# for row in doc.custom_item_parameters or []:\n#     if row.value:\n#         parts.append(row.value.strip().upper())\n\n# new_code = \"-\".join(parts)\n\n# # Update item_code field\n# doc.item_code = new_code\n\n# # Update description field also\n# doc.description = new_code\n\n# # Optional: also update item_name if blank\n# if not doc.item_name:\n#     doc.item_name = new_code\n\n# # If you want to also rename the document's name (primary key)\n# if doc.name != new_code:\n#     frappe.rename_doc(\"Item\", doc.name, new_code, force=True)\n\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "Daily",
  "modified": "2025-10-07 11:05:20.027266",
  "module": null,
  "name": "notification",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Lead",
  "script": "if doc.custom_call_again == frappe.utils.nowdate():\r\n    # ðŸ”” Notification Log\r\n    frappe.get_doc({\r\n        \"doctype\": \"Notification Log\",\r\n        \"subject\": f\"Follow-up Reminder for {doc.lead_name}\",\r\n        \"email_content\": f\"Follow-up task for Lead {doc.lead_name}\",\r\n        \"for_user\": doc.owner,\r\n        \"document_type\": \"Lead\",\r\n        \"document_name\": doc.name,\r\n        \"type\": \"Alert\"\r\n    }).insert(ignore_permissions=True)\r\n\r\n    # âœ… Task Create\r\n    task = frappe.get_doc({\r\n        \"doctype\": \"Task\",\r\n        \"subject\": f\"Follow-up for {doc.lead_name}\",\r\n        \"status\": \"Open\",\r\n        \"priority\": \"Medium\",\r\n        \"exp_start_date\": frappe.utils.nowdate(),\r\n        \"exp_end_date\": doc.custom_call_again,\r\n        \"reference_type\": \"Lead\",\r\n        \"reference_name\": doc.name,\r\n        \"description\": f\"Follow-up task for Lead {doc.lead_name}\"\r\n    })\r\n    task.insert(ignore_permissions=True)\r\n\r\n    # âœ… Assign Task to Lead Owner (ToDo Entry with Description)\r\n    frappe.get_doc({\r\n        \"doctype\": \"ToDo\",\r\n        \"owner\": doc.owner,\r\n        \"description\": f\"Follow-up task for Lead {doc.lead_name}\",\r\n        \"reference_type\": \"Task\",\r\n        \"reference_name\": task.name,\r\n        \"assigned_by\": frappe.session.user\r\n    }).insert(ignore_permissions=True)\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-30 11:34:47.644618",
  "module": "galaxynext",
  "name": "company event",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Subcontracting Order",
  "script": "# # Script Type: Document Event\r\n# # Ref Doctype: Purchase Order\r\n# # Event: on_submit\r\n\r\n# if doc.is_internal_supplier:\r\n#     # Customer mapping\r\n#     customer = frappe.db.get_value(\"Customer\", {\"represents_company\": doc.company}, \"name\")\r\n#     if customer:\r\n#         so = frappe.new_doc(\"Sales Order\")\r\n#         so.customer = customer\r\n#         so.company = doc.represents_company\r\n#         so.transaction_date = doc.transaction_date\r\n#         so.delivery_date = doc.schedule_date\r\n\r\n#         # add items\r\n#         for item in doc.items:\r\n#             so.append(\"items\", {\r\n#                 \"item_code\": item.item_code,\r\n#                 \"qty\": item.qty,\r\n#                 \"rate\": item.rate,\r\n#                 \"warehouse\": frappe.db.get_value(\r\n#                     \"Item Default\",\r\n#                     {\"parent\": item.item_code, \"company\": doc.represents_company},\r\n#                     \"default_warehouse\"\r\n#                 )\r\n#             })\r\n\r\n#         so.flags.ignore_permissions = True\r\n#         so.insert()\r\n#         so.submit()\r\n\r\n#         frappe.msgprint(f\"Inter Company Sales Order {so.name} created for {customer}\")\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n# warehouse error\r\n\r\n\r\n\r\n# # Auto create Sales Order when Subcontracting Order is submitted\r\n# if doc.supplier:\r\n#     # find customer linked to this company\r\n#     customer = frappe.db.get_value(\r\n#         \"Customer\",\r\n#         {\"represents_company\": doc.company},\r\n#         \"name\"\r\n#     )\r\n\r\n#     if not customer:\r\n#         frappe.msgprint(f\"No Internal Customer found for Company: {doc.company}\")\r\n#     else:\r\n#         # find supplier's company\r\n#         supplier_company = frappe.db.get_value(\"Supplier\", doc.supplier, \"represents_company\")\r\n\r\n#         if not supplier_company:\r\n#             frappe.msgprint(\"Supplier is not linked to any company.\")\r\n#         else:\r\n#             # create Sales Order\r\n#             so = frappe.new_doc(\"Sales Order\")\r\n#             so.customer = customer\r\n#             so.company = supplier_company\r\n#             so.transaction_date = doc.transaction_date\r\n#             so.delivery_date = doc.schedule_date\r\n\r\n#             # map items from subcontracting order\r\n#             for item in doc.items:\r\n#                 so.append(\"items\", {\r\n#                     \"item_code\": item.item_code,\r\n#                     \"qty\": item.qty,\r\n#                     \"rate\": item.rate,\r\n#                     \"warehouse\": item.warehouse\r\n#                 })\r\n\r\n#             so.flags.ignore_permissions = True\r\n#             so.insert(ignore_permissions=True)\r\n#             so.submit()\r\n\r\n#             frappe.msgprint(f\"âœ… Sales Order {so.name} auto-created from Subcontracting Order {doc.name}\")\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n# pefect code\r\n\r\n\r\n\r\n# # Auto create Sales Order when Subcontracting Order is submitted\r\n# if doc.supplier:\r\n#     # find customer linked to this company\r\n#     customer = frappe.db.get_value(\r\n#         \"Customer\",\r\n#         {\"represents_company\": doc.company},\r\n#         \"name\"\r\n#     )\r\n\r\n#     if not customer:\r\n#         frappe.msgprint(f\"No Internal Customer found for Company: {doc.company}\")\r\n#     else:\r\n#         # find supplier's company\r\n#         supplier_company = frappe.db.get_value(\"Supplier\", doc.supplier, \"represents_company\")\r\n\r\n#         if not supplier_company:\r\n#             frappe.msgprint(\"Supplier is not linked to any company.\")\r\n#         else:\r\n#             # create Sales Order\r\n#             so = frappe.new_doc(\"Sales Order\")\r\n#             so.customer = customer\r\n#             so.company = supplier_company\r\n#             so.transaction_date = doc.transaction_date\r\n#             so.delivery_date = doc.schedule_date\r\n\r\n#             for item in doc.items:\r\n#                 # check if warehouse belongs to correct company\r\n#                 wh_company = frappe.db.get_value(\"Warehouse\", item.warehouse, \"company\")\r\n\r\n#                 if wh_company != supplier_company:\r\n#                     # find default warehouse for supplier company\r\n#                     default_wh = frappe.db.get_value(\r\n#                         \"Warehouse\",\r\n#                         {\"company\": supplier_company, \"is_group\": 0},\r\n#                         \"name\"\r\n#                     )\r\n#                     frappe.msgprint(\r\n#                         f\"âš ï¸ Warehouse {item.warehouse} belongs to {wh_company}, \"\r\n#                         f\"auto-changed to {default_wh} for company {supplier_company}\"\r\n#                     )\r\n#                     warehouse_to_use = default_wh\r\n#                 else:\r\n#                     warehouse_to_use = item.warehouse\r\n\r\n#                 # append item with corrected warehouse\r\n#                 so.append(\"items\", {\r\n#                     \"item_code\": item.item_code,\r\n#                     \"qty\": item.qty,\r\n#                     \"rate\": item.rate,\r\n#                     \"warehouse\": warehouse_to_use\r\n#                 })\r\n\r\n#             so.flags.ignore_permissions = True\r\n#             so.insert(ignore_permissions=True)\r\n#             so.submit()\r\n\r\n#             frappe.msgprint(f\"âœ… Sales Order {so.name} auto-created from Subcontracting Order {doc.name}\")\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n# # Auto create Sales Order when Subcontracting Order is submitted\r\n# if doc.supplier:\r\n#     # find customer linked to this company\r\n#     customer = frappe.db.get_value(\r\n#         \"Customer\",\r\n#         {\"represents_company\": doc.company},\r\n#         \"name\"\r\n#     )\r\n#     if not customer:\r\n#         frappe.msgprint(f\"No Internal Customer found for Company: {doc.company}\")\r\n#     else:\r\n#         # find supplier's company\r\n#         supplier_company = frappe.db.get_value(\"Supplier\", doc.supplier, \"represents_company\")\r\n#         if not supplier_company:\r\n#             frappe.msgprint(\"Supplier is not linked to any company.\")\r\n#         else:\r\n#             # create Sales Order\r\n#             so = frappe.new_doc(\"Sales Order\")\r\n#             so.customer = customer\r\n#             so.company = supplier_company\r\n#             so.transaction_date = doc.transaction_date\r\n#             so.delivery_date = doc.schedule_date\r\n            \r\n#             # Add items with correct warehouse for supplier company\r\n#             for item in doc.items:\r\n#                 # Get item's default warehouse for supplier company\r\n#                 item_default_wh = frappe.db.get_value(\r\n#                     \"Item Default\",\r\n#                     {\r\n#                         \"parent\": item.item_code,\r\n#                         \"company\": supplier_company\r\n#                     },\r\n#                     \"default_warehouse\"\r\n#                 )\r\n                \r\n#                 # Use item default warehouse if found, otherwise use original\r\n#                 warehouse_to_usew = item_default_wh if item_default_wh else item.warehouse\r\n                \r\n#                 so.append(\"items\", {\r\n#                     \"item_code\": item.item_code,\r\n#                     \"qty\": item.qty,\r\n#                     \"rate\": item.rate,\r\n#                     \"warehouse\": warehouse_to_use\r\n#                 })\r\n            \r\n#             so.flags.ignore_permissions = True\r\n#             so.insert(ignore_permissions=True)\r\n#             so.submit()\r\n#             frappe.msgprint(f\"âœ… Sales Order {so.name} auto-created from Subcontracting Order {doc.name}\")\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n# # Auto create Sales Order when Subcontracting Order is submitted\r\n# if doc.supplier:\r\n#     # find customer linked to this company\r\n#     customer = frappe.db.get_value(\r\n#         \"Customer\",\r\n#         {\"represents_company\": doc.company},\r\n#         \"name\"\r\n#     )\r\n#     if not customer:\r\n#         frappe.msgprint(f\"No Internal Customer found for Company: {doc.company}\")\r\n#     else:\r\n#         # find supplier's company\r\n#         supplier_company = frappe.db.get_value(\"Supplier\", doc.supplier, \"represents_company\")\r\n#         if not supplier_company:\r\n#             frappe.msgprint(\"Supplier is not linked to any company.\")\r\n#         else:\r\n#             # create Sales Order\r\n#             so = frappe.new_doc(\"Sales Order\")\r\n#             so.customer = customer\r\n#             so.company = supplier_company\r\n#             so.transaction_date = doc.transaction_date\r\n#             so.delivery_date = doc.schedule_date\r\n            \r\n#             # Add items with correct warehouse for supplier company\r\n#             for item in doc.items:\r\n#                 # Get item's default warehouse for supplier company\r\n#                 item_default_wh = frappe.db.get_value(\r\n#                     \"Item Default\",\r\n#                     {\r\n#                         \"parent\": item.item_code,\r\n#                         \"company\": supplier_company\r\n#                     },\r\n#                     \"default_warehouse\"\r\n#                 )\r\n                \r\n#                 # âœ… Correct variable name (no extra 'w')\r\n#                 warehouse_to_use = item_default_wh if item_default_wh else item.warehouse\r\n                \r\n#                 # Append item to Sales Order\r\n#                 so.append(\"items\", {\r\n#                     \"item_code\": item.item_code,\r\n#                     \"qty\": item.qty,\r\n#                     \"rate\": item.rate,\r\n#                     \"warehouse\": warehouse_to_use\r\n#                 })\r\n            \r\n#             so.flags.ignore_permissions = True\r\n#             so.insert(ignore_permissions=True)\r\n#             so.submit()\r\n#             frappe.msgprint(f\"âœ… Sales Order {so.name} auto-created from Subcontracting Order {doc.name}\")\r\n\r\n\r\n\r\n\r\n# Auto create Sales Order when Subcontracting Order is submitted\r\n\r\n# # Auto create Sales Order when Subcontracting Order is submitted\r\n\r\n# if doc.supplier:\r\n#     # find customer linked to this company\r\n#     customer = frappe.db.get_value(\r\n#         \"Customer\",\r\n#         {\"represents_company\": doc.company},\r\n#         \"name\"\r\n#     )\r\n    \r\n#     print(f\"ðŸ” Customer found: {customer}\")\r\n    \r\n#     if not customer:\r\n#         frappe.msgprint(f\"No Internal Customer found for Company: {doc.company}\")\r\n#     else:\r\n#         # find supplier's company\r\n#         supplier_company = frappe.db.get_value(\"Supplier\", doc.supplier, \"represents_company\")\r\n        \r\n#         print(f\"ðŸ¢ Supplier Company: {supplier_company}\")\r\n        \r\n#         if not supplier_company:\r\n#             frappe.msgprint(\"Supplier is not linked to any company.\")\r\n#         else:\r\n#             # create Sales Order\r\n#             so = frappe.new_doc(\"Sales Order\")\r\n#             so.customer = customer\r\n#             so.company = supplier_company\r\n#             so.transaction_date = doc.transaction_date\r\n#             so.delivery_date = frappe.utils.today()  # âœ… Today's date\r\n#             so.po_no = doc.name  # âœ… Subcontracting Order ID\r\n#             so.po_date = doc.transaction_date  # âœ… Subcontracting Order date\r\n            \r\n#             print(f\"ðŸ“… Delivery Date set to: {so.delivery_date}\")\r\n#             print(f\"ðŸ“ PO No set to: {so.po_no}\")\r\n#             print(f\"ðŸ“… PO Date set to: {so.po_date}\")\r\n            \r\n#             # âœ… Get service item rate (same as client script logic)\r\n#             service_rate = 0\r\n#             if doc.service_items and len(doc.service_items) > 0:\r\n#                 service_rate = doc.service_items[0].rate or 0\r\n#                 print(f\"ðŸ’° Service Rate from first service item: {service_rate}\")\r\n#             else:\r\n#                 print(f\"âš ï¸ WARNING: No service items found\")\r\n            \r\n#             print(f\"Total Items to process: {len(doc.items)}\")\r\n            \r\n#             # Sort items by idx to maintain order (same as client script)\r\n#             sorted_items = sorted(doc.items, key=lambda x: x.idx or 0)\r\n#             print(f\"Items sorted by idx\")\r\n            \r\n#             # Add items with rate from service_items table\r\n#             for item in sorted_items:\r\n#                 print(f\"\\n--- Processing Item idx {item.idx}: {item.item_code} ---\")\r\n                \r\n#                 # Get item's default warehouse for supplier company\r\n#                 item_default_wh = frappe.db.get_value(\r\n#                     \"Item Default\",\r\n#                     {\r\n#                         \"parent\": item.item_code,\r\n#                         \"company\": supplier_company\r\n#                     },\r\n#                     \"default_warehouse\"\r\n#                 )\r\n                \r\n#                 warehouse_to_use = item_default_wh if item_default_wh else item.warehouse\r\n#                 print(f\"ðŸ“¦ Warehouse: {warehouse_to_use}\")\r\n                \r\n#                 # âœ… Use service rate as priority (same logic as client script)\r\n#                 item_rate = service_rate or item.rate or item.amount or 0\r\n                \r\n#                 print(f\"ðŸ’° Rate calculation:\")\r\n#                 print(f\"   - Service Rate: {service_rate}\")\r\n#                 print(f\"   - Item Rate: {item.rate}\")\r\n#                 print(f\"   - Final Rate: {item_rate}\")\r\n                \r\n#                 # Get default BOM\r\n#                 default_bom = frappe.db.get_value(\"Item\", item.item_code, \"default_bom\")\r\n                \r\n#                 # Append item to Sales Order (same structure as client script)\r\n#                 so.append(\"items\", {\r\n#                     \"item_code\": item.item_code,\r\n#                     \"item_name\": item.item_name,\r\n#                     \"qty\": item.qty,\r\n#                     \"uom\": item.uom or item.stock_uom,\r\n#                     \"delivery_date\": frappe.utils.today(),\r\n#                     \"warehouse\": warehouse_to_use,\r\n#                     \"rate\": item_rate,\r\n#                     \"bom_no\": default_bom\r\n#                 })\r\n                \r\n#                 print(f\"âœ… Item added: {item.item_code}, Qty: {item.qty}, Rate: {item_rate}, BOM: {default_bom}\")\r\n            \r\n#             so.flags.ignore_permissions = True\r\n#             so.insert(ignore_permissions=True)\r\n#             so.submit()\r\n            \r\n#             print(f\"ðŸŽ‰ Sales Order {so.name} created successfully!\")\r\n#             frappe.msgprint(f\"âœ… Sales Order {so.name} auto-created from Subcontracting Order {doc.name}\")\r\n\r\n\r\n\r\n\r\n# # =====================================================================\r\n# # AUTO CREATE SALES ORDER + WORK ORDER FROM SUBCONTRACTING ORDER\r\n# # Production Version - Clean & Simple\r\n# # =====================================================================\r\n\r\n# if doc.supplier:\r\n    \r\n#     # Get internal customer\r\n#     customer = frappe.db.get_value(\r\n#         \"Customer\",\r\n#         {\"represents_company\": doc.company},\r\n#         \"name\"\r\n#     )\r\n    \r\n#     if not customer:\r\n#         frappe.msgprint(\"No Internal Customer found for Company: \" + doc.company)\r\n#     else:\r\n        \r\n#         # Get supplier's company\r\n#         supplier_company = frappe.db.get_value(\"Supplier\", doc.supplier, \"represents_company\")\r\n        \r\n#         if not supplier_company:\r\n#             frappe.msgprint(\"Supplier is not linked to any company.\")\r\n#         else:\r\n            \r\n#             # =====================================================================\r\n#             # STEP 1: CREATE SALES ORDER\r\n#             # =====================================================================\r\n            \r\n#             so = frappe.new_doc(\"Sales Order\")\r\n#             so.company = supplier_company\r\n#             so.customer = customer\r\n#             so.transaction_date = doc.transaction_date\r\n#             so.delivery_date = frappe.utils.today()\r\n#             so.po_no = doc.name\r\n#             so.po_date = doc.transaction_date\r\n            \r\n#             # Get service rate from first service item\r\n#             service_rate = 0\r\n#             if doc.service_items and len(doc.service_items) > 0:\r\n#                 service_rate = doc.service_items[0].rate or 0\r\n            \r\n#             # Sort items by idx\r\n#             sorted_items = sorted(doc.items, key=lambda x: x.idx or 0)\r\n            \r\n#             # Add items to Sales Order\r\n#             for item in sorted_items:\r\n                \r\n#                 # Get warehouse\r\n#                 item_default_wh = frappe.db.get_value(\r\n#                     \"Item Default\",\r\n#                     {\"parent\": item.item_code, \"company\": supplier_company},\r\n#                     \"default_warehouse\"\r\n#                 )\r\n#                 warehouse_to_use = item_default_wh if item_default_wh else item.warehouse\r\n                \r\n#                 # Calculate rate: service_rate > item.rate > item.amount > 0\r\n#                 item_rate = service_rate or item.rate or item.amount or 0\r\n                \r\n#                 # Get default BOM\r\n#                 default_bom = frappe.db.get_value(\"Item\", item.item_code, \"default_bom\")\r\n                \r\n#                 # Append item\r\n#                 so.append(\"items\", {\r\n#                     \"item_code\": item.item_code,\r\n#                     \"item_name\": item.item_name,\r\n#                     \"qty\": item.qty,\r\n#                     \"uom\": item.uom or item.stock_uom,\r\n#                     \"delivery_date\": frappe.utils.today(),\r\n#                     \"warehouse\": warehouse_to_use,\r\n#                     \"rate\": item_rate,\r\n#                     \"bom_no\": default_bom\r\n#                 })\r\n            \r\n#             # Insert and submit Sales Order\r\n#             so.flags.ignore_permissions = True\r\n#             so.insert(ignore_permissions=True)\r\n#             so.submit()\r\n            \r\n#             # =====================================================================\r\n#             # STEP 2: AUTO CREATE WORK ORDERS\r\n#             # =====================================================================\r\n            \r\n#             try:\r\n#                 work_orders_created = []\r\n                \r\n#                 # Auto-detect default warehouses\r\n#                 default_wip_warehouse = \"\"\r\n#                 default_fg_warehouse = \"\"\r\n#                 default_source_warehouse = \"\"\r\n                \r\n#                 # Find WIP Warehouse\r\n#                 try:\r\n#                     wip_warehouses = frappe.get_all(\r\n#                         \"Warehouse\",\r\n#                         filters={\"company\": supplier_company, \"is_group\": 0, \"disabled\": 0},\r\n#                         fields=[\"name\"],\r\n#                         or_filters=[\r\n#                             {\"warehouse_name\": [\"like\", \"%Work In Progress%\"]},\r\n#                             {\"warehouse_name\": [\"like\", \"%WIP%\"]},\r\n#                             {\"name\": [\"like\", \"%Work In Progress%\"]},\r\n#                             {\"name\": [\"like\", \"%WIP%\"]}\r\n#                         ],\r\n#                         limit=1\r\n#                     )\r\n#                     if wip_warehouses:\r\n#                         default_wip_warehouse = wip_warehouses[0].name\r\n#                 except:\r\n#                     pass\r\n                \r\n#                 # Find FG Warehouse\r\n#                 try:\r\n#                     fg_warehouses = frappe.get_all(\r\n#                         \"Warehouse\",\r\n#                         filters={\"company\": supplier_company, \"is_group\": 0, \"disabled\": 0},\r\n#                         fields=[\"name\"],\r\n#                         or_filters=[\r\n#                             {\"warehouse_name\": [\"like\", \"%Finished Goods%\"]},\r\n#                             {\"warehouse_name\": [\"like\", \"%FG%\"]},\r\n#                             {\"name\": [\"like\", \"%Finished Goods%\"]},\r\n#                             {\"warehouse_name\": [\"like\", \"%Finish%\"]}\r\n#                         ],\r\n#                         limit=1\r\n#                     )\r\n#                     if fg_warehouses:\r\n#                         default_fg_warehouse = fg_warehouses[0].name\r\n#                 except:\r\n#                     pass\r\n                \r\n#                 # Find Source Warehouse\r\n#                 try:\r\n#                     source_warehouses = frappe.get_all(\r\n#                         \"Warehouse\",\r\n#                         filters={\"company\": supplier_company, \"is_group\": 0, \"disabled\": 0},\r\n#                         fields=[\"name\"],\r\n#                         or_filters=[\r\n#                             {\"warehouse_name\": [\"like\", \"%Stores%\"]},\r\n#                             {\"warehouse_name\": [\"like\", \"%Raw Material%\"]},\r\n#                             {\"name\": [\"like\", \"%Stores%\"]},\r\n#                             {\"name\": [\"like\", \"%Raw%\"]}\r\n#                         ],\r\n#                         limit=1\r\n#                     )\r\n#                     if source_warehouses:\r\n#                         default_source_warehouse = source_warehouses[0].name\r\n#                 except:\r\n#                     pass\r\n                \r\n#                 # Create Work Orders for each item\r\n#                 for so_item in so.items:\r\n                    \r\n#                     # Skip if no BOM\r\n#                     bom_no = so_item.bom_no\r\n#                     if not bom_no:\r\n#                         continue\r\n                    \r\n#                     # Get BOM document\r\n#                     try:\r\n#                         bom_doc = frappe.get_doc(\"BOM\", bom_no)\r\n#                     except Exception as bom_err:\r\n#                         frappe.log_error(message=\"BOM not found: \" + bom_no, title=\"Auto WO Error\")\r\n#                         continue\r\n                    \r\n#                     # Create Work Order\r\n#                     wo = frappe.get_doc({\r\n#                         \"doctype\": \"Work Order\",\r\n#                         \"company\": supplier_company,\r\n#                         \"production_item\": so_item.item_code,\r\n#                         \"item_name\": so_item.item_name,\r\n#                         \"description\": so_item.description,\r\n#                         \"qty\": so_item.qty or 0,\r\n#                         \"bom_no\": bom_no,\r\n#                         \"sales_order\": so.name,\r\n#                         \"sales_order_item\": so_item.name,\r\n#                         \"fg_warehouse\": so_item.warehouse or default_fg_warehouse,\r\n#                         \"wip_warehouse\": default_wip_warehouse,\r\n#                         \"source_warehouse\": default_source_warehouse,\r\n#                         \"use_multi_level_bom\": 1,\r\n#                         \"skip_transfer\": 0,\r\n#                         \"transfer_material_against\": \"Work Order\",\r\n#                         \"expected_delivery_date\": so_item.delivery_date or so.delivery_date,\r\n#                         \"project\": so.project\r\n#                     })\r\n                    \r\n#                     # Add required items from BOM\r\n#                     for b_item in bom_doc.items or []:\r\n#                         required_qty = (b_item.qty or 0) * (so_item.qty or 0)\r\n#                         wo.append(\"required_items\", {\r\n#                             \"item_code\": b_item.item_code,\r\n#                             \"item_name\": b_item.item_name,\r\n#                             \"description\": b_item.description,\r\n#                             \"required_qty\": required_qty,\r\n#                             \"source_warehouse\": b_item.source_warehouse or default_source_warehouse,\r\n#                             \"rate\": b_item.rate or 0,\r\n#                             \"amount\": (b_item.rate or 0) * required_qty\r\n#                         })\r\n                    \r\n#                     # Add operations from BOM\r\n#                     if bom_doc.with_operations and bom_doc.operations:\r\n#                         for op in bom_doc.operations:\r\n#                             wo.append(\"operations\", {\r\n#                                 \"operation\": op.operation,\r\n#                                 \"bom\": bom_no,\r\n#                                 \"bom_operation\": op.name,\r\n#                                 \"description\": op.description,\r\n#                                 \"workstation\": op.workstation,\r\n#                                 \"workstation_type\": op.workstation_type,\r\n#                                 \"time_in_mins\": op.time_in_mins or 0,\r\n#                                 \"operating_cost\": op.operating_cost or 0,\r\n#                                 \"hour_rate\": op.hour_rate or 0,\r\n#                                 \"batch_size\": op.batch_size or 1,\r\n#                                 \"sequence_id\": op.sequence_id or op.idx,\r\n#                                 \"status\": \"Pending\",\r\n#                                 \"completed_qty\": 0\r\n#                             })\r\n                    \r\n#                     # Insert and submit Work Order\r\n#                     try:\r\n#                         wo.insert(ignore_permissions=True)\r\n#                         work_orders_created.append(wo.name)\r\n#                         wo.submit()\r\n#                     except Exception as ins_err:\r\n#                         frappe.log_error(\r\n#                             message=\"WO creation failed for \" + so_item.item_code + \": \" + str(ins_err), \r\n#                             title=\"Auto WO Error\"\r\n#                         )\r\n                \r\n#                 # Success message - Simple format\r\n#                 if work_orders_created:\r\n#                     wo_list = \", \".join(work_orders_created)\r\n#                     frappe.msgprint(\"Sales Order: \" + so.name + \"<br><br>Work Orders Created: \" + wo_list)\r\n#                 else:\r\n#                     frappe.msgprint(\"Sales Order created: \" + so.name)\r\n                    \r\n#             except Exception as wo_err:\r\n#                 frappe.log_error(message=str(wo_err), title=\"Work Order Auto Creation Error\")\r\n#                 frappe.msgprint(\"Sales Order \" + so.name + \" created but Work Orders failed. Check Error Log.\")\r\n\r\n\r\n\r\n\r\n# # # =====================================================================\r\n# # # AUTO CREATE SALES ORDER + WORK ORDER FROM SUBCONTRACTING ORDER\r\n# # # Production Version with Console Logs for Debugging\r\n# # # Without Parameter Code\r\n# # # =====================================================================\r\n\r\n# if doc.supplier:\r\n#     frappe.log(\"=\" * 60)\r\n#     frappe.log(\"STARTING AUTO SO + WO CREATION\")\r\n#     frappe.log(\"=\" * 60)\r\n#     frappe.log(f\"Supplier: {doc.supplier}\")\r\n#     frappe.log(f\"Company: {doc.company}\")\r\n    \r\n#     # Get internal customer\r\n#     customer = frappe.db.get_value(\r\n#         \"Customer\",\r\n#         {\"represents_company\": doc.company},\r\n#         \"name\"\r\n#     )\r\n#     frappe.log(f\"Internal Customer Found: {customer}\")\r\n    \r\n#     if not customer:\r\n#         frappe.msgprint(\"No Internal Customer found for Company: \" + doc.company)\r\n#     else:\r\n        \r\n#         # Get supplier's company\r\n#         supplier_company = frappe.db.get_value(\"Supplier\", doc.supplier, \"represents_company\")\r\n#         frappe.log(f\"Supplier Company: {supplier_company}\")\r\n        \r\n#         if not supplier_company:\r\n#             frappe.msgprint(\"Supplier is not linked to any company.\")\r\n#         else:\r\n            \r\n#             # =====================================================================\r\n#             # STEP 1: CREATE SALES ORDER\r\n#             # =====================================================================\r\n#             frappe.log(\"-\" * 60)\r\n#             frappe.log(\"STEP 1: CREATING SALES ORDER\")\r\n#             frappe.log(\"-\" * 60)\r\n            \r\n#             so = frappe.new_doc(\"Sales Order\")\r\n#             so.company = supplier_company\r\n#             so.customer = customer\r\n#             so.transaction_date = doc.transaction_date\r\n#             so.delivery_date = frappe.utils.today()\r\n#             so.po_no = doc.name\r\n#             so.po_date = doc.transaction_date\r\n            \r\n#             # Get service rate from first service item\r\n#             service_rate = 0\r\n#             if doc.service_items and len(doc.service_items) > 0:\r\n#                 service_rate = doc.service_items[0].rate or 0\r\n#             frappe.log(f\"Service Rate from first item: {service_rate}\")\r\n            \r\n#             # Sort items by idx\r\n#             sorted_items = sorted(doc.items, key=lambda x: x.idx or 0)\r\n#             frappe.log(f\"Total Items to process: {len(sorted_items)}\")\r\n            \r\n#             # Add items to Sales Order\r\n#             for idx, item in enumerate(sorted_items, 1):\r\n#                 frappe.log(f\"\\n  Item {idx}: {item.item_code}\")\r\n                \r\n#                 # Get warehouse\r\n#                 item_default_wh = frappe.db.get_value(\r\n#                     \"Item Default\",\r\n#                     {\"parent\": item.item_code, \"company\": supplier_company},\r\n#                     \"default_warehouse\"\r\n#                 )\r\n#                 warehouse_to_use = item_default_wh if item_default_wh else item.warehouse\r\n#                 frappe.log(f\"    Warehouse: {warehouse_to_use}\")\r\n                \r\n#                 # Calculate rate: service_rate > item.rate > item.amount > 0\r\n#                 item_rate = service_rate or item.rate or item.amount or 0\r\n#                 frappe.log(f\"    Rate: {item_rate} (service: {service_rate}, item.rate: {item.rate})\")\r\n                \r\n#                 # Get default BOM\r\n#                 default_bom = frappe.db.get_value(\"Item\", item.item_code, \"default_bom\")\r\n#                 frappe.log(f\"    BOM: {default_bom}\")\r\n                \r\n#                 # Append item\r\n#                 so.append(\"items\", {\r\n#                     \"item_code\": item.item_code,\r\n#                     \"item_name\": item.item_name,\r\n#                     \"qty\": item.qty,\r\n#                     \"uom\": item.uom or item.stock_uom,\r\n#                     \"delivery_date\": frappe.utils.today(),\r\n#                     \"warehouse\": warehouse_to_use,\r\n#                     \"rate\": item_rate,\r\n#                     \"bom_no\": default_bom\r\n#                 })\r\n            \r\n#             # Insert and submit Sales Order\r\n#             so.flags.ignore_permissions = True\r\n#             so.insert(ignore_permissions=True)\r\n#             frappe.log(f\"\\nSales Order Inserted: {so.name}\")\r\n#             so.submit()\r\n#             frappe.log(f\"Sales Order Submitted: {so.name}\")\r\n            \r\n#             # =====================================================================\r\n#             # STEP 2: AUTO CREATE WORK ORDERS\r\n#             # =====================================================================\r\n#             frappe.log(\"\\n\" + \"-\" * 60)\r\n#             frappe.log(\"STEP 2: CREATING WORK ORDERS\")\r\n#             frappe.log(\"-\" * 60)\r\n            \r\n#             try:\r\n#                 work_orders_created = []\r\n                \r\n#                 # Auto-detect default warehouses\r\n#                 default_wip_warehouse = \"\"\r\n#                 default_fg_warehouse = \"\"\r\n#                 default_source_warehouse = \"\"\r\n                \r\n#                 # Find WIP Warehouse\r\n#                 try:\r\n#                     wip_warehouses = frappe.get_all(\r\n#                         \"Warehouse\",\r\n#                         filters={\"company\": supplier_company, \"is_group\": 0, \"disabled\": 0},\r\n#                         fields=[\"name\"],\r\n#                         or_filters=[\r\n#                             {\"warehouse_name\": [\"like\", \"%Work In Progress%\"]},\r\n#                             {\"warehouse_name\": [\"like\", \"%WIP%\"]},\r\n#                             {\"name\": [\"like\", \"%Work In Progress%\"]},\r\n#                             {\"name\": [\"like\", \"%WIP%\"]}\r\n#                         ],\r\n#                         limit=1\r\n#                     )\r\n#                     if wip_warehouses:\r\n#                         default_wip_warehouse = wip_warehouses[0].name\r\n#                 except:\r\n#                     pass\r\n#                 frappe.log(f\"WIP Warehouse: {default_wip_warehouse}\")\r\n                \r\n#                 # Find FG Warehouse\r\n#                 try:\r\n#                     fg_warehouses = frappe.get_all(\r\n#                         \"Warehouse\",\r\n#                         filters={\"company\": supplier_company, \"is_group\": 0, \"disabled\": 0},\r\n#                         fields=[\"name\"],\r\n#                         or_filters=[\r\n#                             {\"warehouse_name\": [\"like\", \"%Finished Goods%\"]},\r\n#                             {\"warehouse_name\": [\"like\", \"%FG%\"]},\r\n#                             {\"name\": [\"like\", \"%Finished Goods%\"]},\r\n#                             {\"warehouse_name\": [\"like\", \"%Finish%\"]}\r\n#                         ],\r\n#                         limit=1\r\n#                     )\r\n#                     if fg_warehouses:\r\n#                         default_fg_warehouse = fg_warehouses[0].name\r\n#                 except:\r\n#                     pass\r\n#                 frappe.log(f\"FG Warehouse: {default_fg_warehouse}\")\r\n                \r\n#                 # Find Source Warehouse\r\n#                 try:\r\n#                     source_warehouses = frappe.get_all(\r\n#                         \"Warehouse\",\r\n#                         filters={\"company\": supplier_company, \"is_group\": 0, \"disabled\": 0},\r\n#                         fields=[\"name\"],\r\n#                         or_filters=[\r\n#                             {\"warehouse_name\": [\"like\", \"%Stores%\"]},\r\n#                             {\"warehouse_name\": [\"like\", \"%Raw Material%\"]},\r\n#                             {\"name\": [\"like\", \"%Stores%\"]},\r\n#                             {\"name\": [\"like\", \"%Raw%\"]}\r\n#                         ],\r\n#                         limit=1\r\n#                     )\r\n#                     if source_warehouses:\r\n#                         default_source_warehouse = source_warehouses[0].name\r\n#                 except:\r\n#                     pass\r\n#                 frappe.log(f\"Source Warehouse: {default_source_warehouse}\")\r\n                \r\n#                 # Create Work Orders for each item\r\n#                 frappe.log(f\"\\nProcessing {len(so.items)} SO items for Work Orders...\")\r\n                \r\n#                 for wo_idx, so_item in enumerate(so.items, 1):\r\n#                     frappe.log(f\"\\n  WO {wo_idx}: {so_item.item_code}\")\r\n                    \r\n#                     # Skip if no BOM\r\n#                     bom_no = so_item.bom_no\r\n#                     if not bom_no:\r\n#                         frappe.log(f\"    SKIPPED - No BOM found\")\r\n#                         continue\r\n                    \r\n#                     frappe.log(f\"    BOM: {bom_no}\")\r\n                    \r\n#                     # Get BOM document\r\n#                     try:\r\n#                         bom_doc = frappe.get_doc(\"BOM\", bom_no)\r\n#                         frappe.log(f\"    BOM loaded: {len(bom_doc.items or [])} items, {len(bom_doc.operations or [])} operations\")\r\n#                     except Exception as bom_err:\r\n#                         frappe.log_error(message=\"BOM not found: \" + bom_no, title=\"Auto WO Error\")\r\n#                         frappe.log(f\"    ERROR loading BOM: {str(bom_err)}\")\r\n#                         continue\r\n                    \r\n#                     # Create Work Order\r\n#                     wo = frappe.get_doc({\r\n#                         \"doctype\": \"Work Order\",\r\n#                         \"company\": supplier_company,\r\n#                         \"production_item\": so_item.item_code,\r\n#                         \"item_name\": so_item.item_name,\r\n#                         \"description\": so_item.description,\r\n#                         \"qty\": so_item.qty or 0,\r\n#                         \"bom_no\": bom_no,\r\n#                         \"sales_order\": so.name,\r\n#                         \"sales_order_item\": so_item.name,\r\n#                         \"fg_warehouse\": so_item.warehouse or default_fg_warehouse,\r\n#                         \"wip_warehouse\": default_wip_warehouse,\r\n#                         \"source_warehouse\": default_source_warehouse,\r\n#                         \"use_multi_level_bom\": 1,\r\n#                         \"skip_transfer\": 0,\r\n#                         \"transfer_material_against\": \"Work Order\",\r\n#                         \"expected_delivery_date\": so_item.delivery_date or so.delivery_date,\r\n#                         \"project\": so.project\r\n#                     })\r\n#                     frappe.log(f\"    WO document created (not saved yet)\")\r\n                    \r\n#                     # Add required items from BOM\r\n#                     for b_item in bom_doc.items or []:\r\n#                         required_qty = (b_item.qty or 0) * (so_item.qty or 0)\r\n#                         wo.append(\"required_items\", {\r\n#                             \"item_code\": b_item.item_code,\r\n#                             \"item_name\": b_item.item_name,\r\n#                             \"description\": b_item.description,\r\n#                             \"required_qty\": required_qty,\r\n#                             \"source_warehouse\": b_item.source_warehouse or default_source_warehouse,\r\n#                             \"rate\": b_item.rate or 0,\r\n#                             \"amount\": (b_item.rate or 0) * required_qty\r\n#                         })\r\n#                     frappe.log(f\"    Added {len(bom_doc.items or [])} required items\")\r\n                    \r\n#                     # Add operations from BOM\r\n#                     if bom_doc.with_operations and bom_doc.operations:\r\n#                         for op in bom_doc.operations:\r\n#                             wo.append(\"operations\", {\r\n#                                 \"operation\": op.operation,\r\n#                                 \"bom\": bom_no,\r\n#                                 \"bom_operation\": op.name,\r\n#                                 \"description\": op.description,\r\n#                                 \"workstation\": op.workstation,\r\n#                                 \"workstation_type\": op.workstation_type,\r\n#                                 \"time_in_mins\": op.time_in_mins or 0,\r\n#                                 \"operating_cost\": op.operating_cost or 0,\r\n#                                 \"hour_rate\": op.hour_rate or 0,\r\n#                                 \"batch_size\": op.batch_size or 1,\r\n#                                 \"sequence_id\": op.sequence_id or op.idx,\r\n#                                 \"status\": \"Pending\",\r\n#                                 \"completed_qty\": 0\r\n#                             })\r\n#                         frappe.log(f\"    Added {len(bom_doc.operations)} operations\")\r\n                    \r\n#                     # Insert and submit Work Order\r\n#                     try:\r\n#                         wo.insert(ignore_permissions=True)\r\n#                         frappe.log(f\"    âœ“ WO Inserted: {wo.name}\")\r\n#                         work_orders_created.append(wo.name)\r\n#                         wo.submit()\r\n#                         frappe.log(f\"    âœ“ WO Submitted: {wo.name}\")\r\n#                     except Exception as ins_err:\r\n#                         frappe.log_error(\r\n#                             message=\"WO creation failed for \" + so_item.item_code + \": \" + str(ins_err), \r\n#                             title=\"Auto WO Error\"\r\n#                         )\r\n#                         frappe.log(f\"    âœ— WO Creation FAILED: {str(ins_err)}\")\r\n                \r\n#                 # Success message - Simple format\r\n#                 frappe.log(\"\\n\" + \"=\" * 60)\r\n#                 frappe.log(\"PROCESS COMPLETED\")\r\n#                 frappe.log(\"=\" * 60)\r\n#                 frappe.log(f\"Sales Order: {so.name}\")\r\n#                 frappe.log(f\"Work Orders Created: {len(work_orders_created)}\")\r\n#                 for wo_name in work_orders_created:\r\n#                     frappe.log(f\"  - {wo_name}\")\r\n                \r\n#                 if work_orders_created:\r\n#                     wo_list = \", \".join(work_orders_created)\r\n#                     frappe.msgprint(\"Sales Order: \" + so.name + \"<br><br>Work Orders Created: \" + wo_list)\r\n#                 else:\r\n#                     frappe.msgprint(\"Sales Order created: \" + so.name)\r\n                    \r\n#             except Exception as wo_err:\r\n#                 frappe.log_error(message=str(wo_err), title=\"Work Order Auto Creation Error\")\r\n#                 frappe.log(f\"ERROR in Work Order creation: {str(wo_err)}\")\r\n#                 frappe.msgprint(\"Sales Order \" + so.name + \" created but Work Orders failed. Check Error Log.\")\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n# =====================================================================\r\n# AUTO CREATE SALES ORDER FROM SUBCONTRACTING ORDER\r\n# Checks: Parameter = true AND supplier's company matches\r\n# Work Order creation removed\r\n# =====================================================================\r\n\r\nif doc.supplier:\r\n    frappe.log(\"=\" * 60)\r\n    frappe.log(\"CHECKING AUTO SALES ORDER CREATION\")\r\n    frappe.log(\"=\" * 60)\r\n    frappe.log(f\"Supplier: {doc.supplier}\")\r\n    frappe.log(f\"Company: {doc.company}\")\r\n    \r\n    # Get supplier's company\r\n    supplier_company = frappe.db.get_value(\"Supplier\", doc.supplier, \"represents_company\")\r\n    frappe.log(f\"Supplier Company: {supplier_company}\")\r\n    \r\n    if not supplier_company:\r\n        frappe.log(\"Supplier is not linked to any company - SKIPPED\")\r\n    else:\r\n        # Get parameter for this company\r\n        param_value = frappe.db.get_value(\r\n            \"parameter\",\r\n            {\r\n                \"param_name\": \"SUBCONTRACTING\",\r\n                \"company\": doc.company\r\n            },\r\n            \"param_value\"\r\n        )\r\n        \r\n        # -------------------------------\r\n        # CASE 2: Parameter not TRUE\r\n        # -------------------------------\r\n        if not (param_value and str(param_value).lower() == \"true\"):\r\n            frappe.msgprint(\r\n                f\"Sales Order not created. \"\r\n                f\"SUBCONTRACTING parameter is not enabled for \"\r\n                f\"company {doc.company}.\",\r\n                indicator=\"red\"\r\n            )\r\n\r\n        frappe.log(f\"Parameter Value for {supplier_company}: {param_value}\")\r\n        \r\n        # Check if parameter is true/TRUE\r\n        if param_value and str(param_value).lower() == \"true\":\r\n            frappe.log(\"âœ“ Parameter is TRUE - Proceeding with SO creation\")\r\n            \r\n            # Get internal customer\r\n            customer = frappe.db.get_value(\r\n                \"Customer\",\r\n                {\"represents_company\": doc.company},\r\n                \"name\"\r\n            )\r\n            frappe.log(f\"Internal Customer Found: {customer}\")\r\n            \r\n            if not customer:\r\n                frappe.msgprint(\"No Internal Customer found for Company: \" + doc.company)\r\n            else:\r\n                # =====================================================================\r\n                # CREATE SALES ORDER\r\n                # =====================================================================\r\n                frappe.log(\"-\" * 60)\r\n                frappe.log(\"CREATING SALES ORDER\")\r\n                frappe.log(\"-\" * 60)\r\n                \r\n                so = frappe.new_doc(\"Sales Order\")\r\n                so.company = supplier_company\r\n                so.customer = customer\r\n                so.transaction_date = doc.transaction_date\r\n                so.delivery_date = frappe.utils.today()\r\n                so.po_no = doc.name\r\n                so.po_date = doc.transaction_date\r\n                \r\n                # Get service rate from first service item\r\n                service_rate = 0\r\n                if doc.service_items and len(doc.service_items) > 0:\r\n                    service_rate = doc.service_items[0].rate or 0\r\n                frappe.log(f\"Service Rate from first item: {service_rate}\")\r\n                \r\n                # Sort items by idx\r\n                sorted_items = sorted(doc.items, key=lambda x: x.idx or 0)\r\n                frappe.log(f\"Total Items to process: {len(sorted_items)}\")\r\n                \r\n                # Add items to Sales Order\r\n                for idx, item in enumerate(sorted_items, 1):\r\n                    frappe.log(f\"\\n  Item {idx}: {item.item_code}\")\r\n                    \r\n                    # Get warehouse\r\n                    item_default_wh = frappe.db.get_value(\r\n                        \"Item Default\",\r\n                        {\"parent\": item.item_code, \"company\": supplier_company},\r\n                        \"default_warehouse\"\r\n                    )\r\n                    warehouse_to_use = item_default_wh if item_default_wh else item.warehouse\r\n                    frappe.log(f\"    Warehouse: {warehouse_to_use}\")\r\n                    \r\n                    # Calculate rate: service_rate > item.rate > item.amount > 0\r\n                    item_rate = service_rate or item.rate or item.amount or 0\r\n                    frappe.log(f\"    Rate: {item_rate} (service: {service_rate}, item.rate: {item.rate})\")\r\n                    \r\n                    # Get default BOM\r\n                    default_bom = frappe.db.get_value(\"Item\", item.item_code, \"default_bom\")\r\n                    frappe.log(f\"    BOM: {default_bom}\")\r\n                    \r\n                    # Append item\r\n                    so.append(\"items\", {\r\n                        \"item_code\": item.item_code,\r\n                        \"item_name\": item.item_name,\r\n                        \"qty\": item.qty,\r\n                        \"uom\": item.uom or item.stock_uom,\r\n                        \"delivery_date\": frappe.utils.today(),\r\n                        \"warehouse\": warehouse_to_use,\r\n                        \"rate\": item_rate,\r\n                        \"bom_no\": default_bom\r\n                    })\r\n                \r\n                # Insert and submit Sales Order\r\n                so.flags.ignore_permissions = True\r\n                so.insert(ignore_permissions=True)\r\n                frappe.log(f\"\\nSales Order Inserted: {so.name}\")\r\n                so.submit()\r\n                frappe.log(f\"Sales Order Submitted: {so.name}\")\r\n                \r\n                # Success message\r\n                frappe.log(\"\\n\" + \"=\" * 60)\r\n                frappe.log(\"PROCESS COMPLETED\")\r\n                frappe.log(\"=\" * 60)\r\n                frappe.log(f\"Sales Order: {so.name}\")\r\n                \r\n                frappe.msgprint(\"Sales Order created successfully: \" + so.name)\r\n        else:\r\n            frappe.log(\"âœ— Parameter is not TRUE - SKIPPED\")\r\n            frappe.log(f\"  Company: {supplier_company}\")\r\n            frappe.log(f\"  Parameter Value: {param_value}\")\r\n\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-23 15:52:31.934017",
  "module": "galaxynext",
  "name": "auto create work order",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Order",
  "script": "# try:\r\n#     work_orders_created = []\r\n\r\n#     # ----- Company defaults -----\r\n#     company_name = doc.get(\"company\")\r\n#     if not company_name:\r\n#         frappe.throw(\"Sales Order Company not set.\")\r\n\r\n#     # Get default warehouses - search for WIP warehouse by name pattern\r\n#     default_wip_warehouse = \"\"\r\n#     default_fg_warehouse = \"\"\r\n#     default_source_warehouse = \"\"\r\n    \r\n#     # Try to find WIP warehouse for this company\r\n#     try:\r\n#         wip_warehouses = frappe.get_all(\r\n#             \"Warehouse\",\r\n#             filters={\r\n#                 \"company\": company_name,\r\n#                 \"is_group\": 0,\r\n#                 \"disabled\": 0\r\n#             },\r\n#             fields=[\"name\"],\r\n#             or_filters=[\r\n#                 {\"warehouse_name\": [\"like\", \"%Work In Progress%\"]},\r\n#                 {\"warehouse_name\": [\"like\", \"%WIP%\"]},\r\n#                 {\"name\": [\"like\", \"%Work In Progress%\"]},\r\n#                 {\"name\": [\"like\", \"%WIP%\"]}\r\n#             ],\r\n#             limit=1\r\n#         )\r\n#         if wip_warehouses:\r\n#             default_wip_warehouse = wip_warehouses[0].name\r\n#     except:\r\n#         pass\r\n    \r\n#     # Try to find Finished Goods warehouse\r\n#     try:\r\n#         fg_warehouses = frappe.get_all(\r\n#             \"Warehouse\",\r\n#             filters={\r\n#                 \"company\": company_name,\r\n#                 \"is_group\": 0,\r\n#                 \"disabled\": 0\r\n#             },\r\n#             fields=[\"name\"],\r\n#             or_filters=[\r\n#                 {\"warehouse_name\": [\"like\", \"%Finished Goods%\"]},\r\n#                 {\"warehouse_name\": [\"like\", \"%FG%\"]},\r\n#                 {\"name\": [\"like\", \"%Finished Goods%\"]},\r\n#                 {\"warehouse_name\": [\"like\", \"%Finish%\"]}\r\n#             ],\r\n#             limit=1\r\n#         )\r\n#         if fg_warehouses:\r\n#             default_fg_warehouse = fg_warehouses[0].name\r\n#     except:\r\n#         pass\r\n    \r\n#     # Try to find Stores/Raw Material warehouse\r\n#     try:\r\n#         source_warehouses = frappe.get_all(\r\n#             \"Warehouse\",\r\n#             filters={\r\n#                 \"company\": company_name,\r\n#                 \"is_group\": 0,\r\n#                 \"disabled\": 0\r\n#             },\r\n#             fields=[\"name\"],\r\n#             or_filters=[\r\n#                 {\"warehouse_name\": [\"like\", \"%Stores%\"]},\r\n#                 {\"warehouse_name\": [\"like\", \"%Raw Material%\"]},\r\n#                 {\"name\": [\"like\", \"%Stores%\"]},\r\n#                 {\"name\": [\"like\", \"%Raw%\"]}\r\n#             ],\r\n#             limit=1\r\n#         )\r\n#         if source_warehouses:\r\n#             default_source_warehouse = source_warehouses[0].name\r\n#     except:\r\n#         pass\r\n\r\n#     # ----- Loop through Sales Order items -----\r\n#     for so_item in doc.get(\"items\") or []:\r\n#         bom_no = so_item.get(\"bom_no\") or so_item.get(\"bom\") or so_item.get(\"custom_bom\")\r\n#         if not bom_no:\r\n#             continue\r\n\r\n#         # Fetch BOM doc\r\n#         try:\r\n#             bom_doc = frappe.get_doc(\"BOM\", bom_no)\r\n#         except Exception as bom_err:\r\n#             frappe.log_error(message=f\"BOM not found: {bom_no} for SO {doc.name}\", title=\"Auto WO Error\")\r\n#             continue\r\n\r\n#         # Create Work Order\r\n#         wo = frappe.get_doc({\r\n#             \"doctype\": \"Work Order\",\r\n#             \"company\": company_name,\r\n#             \"production_item\": so_item.get(\"item_code\"),\r\n#             \"item_name\": so_item.get(\"item_name\"),\r\n#             \"description\": so_item.get(\"description\"),\r\n#             \"qty\": so_item.get(\"qty\") or 0,\r\n#             \"bom_no\": bom_no,\r\n#             \"sales_order\": doc.name,\r\n#             \"sales_order_item\": so_item.get(\"name\"),\r\n#             \"fg_warehouse\": so_item.get(\"warehouse\") or default_fg_warehouse,\r\n#             \"wip_warehouse\": default_wip_warehouse,\r\n#             \"source_warehouse\": default_source_warehouse,\r\n#             \"use_multi_level_bom\": 1,\r\n#             \"skip_transfer\": 0,\r\n#             \"transfer_material_against\": \"Work Order\",\r\n#             \"expected_delivery_date\": so_item.get(\"delivery_date\") or doc.get(\"delivery_date\"),\r\n#             \"project\": doc.get(\"project\")\r\n#         })\r\n\r\n#         # ----- Append Required Items -----\r\n#         for b_item in bom_doc.get(\"items\") or []:\r\n#             required_qty = (b_item.get(\"qty\") or 0) * (so_item.get(\"qty\") or 0)\r\n#             wo.append(\"required_items\", {\r\n#                 \"item_code\": b_item.get(\"item_code\"),\r\n#                 \"item_name\": b_item.get(\"item_name\"),\r\n#                 \"description\": b_item.get(\"description\"),\r\n#                 \"required_qty\": required_qty,\r\n#                 \"source_warehouse\": b_item.get(\"source_warehouse\") or default_source_warehouse,\r\n#                 \"rate\": b_item.get(\"rate\") or 0,\r\n#                 \"amount\": (b_item.get(\"rate\") or 0) * required_qty\r\n#             })\r\n\r\n#         # ----- Append Operations with correct BOM mapping -----\r\n#         if bom_doc.get(\"with_operations\") and bom_doc.get(\"operations\"):\r\n#             for op in bom_doc.get(\"operations\"):\r\n#                 wo.append(\"operations\", {\r\n#                     \"operation\": op.get(\"operation\"),\r\n#                     \"bom\": bom_no,  # BOM field - link to main BOM\r\n#                     \"bom_operation\": op.get(\"name\"),  # Link to specific BOM operation row\r\n#                     \"description\": op.get(\"description\"),\r\n#                     \"workstation\": op.get(\"workstation\"),\r\n#                     \"workstation_type\": op.get(\"workstation_type\"),\r\n#                     \"time_in_mins\": op.get(\"time_in_mins\") or 0,\r\n#                     \"operating_cost\": op.get(\"operating_cost\") or 0,\r\n#                     \"hour_rate\": op.get(\"hour_rate\") or 0,\r\n#                     \"batch_size\": op.get(\"batch_size\") or 1,\r\n#                     \"sequence_id\": op.get(\"sequence_id\") or op.get(\"idx\"),\r\n#                     \"status\": \"Pending\",\r\n#                     \"completed_qty\": 0\r\n#                 })\r\n\r\n#         # ----- Insert Work Order -----\r\n#         try:\r\n#             wo.insert(ignore_permissions=True)\r\n#             work_orders_created.append(wo.name)\r\n            \r\n#             # Auto-submit the Work Order\r\n#             wo.submit()\r\n            \r\n#         except Exception as ins_err:\r\n#             frappe.log_error(\r\n#                 message=f\"Failed to insert WO for SO {doc.name}, item {so_item.get('item_code')}: {str(ins_err)}\", \r\n#                 title=\"Auto WO Insert Error\"\r\n#             )\r\n\r\n#     # ----- Show success message -----\r\n#     if work_orders_created:\r\n#         frappe.msgprint(f\"âœ“ Work Orders Created: {', '.join(work_orders_created)}\")\r\n\r\n# except Exception as e:\r\n#     frappe.log_error(message=str(e), title=\"Work Order Auto Creation Error\")\r\n#     frappe.throw(f\"Error creating Work Order: {str(e)}\")\r\n\r\n\r\n\r\n\r\n\r\ntry:\r\n    work_orders_created = []\r\n\r\n    # -----------------------------------------------------------\r\n    # 1ï¸âƒ£ Get Company and Validate\r\n    # -----------------------------------------------------------\r\n    company_name = doc.get(\"company\")\r\n    if not company_name:\r\n        frappe.throw(\"Sales Order Company not set.\")\r\n\r\n    # -----------------------------------------------------------\r\n    # 2ï¸âƒ£ Detect Company-wise Default Warehouses Automatically\r\n    #    (Search based on warehouse name patterns)\r\n    # -----------------------------------------------------------\r\n    default_wip_warehouse = \"\"\r\n    default_fg_warehouse = \"\"\r\n    default_source_warehouse = \"\"\r\n    \r\n    # ----- Auto-detect WIP (Work In Progress) Warehouse -----\r\n    try:\r\n        wip_warehouses = frappe.get_all(\r\n            \"Warehouse\",\r\n            filters={\r\n                \"company\": company_name,\r\n                \"is_group\": 0,\r\n                \"disabled\": 0\r\n            },\r\n            fields=[\"name\"],\r\n            or_filters=[\r\n                {\"warehouse_name\": [\"like\", \"%Work In Progress%\"]},\r\n                {\"warehouse_name\": [\"like\", \"%WIP%\"]},\r\n                {\"name\": [\"like\", \"%Work In Progress%\"]},\r\n                {\"name\": [\"like\", \"%WIP%\"]}\r\n            ],\r\n            limit=1\r\n        )\r\n        if wip_warehouses:\r\n            default_wip_warehouse = wip_warehouses[0].name\r\n    except:\r\n        pass\r\n    \r\n    # ----- Auto-detect Finished Goods Warehouse -----\r\n    try:\r\n        fg_warehouses = frappe.get_all(\r\n            \"Warehouse\",\r\n            filters={\r\n                \"company\": company_name,\r\n                \"is_group\": 0,\r\n                \"disabled\": 0\r\n            },\r\n            fields=[\"name\"],\r\n            or_filters=[\r\n                {\"warehouse_name\": [\"like\", \"%Finished Goods%\"]},\r\n                {\"warehouse_name\": [\"like\", \"%FG%\"]},\r\n                {\"name\": [\"like\", \"%Finished Goods%\"]},\r\n                {\"warehouse_name\": [\"like\", \"%Finish%\"]}\r\n            ],\r\n            limit=1\r\n        )\r\n        if fg_warehouses:\r\n            default_fg_warehouse = fg_warehouses[0].name\r\n    except:\r\n        pass\r\n    \r\n    # ----- Auto-detect Source / Raw Material Warehouse -----\r\n    try:\r\n        source_warehouses = frappe.get_all(\r\n            \"Warehouse\",\r\n            filters={\r\n                \"company\": company_name,\r\n                \"is_group\": 0,\r\n                \"disabled\": 0\r\n            },\r\n            fields=[\"name\"],\r\n            or_filters=[\r\n                {\"warehouse_name\": [\"like\", \"%Stores%\"]},\r\n                {\"warehouse_name\": [\"like\", \"%Raw Material%\"]},\r\n                {\"name\": [\"like\", \"%Stores%\"]},\r\n                {\"name\": [\"like\", \"%Raw%\"]}\r\n            ],\r\n            limit=1\r\n        )\r\n        if source_warehouses:\r\n            default_source_warehouse = source_warehouses[0].name\r\n    except:\r\n        pass\r\n\r\n    # -----------------------------------------------------------\r\n    # 3ï¸âƒ£ Loop through Sales Order Items\r\n    # -----------------------------------------------------------\r\n    for so_item in doc.get(\"items\") or []:\r\n\r\n        # Fetch BOM from different possible fields\r\n        bom_no = so_item.get(\"bom_no\") or so_item.get(\"bom\") or so_item.get(\"custom_bom\")\r\n        if not bom_no:\r\n            continue\r\n\r\n        # Fetch BOM document safely\r\n        try:\r\n            bom_doc = frappe.get_doc(\"BOM\", bom_no)\r\n        except Exception as bom_err:\r\n            frappe.log_error(message=f\"BOM not found: {bom_no} for SO {doc.name}\", title=\"Auto WO Error\")\r\n            continue\r\n\r\n        # -----------------------------------------------------------\r\n        # 4ï¸âƒ£ Create new Work Order\r\n        # -----------------------------------------------------------\r\n        wo = frappe.get_doc({\r\n            \"doctype\": \"Work Order\",\r\n            \"company\": company_name,\r\n\r\n            # Production details\r\n            \"production_item\": so_item.get(\"item_code\"),\r\n            \"item_name\": so_item.get(\"item_name\"),\r\n            \"description\": so_item.get(\"description\"),\r\n            \"qty\": so_item.get(\"qty\") or 0,\r\n            \"bom_no\": bom_no,\r\n\r\n            # Linking to Sales Order\r\n            \"sales_order\": doc.name,\r\n            \"sales_order_item\": so_item.get(\"name\"),\r\n\r\n            # Auto-set warehouses\r\n            \"fg_warehouse\": so_item.get(\"warehouse\") or default_fg_warehouse,\r\n            \"wip_warehouse\": default_wip_warehouse,\r\n            \"source_warehouse\": default_source_warehouse,\r\n\r\n            # Configuration\r\n            \"use_multi_level_bom\": 1,\r\n            \"skip_transfer\": 0,\r\n            \"transfer_material_against\": \"Work Order\",\r\n\r\n            # Dates\r\n            \"expected_delivery_date\": so_item.get(\"delivery_date\") or doc.get(\"delivery_date\"),\r\n            \"project\": doc.get(\"project\")\r\n        })\r\n\r\n        # -----------------------------------------------------------\r\n        # 5ï¸âƒ£ Add Required Items (Raw Materials)\r\n        # -----------------------------------------------------------\r\n        for b_item in bom_doc.get(\"items\") or []:\r\n            required_qty = (b_item.get(\"qty\") or 0) * (so_item.get(\"qty\") or 0)\r\n            \r\n            wo.append(\"required_items\", {\r\n                \"item_code\": b_item.get(\"item_code\"),\r\n                \"item_name\": b_item.get(\"item_name\"),\r\n                \"description\": b_item.get(\"description\"),\r\n                \"required_qty\": required_qty,\r\n                \"source_warehouse\": b_item.get(\"source_warehouse\") or default_source_warehouse,\r\n                \"rate\": b_item.get(\"rate\") or 0,\r\n                \"amount\": (b_item.get(\"rate\") or 0) * required_qty\r\n            })\r\n\r\n        # -----------------------------------------------------------\r\n        # 6ï¸âƒ£ Add Operations from BOM\r\n        # -----------------------------------------------------------\r\n        if bom_doc.get(\"with_operations\") and bom_doc.get(\"operations\"):\r\n            for op in bom_doc.get(\"operations\"):\r\n                wo.append(\"operations\", {\r\n                    \"operation\": op.get(\"operation\"),\r\n                    \"bom\": bom_no,                  # Link to main BOM\r\n                    \"bom_operation\": op.get(\"name\"),  # Link to BOM Operation row\r\n                    \"description\": op.get(\"description\"),\r\n                    \"workstation\": op.get(\"workstation\"),\r\n                    \"workstation_type\": op.get(\"workstation_type\"),\r\n                    \"time_in_mins\": op.get(\"time_in_mins\") or 0,\r\n                    \"operating_cost\": op.get(\"operating_cost\") or 0,\r\n                    \"hour_rate\": op.get(\"hour_rate\") or 0,\r\n                    \"batch_size\": op.get(\"batch_size\") or 1,\r\n                    \"sequence_id\": op.get(\"sequence_id\") or op.get(\"idx\"),\r\n                    \"status\": \"Pending\",\r\n                    \"completed_qty\": 0\r\n                })\r\n\r\n        # -----------------------------------------------------------\r\n        # 7ï¸âƒ£ Insert and Auto-submit Work Order\r\n        # -----------------------------------------------------------\r\n        try:\r\n            wo.insert(ignore_permissions=True)\r\n            work_orders_created.append(wo.name)\r\n\r\n            # Auto-submit Work Order\r\n            wo.submit()\r\n\r\n        except Exception as ins_err:\r\n            frappe.log_error(\r\n                message=f\"Failed to insert WO for SO {doc.name}, item {so_item.get('item_code')}: {str(ins_err)}\", \r\n                title=\"Auto WO Insert Error\"\r\n            )\r\n\r\n    # -----------------------------------------------------------\r\n    # 8ï¸âƒ£ Success Message\r\n    # -----------------------------------------------------------\r\n    if work_orders_created:\r\n        frappe.msgprint(f\"âœ“ Work Orders Created: {', '.join(work_orders_created)}\")\r\n\r\nexcept Exception as e:\r\n    frappe.log_error(message=str(e), title=\"Work Order Auto Creation Error\")\r\n    frappe.throw(f\"Error creating Work Order: {str(e)}\")\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-24 14:35:36.064260",
  "module": null,
  "name": "Stock Effect",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Job Inward_In-House Job",
  "script": "\r\n\r\n\r\n# Helper: Get leaf warehouse if given is group\r\ndef get_leaf_warehouse(warehouse):\r\n    if frappe.db.get_value(\"Warehouse\", warehouse, \"is_group\"):\r\n        child = frappe.db.get_value(\r\n            \"Warehouse\",\r\n            {\"parent_warehouse\": warehouse, \"is_group\": 0},\r\n            \"name\"\r\n        )\r\n        return child\r\n    return warehouse\r\n\r\n\r\n# Main logic\r\nif not doc.get(\"stock_entry_ref\"):\r\n    try:\r\n        frappe.msgprint(\"ðŸš€ Creating Stock Entry...\")\r\n\r\n        se = frappe.new_doc(\"Stock Entry\")\r\n        se.stock_entry_type = \"Material Receipt\"\r\n        se.purpose = \"Material Receipt\"\r\n        se.company = doc.company or frappe.defaults.get_default(\"company\")\r\n        se.posting_date = doc.get(\"inward_date\") or frappe.utils.nowdate()\r\n\r\n        # Main warehouse (if present in parent)\r\n        se.to_warehouse = get_leaf_warehouse(doc.get(\"warehouse_name\")) if doc.get(\"warehouse_name\") else None\r\n        se.set(\"items\", [])\r\n\r\n        for row in doc.get(\"table_duni\") or []:\r\n            total_qty = frappe.utils.flt(row.get(\"total_quantity\") or row.get(\"total_quant\") or 0)\r\n\r\n            # ðŸ”¥ Main PCS from Job Inward (actual PCS)\r\n            main_pcs = int(row.get(\"total_pcs\") or 1)\r\n\r\n            # ðŸ”¥ Stock Entry me hamesha PCS = 1 hoga\r\n            stock_entry_pcs = 1\r\n\r\n            item_code = row.get(\"product_name\") or row.get(\"item_code\")\r\n            warehouse = get_leaf_warehouse(row.get(\"warehouse_name\")) if row.get(\"warehouse_name\") else None\r\n            uom = row.get(\"unit\") or row.get(\"uom\") or \"\"\r\n            basic_rate = frappe.utils.flt(row.get(\"rate\") or 0)\r\n\r\n            # Product name for identifying detail rows\r\n            product_name = f\"{row.get('product_type') or ''} - {item_code}\"\r\n\r\n            # Find matching sub-rows\r\n            matching_sub_rows = []\r\n            for r in (doc.get(\"job_inward_item_detail\") or []):\r\n                if r.get(\"reference_item\") == product_name:\r\n                    matching_sub_rows.append(r)\r\n\r\n            # Case 1: Sub-rows found â†’ use their qty exactly\r\n            if matching_sub_rows:\r\n                for sub in matching_sub_rows:\r\n                    qty = frappe.utils.flt(sub.get(\"quantity\") or 0)\r\n\r\n                    se.append(\"items\", {\r\n                        \"item_code\": item_code,\r\n                        \"item_name\": item_code,\r\n                        \"description\": f\"{row.get('product_type') or ''} - {item_code} - {sub.get('sub_item') or ''}\",\r\n                        \"qty\": qty,\r\n                        \"uom\": sub.get(\"uom\") or uom,\r\n                        \"basic_rate\": basic_rate,\r\n                        \"t_warehouse\": warehouse,\r\n\r\n                        # â­ Always 1 PCS in Stock Entry\r\n                        \"pcs\": 1\r\n                    })\r\n\r\n                    frappe.msgprint(f\"âœ… Sub Row Added (PCS=1): {item_code} | Qty: {qty}\")\r\n\r\n            # Case 2: No sub-rows â†’ fallback to split using main PCS\r\n            else:\r\n                qty_per_piece = total_qty / main_pcs if main_pcs > 0 else total_qty\r\n\r\n                for i in range(main_pcs):\r\n                    se.append(\"items\", {\r\n                        \"item_code\": item_code,\r\n                        \"item_name\": item_code,\r\n                        \"description\": f\"{row.get('product_type') or ''} - {item_code} - Piece {i+1}\",\r\n                        \"qty\": qty_per_piece,\r\n                        \"uom\": uom,\r\n                        \"basic_rate\": basic_rate,\r\n                        \"t_warehouse\": warehouse,\r\n\r\n                        # â­ Always 1 PCS in Stock Entry\r\n                        \"pcs\": 1\r\n                    })\r\n\r\n                frappe.msgprint(f\"âœ… Fallback Split: {item_code} | Qty per piece: {qty_per_piece}\")\r\n\r\n        # Save and Submit Stock Entry\r\n        frappe.msgprint(\"ðŸ‘‰ Inserting Stock Entry...\")\r\n        se.insert()\r\n\r\n        frappe.msgprint(\"ðŸ‘‰ Submitting Stock Entry...\")\r\n        se.submit()\r\n\r\n        frappe.msgprint(f\"ðŸŽ‰ Stock Entry Created: {se.name}\")\r\n\r\n        # Link back to Job Inward\r\n        frappe.db.set_value(doc.doctype, doc.name, \"stock_entry_ref\", se.name, update_modified=False)\r\n\r\n        # --- Batch Update Logic ---\r\n        job_inward_no = doc.get(\"jobinward_no\")\r\n        if job_inward_no:\r\n            sle_list = frappe.get_all(\r\n                \"Stock Ledger Entry\",\r\n                filters={\"voucher_no\": se.name},\r\n                fields=[\"name\"]\r\n            )\r\n            for sle in sle_list:\r\n                frappe.db.set_value(\"Stock Ledger Entry\", sle.name, \"batch_no\", job_inward_no)\r\n\r\n    except Exception as e:\r\n        frappe.log_error(message=str(e), title=\"Job Inward -> create Stock Entry error\")\r\n        frappe.msgprint(f\"âŒ Error: {str(e)}\")\r\n        raise\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Cancel",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-24 12:25:22.692963",
  "module": "galaxynext",
  "name": "Cancel Stock Entry on Job Inward Cancel",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Job Inward_In-House Job",
  "script": "ste = (doc.stock_entry_ref or \"\").strip()\r\n\r\nif ste:\r\n    try:\r\n        # 1) First clear link from Job Inward\r\n        frappe.db.set_value(doc.doctype, doc.name, \"stock_entry_ref\", \"\")\r\n        doc.stock_entry_ref = \"\"\r\n\r\n        # 2) Load Stock Entry\r\n        se = frappe.get_doc(\"Stock Entry\", ste)\r\n\r\n        # 3) If submitted, cancel first\r\n        if se.docstatus == 1:\r\n            se.cancel()\r\n\r\n        # 4) Now force delete ignoring links\r\n        se.delete(force=True, ignore_permissions=True, delete_permanently=True)\r\n\r\n        frappe.msgprint(f\"Stock Entry {ste} cancelled and hard-deleted.\")\r\n\r\n    except Exception as e:\r\n        frappe.throw(f\"Error while deleting Stock Entry {ste}: {e}\")\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Cancel",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-24 12:25:54.823921",
  "module": "galaxynext",
  "name": "for stock",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Job Inward_In-House Job",
  "script": "# Job Inward -> Cancel linked Stock Entry and clean SLE\r\nif doc.stock_entry_ref:\r\n    try:\r\n        se = frappe.get_doc(\"Stock Entry\", doc.stock_entry_ref)\r\n\r\n        # 1. If submitted, cancel first\r\n        if se.docstatus == 1:\r\n            se.cancel()\r\n            frappe.db.commit()\r\n\r\n        # 2. Delete related Stock Ledger Entries\r\n        frappe.db.sql(\"\"\"\r\n            DELETE FROM `tabStock Ledger Entry` \r\n            WHERE voucher_no = %s\r\n        \"\"\", se.name)\r\n\r\n        # 3. Delete Stock Entry itself (force delete)\r\n        frappe.delete_doc(\"Stock Entry\", se.name, force=1, ignore_permissions=True)\r\n\r\n        # 4. Unlink from Job Inward\r\n        frappe.db.set_value(doc.doctype, doc.name, \"stock_entry_ref\", None, update_modified=False)\r\n\r\n        frappe.db.commit()\r\n\r\n    except Exception as e:\r\n        frappe.log_error(message=str(e), title=\"Job Inward -> Cancel/Delete Stock Entry\")\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-29 14:56:32.964094",
  "module": "galaxynext",
  "name": "job Inward Auto Work Order Creation",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Job Inward_In-House Job",
  "script": "# try:\r\n#     work_orders_created = []\r\n#     proceed = True\r\n\r\n#     # -----------------------------------------------------------\r\n#     # Get Company\r\n#     # -----------------------------------------------------------\r\n#     company_name = doc.get(\"company\")\r\n#     if not company_name:\r\n#         frappe.throw(\"Company not set in Job Inward.\")\r\n\r\n#     # -----------------------------------------------------------\r\n#     # Auto-detect Warehouses\r\n#     # -----------------------------------------------------------\r\n#     default_wip_warehouse = \"\"\r\n#     default_fg_warehouse = \"\"\r\n#     default_source_warehouse = \"\"\r\n\r\n#     wip_warehouses = frappe.get_all(\r\n#         \"Warehouse\",\r\n#         filters={\"company\": company_name, \"is_group\": 0, \"disabled\": 0},\r\n#         fields=[\"name\"],\r\n#         or_filters=[\r\n#             {\"warehouse_name\": [\"like\", \"%Work In Progress%\"]},\r\n#             {\"warehouse_name\": [\"like\", \"%WIP%\"]}\r\n#         ],\r\n#         limit=1\r\n#     )\r\n#     if wip_warehouses:\r\n#         default_wip_warehouse = wip_warehouses[0].name\r\n\r\n#     fg_warehouses = frappe.get_all(\r\n#         \"Warehouse\",\r\n#         filters={\"company\": company_name, \"is_group\": 0, \"disabled\": 0},\r\n#         fields=[\"name\"],\r\n#         or_filters=[\r\n#             {\"warehouse_name\": [\"like\", \"%Finished Goods%\"]},\r\n#             {\"warehouse_name\": [\"like\", \"%FG%\"]}\r\n#         ],\r\n#         limit=1\r\n#     )\r\n#     if fg_warehouses:\r\n#         default_fg_warehouse = fg_warehouses[0].name\r\n\r\n#     source_warehouses = frappe.get_all(\r\n#         \"Warehouse\",\r\n#         filters={\"company\": company_name, \"is_group\": 0, \"disabled\": 0},\r\n#         fields=[\"name\"],\r\n#         or_filters=[\r\n#             {\"warehouse_name\": [\"like\", \"%Stores%\"]},\r\n#             {\"warehouse_name\": [\"like\", \"%Raw%\"]}\r\n#         ],\r\n#         limit=1\r\n#     )\r\n#     if source_warehouses:\r\n#         default_source_warehouse = source_warehouses[0].name\r\n\r\n#     # -----------------------------------------------------------\r\n#     # Get Subcontracting Order\r\n#     # -----------------------------------------------------------\r\n#     dyeing_program = doc.get(\"subcontracting_order\")\r\n#     if not dyeing_program:\r\n#         frappe.msgprint(\"Dyeing Program Number not found.\")\r\n#         proceed = False\r\n\r\n#     if proceed:\r\n#         try:\r\n#             sub_order = frappe.get_doc(\"Subcontracting Order\", dyeing_program)\r\n#         except Exception as sub_err:\r\n#             frappe.log_error(str(sub_err), \"Subcontracting Order Not Found\")\r\n#             frappe.msgprint(\"Subcontracting Order not found: \" + dyeing_program)\r\n#             proceed = False\r\n\r\n#     # -----------------------------------------------------------\r\n#     # Loop Job Inward Items\r\n#     # -----------------------------------------------------------\r\n#     if proceed:\r\n#         for job_item in doc.get(\"table_duni\") or []:\r\n\r\n#             product_name = job_item.get(\"product_name\")\r\n#             total_quantity = job_item.get(\"total_quantity\") or 0\r\n#             warehouse = job_item.get(\"warehouse_name\")\r\n\r\n#             if not product_name or total_quantity <= 0:\r\n#                 continue\r\n\r\n#             # Find BOM from Subcontracting Order\r\n#             bom_no = None\r\n#             for sub_item in sub_order.get(\"items\") or []:\r\n#                 if sub_item.get(\"item_code\") == product_name:\r\n#                     bom_no = sub_item.get(\"bom\")\r\n#                     break\r\n\r\n#             if not bom_no:\r\n#                 frappe.msgprint(\"BOM not found for item: \" + product_name)\r\n#                 continue\r\n\r\n#             bom_doc = frappe.get_doc(\"BOM\", bom_no)\r\n\r\n#             # ---------------------------------------------------\r\n#             # Create Work Order\r\n#             # ---------------------------------------------------\r\n#             wo = frappe.get_doc({\r\n#                 \"doctype\": \"Work Order\",\r\n#                 \"company\": company_name,\r\n#                 \"production_item\": product_name,\r\n#                 \"qty\": total_quantity,\r\n#                 \"bom_no\": bom_no,\r\n#                 \"fg_warehouse\": warehouse or default_fg_warehouse,\r\n#                 \"wip_warehouse\": default_wip_warehouse,\r\n#                 \"source_warehouse\": default_source_warehouse,\r\n#                 \"use_multi_level_bom\": 1,\r\n#                 \"transfer_material_against\": \"Work Order\",\r\n#                 \"planned_start_date\": doc.get(\"inward_date\"),\r\n#                 \"expected_delivery_date\": doc.get(\"inward_date\"),\r\n#                 \"remarks\": \"Auto-created from Job Inward: \" + doc.name\r\n#             })\r\n\r\n#             # Required Items\r\n#             for b_item in bom_doc.items:\r\n#                 wo.append(\"required_items\", {\r\n#                     \"item_code\": b_item.item_code,\r\n#                     \"required_qty\": b_item.qty * total_quantity,\r\n#                     \"source_warehouse\": b_item.source_warehouse or default_source_warehouse\r\n#                 })\r\n\r\n#             # Operations\r\n#             if bom_doc.with_operations:\r\n#                 for op in bom_doc.operations:\r\n#                     wo.append(\"operations\", {\r\n#                         \"operation\": op.operation,\r\n#                         \"workstation\": op.workstation,\r\n#                         \"time_in_mins\": op.time_in_mins,\r\n#                         \"sequence_id\": op.idx\r\n#                     })\r\n\r\n#             # Insert & Submit\r\n#             wo.insert(ignore_permissions=True)\r\n#             wo.submit()\r\n#             work_orders_created.append(wo.name)\r\n\r\n#     # -----------------------------------------------------------\r\n#     # Success Message\r\n#     # -----------------------------------------------------------\r\n#     if work_orders_created:\r\n#         frappe.msgprint(\"Work Orders Created: \" + \", \".join(work_orders_created))\r\n#     else:\r\n#         frappe.msgprint(\"No Work Orders created.\")\r\n\r\n# except Exception as e:\r\n#     frappe.log_error(str(e), \"Job Inward Auto WO Error\")\r\n#     frappe.throw(\"Error creating Work Order: \" + str(e))\r\n\r\n\r\n\r\n# # ============================================================\r\n# # AUTO CREATE WORK ORDER FROM JOB INWARD (IN-HOUSE)\r\n# # SAFE EXEC COMPATIBLE VERSION\r\n# # ============================================================\r\n\r\n# try:\r\n#     work_orders_created = []\r\n\r\n#     # -----------------------------------------------------------\r\n#     # 1ï¸âƒ£ Company Validation\r\n#     # -----------------------------------------------------------\r\n#     company = doc.company\r\n#     frappe.log_error(f\"Company => {company}\", \"DEBUG-JOB-INWARD\")\r\n\r\n#     if not company:\r\n#         frappe.throw(\"Company not set in Job Inward.\")\r\n\r\n#     # -----------------------------------------------------------\r\n#     # 2ï¸âƒ£ Warehouse Finder\r\n#     # -----------------------------------------------------------\r\n#     def get_warehouse(company, like_list):\r\n#         wh = frappe.get_all(\r\n#             \"Warehouse\",\r\n#             filters={\r\n#                 \"company\": company,\r\n#                 \"is_group\": 0,\r\n#                 \"disabled\": 0\r\n#             },\r\n#             or_filters=like_list,\r\n#             fields=[\"name\"],\r\n#             limit=1\r\n#         )\r\n#         return wh[0].name if wh else None\r\n\r\n#     # ---------------- WIP (MANDATORY) ----------------\r\n#     wip_warehouse = get_warehouse(company, [\r\n#         {\"warehouse_name\": [\"like\", \"%WIP%\"]},\r\n#         {\"warehouse_name\": [\"like\", \"%Work In Progress%\"]},\r\n#         {\"name\": [\"like\", \"%WIP%\"]}\r\n#     ])\r\n\r\n#     if not wip_warehouse:\r\n#         frappe.throw(\"Work-in-Progress Warehouse not found for this Company\")\r\n\r\n#     # ---------------- FG ----------------\r\n#     fg_warehouse = get_warehouse(company, [\r\n#         {\"warehouse_name\": [\"like\", \"%Finished%\"]},\r\n#         {\"warehouse_name\": [\"like\", \"%FG%\"]}\r\n#     ])\r\n\r\n#     # ---------------- SOURCE ----------------\r\n#     source_warehouse = get_warehouse(company, [\r\n#         {\"warehouse_name\": [\"like\", \"%Store%\"]},\r\n#         {\"warehouse_name\": [\"like\", \"%Raw%\"]}\r\n#     ])\r\n\r\n#     frappe.log_error(\r\n#         f\"FG={fg_warehouse}, WIP={wip_warehouse}, SOURCE={source_warehouse}\",\r\n#         \"DEBUG-WAREHOUSE\"\r\n#     )\r\n\r\n#     # -----------------------------------------------------------\r\n#     # 3ï¸âƒ£ Loop Job Inward Items\r\n#     # -----------------------------------------------------------\r\n#     for row in doc.get(\"table_duni\") or []:\r\n\r\n#         item_code = row.product_name\r\n#         qty = row.total_quantity or 0\r\n#         fg_wh = row.warehouse_name or fg_warehouse\r\n#         bom_no = row.bom or row.bom_no\r\n\r\n#         if not item_code or qty <= 0:\r\n#             continue\r\n\r\n#         if not bom_no or not frappe.db.exists(\"BOM\", bom_no):\r\n#             continue\r\n\r\n#         bom_doc = frappe.get_doc(\"BOM\", bom_no)\r\n#         if not bom_doc.is_active:\r\n#             continue\r\n\r\n#         # -------------------------------------------------------\r\n#         # 4ï¸âƒ£ Create Work Order\r\n#         # -------------------------------------------------------\r\n#         wo = frappe.new_doc(\"Work Order\")\r\n#         wo.company = company\r\n#         wo.production_item = item_code\r\n#         wo.qty = qty\r\n#         wo.bom_no = bom_no\r\n\r\n#         wo.fg_warehouse = fg_wh\r\n#         wo.wip_warehouse = wip_warehouse      # âœ… FIXED\r\n#         wo.source_warehouse = source_warehouse\r\n\r\n#         wo.use_multi_level_bom = 0\r\n#         wo.skip_transfer = 0\r\n#         wo.transfer_material_against = \"Work Order\"\r\n\r\n#         wo.planned_start_date = doc.challan_date or doc.inward_date\r\n#         wo.expected_delivery_date = doc.challan_date or doc.inward_date\r\n#         wo.remarks = f\"Auto-created from Job Inward {doc.name}\"\r\n\r\n#         # -------------------------------------------------------\r\n#         # 5ï¸âƒ£ Insert & Submit\r\n#         # -------------------------------------------------------\r\n#         wo.flags.ignore_validate = True\r\n#         wo.flags.ignore_mandatory = True\r\n#         wo.insert(ignore_permissions=True)\r\n#         wo.submit()\r\n\r\n#         work_orders_created.append(wo.name)\r\n\r\n#     # -----------------------------------------------------------\r\n#     # 6ï¸âƒ£ Final Message\r\n#     # -----------------------------------------------------------\r\n#     if work_orders_created:\r\n#         frappe.msgprint(\r\n#             f\"Work Orders Created:<br><b>{', '.join(work_orders_created)}</b>\",\r\n#             indicator=\"green\"\r\n#         )\r\n#     else:\r\n#         frappe.msgprint(\r\n#             \"No Work Orders created. Check Error Log.\",\r\n#             indicator=\"orange\"\r\n#         )\r\n\r\n# except Exception as e:\r\n#     frappe.log_error(frappe.get_traceback(), \"Job Inward Auto WO Error\")\r\n#     frappe.msgprint(str(e), indicator=\"red\")\r\n\r\n\r\n# -------------------------------------------------working code-----------------------------------------------------------------------\r\n\r\n# # ============================================================\r\n# # AUTO CREATE WORK ORDER FROM JOB INWARD (IN-HOUSE)\r\n# # FINAL WORKING VERSION - NO UNSAFE METHODS\r\n# # ============================================================\r\n\r\n# try:\r\n#     work_orders_created = []\r\n#     company = doc.company\r\n\r\n#     if not company:\r\n#         frappe.throw(\"Company not set in Job Inward.\")\r\n\r\n#     # -----------------------------------------------------------\r\n#     # Auto-detect Warehouses\r\n#     # -----------------------------------------------------------\r\n#     default_wip_warehouse = \"\"\r\n#     default_fg_warehouse = \"\"\r\n#     default_source_warehouse = \"\"\r\n    \r\n#     # Find WIP Warehouse\r\n#     try:\r\n#         wip_warehouses = frappe.get_all(\r\n#             \"Warehouse\",\r\n#             filters={\"company\": company, \"is_group\": 0, \"disabled\": 0},\r\n#             fields=[\"name\"],\r\n#             or_filters=[\r\n#                 {\"warehouse_name\": [\"like\", \"%Work In Progress%\"]},\r\n#                 {\"warehouse_name\": [\"like\", \"%WIP%\"]},\r\n#                 {\"name\": [\"like\", \"%Work In Progress%\"]},\r\n#                 {\"name\": [\"like\", \"%WIP%\"]}\r\n#             ],\r\n#             limit=1\r\n#         )\r\n#         if wip_warehouses:\r\n#             default_wip_warehouse = wip_warehouses[0].name\r\n#     except:\r\n#         pass\r\n    \r\n#     # Find FG Warehouse\r\n#     try:\r\n#         fg_warehouses = frappe.get_all(\r\n#             \"Warehouse\",\r\n#             filters={\"company\": company, \"is_group\": 0, \"disabled\": 0},\r\n#             fields=[\"name\"],\r\n#             or_filters=[\r\n#                 {\"warehouse_name\": [\"like\", \"%Finished Goods%\"]},\r\n#                 {\"warehouse_name\": [\"like\", \"%FG%\"]},\r\n#                 {\"warehouse_name\": [\"like\", \"%Finish%\"]},\r\n#                 {\"name\": [\"like\", \"%GERP WAREHOUSE%\"]}\r\n#             ],\r\n#             limit=1\r\n#         )\r\n#         if fg_warehouses:\r\n#             default_fg_warehouse = fg_warehouses[0].name\r\n#     except:\r\n#         pass\r\n    \r\n#     # Find Source Warehouse\r\n#     try:\r\n#         source_warehouses = frappe.get_all(\r\n#             \"Warehouse\",\r\n#             filters={\"company\": company, \"is_group\": 0, \"disabled\": 0},\r\n#             fields=[\"name\"],\r\n#             or_filters=[\r\n#                 {\"warehouse_name\": [\"like\", \"%Stores%\"]},\r\n#                 {\"warehouse_name\": [\"like\", \"%Raw Material%\"]},\r\n#                 {\"warehouse_name\": [\"like\", \"%store warehouse%\"]},\r\n#                 {\"name\": [\"like\", \"%Stores%\"]}\r\n#             ],\r\n#             limit=1\r\n#         )\r\n#         if source_warehouses:\r\n#             default_source_warehouse = source_warehouses[0].name\r\n#     except:\r\n#         pass\r\n\r\n#     # -----------------------------------------------------------\r\n#     # Loop Job Inward Items\r\n#     # -----------------------------------------------------------\r\n#     for row in doc.get(\"table_duni\") or []:\r\n\r\n#         item_code = row.product_name\r\n#         qty = row.total_quantity or 0\r\n#         fg_wh = row.warehouse_name or default_fg_warehouse\r\n#         bom_no = row.bom or row.bom_no\r\n\r\n#         if not item_code or qty <= 0:\r\n#             continue\r\n\r\n#         if not bom_no or not frappe.db.exists(\"BOM\", bom_no):\r\n#             continue\r\n\r\n#         # Load BOM Document\r\n#         bom_doc = frappe.get_doc(\"BOM\", bom_no)\r\n#         if not bom_doc.is_active:\r\n#             continue\r\n\r\n#         # -----------------------------------------------------------\r\n#         # Create Work Order\r\n#         # -----------------------------------------------------------\r\n#         wo = frappe.get_doc({\r\n#             \"doctype\": \"Work Order\",\r\n#             \"company\": company,\r\n#             \"production_item\": item_code,\r\n#             \"qty\": qty,\r\n#             \"bom_no\": bom_no,\r\n#             \"fg_warehouse\": fg_wh,\r\n#             \"wip_warehouse\": default_wip_warehouse,\r\n#             \"source_warehouse\": default_source_warehouse,\r\n#             \"use_multi_level_bom\": 1,\r\n#             \"skip_transfer\": 0,\r\n#             \"transfer_material_against\": \"Work Order\",\r\n#             \"expected_delivery_date\": doc.challan_date or doc.inward_date or frappe.utils.today(),\r\n#             \"planned_start_date\": doc.challan_date or doc.inward_date or frappe.utils.today()\r\n#         })\r\n\r\n#         # -----------------------------------------------------------\r\n#         # Add BOM Materials (Required Items)\r\n#         # -----------------------------------------------------------\r\n#         for bom_item in bom_doc.items or []:\r\n#             required_qty = (bom_item.qty or 0) * qty\r\n#             wo.append(\"required_items\", {\r\n#                 \"item_code\": bom_item.item_code,\r\n#                 \"item_name\": bom_item.item_name,\r\n#                 \"description\": bom_item.description,\r\n#                 \"required_qty\": required_qty,\r\n#                 \"source_warehouse\": bom_item.source_warehouse or default_source_warehouse,\r\n#                 \"rate\": bom_item.rate or 0,\r\n#                 \"amount\": (bom_item.rate or 0) * required_qty\r\n#             })\r\n\r\n#         # -----------------------------------------------------------\r\n#         # Add Operations from BOM\r\n#         # -----------------------------------------------------------\r\n#         if bom_doc.with_operations and bom_doc.operations:\r\n#             for op in bom_doc.operations:\r\n#                 wo.append(\"operations\", {\r\n#                     \"operation\": op.operation,\r\n#                     \"bom\": bom_no,\r\n#                     \"bom_operation\": op.name,\r\n#                     \"description\": op.description,\r\n#                     \"workstation\": op.workstation,\r\n#                     \"workstation_type\": op.workstation_type,\r\n#                     \"time_in_mins\": op.time_in_mins or 0,\r\n#                     \"operating_cost\": op.operating_cost or 0,\r\n#                     \"hour_rate\": op.hour_rate or 0,\r\n#                     \"batch_size\": op.batch_size or 1,\r\n#                     \"sequence_id\": op.sequence_id or op.idx,\r\n#                     \"status\": \"Pending\",\r\n#                     \"completed_qty\": 0\r\n#                 })\r\n\r\n#         # -----------------------------------------------------------\r\n#         # Insert and Try Submit\r\n#         # -----------------------------------------------------------\r\n#         try:\r\n#             wo.insert(ignore_permissions=True)\r\n#             work_orders_created.append(wo.name)\r\n            \r\n#             # Try to submit\r\n#             try:\r\n#                 wo.submit()\r\n#             except Exception as submit_err:\r\n#                 # Log submit error but don't fail the whole process\r\n#                 frappe.msgprint(\r\n#                     f\"Work Order {wo.name} created but could not be submitted.<br>Error: {str(submit_err)}\",\r\n#                     indicator=\"orange\"\r\n#                 )\r\n                \r\n#         except Exception as ins_err:\r\n#             frappe.msgprint(\r\n#                 f\"Failed to create Work Order for {item_code}: {str(ins_err)}\",\r\n#                 indicator=\"red\"\r\n#             )\r\n\r\n#     # -----------------------------------------------------------\r\n#     # Final Message\r\n#     # -----------------------------------------------------------\r\n#     if work_orders_created:\r\n#         frappe.msgprint(\r\n#             f\"Work Orders Created: <b>{', '.join(work_orders_created)}</b>\",\r\n#             indicator=\"green\"\r\n#         )\r\n\r\n# except Exception as e:\r\n#     frappe.msgprint(\r\n#         f\"Error: {str(e)}\",\r\n#         indicator=\"red\"\r\n#     )\r\n\r\n\r\n\r\n# -----------------------SALE ORDERNOT FOUND----------------------------------------------\r\n\r\n# ============================================================\r\n# AUTO CREATE WORK ORDER FROM JOB INWARD (IN-HOUSE)\r\n# WITH SALES ORDER LINKING & ITEM-BASED BOM FETCH\r\n# ============================================================\r\n\r\n# try:\r\n#     work_orders_created = []\r\n    \r\n#     frappe.log_error(\"=\" * 80, \"JOB INWARD START\")\r\n#     frappe.log_error(\"Job Inward: \" + str(doc.name), \"JOB INWARD INFO\")\r\n    \r\n#     company = doc.company\r\n#     frappe.log_error(\"Company: \" + str(company), \"COMPANY INFO\")\r\n\r\n#     if not company:\r\n#         frappe.throw(\"Company not set in Job Inward.\")\r\n\r\n#     # -----------------------------------------------------------\r\n#     # SALES ORDER LINKING - WITH DETAILED DEBUG\r\n#     # -----------------------------------------------------------\r\n#     dyeing_program_number = doc.subcontracting_order\r\n    \r\n#     frappe.log_error(\"Subcontracting Order: \" + str(dyeing_program_number or 'EMPTY'), \"SO DEBUG - VALUE\")\r\n    \r\n#     sales_order_name = None\r\n    \r\n#     if dyeing_program_number:\r\n#         try:\r\n#             # First list ALL Sales Orders to see what's available\r\n#             frappe.log_error(\"Fetching all Sales Orders for company...\", \"SO DEBUG - SEARCH\")\r\n            \r\n#             all_sales_orders = frappe.get_all(\r\n#                 \"Sales Order\",\r\n#                 filters={\r\n#                     \"company\": company,\r\n#                     \"docstatus\": 1\r\n#                 },\r\n#                 fields=[\"name\", \"po_no\"],\r\n#                 limit=20\r\n#             )\r\n            \r\n#             frappe.log_error(\"Total Sales Orders found: \" + str(len(all_sales_orders)), \"SO DEBUG - COUNT\")\r\n            \r\n#             # Log each Sales Order with its po_no value\r\n#             for so in all_sales_orders:\r\n#                 po_value = so.get('po_no')\r\n#                 if po_value:\r\n#                     frappe.log_error(\"  SO: \" + so.name + \" | PO No: \" + str(po_value), \"SO DEBUG - LIST\")\r\n#                 else:\r\n#                     frappe.log_error(\"  SO: \" + so.name + \" | PO No: BLANK\", \"SO DEBUG - LIST\")\r\n            \r\n#             # Now search for exact match using po_no field\r\n#             frappe.log_error(\"Searching for match with: \" + str(dyeing_program_number), \"SO DEBUG - MATCH\")\r\n            \r\n#             sales_orders = frappe.get_all(\r\n#                 \"Sales Order\",\r\n#                 filters={\r\n#                     \"po_no\": dyeing_program_number,\r\n#                     \"company\": company,\r\n#                     \"docstatus\": 1\r\n#                 },\r\n#                 fields=[\"name\", \"po_no\", \"transaction_date\"],\r\n#                 limit=5\r\n#             )\r\n            \r\n#             frappe.log_error(\"Matches Found: \" + str(len(sales_orders)), \"SO DEBUG - RESULT\")\r\n            \r\n#             if sales_orders:\r\n#                 sales_order_name = sales_orders[0].name\r\n#                 frappe.log_error(\"SUCCESS - Sales Order Found: \" + sales_order_name, \"SO DEBUG - SUCCESS\")\r\n#                 frappe.log_error(\"SO Date: \" + str(sales_orders[0].get('transaction_date')), \"SO DEBUG - SUCCESS\")\r\n                \r\n#                 if len(sales_orders) > 1:\r\n#                     frappe.log_error(\"Multiple Sales Orders found:\", \"SO DEBUG - MULTIPLE\")\r\n#                     for so in sales_orders:\r\n#                         frappe.log_error(\"  - \" + so.name, \"SO DEBUG - MULTIPLE\")\r\n#             else:\r\n#                 frappe.log_error(\"NOT FOUND - No match for: \" + str(dyeing_program_number), \"SO DEBUG - FAIL\")\r\n#                 frappe.msgprint(\r\n#                     \"Warning: Sales Order not found for SC Order: <b>\" + str(dyeing_program_number) + \"</b><br>Check if Sales Order exists with this value.\",\r\n#                     indicator=\"orange\",\r\n#                     title=\"Sales Order Not Found\"\r\n#                 )\r\n                \r\n#         except Exception as so_err:\r\n#             frappe.log_error(\"Sales Order search error: \" + str(so_err), \"SO DEBUG - ERROR\")\r\n#     else:\r\n#         frappe.log_error(\"No Subcontracting Order value provided\", \"SO DEBUG - EMPTY\")\r\n#         frappe.msgprint(\r\n#             \"Note: No 'subcontracting_order' value found in Job Inward.<br>Sales Order will not be linked.\",\r\n#             indicator=\"blue\",\r\n#             title=\"No Sales Order Link\"\r\n#         )\r\n\r\n#     # -----------------------------------------------------------\r\n#     # WAREHOUSE AUTO-DETECTION\r\n#     # -----------------------------------------------------------\r\n#     frappe.log_error(\"Starting Warehouse Detection...\", \"WAREHOUSE\")\r\n    \r\n#     default_wip_warehouse = \"\"\r\n#     default_fg_warehouse = \"\"\r\n#     default_source_warehouse = \"\"\r\n    \r\n#     # Find WIP Warehouse\r\n#     try:\r\n#         wip_warehouses = frappe.get_all(\r\n#             \"Warehouse\",\r\n#             filters={\"company\": company, \"is_group\": 0, \"disabled\": 0},\r\n#             fields=[\"name\"],\r\n#             or_filters=[\r\n#                 {\"warehouse_name\": [\"like\", \"%Work In Progress%\"]},\r\n#                 {\"warehouse_name\": [\"like\", \"%WIP%\"]},\r\n#                 {\"name\": [\"like\", \"%Work In Progress%\"]},\r\n#                 {\"name\": [\"like\", \"%WIP%\"]}\r\n#             ],\r\n#             limit=1\r\n#         )\r\n#         if wip_warehouses:\r\n#             default_wip_warehouse = wip_warehouses[0].name\r\n#             frappe.log_error(\"WIP Warehouse: \" + default_wip_warehouse, \"WAREHOUSE - WIP\")\r\n#         else:\r\n#             frappe.log_error(\"WIP Warehouse NOT FOUND\", \"WAREHOUSE - WIP\")\r\n#     except Exception as wip_err:\r\n#         frappe.log_error(\"WIP Error: \" + str(wip_err), \"WAREHOUSE - WIP ERROR\")\r\n    \r\n#     # Find FG Warehouse\r\n#     try:\r\n#         fg_warehouses = frappe.get_all(\r\n#             \"Warehouse\",\r\n#             filters={\"company\": company, \"is_group\": 0, \"disabled\": 0},\r\n#             fields=[\"name\"],\r\n#             or_filters=[\r\n#                 {\"warehouse_name\": [\"like\", \"%Finished Goods%\"]},\r\n#                 {\"warehouse_name\": [\"like\", \"%FG%\"]},\r\n#                 {\"name\": [\"like\", \"%GERP WAREHOUSE%\"]}\r\n#             ],\r\n#             limit=1\r\n#         )\r\n#         if fg_warehouses:\r\n#             default_fg_warehouse = fg_warehouses[0].name\r\n#             frappe.log_error(\"FG Warehouse: \" + default_fg_warehouse, \"WAREHOUSE - FG\")\r\n#         else:\r\n#             frappe.log_error(\"FG Warehouse NOT FOUND\", \"WAREHOUSE - FG\")\r\n#     except Exception as fg_err:\r\n#         frappe.log_error(\"FG Error: \" + str(fg_err), \"WAREHOUSE - FG ERROR\")\r\n    \r\n#     # Find Source Warehouse\r\n#     try:\r\n#         source_warehouses = frappe.get_all(\r\n#             \"Warehouse\",\r\n#             filters={\"company\": company, \"is_group\": 0, \"disabled\": 0},\r\n#             fields=[\"name\"],\r\n#             or_filters=[\r\n#                 {\"warehouse_name\": [\"like\", \"%Stores%\"]},\r\n#                 {\"warehouse_name\": [\"like\", \"%Raw Material%\"]},\r\n#                 {\"name\": [\"like\", \"%Stores%\"]}\r\n#             ],\r\n#             limit=1\r\n#         )\r\n#         if source_warehouses:\r\n#             default_source_warehouse = source_warehouses[0].name\r\n#             frappe.log_error(\"Source Warehouse: \" + default_source_warehouse, \"WAREHOUSE - SOURCE\")\r\n#         else:\r\n#             frappe.log_error(\"Source Warehouse NOT FOUND\", \"WAREHOUSE - SOURCE\")\r\n#     except Exception as src_err:\r\n#         frappe.log_error(\"Source Error: \" + str(src_err), \"WAREHOUSE - SOURCE ERROR\")\r\n\r\n#     # -----------------------------------------------------------\r\n#     # PROCESS ITEMS FROM JOB INWARD\r\n#     # -----------------------------------------------------------\r\n#     total_items = len(doc.get('table_duni') or [])\r\n#     frappe.log_error(\"Total Items to Process: \" + str(total_items), \"ITEMS\")\r\n    \r\n#     for idx, row in enumerate(doc.get(\"table_duni\") or [], 1):\r\n        \r\n#         frappe.log_error(\"-\" * 80, \"ITEM \" + str(idx) + \" START\")\r\n        \r\n#         item_code = row.product_name\r\n#         qty = row.total_quantity or 0\r\n#         fg_wh = row.warehouse_name or default_fg_warehouse\r\n\r\n#         frappe.log_error(\"Item: \" + str(item_code) + \" | Qty: \" + str(qty) + \" | FG: \" + str(fg_wh), \"ITEM \" + str(idx))\r\n\r\n#         if not item_code or qty <= 0:\r\n#             frappe.log_error(\"SKIPPED: Invalid item or quantity\", \"ITEM \" + str(idx))\r\n#             continue\r\n\r\n#         # Fetch BOM from Item Master\r\n#         try:\r\n#             item_doc = frappe.get_doc(\"Item\", item_code)\r\n#             bom_no = item_doc.default_bom\r\n            \r\n#             bom_display = bom_no if bom_no else 'NOT SET'\r\n#             frappe.log_error(\"Item Default BOM: \" + str(bom_display), \"ITEM \" + str(idx) + \" - BOM\")\r\n            \r\n#             if not bom_no:\r\n#                 frappe.log_error(\"SKIPPED: No default BOM set for item\", \"ITEM \" + str(idx))\r\n#                 continue\r\n                \r\n#         except Exception as item_err:\r\n#             frappe.log_error(\"Item fetch error: \" + str(item_err), \"ITEM \" + str(idx) + \" - ERROR\")\r\n#             continue\r\n\r\n#         # Validate BOM exists\r\n#         if not frappe.db.exists(\"BOM\", bom_no):\r\n#             frappe.log_error(\"SKIPPED: BOM does not exist\", \"ITEM \" + str(idx))\r\n#             continue\r\n\r\n#         # Load BOM\r\n#         bom_doc = frappe.get_doc(\"BOM\", bom_no)\r\n#         frappe.log_error(\"BOM: \" + str(bom_no) + \" | Active: \" + str(bom_doc.is_active), \"ITEM \" + str(idx) + \" - BOM\")\r\n#         frappe.log_error(\"BOM Materials: \" + str(len(bom_doc.items or [])) + \" | Operations: \" + str(len(bom_doc.operations or [])), \"ITEM \" + str(idx) + \" - BOM\")\r\n        \r\n#         if not bom_doc.is_active:\r\n#             frappe.log_error(\"SKIPPED: BOM is not active\", \"ITEM \" + str(idx))\r\n#             continue\r\n\r\n#         # Create Work Order\r\n#         wo = frappe.get_doc({\r\n#             \"doctype\": \"Work Order\",\r\n#             \"company\": company,\r\n#             \"production_item\": item_code,\r\n#             \"qty\": qty,\r\n#             \"bom_no\": bom_no,\r\n#             \"sales_order\": sales_order_name,\r\n#             \"fg_warehouse\": fg_wh,\r\n#             \"wip_warehouse\": default_wip_warehouse,\r\n#             \"source_warehouse\": default_source_warehouse,\r\n#             \"use_multi_level_bom\": 1,\r\n#             \"skip_transfer\": 0,\r\n#             \"transfer_material_against\": \"Work Order\",\r\n#             \"expected_delivery_date\": doc.challan_date or doc.inward_date or frappe.utils.today(),\r\n#             \"planned_start_date\": doc.challan_date or doc.inward_date or frappe.utils.today()\r\n#         })\r\n        \r\n#         so_link_display = sales_order_name if sales_order_name else 'NONE'\r\n#         frappe.log_error(\"Work Order created | Sales Order Link: \" + str(so_link_display), \"ITEM \" + str(idx) + \" - WO\")\r\n\r\n#         # Add BOM Materials\r\n#         material_count = 0\r\n#         for mat in bom_doc.items or []:\r\n#             wo.append(\"required_items\", {\r\n#                 \"item_code\": mat.item_code,\r\n#                 \"item_name\": mat.item_name,\r\n#                 \"description\": mat.description,\r\n#                 \"required_qty\": (mat.qty or 0) * qty,\r\n#                 \"source_warehouse\": mat.source_warehouse or default_source_warehouse,\r\n#                 \"rate\": mat.rate or 0,\r\n#                 \"amount\": (mat.rate or 0) * (mat.qty or 0) * qty\r\n#             })\r\n#             material_count = material_count + 1\r\n        \r\n#         frappe.log_error(\"Added \" + str(material_count) + \" materials to Work Order\", \"ITEM \" + str(idx) + \" - MATERIALS\")\r\n\r\n#         # Add BOM Operations\r\n#         operation_count = 0\r\n#         if bom_doc.with_operations and bom_doc.operations:\r\n#             for op in bom_doc.operations:\r\n#                 wo.append(\"operations\", {\r\n#                     \"operation\": op.operation,\r\n#                     \"bom\": bom_no,\r\n#                     \"bom_operation\": op.name,\r\n#                     \"description\": op.description,\r\n#                     \"workstation\": op.workstation,\r\n#                     \"workstation_type\": op.workstation_type,\r\n#                     \"time_in_mins\": op.time_in_mins or 0,\r\n#                     \"operating_cost\": op.operating_cost or 0,\r\n#                     \"hour_rate\": op.hour_rate or 0,\r\n#                     \"batch_size\": op.batch_size or 1,\r\n#                     \"sequence_id\": op.sequence_id or op.idx,\r\n#                     \"status\": \"Pending\",\r\n#                     \"completed_qty\": 0\r\n#                 })\r\n#                 operation_count = operation_count + 1\r\n            \r\n#             frappe.log_error(\"Added \" + str(operation_count) + \" operations to Work Order\", \"ITEM \" + str(idx) + \" - OPERATIONS\")\r\n#         else:\r\n#             frappe.log_error(\"No operations in BOM\", \"ITEM \" + str(idx) + \" - OPERATIONS\")\r\n\r\n#         # Insert and Submit Work Order\r\n#         try:\r\n#             wo.insert(ignore_permissions=True)\r\n#             frappe.log_error(\"Work Order INSERTED: \" + wo.name, \"ITEM \" + str(idx) + \" - SUCCESS\")\r\n#             work_orders_created.append(wo.name)\r\n            \r\n#             try:\r\n#                 wo.submit()\r\n#                 frappe.log_error(\"Work Order SUBMITTED: \" + wo.name, \"ITEM \" + str(idx) + \" - SUCCESS\")\r\n#             except Exception as submit_err:\r\n#                 frappe.log_error(\"Submit failed: \" + str(submit_err), \"ITEM \" + str(idx) + \" - SUBMIT ERROR\")\r\n#                 frappe.msgprint(\r\n#                     \"Work Order <b>\" + wo.name + \"</b> created but could not be submitted:<br>\" + str(submit_err),\r\n#                     indicator=\"orange\"\r\n#                 )\r\n                \r\n#         except Exception as ins_err:\r\n#             frappe.log_error(\"Insert failed: \" + str(ins_err), \"ITEM \" + str(idx) + \" - INSERT ERROR\")\r\n#             frappe.msgprint(\r\n#                 \"Failed to create Work Order for <b>\" + str(item_code) + \"</b>:<br>\" + str(ins_err),\r\n#                 indicator=\"red\"\r\n#             )\r\n        \r\n#         frappe.log_error(\"-\" * 80, \"ITEM \" + str(idx) + \" END\")\r\n\r\n#     # -----------------------------------------------------------\r\n#     # FINAL SUMMARY\r\n#     # -----------------------------------------------------------\r\n#     frappe.log_error(\"=\" * 80, \"SUMMARY\")\r\n#     frappe.log_error(\"Work Orders Created: \" + str(len(work_orders_created)), \"SUMMARY\")\r\n#     so_summary = sales_order_name if sales_order_name else 'NONE'\r\n#     frappe.log_error(\"Sales Order Linked: \" + str(so_summary), \"SUMMARY\")\r\n    \r\n#     for wo_name in work_orders_created:\r\n#         frappe.log_error(\"  - \" + wo_name, \"SUMMARY - WO\")\r\n    \r\n#     frappe.log_error(\"=\" * 80, \"END\")\r\n    \r\n#     # Show success message\r\n#     if work_orders_created:\r\n#         wo_list = ', '.join(work_orders_created)\r\n#         msg = \"Work Orders Created: <b>\" + wo_list + \"</b>\"\r\n#         if sales_order_name:\r\n#             msg = msg + \"<br>Linked to Sales Order: <b>\" + sales_order_name + \"</b>\"\r\n#         else:\r\n#             msg = msg + \"<br><span style='color: orange;'>No Sales Order linked</span>\"\r\n        \r\n#         msg_indicator = \"green\" if sales_order_name else \"orange\"\r\n#         frappe.msgprint(msg, indicator=msg_indicator, title=\"Work Orders Created\")\r\n\r\n# except Exception as e:\r\n#     error_msg = str(e)\r\n#     frappe.log_error(\"FATAL ERROR: \" + error_msg, \"JOB INWARD FATAL ERROR\")\r\n#     frappe.msgprint(\"Error creating Work Orders: \" + error_msg, indicator=\"red\", title=\"Error\")\r\n\r\n\r\n\r\n# ----------------------------------perfect working code-----------------------\r\n\r\n\r\n# try:\r\n#     work_orders_created = []\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 1ï¸âƒ£ BASIC VALIDATION\r\n#     # ---------------------------------------------------------\r\n#     company = doc.company\r\n#     if not company:\r\n#         frappe.throw(\"Company is mandatory\")\r\n\r\n#     # Sales Order from Dyeing Program Number\r\n#     sales_order_name = None\r\n#     if doc.subcontracting_order and frappe.db.exists(\"Sales Order\", doc.subcontracting_order):\r\n#         so = frappe.get_doc(\"Sales Order\", doc.subcontracting_order)\r\n#         if so.docstatus == 1 and so.status not in [\"Cancelled\", \"Closed\"]:\r\n#             sales_order_name = so.name\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 2ï¸âƒ£ HELPER FUNCTIONS\r\n#     # ---------------------------------------------------------\r\n#     def get_warehouse(company, patterns):\r\n#         wh = frappe.get_all(\r\n#             \"Warehouse\",\r\n#             filters={\"company\": company, \"is_group\": 0, \"disabled\": 0},\r\n#             or_filters=patterns,\r\n#             fields=[\"name\"],\r\n#             limit=1\r\n#         )\r\n#         return wh[0].name if wh else None\r\n\r\n#     def validate_warehouse(warehouse, company):\r\n#         if warehouse and frappe.db.get_value(\"Warehouse\", warehouse, \"company\") == company:\r\n#             return warehouse\r\n#         return None\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 3ï¸âƒ£ AUTO-DETECT COMPANY WAREHOUSES\r\n#     # ---------------------------------------------------------\r\n#     default_wip_warehouse = get_warehouse(company, [\r\n#         {\"warehouse_name\": [\"like\", \"%WIP%\"]},\r\n#         {\"warehouse_name\": [\"like\", \"%Work In Progress%\"]}\r\n#     ])\r\n\r\n#     default_fg_warehouse = get_warehouse(company, [\r\n#         {\"warehouse_name\": [\"like\", \"%FG%\"]},\r\n#         {\"warehouse_name\": [\"like\", \"%Finished Goods%\"]}\r\n#     ])\r\n\r\n#     default_source_warehouse = get_warehouse(company, [\r\n#         {\"warehouse_name\": [\"like\", \"%Stores%\"]},\r\n#         {\"warehouse_name\": [\"like\", \"%Raw%\"]}\r\n#     ])\r\n\r\n#     if not default_source_warehouse:\r\n#         frappe.throw(f\"No Source Warehouse found for company {company}\")\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 4ï¸âƒ£ FETCH SUBCONTRACTING ORDER\r\n#     # ---------------------------------------------------------\r\n#     if not doc.subcontracting_order:\r\n#         frappe.throw(\"Subcontracting Order is mandatory\")\r\n\r\n#     if not frappe.db.exists(\"Subcontracting Order\", doc.subcontracting_order):\r\n#         frappe.throw(\"Subcontracting Order not found\")\r\n\r\n#     subcontracting_doc = frappe.get_doc(\"Subcontracting Order\", doc.subcontracting_order)\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 5ï¸âƒ£ LOOP SUBCONTRACTING ORDER ITEMS âœ…\r\n#     # ---------------------------------------------------------\r\n#     for row in subcontracting_doc.items:\r\n\r\n#         item_code = row.item_code          # âœ… Correct Item\r\n#         qty = row.qty or 0\r\n#         fg_wh = validate_warehouse(row.warehouse, company) or default_fg_warehouse\r\n\r\n#         if not item_code or qty <= 0:\r\n#             continue\r\n\r\n#         # -----------------------------------------------------\r\n#         # 6ï¸âƒ£ FETCH BOM (SAME COMPANY â†’ ELSE OTHER COMPANY)\r\n#         # -----------------------------------------------------\r\n#         bom_no = None\r\n\r\n#         bom = frappe.get_all(\r\n#             \"BOM\",\r\n#             filters={\r\n#                 \"item\": item_code,\r\n#                 \"company\": company,\r\n#                 \"is_active\": 1,\r\n#                 \"docstatus\": 1\r\n#             },\r\n#             fields=[\"name\"],\r\n#             limit=1\r\n#         )\r\n\r\n#         if bom:\r\n#             bom_no = bom[0].name\r\n#         else:\r\n#             bom_other = frappe.get_all(\r\n#                 \"BOM\",\r\n#                 filters={\r\n#                     \"item\": item_code,\r\n#                     \"is_active\": 1,\r\n#                     \"docstatus\": 1\r\n#                 },\r\n#                 fields=[\"name\"],\r\n#                 limit=1\r\n#             )\r\n#             if bom_other:\r\n#                 bom_no = bom_other[0].name\r\n\r\n#         if not bom_no:\r\n#             frappe.log_error(f\"No BOM found for Item {item_code}\", \"JOB INWARD AUTO WO\")\r\n#             continue\r\n\r\n#         bom_doc = frappe.get_doc(\"BOM\", bom_no)\r\n\r\n#         # -----------------------------------------------------\r\n#         # 7ï¸âƒ£ CREATE WORK ORDER\r\n#         # -----------------------------------------------------\r\n#         wo = frappe.get_doc({\r\n#             \"doctype\": \"Work Order\",\r\n#             \"company\": company,\r\n#             \"production_item\": item_code,\r\n#             \"qty\": qty,\r\n#             \"bom_no\": bom_no,\r\n#             \"sales_order\": sales_order_name,\r\n#             \"fg_warehouse\": fg_wh,\r\n#             \"wip_warehouse\": default_wip_warehouse,\r\n#             \"source_warehouse\": default_source_warehouse,\r\n#             \"use_multi_level_bom\": 1,\r\n#             \"skip_transfer\": 0,\r\n#             \"transfer_material_against\": \"Work Order\",\r\n#             \"planned_start_date\": doc.inward_date or frappe.utils.today(),\r\n#             \"expected_delivery_date\": doc.inward_date or frappe.utils.today()\r\n#         })\r\n\r\n#         # -----------------------------------------------------\r\n#         # 8ï¸âƒ£ ADD RAW MATERIALS (WAREHOUSE COMPANY SAFE)\r\n#         # -----------------------------------------------------\r\n#         for b in bom_doc.items:\r\n#             wo.append(\"required_items\", {\r\n#                 \"item_code\": b.item_code,\r\n#                 \"item_name\": b.item_name,\r\n#                 \"description\": b.description,\r\n#                 \"required_qty\": (b.qty or 0) * qty,\r\n#                 \"source_warehouse\": validate_warehouse(b.source_warehouse, company) or default_source_warehouse,\r\n#                 \"rate\": b.rate or 0,\r\n#                 \"amount\": (b.rate or 0) * (b.qty or 0) * qty\r\n#             })\r\n\r\n#         # -----------------------------------------------------\r\n#         # 9ï¸âƒ£ ADD OPERATIONS\r\n#         # -----------------------------------------------------\r\n#         if bom_doc.with_operations:\r\n#             for op in bom_doc.operations:\r\n#                 wo.append(\"operations\", {\r\n#                     \"operation\": op.operation,\r\n#                     \"bom\": bom_no,\r\n#                     \"bom_operation\": op.name,\r\n#                     \"description\": op.description,\r\n#                     \"workstation\": op.workstation,\r\n#                     \"workstation_type\": op.workstation_type,\r\n#                     \"time_in_mins\": op.time_in_mins or 0,\r\n#                     \"hour_rate\": op.hour_rate or 0,\r\n#                     \"operating_cost\": op.operating_cost or 0,\r\n#                     \"sequence_id\": op.sequence_id or op.idx,\r\n#                     \"status\": \"Pending\"\r\n#                 })\r\n\r\n#         # -----------------------------------------------------\r\n#         # ðŸ”Ÿ INSERT & SUBMIT\r\n#         # -----------------------------------------------------\r\n#         wo.insert(ignore_permissions=True)\r\n#         wo.submit()\r\n#         work_orders_created.append(wo.name)\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 1ï¸âƒ£1ï¸âƒ£ SUCCESS MESSAGE\r\n#     # ---------------------------------------------------------\r\n#     if work_orders_created:\r\n#         frappe.msgprint(\r\n#             \"Work Orders Created:<br><b>\" + \"<br>\".join(work_orders_created) + \"</b>\",\r\n#             indicator=\"green\",\r\n#             title=\"Success\"\r\n#         )\r\n\r\n# except Exception as e:\r\n#     frappe.log_error(str(e), \"JOB INWARD AUTO WORK ORDER ERROR\")\r\n#     frappe.throw(str(e))\r\n\r\n\r\n\r\n\r\n\r\n\r\n# try:\r\n#     work_orders_created = []\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 1ï¸âƒ£ BASIC VALIDATION\r\n#     # ---------------------------------------------------------\r\n#     company = doc.company\r\n#     if not company:\r\n#         frappe.throw(\"Company is mandatory\")\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 2ï¸âƒ£ HELPER FUNCTIONS\r\n#     # ---------------------------------------------------------\r\n#     def get_warehouse(company, patterns):\r\n#         wh = frappe.get_all(\r\n#             \"Warehouse\",\r\n#             filters={\"company\": company, \"is_group\": 0, \"disabled\": 0},\r\n#             or_filters=patterns,\r\n#             fields=[\"name\"],\r\n#             limit=1\r\n#         )\r\n#         return wh[0].name if wh else None\r\n\r\n#     def validate_warehouse(warehouse, company):\r\n#         if warehouse and frappe.db.get_value(\"Warehouse\", warehouse, \"company\") == company:\r\n#             return warehouse\r\n#         return None\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 3ï¸âƒ£ AUTO-DETECT COMPANY WAREHOUSES\r\n#     # ---------------------------------------------------------\r\n#     default_wip_warehouse = get_warehouse(company, [\r\n#         {\"warehouse_name\": [\"like\", \"%WIP%\"]},\r\n#         {\"warehouse_name\": [\"like\", \"%Work In Progress%\"]}\r\n#     ])\r\n\r\n#     default_fg_warehouse = get_warehouse(company, [\r\n#         {\"warehouse_name\": [\"like\", \"%FG%\"]},\r\n#         {\"warehouse_name\": [\"like\", \"%Finished Goods%\"]}\r\n#     ])\r\n\r\n#     default_source_warehouse = get_warehouse(company, [\r\n#         {\"warehouse_name\": [\"like\", \"%Stores%\"]},\r\n#         {\"warehouse_name\": [\"like\", \"%Raw%\"]}\r\n#     ])\r\n\r\n#     if not default_source_warehouse:\r\n#         frappe.throw(f\"No Source Warehouse found for company {company}\")\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 4ï¸âƒ£ FETCH SUBCONTRACTING ORDER\r\n#     # ---------------------------------------------------------\r\n#     if not doc.subcontracting_order:\r\n#         frappe.throw(\"Subcontracting Order is mandatory\")\r\n\r\n#     if not frappe.db.exists(\"Subcontracting Order\", doc.subcontracting_order):\r\n#         frappe.throw(\"Subcontracting Order not found\")\r\n\r\n#     subcontracting_doc = frappe.get_doc(\"Subcontracting Order\", doc.subcontracting_order)\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 5ï¸âƒ£ LOOP SUBCONTRACTING ORDER ITEMS\r\n#     # ---------------------------------------------------------\r\n#     for row in subcontracting_doc.items:\r\n\r\n#         item_code = row.item_code\r\n#         qty = row.qty or 0\r\n#         fg_wh = validate_warehouse(row.warehouse, company) or default_fg_warehouse\r\n\r\n#         if not item_code or qty <= 0:\r\n#             continue\r\n\r\n#         # -----------------------------------------------------\r\n#         # 6ï¸âƒ£ FETCH SALES ORDER (ðŸ”¥ UPDATED - NO ITEM MATCH)\r\n#         # -----------------------------------------------------\r\n#         sales_order_name = None\r\n\r\n#         # Search Sales Order where po_no matches subcontracting_order from Job Inward\r\n#         if doc.subcontracting_order:\r\n#             sales_orders = frappe.get_all(\r\n#                 \"Sales Order\",\r\n#                 filters={\r\n#                     \"po_no\": doc.subcontracting_order,  # SC-ORD-2025-00029-1\r\n#                     \"docstatus\": 1\r\n#                 },\r\n#                 fields=[\"name\"],\r\n#                 limit=1\r\n#             )\r\n            \r\n#             if sales_orders:\r\n#                 so = frappe.get_doc(\"Sales Order\", sales_orders[0].name)\r\n                \r\n#                 if so.status not in [\"Cancelled\", \"Closed\"]:\r\n#                     sales_order_name = so.name  # SAL-ORD-2025-00087\r\n\r\n#         # -----------------------------------------------------\r\n#         # 7ï¸âƒ£ FETCH BOM\r\n#         # -----------------------------------------------------\r\n#         bom_no = None\r\n\r\n#         bom = frappe.get_all(\r\n#             \"BOM\",\r\n#             filters={\r\n#                 \"item\": item_code,\r\n#                 \"company\": company,\r\n#                 \"is_active\": 1,\r\n#                 \"docstatus\": 1\r\n#             },\r\n#             fields=[\"name\"],\r\n#             limit=1\r\n#         )\r\n\r\n#         if bom:\r\n#             bom_no = bom[0].name\r\n#         else:\r\n#             bom_other = frappe.get_all(\r\n#                 \"BOM\",\r\n#                 filters={\r\n#                     \"item\": item_code,\r\n#                     \"is_active\": 1,\r\n#                     \"docstatus\": 1\r\n#                 },\r\n#                 fields=[\"name\"],\r\n#                 limit=1\r\n#             )\r\n#             if bom_other:\r\n#                 bom_no = bom_other[0].name\r\n\r\n#         if not bom_no:\r\n#             frappe.log_error(f\"No BOM found for Item {item_code}\", \"JOB INWARD AUTO WO\")\r\n#             continue\r\n\r\n#         bom_doc = frappe.get_doc(\"BOM\", bom_no)\r\n\r\n#         # -----------------------------------------------------\r\n#         # 8ï¸âƒ£ CREATE WORK ORDER\r\n#         # -----------------------------------------------------\r\n#         wo = frappe.get_doc({\r\n#             \"doctype\": \"Work Order\",\r\n#             \"company\": company,\r\n#             \"production_item\": item_code,\r\n#             \"qty\": qty,\r\n#             \"bom_no\": bom_no,\r\n#             \"sales_order\": sales_order_name,\r\n#             \"fg_warehouse\": fg_wh,\r\n#             \"wip_warehouse\": default_wip_warehouse,\r\n#             \"source_warehouse\": default_source_warehouse,\r\n#             \"use_multi_level_bom\": 1,\r\n#             # \"skip_transfer\": 0,\r\n#             # \"transfer_material_against\": \"Work Order\",\r\n#             \"planned_start_date\": doc.inward_date or frappe.utils.today(),\r\n#             \"expected_delivery_date\": doc.inward_date or frappe.utils.today()\r\n#         })\r\n\r\n#         # -----------------------------------------------------\r\n#         # 9ï¸âƒ£ ADD RAW MATERIALS\r\n#         # -----------------------------------------------------\r\n#         for b in bom_doc.items:\r\n#             wo.append(\"required_items\", {\r\n#                 \"item_code\": b.item_code,\r\n#                 \"item_name\": b.item_name,\r\n#                 \"description\": b.description,\r\n#                 \"required_qty\": (b.qty or 0) * qty,\r\n#                 \"source_warehouse\": validate_warehouse(b.source_warehouse, company) or default_source_warehouse,\r\n#                 \"rate\": b.rate or 0,\r\n#                 \"amount\": (b.rate or 0) * (b.qty or 0) * qty\r\n#             })\r\n\r\n#         # -----------------------------------------------------\r\n#         # ðŸ”Ÿ ADD OPERATIONS\r\n#         # -----------------------------------------------------\r\n#         if bom_doc.with_operations:\r\n#             for op in bom_doc.operations:\r\n#                 wo.append(\"operations\", {\r\n#                     \"operation\": op.operation,\r\n#                     \"bom\": bom_no,\r\n#                     \"bom_operation\": op.name,\r\n#                     \"description\": op.description,\r\n#                     \"workstation\": op.workstation,\r\n#                     \"workstation_type\": op.workstation_type,\r\n#                     \"time_in_mins\": op.time_in_mins or 0,\r\n#                     \"hour_rate\": op.hour_rate or 0,\r\n#                     \"operating_cost\": op.operating_cost or 0,\r\n#                     \"sequence_id\": op.sequence_id or op.idx,\r\n#                     \"status\": \"Pending\"\r\n#                 })\r\n\r\n#         # -----------------------------------------------------\r\n#         # # 1ï¸âƒ£1ï¸âƒ£ INSERT & SUBMIT\r\n#         # # -----------------------------------------------------\r\n#         # wo.flags.ignore_validate = True  # Skip Sales Order qty validation\r\n#         # wo.insert(ignore_permissions=True)\r\n#         # wo.submit()\r\n#         # work_orders_created.append(wo.name)\r\n      \r\n#               # -----------------------------------------------------\r\n#         # 1ï¸âƒ£1ï¸âƒ£ INSERT & PROPER SUBMIT (FIXED)\r\n#         # -----------------------------------------------------\r\n#         wo.flags.ignore_workflow = True\r\n#         wo.flags.ignore_validate = True\r\n\r\n#         wo.insert(ignore_permissions=True)\r\n#         wo.submit()   # MUST â€“ ERPNext internal logic runs here\r\n\r\n#         work_orders_created.append(wo.name)\r\n\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 1ï¸âƒ£2ï¸âƒ£ SUCCESS MESSAGE\r\n#     # ---------------------------------------------------------\r\n#     if work_orders_created:\r\n#         frappe.msgprint(\r\n#             \"Work Orders Created:<br><b>\" + \"<br>\".join(work_orders_created) + \"</b>\",\r\n#             indicator=\"green\",\r\n#             title=\"Success\"\r\n#         )\r\n\r\n# except Exception as e:\r\n#     frappe.log_error(str(e), \"JOB INWARD AUTO WORK ORDER ERROR\")\r\n#     frappe.throw(str(e))\r\n\r\n# -------------------------------------------------status not started and working code----------------------------\r\n\r\n\r\n# try:\r\n#     work_orders_created = []\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 1ï¸âƒ£ BASIC VALIDATION\r\n#     # ---------------------------------------------------------\r\n#     company = doc.company\r\n#     if not company:\r\n#         frappe.throw(\"Company is mandatory\")\r\n\r\n#     if not doc.subcontracting_order:\r\n#         frappe.throw(\"Subcontracting Order is mandatory\")\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 2ï¸âƒ£ HELPER FUNCTIONS\r\n#     # ---------------------------------------------------------\r\n#     def get_warehouse(company, keywords):\r\n#         wh = frappe.get_all(\r\n#             \"Warehouse\",\r\n#             filters={\"company\": company, \"is_group\": 0, \"disabled\": 0},\r\n#             or_filters=[{\"warehouse_name\": [\"like\", f\"%{k}%\"]} for k in keywords],\r\n#             fields=[\"name\"],\r\n#             limit=1\r\n#         )\r\n#         return wh[0].name if wh else None\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 3ï¸âƒ£ AUTO WAREHOUSE DETECTION\r\n#     # ---------------------------------------------------------\r\n#     source_wh = get_warehouse(company, [\"Raw\", \"Store\"])\r\n#     wip_wh = get_warehouse(company, [\"WIP\", \"Work In Progress\"])\r\n#     fg_wh = get_warehouse(company, [\"FG\", \"Finished\"])\r\n\r\n#     if not source_wh:\r\n#         frappe.throw(\"Source Warehouse not found\")\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 4ï¸âƒ£ FETCH SUBCONTRACTING ORDER\r\n#     # ---------------------------------------------------------\r\n#     sc = frappe.get_doc(\"Subcontracting Order\", doc.subcontracting_order)\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 5ï¸âƒ£ FETCH SALES ORDER (ðŸ”¥ FROM FIRST CODE)\r\n#     # ---------------------------------------------------------\r\n#     sales_order_name = None\r\n\r\n#     sales_orders = frappe.get_all(\r\n#         \"Sales Order\",\r\n#         filters={\r\n#             \"po_no\": doc.subcontracting_order,\r\n#             \"docstatus\": 1\r\n#         },\r\n#         fields=[\"name\", \"status\"],\r\n#         limit=1\r\n#     )\r\n\r\n#     if sales_orders:\r\n#         so = frappe.get_doc(\"Sales Order\", sales_orders[0].name)\r\n#         if so.status not in [\"Cancelled\", \"Closed\"]:\r\n#             sales_order_name = so.name\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 6ï¸âƒ£ LOOP SUBCONTRACTING ORDER ITEMS\r\n#     # ---------------------------------------------------------\r\n#     for row in sc.items:\r\n#         if not row.item_code or not row.qty:\r\n#             continue\r\n\r\n#         item_code = row.item_code\r\n#         qty = row.qty\r\n\r\n#         # -----------------------------------------------------\r\n#         # 7ï¸âƒ£ PREVENT DUPLICATE WORK ORDER\r\n#         # -----------------------------------------------------\r\n#         exists = frappe.db.exists(\r\n#             \"Work Order\",\r\n#             {\r\n#                 \"production_item\": item_code,\r\n#                 \"subcontracting_order\": doc.subcontracting_order,\r\n#                 \"docstatus\": [\"!=\", 2]\r\n#             }\r\n#         )\r\n#         if exists:\r\n#             continue\r\n\r\n#         # -----------------------------------------------------\r\n#         # 8ï¸âƒ£ FETCH BOM\r\n#         # -----------------------------------------------------\r\n#         bom = frappe.db.get_value(\r\n#             \"BOM\",\r\n#             {\r\n#                 \"item\": item_code,\r\n#                 \"is_active\": 1,\r\n#                 \"company\":company,\r\n#                 \"docstatus\": 1\r\n#             },\r\n#             \"name\"\r\n#         )\r\n\r\n#         if not bom:\r\n#             frappe.log_error(f\"No BOM found for {item_code}\", \"JOB INWARD AUTO WO\")\r\n#             continue\r\n\r\n#         bom_doc = frappe.get_doc(\"BOM\", bom)\r\n\r\n#         # -----------------------------------------------------\r\n#         # 9ï¸âƒ£ CREATE WORK ORDER\r\n#         # -----------------------------------------------------\r\n#         wo = frappe.get_doc({\r\n#             \"doctype\": \"Work Order\",\r\n#             \"company\": company,\r\n#             \"production_item\": item_code,\r\n#             \"qty\": qty,\r\n#             \"bom_no\": bom,\r\n#             \"fg_warehouse\": fg_wh,\r\n#             \"wip_warehouse\": wip_wh,\r\n#             \"source_warehouse\": source_wh,\r\n#             \"planned_start_date\": doc.inward_date or frappe.utils.today(),\r\n#             \"expected_delivery_date\": doc.inward_date or frappe.utils.today(),\r\n#             \"use_multi_level_bom\": 1,\r\n#             \"skip_transfer\": 0,\r\n#             \"transfer_material_against\": \"Work Order\",\r\n#             \"subcontracting_order\": doc.subcontracting_order,\r\n#             \"sales_order\": sales_order_name  # ðŸ”¥ FIXED\r\n#         })\r\n\r\n#         # -----------------------------------------------------\r\n#         # ðŸ”Ÿ RAW MATERIALS\r\n#         # -----------------------------------------------------\r\n#         for b in bom_doc.items:\r\n#             wo.append(\"required_items\", {\r\n#                 \"item_code\": b.item_code,\r\n#                 \"required_qty\": b.qty * qty,\r\n#                 \"source_warehouse\": b.source_warehouse or source_wh,\r\n#                 \"rate\": b.rate or 0\r\n#             })\r\n\r\n#         # -----------------------------------------------------\r\n#         # 1ï¸âƒ£1ï¸âƒ£ OPERATIONS\r\n#         # -----------------------------------------------------\r\n#         if bom_doc.with_operations:\r\n#             for op in bom_doc.operations:\r\n#                 wo.append(\"operations\", {\r\n#                     \"operation\": op.operation,\r\n#                     \"workstation\": op.workstation,\r\n#                     \"time_in_mins\": op.time_in_mins or 0,\r\n#                     \"sequence_id\": op.sequence_id or op.idx\r\n#                 })\r\n\r\n#         # -----------------------------------------------------\r\n#         # 1ï¸âƒ£2ï¸âƒ£ INSERT & SUBMIT (SAFE)\r\n#         # -----------------------------------------------------\r\n#         wo.flags.ignore_validate = True\r\n#         wo.flags.ignore_validate_update_after_submit = True\r\n#         wo.flags.ignore_workflow = True\r\n\r\n#         wo.insert(ignore_permissions=True)\r\n#         wo.submit()\r\n\r\n#         # -----------------------------------------------------\r\n#         # 1ï¸âƒ£3ï¸âƒ£ RESET MATERIAL TRANSFER FLAGS (ðŸ”¥ IMPORTANT)\r\n#         # # -----------------------------------------------------\r\n#         frappe.db.set_value(\r\n#             \"Work Order\",\r\n#             wo.name,\r\n#             {\r\n#                 \"material_transferred_for_manufacturing\": 0,\r\n#                 \"status\": \"Not Started\"\r\n#             },\r\n#             update_modified=False\r\n#         )\r\n\r\n#         work_orders_created.append(wo.name)\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 1ï¸âƒ£4ï¸âƒ£ SUCCESS MESSAGE\r\n#     # ---------------------------------------------------------\r\n#     if work_orders_created:\r\n#         frappe.msgprint(\r\n#             \"Work Orders Created:<br><b>\" + \"<br>\".join(work_orders_created) + \"</b>\",\r\n#             indicator=\"green\",\r\n#             title=\"Success\"\r\n#         )\r\n\r\n# except Exception as e:\r\n#     import traceback\r\n#     frappe.log_error(\r\n#         traceback.format_exc(),\r\n#         \"JOB INWARD AUTO WORK ORDER ERROR\"\r\n#     )\r\n#     frappe.throw(str(e))\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n# -------------------------------------------------fetch bom --------------------------------------------------------\r\n\r\n\r\n\r\n\r\n# try:\r\n#     work_orders_created = []\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 1ï¸âƒ£ BASIC VALIDATION\r\n#     # ---------------------------------------------------------\r\n#     company = doc.company\r\n#     if not company:\r\n#         frappe.throw(\"Company is mandatory\")\r\n\r\n#     if not doc.subcontracting_order:\r\n#         frappe.throw(\"Subcontracting Order is mandatory\")\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 2ï¸âƒ£ HELPER FUNCTION: AUTO-DETECT WAREHOUSE\r\n#     # ---------------------------------------------------------\r\n#     def get_warehouse(company, keywords):\r\n#         wh = frappe.get_all(\r\n#             \"Warehouse\",\r\n#             filters={\r\n#                 \"company\": company,\r\n#                 \"is_group\": 0,\r\n#                 \"disabled\": 0\r\n#             },\r\n#             or_filters=[{\"warehouse_name\": [\"like\", f\"%{k}%\"]} for k in keywords],\r\n#             fields=[\"name\"],\r\n#             limit=1\r\n#         )\r\n#         return wh[0].name if wh else None\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 3ï¸âƒ£ AUTO WAREHOUSE DETECTION\r\n#     # ---------------------------------------------------------\r\n#     source_wh = get_warehouse(company, [\"Raw\", \"Store\"])\r\n#     wip_wh = get_warehouse(company, [\"WIP\", \"Work In Progress\"])\r\n#     fg_wh = get_warehouse(company, [\"FG\", \"Finished\"])\r\n\r\n#     if not source_wh:\r\n#         frappe.throw(\"Source Warehouse not found\")\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 4ï¸âƒ£ FETCH SUBCONTRACTING ORDER\r\n#     # ---------------------------------------------------------\r\n#     sc = frappe.get_doc(\"Subcontracting Order\", doc.subcontracting_order)\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 5ï¸âƒ£ FETCH SALES ORDER (IF EXISTS)\r\n#     # ---------------------------------------------------------\r\n#     sales_order_name = None\r\n#     sales_orders = frappe.get_all(\r\n#         \"Sales Order\",\r\n#         filters={\r\n#             \"po_no\": doc.subcontracting_order,\r\n#             \"docstatus\": 1\r\n#         },\r\n#         fields=[\"name\", \"status\"],\r\n#         limit=1\r\n#     )\r\n\r\n#     if sales_orders:\r\n#         so = frappe.get_doc(\"Sales Order\", sales_orders[0].name)\r\n#         if so.status not in [\"Cancelled\", \"Closed\"]:\r\n#             sales_order_name = so.name\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 6ï¸âƒ£ LOOP SUBCONTRACTING ORDER ITEMS\r\n#     # ---------------------------------------------------------\r\n#     for row in sc.items:\r\n#         if not row.item_code or not row.qty:\r\n#             continue\r\n\r\n#         item_code = row.item_code\r\n#         qty = row.qty\r\n\r\n#         # -----------------------------------------------------\r\n#         # 7ï¸âƒ£ PREVENT DUPLICATE WORK ORDER\r\n#         # -----------------------------------------------------\r\n#         exists = frappe.db.exists(\r\n#             \"Work Order\",\r\n#             {\r\n#                 \"production_item\": item_code,\r\n#                 \"subcontracting_order\": doc.subcontracting_order,\r\n#                 \"docstatus\": [\"!=\", 2]\r\n#             }\r\n#         )\r\n#         if exists:\r\n#             continue\r\n\r\n#         # -----------------------------------------------------\r\n#         # 8ï¸âƒ£ FETCH BOM (ITEM + COMPANY MATCH ONLY)\r\n#         # -----------------------------------------------------\r\n#         bom_list = frappe.get_all(\r\n#             \"BOM\",\r\n#             filters={\r\n#                 \"item\": item_code,\r\n#                 \"company\": company,\r\n#                 \"is_active\": 1,\r\n#                 \"docstatus\": 1\r\n#             },\r\n#             order_by=\"modified desc\",\r\n#             pluck=\"name\",\r\n#             limit=1\r\n#         )\r\n\r\n#         bom = bom_list[0] if bom_list else None\r\n\r\n#         if not bom:\r\n#             frappe.log_error(\r\n#                 f\"\"\"\r\n# BOM NOT FOUND\r\n\r\n# Item: {item_code}\r\n# Company: {company}\r\n\r\n# Required:\r\n# - Item match\r\n# - Company match\r\n# - Active BOM\r\n# - Submitted BOM\r\n# \"\"\",\r\n#                 \"JOB INWARD - BOM MISSING\"\r\n#             )\r\n\r\n#             frappe.msgprint(\r\n#                 f\"BOM not found for <b>{item_code}</b> in company <b>{company}</b>\",\r\n#                 indicator=\"orange\",\r\n#                 alert=True\r\n#             )\r\n#             continue\r\n\r\n#         bom_doc = frappe.get_doc(\"BOM\", bom)\r\n\r\n#         # -----------------------------------------------------\r\n#         # 9ï¸âƒ£ CREATE WORK ORDER\r\n#         # -----------------------------------------------------\r\n#         wo = frappe.get_doc({\r\n#             \"doctype\": \"Work Order\",\r\n#             \"company\": company,\r\n#             \"production_item\": item_code,\r\n#             \"qty\": qty,\r\n#             \"bom_no\": bom,\r\n#             \"fg_warehouse\": fg_wh,\r\n#             \"wip_warehouse\": wip_wh,\r\n#             \"source_warehouse\": source_wh,\r\n#             \"planned_start_date\": doc.inward_date or frappe.utils.today(),\r\n#             \"expected_delivery_date\": doc.inward_date or frappe.utils.today(),\r\n#             \"use_multi_level_bom\": 1,\r\n#             \"skip_transfer\": 0,\r\n#             \"transfer_material_against\": \"Work Order\",\r\n#             \"subcontracting_order\": doc.subcontracting_order,\r\n#             \"sales_order\": sales_order_name\r\n#         })\r\n\r\n#         # -----------------------------------------------------\r\n#         # ðŸ”Ÿ RAW MATERIALS FROM BOM\r\n#         # -----------------------------------------------------\r\n#         for b in bom_doc.items:\r\n#             wo.append(\"required_items\", {\r\n#                 \"item_code\": b.item_code,\r\n#                 \"required_qty\": b.qty * qty,\r\n#                 \"source_warehouse\": b.source_warehouse or source_wh,\r\n#                 \"rate\": b.rate or 0\r\n#             })\r\n\r\n#         # -----------------------------------------------------\r\n#         # 1ï¸âƒ£1ï¸âƒ£ OPERATIONS FROM BOM\r\n#         # -----------------------------------------------------\r\n#         if bom_doc.with_operations:\r\n#             for op in bom_doc.operations:\r\n#                 wo.append(\"operations\", {\r\n#                     \"operation\": op.operation,\r\n#                     \"workstation\": op.workstation,\r\n#                     \"time_in_mins\": op.time_in_mins or 0,\r\n#                     \"sequence_id\": op.sequence_id or op.idx\r\n#                 })\r\n\r\n#         # -----------------------------------------------------\r\n#         # 1ï¸âƒ£2ï¸âƒ£ INSERT & SUBMIT WORK ORDER\r\n#         # -----------------------------------------------------\r\n#         wo.flags.ignore_validate = True\r\n#         wo.flags.ignore_validate_update_after_submit = True\r\n#         wo.flags.ignore_workflow = True\r\n\r\n#         wo.insert(ignore_permissions=True)\r\n#         wo.submit()\r\n\r\n#         # -----------------------------------------------------\r\n#         # 1ï¸âƒ£3ï¸âƒ£ RESET MATERIAL TRANSFER FLAGS\r\n#         # -----------------------------------------------------\r\n#         frappe.db.set_value(\r\n#             \"Work Order\",\r\n#             wo.name,\r\n#             {\r\n#                 \"material_transferred_for_manufacturing\": 0,\r\n#                 \"status\": \"Not Started\"\r\n#             },\r\n#             update_modified=False\r\n#         )\r\n\r\n#         work_orders_created.append(wo.name)\r\n\r\n#     # ---------------------------------------------------------\r\n#     # 1ï¸âƒ£4ï¸âƒ£ SUCCESS MESSAGE\r\n#     # ---------------------------------------------------------\r\n#     if work_orders_created:\r\n#         frappe.msgprint(\r\n#             \"Work Orders Created:<br><b>\" + \"<br>\".join(work_orders_created) + \"</b>\",\r\n#             indicator=\"green\",\r\n#             title=\"Success\"\r\n#         )\r\n\r\n# except Exception:\r\n#     import traceback\r\n#     frappe.log_error(\r\n#         traceback.format_exc(),\r\n#         \"JOB INWARD AUTO WORK ORDER ERROR\"\r\n#     )\r\n#     frappe.throw(\"Error occurred while creating Work Orders\")\r\n\r\n\r\n\r\ntry:\r\n    # List to store successfully created Work Order names\r\n    work_orders_created = []\r\n\r\n    # ---------------------------------------------------------\r\n    # 1ï¸âƒ£ BASIC VALIDATION\r\n    # ---------------------------------------------------------\r\n\r\n    # Get company from current document (Job Inward / In-House Job)\r\n    company = doc.company\r\n\r\n    # Company is mandatory\r\n    if not company:\r\n        frappe.throw(\"Company is mandatory\")\r\n\r\n    # Subcontracting Order is mandatory to proceed\r\n    if not doc.subcontracting_order:\r\n        frappe.throw(\"Subcontracting Order is mandatory\")\r\n\r\n    # ---------------------------------------------------------\r\n    # 2ï¸âƒ£ HELPER FUNCTION: AUTO-DETECT WAREHOUSE\r\n    # ---------------------------------------------------------\r\n    # This function finds a warehouse based on keywords\r\n    # Example: Raw, Store, WIP, FG etc.\r\n    def get_warehouse(company, keywords):\r\n        wh = frappe.get_all(\r\n            \"Warehouse\",\r\n            filters={\r\n                \"company\": company,   # Warehouse must belong to same company\r\n                \"is_group\": 0,        # Only leaf warehouses\r\n                \"disabled\": 0         # Only enabled warehouses\r\n            },\r\n            # Match warehouse name with given keywords\r\n            or_filters=[{\"warehouse_name\": [\"like\", f\"%{k}%\"]} for k in keywords],\r\n            fields=[\"name\"],\r\n            limit=1\r\n        )\r\n        # Return warehouse name if found\r\n        return wh[0].name if wh else None\r\n\r\n    # ---------------------------------------------------------\r\n    # 3ï¸âƒ£ AUTO WAREHOUSE DETECTION\r\n    # ---------------------------------------------------------\r\n\r\n    # Detect Source (Raw Material) Warehouse\r\n    source_wh = get_warehouse(company, [\"Raw\", \"Store\"])\r\n\r\n    # Detect Work In Progress Warehouse\r\n    wip_wh = get_warehouse(company, [\"WIP\", \"Work In Progress\"])\r\n\r\n    # Detect Finished Goods Warehouse\r\n    fg_wh = get_warehouse(company, [\"FG\", \"Finished\"])\r\n\r\n    # Source warehouse is mandatory\r\n    if not source_wh:\r\n        frappe.throw(\"Source Warehouse not found\")\r\n\r\n    # ---------------------------------------------------------\r\n    # 4ï¸âƒ£ FETCH SUBCONTRACTING ORDER\r\n    # ---------------------------------------------------------\r\n\r\n    # Load Subcontracting Order document\r\n    sc = frappe.get_doc(\"Subcontracting Order\", doc.subcontracting_order)\r\n\r\n    # ---------------------------------------------------------\r\n    # 5ï¸âƒ£ FETCH SALES ORDER (IF EXISTS)\r\n    # ---------------------------------------------------------\r\n\r\n    # Default Sales Order value\r\n    sales_order_name = None\r\n\r\n    # Find Sales Order linked via PO No = Subcontracting Order\r\n    sales_orders = frappe.get_all(\r\n        \"Sales Order\",\r\n        filters={\r\n            \"po_no\": doc.subcontracting_order,\r\n            \"docstatus\": 1  # Only submitted Sales Orders\r\n        },\r\n        fields=[\"name\", \"status\"],\r\n        limit=1\r\n    )\r\n\r\n    # If Sales Order found and not closed/cancelled, link it\r\n    if sales_orders:\r\n        so = frappe.get_doc(\"Sales Order\", sales_orders[0].name)\r\n        if so.status not in [\"Cancelled\", \"Closed\"]:\r\n            sales_order_name = so.name\r\n\r\n    # ---------------------------------------------------------\r\n    # 6ï¸âƒ£ LOOP THROUGH SUBCONTRACTING ORDER ITEMS\r\n    # ---------------------------------------------------------\r\n\r\n    for row in sc.items:\r\n        # Skip rows without item or quantity\r\n        if not row.item_code or not row.qty:\r\n            continue\r\n\r\n        item_code = row.item_code\r\n        qty = row.qty\r\n\r\n        # -----------------------------------------------------\r\n        # 7ï¸âƒ£ PREVENT DUPLICATE WORK ORDER\r\n        # -----------------------------------------------------\r\n\r\n        # Check if Work Order already exists for same item & subcontracting order\r\n        exists = frappe.db.exists(\r\n            \"Work Order\",\r\n            {\r\n                \"production_item\": item_code,\r\n                \"subcontracting_order\": doc.subcontracting_order,\r\n                \"docstatus\": [\"!=\", 2]  # Not cancelled\r\n            }\r\n        )\r\n\r\n        # If already exists, skip creation\r\n        if exists:\r\n            continue\r\n\r\n        # -----------------------------------------------------\r\n        # 8ï¸âƒ£ FETCH BOM (MATCH BY ITEM + COMPANY)\r\n        # -----------------------------------------------------\r\n\r\n        # Fetch latest active and submitted BOM\r\n        bom_list = frappe.get_all(\r\n            \"BOM\",\r\n            filters={\r\n                \"item\": item_code,\r\n                \"company\": company,\r\n                \"is_active\": 1,\r\n                \"docstatus\": 1\r\n            },\r\n            order_by=\"modified desc\",\r\n            pluck=\"name\",\r\n            limit=1\r\n        )\r\n\r\n        bom = bom_list[0] if bom_list else None\r\n\r\n        # If BOM not found, show warning and continue\r\n        if not bom:\r\n            frappe.msgprint(\r\n                f\"BOM not found for <b>{item_code}</b> in company <b>{company}</b>\",\r\n                indicator=\"orange\",\r\n                alert=True\r\n            )\r\n            continue\r\n\r\n        # Load BOM document\r\n        bom_doc = frappe.get_doc(\"BOM\", bom)\r\n\r\n        # -----------------------------------------------------\r\n        # ðŸ”Ž LOG RAW MATERIAL ITEMS FROM BOM\r\n        # -----------------------------------------------------\r\n\r\n        # Collect BOM raw material details for debugging\r\n        bom_items_log = []\r\n        for b in bom_doc.items:\r\n            bom_items_log.append(\r\n                f\"Item: {b.item_code}, Qty per BOM: {b.qty}, Source WH: {b.source_warehouse}\"\r\n            )\r\n\r\n        # Save BOM item details in Error Log\r\n        frappe.log_error(\r\n            \"\\n\".join(bom_items_log),\r\n            f\"BOM ITEMS FETCHED | BOM: {bom} | FG ITEM: {item_code}\"\r\n        )\r\n\r\n        # -----------------------------------------------------\r\n        # 9ï¸âƒ£ CREATE WORK ORDER\r\n        # -----------------------------------------------------\r\n\r\n        # Prepare Work Order document\r\n        wo = frappe.get_doc({\r\n            \"doctype\": \"Work Order\",\r\n            \"company\": company,\r\n            \"production_item\": item_code,\r\n            \"qty\": qty,\r\n            \"bom_no\": bom,\r\n            \"fg_warehouse\": fg_wh,\r\n            \"wip_warehouse\": wip_wh,\r\n            \"source_warehouse\": source_wh,\r\n            \"planned_start_date\": doc.inward_date or frappe.utils.today(),\r\n            \"expected_delivery_date\": doc.inward_date or frappe.utils.today(),\r\n            \"use_multi_level_bom\": 1,\r\n            \"skip_transfer\": 0,\r\n            \"transfer_material_against\": \"Work Order\",\r\n            \"subcontracting_order\": doc.subcontracting_order,\r\n            \"sales_order\": sales_order_name\r\n        })\r\n\r\n        # -----------------------------------------------------\r\n        # ðŸ”Ÿ ADD RAW MATERIALS FROM BOM TO WORK ORDER\r\n        # -----------------------------------------------------\r\n\r\n        for b in bom_doc.items:\r\n            wo.append(\"required_items\", {\r\n                \"item_code\": b.item_code,\r\n                \"required_qty\": b.qty * qty,  # BOM qty Ã— Work Order qty\r\n                \"source_warehouse\": b.source_warehouse or source_wh,\r\n                \"rate\": b.rate or 0,\r\n                # IMPORTANT: Required for material transfer\r\n                \"include_item_in_manufacturing\": 1\r\n            })\r\n\r\n        # -----------------------------------------------------\r\n        # 1ï¸âƒ£1ï¸âƒ£ ADD OPERATIONS FROM BOM\r\n        # -----------------------------------------------------\r\n\r\n        if bom_doc.with_operations:\r\n            for op in bom_doc.operations:\r\n                wo.append(\"operations\", {\r\n                    \"operation\": op.operation,\r\n                    \"workstation\": op.workstation,\r\n                    \"time_in_mins\": op.time_in_mins or 0,\r\n                    \"sequence_id\": op.sequence_id or op.idx\r\n                })\r\n\r\n        # -----------------------------------------------------\r\n        # 1ï¸âƒ£2ï¸âƒ£ INSERT & SUBMIT WORK ORDER\r\n        # -----------------------------------------------------\r\n\r\n        # Ignore validations & workflow restrictions\r\n        wo.flags.ignore_validate = True\r\n        wo.flags.ignore_validate_update_after_submit = True\r\n        wo.flags.ignore_workflow = True\r\n\r\n        # Save Work Order to database\r\n        wo.insert(ignore_permissions=True)\r\n\r\n        # Submit Work Order\r\n        wo.submit()\r\n\r\n        # -----------------------------------------------------\r\n        # 1ï¸âƒ£3ï¸âƒ£ RESET MATERIAL TRANSFER STATUS\r\n        # -----------------------------------------------------\r\n\r\n        # Ensure material transfer can happen later\r\n        frappe.db.set_value(\r\n            \"Work Order\",\r\n            wo.name,\r\n            {\r\n                \"material_transferred_for_manufacturing\": 0,\r\n                \"status\": \"Not Started\"\r\n            },\r\n            update_modified=False\r\n        )\r\n\r\n        # Store created Work Order name\r\n        work_orders_created.append(wo.name)\r\n\r\n    # ---------------------------------------------------------\r\n    # 1ï¸âƒ£4ï¸âƒ£ SUCCESS MESSAGE\r\n    # ---------------------------------------------------------\r\n\r\n    if work_orders_created:\r\n        links = [\r\n            f'<a href=\"/app/work-order/{wo}\" target=\"_blank\"><b>{wo}</b></a>'\r\n            for wo in work_orders_created\r\n        ]\r\n\r\n        frappe.msgprint(\r\n            \"Work Orders Created:<br>\" + \"<br>\".join(links),\r\n            indicator=\"green\",\r\n            title=\"Success\"\r\n        )\r\n\r\nexcept Exception:\r\n    import traceback\r\n\r\n    # Log full error traceback\r\n    frappe.log_error(\r\n        traceback.format_exc(),\r\n        \"JOB INWARD AUTO WORK ORDER ERROR\"\r\n    )\r\n\r\n    # Show generic error to user\r\n    frappe.throw(\"Error occurred while creating Work Orders\")\r\n",
  "script_type": "DocType Event"
 }
]