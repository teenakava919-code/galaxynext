[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 0,
  "modified": "2025-12-30 12:43:07.828264",
  "module": "galaxynext",
  "name": "button event",
  "script": "frappe.ui.form.on(\"Sales Order\", {\r\n    refresh: function(frm) {\r\n        // Initially hide the Finishing Instruction table\r\n        frm.toggle_display(\"finishing_instruction\", false);\r\n        \r\n        // Hide Add Row button in finishing instruction table\r\n        if (frm.fields_dict.finishing_instruction) {\r\n            frm.fields_dict.finishing_instruction.grid.cannot_add_rows = true;\r\n            frm.fields_dict.finishing_instruction.grid.wrapper.find('.grid-add-row').hide();\r\n        }\r\n        \r\n        // Initialize item finishing data storage if not exists\r\n        if (!frm.item_finishing_data) {\r\n            frm.item_finishing_data = {};\r\n        }\r\n        \r\n        // Set options for Status field in finishing instruction\r\n        setTimeout(function() {\r\n            if (frm.fields_dict.finishing_instruction && frm.fields_dict.finishing_instruction.grid) {\r\n                frm.fields_dict.finishing_instruction.grid.update_docfield_property('status', 'fieldtype', 'Select');\r\n                frm.fields_dict.finishing_instruction.grid.update_docfield_property('status', 'options', '\\nYes\\nNo');\r\n            }\r\n        }, 1000);\r\n    }\r\n});\r\n\r\nfrappe.ui.form.on(\"Sales Order Item\", {\r\n    detail: function(frm, cdt, cdn) {\r\n        let item_row = locals[cdt][cdn];\r\n        if (!item_row) return;\r\n        \r\n        // Show Finishing Instruction table\r\n        frm.toggle_display(\"finishing_instruction\", true);\r\n        \r\n        // Initialize item finishing data storage if not exists\r\n        if (!frm.item_finishing_data) {\r\n            frm.item_finishing_data = {};\r\n        }\r\n        \r\n        // Check if finishing instructions already exist for this item\r\n        if (frm.item_finishing_data[cdn]) {\r\n            // Clear current table and load saved data for this item\r\n            frm.clear_table(\"finishing_instruction\");\r\n            frm.item_finishing_data[cdn].forEach(function(saved_row) {\r\n                let child = frm.add_child(\"finishing_instruction\");\r\n                child.finish_process = saved_row.finish_process;\r\n                child.status = saved_row.status;\r\n                child.value = saved_row.value;\r\n            });\r\n            frm.refresh_field(\"finishing_instruction\");\r\n            \r\n            // Set field properties after loading data\r\n            setTimeout(function() {\r\n                if (frm.fields_dict.finishing_instruction && frm.fields_dict.finishing_instruction.grid) {\r\n                    frm.fields_dict.finishing_instruction.grid.update_docfield_property('status', 'fieldtype', 'Select');\r\n                    frm.fields_dict.finishing_instruction.grid.update_docfield_property('status', 'options', '\\nYes\\nNo');\r\n                    frm.refresh_field(\"finishing_instruction\");\r\n                }\r\n            }, 500);\r\n            \r\n            frappe.msgprint(\"Loaded saved finishing processes for Item: \" + (item_row.item_code || item_row.item_name));\r\n            return;\r\n        }\r\n        \r\n        // Clear current table for fresh data\r\n        frm.clear_table(\"finishing_instruction\");\r\n        \r\n        // Fetch finishing processes from MiscellaneousMst\r\n        frappe.call({\r\n            method: \"frappe.client.get_list\",\r\n            args: {\r\n                doctype: \"MiscellaneousMst\",\r\n                filters: {\r\n                    status: \"True\",\r\n                    trantype: \"TM-09-2025-00005\"\r\n                },\r\n                fields: [\"name\", \"value\", \"trantype\"],\r\n                order_by: \"creation asc\"\r\n            },\r\n            callback: function(res) {\r\n                if (res.message && res.message.length > 0) {\r\n                    let finishProcessRecords = res.message.filter(function(record) {\r\n                        return record.trantype === \"TM-09-2025-00005\";\r\n                    });\r\n                    if (finishProcessRecords.length > 0) {\r\n                        // Add fresh rows for this item\r\n                        finishProcessRecords.forEach(function(d) {\r\n                            let child = frm.add_child(\"finishing_instruction\");\r\n                            child.finish_process = d.value;    // Process name\r\n                            child.status = \"\";                 // Blank for user selection\r\n                            child.value = \"\";                  // Blank for user input\r\n                        });\r\n                        \r\n                        // Save this fresh data for current item\r\n                        frm.item_finishing_data[cdn] = frm.doc.finishing_instruction.map(function(row) {\r\n                            return {\r\n                                finish_process: row.finish_process,\r\n                                status: row.status,\r\n                                value: row.value\r\n                            };\r\n                        });\r\n                        \r\n                        // Mark form as dirty to enable save\r\n                        frm.dirty();\r\n                        \r\n                        // Refresh the table display\r\n                        frm.refresh_field(\"finishing_instruction\");\r\n                        \r\n                        // Set field properties for Status dropdown\r\n                        setTimeout(function() {\r\n                            if (frm.fields_dict.finishing_instruction && frm.fields_dict.finishing_instruction.grid) {\r\n                                frm.fields_dict.finishing_instruction.grid.update_docfield_property('status', 'fieldtype', 'Select');\r\n                                frm.fields_dict.finishing_instruction.grid.update_docfield_property('status', 'options', '\\nYes\\nNo');\r\n                                frm.refresh_field(\"finishing_instruction\");\r\n                            }\r\n                            \r\n                            // Hide Add Row button after adding records\r\n                            frm.fields_dict.finishing_instruction.grid.cannot_add_rows = true;\r\n                            frm.fields_dict.finishing_instruction.grid.wrapper.find('.grid-add-row').hide();\r\n                        }, 500);\r\n                        \r\n                        frappe.msgprint(\"Fresh finishing processes loaded for Item: \" + (item_row.item_code || item_row.item_name || \"Selected Item\"));\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n});\r\n\r\n// Save finishing instruction changes for current item\r\nfrappe.ui.form.on(\"Finishing Instruction\", {\r\n    status: function(frm, cdt, cdn) {\r\n        save_current_finishing_data(frm);\r\n    },\r\n    value: function(frm, cdt, cdn) {\r\n        save_current_finishing_data(frm);\r\n    }\r\n});\r\n\r\n// Function to save current finishing data\r\nfunction save_current_finishing_data(frm) {\r\n    // Find which item is currently active (this is a limitation, we'll save for all)\r\n    // Since we can't track active item perfectly, we'll update the storage\r\n    if (frm.item_finishing_data && frm.doc.finishing_instruction) {\r\n        // Get current finishing instruction data\r\n        let current_data = frm.doc.finishing_instruction.map(function(row) {\r\n            return {\r\n                finish_process: row.finish_process,\r\n                status: row.status,\r\n                value: row.value\r\n            };\r\n        });\r\n        \r\n        // Save to the most recently accessed item (limitation of current approach)\r\n        let last_item_key = Object.keys(frm.item_finishing_data).pop();\r\n        if (last_item_key) {\r\n            frm.item_finishing_data[last_item_key] = current_data;\r\n        }\r\n    }\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 0,
  "modified": "2025-12-30 11:44:39.364132",
  "module": "galaxynext",
  "name": "Make PO No Clickable",
  "script": "frappe.ui.form.on('Sales Order', {\r\n    refresh: function(frm) {\r\n        // Check if po_no field has value and starts with \"SC-ORD\"\r\n        if (frm.doc.po_no && frm.doc.po_no.startsWith('SC-ORD')) {\r\n            \r\n            // Get the po_no field wrapper\r\n            let po_field = frm.fields_dict.po_no;\r\n            \r\n            // Make it look like a link\r\n            $(po_field.input_area).find('input').css({\r\n                'color': '#2490ef',\r\n                'text-decoration': 'underline',\r\n                'cursor': 'pointer'\r\n            });\r\n            \r\n            // Add click event to open Subcontracting Order\r\n            $(po_field.input_area).off('click').on('click', function(e) {\r\n                if (frm.doc.po_no && frm.doc.po_no.startsWith('SC-ORD')) {\r\n                    // Open Subcontracting Order in new tab\r\n                    frappe.set_route('Form', 'Subcontracting Order', frm.doc.po_no);\r\n                    e.preventDefault();\r\n                    e.stopPropagation();\r\n                }\r\n            });\r\n            \r\n            // Change mouse cursor on hover\r\n            $(po_field.input_area).hover(\r\n                function() {\r\n                    $(this).css('cursor', 'pointer');\r\n                },\r\n                function() {\r\n                    $(this).css('cursor', 'default');\r\n                }\r\n            );\r\n        }\r\n    },\r\n    \r\n    po_no: function(frm) {\r\n        // Trigger refresh when po_no changes\r\n        frm.trigger('refresh');\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Customer",
  "enabled": 1,
  "modified": "2025-08-23 12:02:04.981672",
  "module": null,
  "name": "customer testing script",
  "script": " frappe.ui.form.on('Customer', {\r\n    test_value_1: function(frm) {\r\n        // àªœàª¯àª¾àª°à«‡ Test Value 1 change àª¥àª¾àª¯\r\n        frappe.show_alert({\r\n            message: __('You typed: {0}', [frm.doc.test_value_1]),\r\n            indicator: 'blue'\r\n        }, 5);\r\n    },\r\n\r\n    test_value_2: function(frm) {\r\n        // Test Value 2 change àª¥àª¾àª¯ àª¤à«àª¯àª¾àª°à«‡ Test Value 1 auto update\r\n        if (frm.doc.test_value_2) {\r\n            frm.set_value('test_value_1', frm.doc.test_value_2.toUpperCase());\r\n            frappe.msgprint(__('Test Value 1 auto-filled with UPPERCASE of Test Value 2'));\r\n        }\r\n    }\r\n});\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Supplier",
  "enabled": 1,
  "modified": "2025-08-23 13:02:09.588259",
  "module": null,
  "name": "supplier testing script",
  "script": "frappe.ui.form.on('Supplier', {\r\n    test_value_1: function(frm) {\r\n        // àªœàª¯àª¾àª°à«‡ Test Value 1 change àª¥àª¾àª¯\r\n        frappe.show_alert({\r\n            message: __('You typed: {0}', [frm.doc.test_value_1]),\r\n            indicator: 'blue'\r\n        }, 5);\r\n    },\r\n\r\n    test_value_2: function(frm) {\r\n        // Test Value 2 change àª¥àª¾àª¯ àª¤à«àª¯àª¾àª°à«‡ Test Value 1 auto update\r\n        if (frm.doc.test_value_2) {\r\n            frm.set_value('test_value_1', frm.doc.test_value_2.toUpperCase());\r\n            frappe.msgprint(__('Test Value 1 auto-filled with UPPERCASE of Test Value 2'));\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Project",
  "enabled": 1,
  "modified": "2025-08-22 12:21:57.376979",
  "module": null,
  "name": "project script",
  "script": "frappe.ui.form.on('Project', {\r\n    refresh(frm) {\r\n        // Add a label highlight effect\r\n        frm.fields_dict.client_name.$wrapper.css({\r\n            'background-color': '#e0ffe0',\r\n            'font-weight': 'bold'\r\n        });\r\n\r\n        // Automatically set a field if empty\r\n        if (!frm.doc.client_name) {\r\n            frm.set_value('client_name', 'Auto-filled by script');\r\n            frappe.show_alert({ \r\n                message: __('Client Name auto-filled'), \r\n                indicator: 'green' \r\n            });\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Campaign",
  "enabled": 1,
  "modified": "2025-08-25 15:08:52.904598",
  "module": "galaxynext",
  "name": "campaign client script",
  "script": "frappe.ui.form.on(\"Campaign\", {\r\n    refresh(frm) {\r\n        // Page refresh àª¥àª¤àª¾àª¨à«€ àª¸àª¾àª¥à«‡ message àª¬àª¤àª¾àªµàª¶à«‡\r\n        frappe.msgprint(\"Contact form loaded successfully!\");\r\n    },\r\n\r\n    test_checkbox(frm) {\r\n        if (frm.doc.test_checkbox) {\r\n            frappe.msgprint(\"âœ… Checkbox selected!\");\r\n        } else {\r\n            frappe.msgprint(\"âŒ Checkbox unselected!\");\r\n        }\r\n    },\r\n\r\n    test_remarks(frm) {\r\n        if (frm.doc.test_remarks) {\r\n            frappe.show_alert({\r\n                message: __(\"You entered: \" + frm.doc.test_remarks),\r\n                indicator: \"green\"\r\n            }, 5);\r\n        }\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Prospect",
  "enabled": 1,
  "modified": "2025-08-26 15:04:54.971402",
  "module": null,
  "name": "prospect client script",
  "script": "frappe.ui.form.on(\"Prospect\", {\r\n    refresh(frm) {\r\n        // Page refresh àª¥àª¤àª¾àª¨à«€ àª¸àª¾àª¥à«‡ message àª¬àª¤àª¾àªµàª¶à«‡\r\n        frappe.msgprint(\"Contact form loaded successfully!\");\r\n    },\r\n\r\n    test_checkbox(frm) {\r\n        if (frm.doc.test_checkbox) {\r\n            frappe.msgprint(\"âœ… Checkbox selected!\");\r\n        } else {\r\n            frappe.msgprint(\"âŒ Checkbox unselected!\");\r\n        }\r\n    },\r\n\r\n    test_remarks(frm) {\r\n        if (frm.doc.test_remarks) {\r\n            frappe.show_alert({\r\n                message: __(\"You entered: \" + frm.doc.test_remarks),\r\n                indicator: \"green\"\r\n            }, 5);\r\n        }\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Opportunity",
  "enabled": 1,
  "modified": "2025-08-25 16:26:07.133879",
  "module": null,
  "name": "opportunity client script",
  "script": "frappe.ui.form.on(\"Opportunity\", {\r\n    refresh(frm) {\r\n        // Page refresh àª¥àª¤àª¾àª¨à«€ àª¸àª¾àª¥à«‡ message àª¬àª¤àª¾àªµàª¶à«‡\r\n        frappe.msgprint(\"Contact form loaded successfully!\");\r\n    },\r\n\r\n    test_checkbox(frm) {\r\n        if (frm.doc.test_checkbox) {\r\n            frappe.msgprint(\"âœ… Checkbox selected!\");\r\n        } else {\r\n            frappe.msgprint(\"âŒ Checkbox unselected!\");\r\n        }\r\n    },\r\n\r\n    test_remarks(frm) {\r\n        if (frm.doc.test_remarks) {\r\n            frappe.show_alert({\r\n                message: __(\"You entered: \" + frm.doc.test_remarks),\r\n                indicator: \"green\"\r\n            }, 5);\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Lead",
  "enabled": 1,
  "modified": "2025-08-26 15:03:09.029573",
  "module": null,
  "name": "lead client script",
  "script": "frappe.ui.form.on(\"Lead\", {\r\n    refresh(frm) {\r\n        // Page refresh àª¥àª¤àª¾àª¨à«€ àª¸àª¾àª¥à«‡ message àª¬àª¤àª¾àªµàª¶à«‡\r\n        frappe.msgprint(\"Contact form loaded successfully!\");\r\n    },\r\n\r\n    test_checkbox(frm) {\r\n        if (frm.doc.test_checkbox) {\r\n            frappe.msgprint(\"âœ… Checkbox selected!\");\r\n        } else {\r\n            frappe.msgprint(\"âŒ Checkbox unselected!\");\r\n        }\r\n    },\r\n\r\n    test_remarks(frm) {\r\n        if (frm.doc.test_remarks) {\r\n            frappe.show_alert({\r\n                message: __(\"You entered: \" + frm.doc.test_remarks),\r\n                indicator: \"green\"\r\n            }, 5);\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Contract",
  "enabled": 1,
  "modified": "2025-08-25 16:43:11.309979",
  "module": null,
  "name": "contract client script",
  "script": "frappe.ui.form.on(\"Contract\", {\r\n    refresh(frm) {\r\n        // Page refresh àª¥àª¤àª¾àª¨à«€ àª¸àª¾àª¥à«‡ message àª¬àª¤àª¾àªµàª¶à«‡\r\n        frappe.msgprint(\"Contact form loaded successfully!\");\r\n    },\r\n\r\n    test_checkbox(frm) {\r\n        if (frm.doc.test_checkbox) {\r\n            frappe.msgprint(\"âœ… Checkbox selected!\");\r\n        } else {\r\n            frappe.msgprint(\"âŒ Checkbox unselected!\");\r\n        }\r\n    },\r\n\r\n    test_remarks(frm) {\r\n        if (frm.doc.test_remarks) {\r\n            frappe.show_alert({\r\n                message: __(\"You entered: \" + frm.doc.test_remarks),\r\n                indicator: \"green\"\r\n            }, 5);\r\n        }\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2025-12-30 12:27:20.272377",
  "module": "galaxynext",
  "name": "auto fill sale order",
  "script": "// frappe.ui.form.on('Sales Order', {\r\n//     refresh(frm) {\r\n//         // âœ… Make po_no field clickable to open Subcontracting Order\r\n//         if (frm.doc.po_no && frm.doc.po_no.startsWith('SC-ORD-')) {\r\n//             frm.fields_dict['po_no'].$wrapper.find('input').css('cursor', 'pointer');\r\n//             frm.fields_dict['po_no'].$wrapper.off('click').on('click', function() {\r\n//                 frappe.set_route('Form', 'Subcontracting Order', frm.doc.po_no);\r\n//             });\r\n//         }\r\n\r\n//         // Show button only if document is new (not saved yet)\r\n//         if (frm.doc.docstatus === 0 && frm.is_new()) {\r\n//             frm.add_custom_button(__('Load From Subcontracting'), function() {\r\n//                 let d = new frappe.ui.Dialog({\r\n//                     title: 'Select Customer & Subcontracting Order',\r\n//                     fields: [\r\n//                         {\r\n//                             label: 'Internal Customer',\r\n//                             fieldname: 'customer',\r\n//                             fieldtype: 'Link',\r\n//                             options: 'Customer',\r\n//                             reqd: 1,\r\n//                             get_query: () => {\r\n//                                 return { filters: { is_internal_customer: 1 } };\r\n//                             },\r\n//                             onchange: () => {\r\n//                                 let customer = d.get_value('customer');\r\n//                                 if (customer) {\r\n//                                     frappe.call({\r\n//                                         method: \"frappe.client.get_value\",\r\n//                                         args: {\r\n//                                             doctype: \"Customer\",\r\n//                                             filters: { name: customer },\r\n//                                             fieldname: \"represents_company\"\r\n//                                         },\r\n//                                         callback(r) {\r\n//                                             if (r.message) {\r\n//                                                 d.set_value(\"customer_company\", r.message.represents_company);\r\n//                                             }\r\n//                                         }\r\n//                                     });\r\n//                                 }\r\n//                             }\r\n//                         },\r\n//                         {\r\n//                             label: 'Customer Company',\r\n//                             fieldname: 'customer_company',\r\n//                             fieldtype: 'Link',\r\n//                             options: 'Company',\r\n//                             read_only: 1\r\n//                         },\r\n//                         {\r\n//                             label: 'Subcontracting Order',\r\n//                             fieldname: 'subcontracting_order',\r\n//                             fieldtype: 'Link',\r\n//                             options: 'Subcontracting Order',\r\n//                             reqd: 1,\r\n//                             get_query: () => {\r\n//                                 return {\r\n//                                     query: \"galaxynext.api.get_available_subcontracting_orders\",\r\n//                                     filters: {\r\n//                                         company: d.get_value(\"customer_company\")\r\n//                                     }\r\n//                                 };\r\n//                             }\r\n//                         }\r\n//                     ],\r\n//                     primary_action_label: 'Load Data',\r\n//                     primary_action(values) {\r\n//                         // Fetch Subcontracting Order\r\n//                         frappe.call({\r\n//                             method: \"frappe.client.get\",\r\n//                             args: {\r\n//                                 doctype: \"Subcontracting Order\",\r\n//                                 name: values.subcontracting_order\r\n//                             },\r\n//                             callback(r) {\r\n//                                 let sco = r.message;\r\n\r\n//                                 // Get Supplier Company first\r\n//                                 frappe.call({\r\n//                                     method: \"frappe.client.get_value\",\r\n//                                     args: {\r\n//                                         doctype: \"Supplier\",\r\n//                                         filters: { name: sco.supplier },\r\n//                                         fieldname: \"represents_company\"\r\n//                                     },\r\n//                                     callback(res) {\r\n//                                         if (!res.message || !res.message.represents_company) {\r\n//                                             frappe.msgprint(__(\"Supplier company not found\"));\r\n//                                             return;\r\n//                                         }\r\n\r\n//                                         let supplier_company = res.message.represents_company;\r\n\r\n//                                         // âœ… Set ALL main fields from Subcontracting Order\r\n//                                         frm.set_value(\"company\", supplier_company);\r\n//                                         frm.set_value(\"customer\", values.customer);\r\n//                                         frm.set_value(\"po_no\", sco.name); // SC-ORD-2025-00020\r\n//                                         frm.set_value(\"delivery_date\", sco.schedule_date);\r\n                                        \r\n//                                         // âœ… Store additional data in console for reference (not shown in form)\r\n//                                         console.log(\"ðŸ“¦ Subcontracting Order Full Data:\", {\r\n//                                             subcontracting_order: sco.name,\r\n//                                             purchase_order: sco.purchase_order,\r\n//                                             job_worker: sco.supplier,\r\n//                                             job_worker_name: sco.supplier_name,\r\n//                                             job_worker_warehouse: sco.supplier_warehouse,\r\n//                                             company: sco.company,\r\n//                                             schedule_date: sco.schedule_date,\r\n//                                             items: sco.items\r\n//                                         });\r\n\r\n//                                         // Clear existing items\r\n//                                         frm.clear_table(\"items\");\r\n\r\n//                                         let items = sco.items || [];\r\n                                        \r\n//                                         if (items.length === 0) {\r\n//                                             frappe.show_alert({\r\n//                                                 message: __(\"No items found in Subcontracting Order\"),\r\n//                                                 indicator: 'orange'\r\n//                                             });\r\n//                                             frm.refresh_fields();\r\n//                                             return;\r\n//                                         }\r\n\r\n//                                         let processed = 0;\r\n\r\n//                                         // Process each item\r\n//                                         items.forEach((item) => {\r\n//                                             // Get correct warehouse for this company\r\n//                                             frappe.call({\r\n//                                                 method: \"galaxynext.api.get_item_default_warehouse\",\r\n//                                                 args: {\r\n//                                                     item_code: item.item_code,\r\n//                                                     company: supplier_company\r\n//                                                 },\r\n//                                                 callback(wr) {\r\n//                                                     let warehouse = wr.message || item.warehouse;\r\n\r\n//                                                     // Add item row\r\n//                                                     let row = frm.add_child(\"items\");\r\n//                                                     row.item_code = item.item_code;\r\n//                                                     row.item_name = item.item_name;\r\n//                                                     row.qty = item.qty;\r\n//                                                     row.uom = item.uom || item.stock_uom;\r\n//                                                     row.delivery_date = sco.schedule_date;\r\n//                                                     row.warehouse = warehouse;\r\n//                                                     row.rate = item.rate || item.amount || item.valuation_rate || 0;\r\n\r\n//                                                     processed++;\r\n\r\n//                                                     // âœ… Refresh ALL fields after all items loaded\r\n//                                                     if (processed === items.length) {\r\n//                                                         // Refresh both header fields and items table\r\n//                                                         frm.refresh_field(\"company\");\r\n//                                                         frm.refresh_field(\"customer\");\r\n//                                                         frm.refresh_field(\"po_no\");\r\n//                                                         frm.refresh_field(\"delivery_date\");\r\n//                                                         frm.refresh_field(\"items\");\r\n                                                        \r\n//                                                         frappe.show_alert({\r\n//                                                             message: __(\"{0} items loaded successfully from {1}\", [processed, sco.name]),\r\n//                                                             indicator: 'green'\r\n//                                                         });\r\n\r\n//                                                         // âœ… Final data check in console\r\n//                                                         console.log(\"âœ… Sales Order Data Loaded:\", {\r\n//                                                             company: frm.doc.company,\r\n//                                                             customer: frm.doc.customer,\r\n//                                                             po_no: frm.doc.po_no,\r\n//                                                             delivery_date: frm.doc.delivery_date,\r\n//                                                             items_count: frm.doc.items.length,\r\n//                                                             items: frm.doc.items\r\n//                                                         });\r\n//                                                     }\r\n//                                                 }\r\n//                                             });\r\n//                                         });\r\n//                                     }\r\n//                                 });\r\n//                             }\r\n//                         });\r\n\r\n//                         d.hide();\r\n//                     }\r\n//                 });\r\n\r\n//                 d.show();\r\n//             });\r\n//         }\r\n//     }\r\n// });\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// frappe.ui.form.on('Sales Order', {\r\n//     refresh(frm) {\r\n//         // âœ… Make po_no field clickable to open Subcontracting Order\r\n//         if (frm.doc.po_no && frm.doc.po_no.startsWith('SC-ORD-')) {\r\n//             frm.fields_dict['po_no'].$wrapper.find('input').css('cursor', 'pointer');\r\n//             frm.fields_dict['po_no'].$wrapper.off('click').on('click', function() {\r\n//                 frappe.set_route('Form', 'Subcontracting Order', frm.doc.po_no);\r\n//             });\r\n//         }\r\n\r\n//         // Show button only if document is new (not saved yet)\r\n//         if (frm.doc.docstatus === 0 && frm.is_new()) {\r\n//             frm.add_custom_button(__('Load From Subcontracting'), function() {\r\n//                 let d = new frappe.ui.Dialog({\r\n//                     title: 'Select Company, Customer & Subcontracting Order',\r\n//                     fields: [\r\n//                         {\r\n//                             label: 'Select Company',\r\n//                             fieldname: 'selected_company',\r\n//                             fieldtype: 'Link',\r\n//                             options: 'Company',\r\n//                             reqd: 1,\r\n//                             onchange: () => {\r\n//                                 // Clear customer and subcontracting order when company changes\r\n//                                 d.set_value('customer', '');\r\n//                                 d.set_value('customer_company', '');\r\n//                                 d.set_value('subcontracting_order', '');\r\n                                \r\n//                                 // Refresh customer field to apply new filters\r\n//                                 d.fields_dict.customer.get_query = () => {\r\n//                                     let selected_company = d.get_value('selected_company');\r\n//                                     return {\r\n//                                         query: \"galaxynext.api.get_allowed_internal_customers\",\r\n//                                         filters: {\r\n//                                             company: selected_company\r\n//                                         }\r\n//                                     };\r\n//                                 };\r\n//                                 d.fields_dict.customer.refresh();\r\n//                             }\r\n//                         },\r\n//                         {\r\n//                             label: 'Internal Customer',\r\n//                             fieldname: 'customer',\r\n//                             fieldtype: 'Link',\r\n//                             options: 'Customer',\r\n//                             reqd: 1,\r\n//                             get_query: () => {\r\n//                                 let selected_company = d.get_value('selected_company');\r\n//                                 if (!selected_company) {\r\n//                                     frappe.msgprint(__('Please select a company first'));\r\n//                                     return { filters: { name: ['=', ''] } };\r\n//                                 }\r\n//                                 return {\r\n//                                     query: \"galaxynext.api.get_allowed_internal_customers\",\r\n//                                     filters: {\r\n//                                         company: selected_company\r\n//                                     }\r\n//                                 };\r\n//                             },\r\n//                             onchange: () => {\r\n//                                 let customer = d.get_value('customer');\r\n//                                 if (customer) {\r\n//                                     frappe.call({\r\n//                                         method: \"frappe.client.get_value\",\r\n//                                         args: {\r\n//                                             doctype: \"Customer\",\r\n//                                             filters: { name: customer },\r\n//                                             fieldname: \"represents_company\"\r\n//                                         },\r\n//                                         callback(r) {\r\n//                                             if (r.message) {\r\n//                                                 d.set_value(\"customer_company\", r.message.represents_company);\r\n//                                             }\r\n//                                         }\r\n//                                     });\r\n//                                 }\r\n//                             }\r\n//                         },\r\n//                         {\r\n//                             label: 'Customer Company',\r\n//                             fieldname: 'customer_company',\r\n//                             fieldtype: 'Link',\r\n//                             options: 'Company',\r\n//                             read_only: 1\r\n//                         },\r\n//                         {\r\n//                             label: 'Subcontracting Order',\r\n//                             fieldname: 'subcontracting_order',\r\n//                             fieldtype: 'Link',\r\n//                             options: 'Subcontracting Order',\r\n//                             reqd: 1,\r\n//                             get_query: () => {\r\n//                                 let customer_company = d.get_value(\"customer_company\");\r\n//                                 if (!customer_company) {\r\n//                                     frappe.msgprint(__('Please select a customer first'));\r\n//                                     return { filters: { name: ['=', ''] } };\r\n//                                 }\r\n//                                 return {\r\n//                                     query: \"galaxynext.api.get_available_subcontracting_orders\",\r\n//                                     filters: {\r\n//                                         company: customer_company\r\n//                                     }\r\n//                                 };\r\n//                             }\r\n//                         }\r\n//                     ],\r\n//                     primary_action_label: 'Load Data',\r\n//                     primary_action(values) {\r\n//                         // Fetch Subcontracting Order\r\n//                         frappe.call({\r\n//                             method: \"frappe.client.get\",\r\n//                             args: {\r\n//                                 doctype: \"Subcontracting Order\",\r\n//                                 name: values.subcontracting_order\r\n//                             },\r\n//                             callback(r) {\r\n//                                 let sco = r.message;\r\n\r\n//                                 // Get Supplier Company first\r\n//                                 frappe.call({\r\n//                                     method: \"frappe.client.get_value\",\r\n//                                     args: {\r\n//                                         doctype: \"Supplier\",\r\n//                                         filters: { name: sco.supplier },\r\n//                                         fieldname: \"represents_company\"\r\n//                                     },\r\n//                                     callback(res) {\r\n//                                         if (!res.message || !res.message.represents_company) {\r\n//                                             frappe.msgprint(__(\"Supplier company not found\"));\r\n//                                             return;\r\n//                                         }\r\n\r\n//                                         let supplier_company = res.message.represents_company;\r\n\r\n//                                         // âœ… Verify that selected company matches supplier company\r\n//                                         if (supplier_company !== values.selected_company) {\r\n//                                             frappe.msgprint(__(\"Selected company does not match the supplier company\"));\r\n//                                             return;\r\n//                                         }\r\n\r\n//                                         // âœ… Set ALL main fields from Subcontracting Order\r\n//                                         frm.set_value(\"company\", supplier_company);\r\n//                                         frm.set_value(\"customer\", values.customer);\r\n//                                         frm.set_value(\"po_no\", sco.name);\r\n//                                         frm.set_value(\"delivery_date\", sco.schedule_date);\r\n                                        \r\n//                                         // âœ… Store additional data in console for reference\r\n//                                         console.log(\"ðŸ“¦ Subcontracting Order Full Data:\", {\r\n//                                             subcontracting_order: sco.name,\r\n//                                             purchase_order: sco.purchase_order,\r\n//                                             job_worker: sco.supplier,\r\n//                                             job_worker_name: sco.supplier_name,\r\n//                                             job_worker_warehouse: sco.supplier_warehouse,\r\n//                                             company: sco.company,\r\n//                                             schedule_date: sco.schedule_date,\r\n//                                             items: sco.items\r\n//                                         });\r\n\r\n//                                         // Clear existing items\r\n//                                         frm.clear_table(\"items\");\r\n\r\n//                                         let items = sco.items || [];\r\n                                        \r\n//                                         if (items.length === 0) {\r\n//                                             frappe.show_alert({\r\n//                                                 message: __(\"No items found in Subcontracting Order\"),\r\n//                                                 indicator: 'orange'\r\n//                                             });\r\n//                                             frm.refresh_fields();\r\n//                                             return;\r\n//                                         }\r\n\r\n//                                         let processed = 0;\r\n\r\n//                                         // Process each item\r\n//                                         items.forEach((item) => {\r\n//                                             // Get correct warehouse for this company\r\n//                                             frappe.call({\r\n//                                                 method: \"galaxynext.api.get_item_default_warehouse\",\r\n//                                                 args: {\r\n//                                                     item_code: item.item_code,\r\n//                                                     company: supplier_company\r\n//                                                 },\r\n//                                                 callback(wr) {\r\n//                                                     let warehouse = wr.message || item.warehouse;\r\n\r\n//                                                     // Add item row\r\n//                                                     let row = frm.add_child(\"items\");\r\n//                                                     row.item_code = item.item_code;\r\n//                                                     row.item_name = item.item_name;\r\n//                                                     row.qty = item.qty;\r\n//                                                     row.uom = item.uom || item.stock_uom;\r\n//                                                     row.delivery_date = sco.schedule_date;\r\n//                                                     row.warehouse = warehouse;\r\n//                                                     row.rate = item.rate || item.amount || item.valuation_rate || 0;\r\n\r\n//                                                     processed++;\r\n\r\n//                                                     // âœ… Refresh ALL fields after all items loaded\r\n//                                                     if (processed === items.length) {\r\n//                                                         frm.refresh_field(\"company\");\r\n//                                                         frm.refresh_field(\"customer\");\r\n//                                                         frm.refresh_field(\"po_no\");\r\n//                                                         frm.refresh_field(\"delivery_date\");\r\n//                                                         frm.refresh_field(\"items\");\r\n                                                        \r\n//                                                         frappe.show_alert({\r\n//                                                             message: __(\"{0} items loaded successfully from {1}\", [processed, sco.name]),\r\n//                                                             indicator: 'green'\r\n//                                                         });\r\n\r\n//                                                         // âœ… Final data check in console\r\n//                                                         console.log(\"âœ… Sales Order Data Loaded:\", {\r\n//                                                             company: frm.doc.company,\r\n//                                                             customer: frm.doc.customer,\r\n//                                                             po_no: frm.doc.po_no,\r\n//                                                             delivery_date: frm.doc.delivery_date,\r\n//                                                             items_count: frm.doc.items.length,\r\n//                                                             items: frm.doc.items\r\n//                                                         });\r\n//                                                     }\r\n//                                                 }\r\n//                                             });\r\n//                                         });\r\n//                                     }\r\n//                                 });\r\n//                             }\r\n//                         });\r\n\r\n//                         d.hide();\r\n//                     }\r\n//                 });\r\n\r\n//                 d.show();\r\n//             });\r\n//         }\r\n//     }\r\n// });\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// frappe.ui.form.on('Sales Order', {\r\n//     refresh(frm) {\r\n//         // âœ… Make po_no field clickable to open Subcontracting Order\r\n//         if (frm.doc.po_no && frm.doc.po_no.startsWith('SC-ORD-')) {\r\n//             frm.fields_dict['po_no'].$wrapper.find('input').css('cursor', 'pointer');\r\n//             frm.fields_dict['po_no'].$wrapper.off('click').on('click', function() {\r\n//                 frappe.set_route('Form', 'Subcontracting Order', frm.doc.po_no);\r\n//             });\r\n//         }\r\n\r\n//         // Show button only if document is new (not saved yet)\r\n//         if (frm.doc.docstatus === 0 && frm.is_new()) {\r\n//             frm.add_custom_button(__('Load From Subcontracting'), function() {\r\n//                 let d = new frappe.ui.Dialog({\r\n//                     title: 'Select Company, Customer & Subcontracting Order',\r\n//                     fields: [\r\n//                         {\r\n//                             label: 'Select Company',\r\n//                             fieldname: 'selected_company',\r\n//                             fieldtype: 'Link',\r\n//                             options: 'Company',\r\n//                             reqd: 1,\r\n//                             onchange: () => {\r\n//                                 // Clear customer and subcontracting order when company changes\r\n//                                 d.set_value('customer', '');\r\n//                                 d.set_value('customer_company', '');\r\n//                                 d.set_value('subcontracting_order', '');\r\n                                \r\n//                                 // Refresh customer field to apply new filters\r\n//                                 d.fields_dict.customer.get_query = () => {\r\n//                                     let selected_company = d.get_value('selected_company');\r\n//                                     return {\r\n//                                         query: \"galaxynext.api.get_allowed_internal_customers\",\r\n//                                         filters: {\r\n//                                             company: selected_company\r\n//                                         }\r\n//                                     };\r\n//                                 };\r\n//                                 d.fields_dict.customer.refresh();\r\n//                             }\r\n//                         },\r\n//                         {\r\n//                             label: 'Internal Customer',\r\n//                             fieldname: 'customer',\r\n//                             fieldtype: 'Link',\r\n//                             options: 'Customer',\r\n//                             reqd: 1,\r\n//                             get_query: () => {\r\n//                                 let selected_company = d.get_value('selected_company');\r\n//                                 if (!selected_company) {\r\n//                                     frappe.msgprint(__('Please select a company first'));\r\n//                                     return { filters: { name: ['=', ''] } };\r\n//                                 }\r\n//                                 return {\r\n//                                     query: \"galaxynext.api.get_allowed_internal_customers\",\r\n//                                     filters: {\r\n//                                         company: selected_company\r\n//                                     }\r\n//                                 };\r\n//                             },\r\n//                             onchange: () => {\r\n//                                 let customer = d.get_value('customer');\r\n//                                 if (customer) {\r\n//                                     frappe.call({\r\n//                                         method: \"frappe.client.get_value\",\r\n//                                         args: {\r\n//                                             doctype: \"Customer\",\r\n//                                             filters: { name: customer },\r\n//                                             fieldname: \"represents_company\"\r\n//                                         },\r\n//                                         callback(r) {\r\n//                                             if (r.message) {\r\n//                                                 d.set_value(\"customer_company\", r.message.represents_company);\r\n//                                             }\r\n//                                         }\r\n//                                     });\r\n//                                 }\r\n//                             }\r\n//                         },\r\n//                         {\r\n//                             label: 'Customer Company',\r\n//                             fieldname: 'customer_company',\r\n//                             fieldtype: 'Link',\r\n//                             options: 'Company',\r\n//                             read_only: 1\r\n//                         },\r\n//                         {\r\n//                             label: 'Subcontracting Order',\r\n//                             fieldname: 'subcontracting_order',\r\n//                             fieldtype: 'Link',\r\n//                             options: 'Subcontracting Order',\r\n//                             reqd: 1,\r\n//                             get_query: () => {\r\n//                                 let customer_company = d.get_value(\"customer_company\");\r\n//                                 if (!customer_company) {\r\n//                                     frappe.msgprint(__('Please select a customer first'));\r\n//                                     return { filters: { name: ['=', ''] } };\r\n//                                 }\r\n//                                 return {\r\n//                                     query: \"galaxynext.api.get_available_subcontracting_orders\",\r\n//                                     filters: {\r\n//                                         company: customer_company\r\n//                                     }\r\n//                                 };\r\n//                             }\r\n//                         }\r\n//                     ],\r\n//                     primary_action_label: 'Load Data',\r\n//                     primary_action(values) {\r\n//                         // Fetch Subcontracting Order\r\n//                         frappe.call({\r\n//                             method: \"frappe.client.get\",\r\n//                             args: {\r\n//                                 doctype: \"Subcontracting Order\",\r\n//                                 name: values.subcontracting_order\r\n//                             },\r\n//                             callback(r) {\r\n//                                 let sco = r.message;\r\n\r\n//                                 // Get Supplier Company first\r\n//                                 frappe.call({\r\n//                                     method: \"frappe.client.get_value\",\r\n//                                     args: {\r\n//                                         doctype: \"Supplier\",\r\n//                                         filters: { name: sco.supplier },\r\n//                                         fieldname: \"represents_company\"\r\n//                                     },\r\n//                                     callback(res) {\r\n//                                         if (!res.message || !res.message.represents_company) {\r\n//                                             frappe.msgprint(__(\"Supplier company not found\"));\r\n//                                             return;\r\n//                                         }\r\n\r\n//                                         let supplier_company = res.message.represents_company;\r\n\r\n//                                         // âœ… Verify that selected company matches supplier company\r\n//                                         if (supplier_company !== values.selected_company) {\r\n//                                             frappe.msgprint(__(\"Selected company does not match the supplier company\"));\r\n//                                             return;\r\n//                                         }\r\n\r\n//                                         // âœ… Set ALL main fields from Subcontracting Order\r\n//                                         frm.set_value(\"company\", supplier_company);\r\n//                                         frm.set_value(\"customer\", values.customer);\r\n//                                         frm.set_value(\"po_no\", sco.name);\r\n//                                         frm.set_value(\"delivery_date\", sco.schedule_date);\r\n                                        \r\n//                                         // âœ… Store additional data in console for reference\r\n//                                         console.log(\"ðŸ“¦ Subcontracting Order Full Data:\", {\r\n//                                             subcontracting_order: sco.name,\r\n//                                             purchase_order: sco.purchase_order,\r\n//                                             job_worker: sco.supplier,\r\n//                                             job_worker_name: sco.supplier_name,\r\n//                                             job_worker_warehouse: sco.supplier_warehouse,\r\n//                                             company: sco.company,\r\n//                                             schedule_date: sco.schedule_date,\r\n//                                             items: sco.items\r\n//                                         });\r\n\r\n//                                         // Clear existing items\r\n//                                         frm.clear_table(\"items\");\r\n\r\n//                                         let items = sco.items || [];\r\n                                        \r\n//                                         if (items.length === 0) {\r\n//                                             frappe.show_alert({\r\n//                                                 message: __(\"No items found in Subcontracting Order\"),\r\n//                                                 indicator: 'orange'\r\n//                                             });\r\n//                                             frm.refresh_fields();\r\n//                                             return;\r\n//                                         }\r\n\r\n//                                         let processed = 0;\r\n\r\n//                                         // Process each item\r\n//                                         items.forEach((item) => {\r\n//                                             // Get correct warehouse for this company\r\n//                                             frappe.call({\r\n//                                                 method: \"galaxynext.api.get_item_default_warehouse\",\r\n//                                                 args: {\r\n//                                                     item_code: item.item_code,\r\n//                                                     company: supplier_company\r\n//                                                 },\r\n//                                                 callback(wr) {\r\n//                                                     let warehouse = wr.message || item.warehouse;\r\n\r\n//                                                     // Add item row\r\n//                                                     let row = frm.add_child(\"items\");\r\n//                                                     row.item_code = item.item_code;\r\n//                                                     row.item_name = item.item_name;\r\n//                                                     row.qty = item.qty;\r\n//                                                     row.uom = item.uom || item.stock_uom;\r\n//                                                     row.delivery_date = sco.schedule_date;\r\n//                                                     row.warehouse = warehouse;\r\n//                                                     row.rate = item.rate || item.amount || item.valuation_rate || 0;\r\n\r\n//                                                     processed++;\r\n\r\n//                                                     // âœ… Refresh ALL fields after all items loaded\r\n//                                                     if (processed === items.length) {\r\n//                                                         frm.refresh_field(\"company\");\r\n//                                                         frm.refresh_field(\"customer\");\r\n//                                                         frm.refresh_field(\"po_no\");\r\n//                                                         frm.refresh_field(\"delivery_date\");\r\n//                                                         frm.refresh_field(\"items\");\r\n                                                        \r\n//                                                         frappe.show_alert({\r\n//                                                             message: __(\"{0} items loaded successfully from {1}\", [processed, sco.name]),\r\n//                                                             indicator: 'green'\r\n//                                                         });\r\n\r\n//                                                         // âœ… Final data check in console\r\n//                                                         console.log(\"âœ… Sales Order Data Loaded:\", {\r\n//                                                             company: frm.doc.company,\r\n//                                                             customer: frm.doc.customer,\r\n//                                                             po_no: frm.doc.po_no,\r\n//                                                             delivery_date: frm.doc.delivery_date,\r\n//                                                             items_count: frm.doc.items.length,\r\n//                                                             items: frm.doc.items\r\n//                                                         });\r\n//                                                     }\r\n//                                                 }\r\n//                                             });\r\n//                                         });\r\n//                                     }\r\n//                                 });\r\n//                             }\r\n//                         });\r\n\r\n//                         d.hide();\r\n//                     }\r\n//                 });\r\n\r\n//                 d.show();\r\n//             });\r\n//         }\r\n//     }\r\n// });\r\n\r\n\r\n\r\n// -----------------------------button disable--------------------------------------------------------\r\n\r\n// frappe.ui.form.on('Sales Order', {\r\n//     refresh(frm) {\r\n//         // ============================================\r\n//         // FEATURE 1: Make PO Number clickable to open Subcontracting Order\r\n//         // ============================================\r\n//         if (frm.doc.po_no && frm.doc.po_no.startsWith('SC-ORD-')) {\r\n//             // Make the field look clickable\r\n//             frm.fields_dict['po_no'].$wrapper.find('input').css('cursor', 'pointer');\r\n            \r\n//             // Add click event to open Subcontracting Order form\r\n//             frm.fields_dict['po_no'].$wrapper.off('click').on('click', function() {\r\n//                 frappe.set_route('Form', 'Subcontracting Order', frm.doc.po_no);\r\n//             });\r\n//         }\r\n\r\n//         // ============================================\r\n//         // FEATURE 2: Load From Subcontracting Button\r\n//         // Only show for new, unsaved Sales Orders\r\n//         // ============================================\r\n//         if (frm.doc.docstatus === 0 && frm.is_new()) {\r\n//             frm.add_custom_button(__('Load From Subcontracting'), function() {\r\n                \r\n//                 // Step 1: Check if data already loaded (prevent duplicate loading)\r\n//                 if (frm._subcontracting_loaded) {\r\n//                     frappe.msgprint({\r\n//                         title: __('Already Loaded'),\r\n//                         message: __('Data has already been loaded from Subcontracting Order. Please refresh the page to load again.'),\r\n//                         indicator: 'orange'\r\n//                     });\r\n//                     return;\r\n//                 }\r\n\r\n//                 // Step 2: Create dialog with 4 fields\r\n//                 let d = new frappe.ui.Dialog({\r\n//                     title: 'Select Company, Customer & Subcontracting Order',\r\n//                     fields: [\r\n//                         // ============================================\r\n//                         // FIELD 1: Company Selection\r\n//                         // ============================================\r\n//                         {\r\n//                             label: 'Select Company',\r\n//                             fieldname: 'selected_company',\r\n//                             fieldtype: 'Link',\r\n//                             options: 'Company',\r\n//                             reqd: 1,\r\n//                             onchange: () => {\r\n//                                 // When company changes, clear dependent fields\r\n//                                 d.set_value('customer', '');\r\n//                                 d.set_value('customer_company', '');\r\n//                                 d.set_value('subcontracting_order', '');\r\n                                \r\n//                                 // Update customer dropdown filter based on selected company\r\n//                                 d.fields_dict.customer.get_query = () => {\r\n//                                     let selected_company = d.get_value('selected_company');\r\n//                                     return {\r\n//                                         query: \"galaxynext.api.get_allowed_internal_customers\",\r\n//                                         filters: {\r\n//                                             company: selected_company\r\n//                                         }\r\n//                                     };\r\n//                                 };\r\n//                                 d.fields_dict.customer.refresh();\r\n//                             }\r\n//                         },\r\n                        \r\n//                         // ============================================\r\n//                         // FIELD 2: Internal Customer Selection\r\n//                         // Shows only customers allowed to transact with selected company\r\n//                         // ============================================\r\n//                         {\r\n//                             label: 'Internal Customer',\r\n//                             fieldname: 'customer',\r\n//                             fieldtype: 'Link',\r\n//                             options: 'Customer',\r\n//                             reqd: 1,\r\n//                             get_query: () => {\r\n//                                 let selected_company = d.get_value('selected_company');\r\n                                \r\n//                                 // Validate: Company must be selected first\r\n//                                 if (!selected_company) {\r\n//                                     frappe.msgprint(__('Please select a company first'));\r\n//                                     return { filters: { name: ['=', ''] } };\r\n//                                 }\r\n                                \r\n//                                 // Filter customers based on \"Allowed To Transact With\" table\r\n//                                 return {\r\n//                                     query: \"galaxynext.api.get_allowed_internal_customers\",\r\n//                                     filters: {\r\n//                                         company: selected_company\r\n//                                     }\r\n//                                 };\r\n//                             },\r\n//                             onchange: () => {\r\n//                                 let customer = d.get_value('customer');\r\n                                \r\n//                                 // Fetch and set customer's company\r\n//                                 if (customer) {\r\n//                                     frappe.call({\r\n//                                         method: \"frappe.client.get_value\",\r\n//                                         args: {\r\n//                                             doctype: \"Customer\",\r\n//                                             filters: { name: customer },\r\n//                                             fieldname: \"represents_company\"\r\n//                                         },\r\n//                                         callback(r) {\r\n//                                             if (r.message) {\r\n//                                                 d.set_value(\"customer_company\", r.message.represents_company);\r\n//                                             }\r\n//                                         }\r\n//                                     });\r\n//                                 }\r\n//                             }\r\n//                         },\r\n                        \r\n//                         // ============================================\r\n//                         // FIELD 3: Customer Company (Read-only)\r\n//                         // Auto-populated from customer's \"represents_company\" field\r\n//                         // ============================================\r\n//                         {\r\n//                             label: 'Customer Company',\r\n//                             fieldname: 'customer_company',\r\n//                             fieldtype: 'Link',\r\n//                             options: 'Company',\r\n//                             read_only: 1\r\n//                         },\r\n                        \r\n//                         // ============================================\r\n//                         // FIELD 4: Subcontracting Order Selection\r\n//                         // Shows only orders from customer's company that aren't used yet\r\n//                         // ============================================\r\n//                         {\r\n//                             label: 'Subcontracting Order',\r\n//                             fieldname: 'subcontracting_order',\r\n//                             fieldtype: 'Link',\r\n//                             options: 'Subcontracting Order',\r\n//                             reqd: 1,\r\n//                             get_query: () => {\r\n//                                 let customer_company = d.get_value(\"customer_company\");\r\n                                \r\n//                                 // Validate: Customer must be selected first\r\n//                                 if (!customer_company) {\r\n//                                     frappe.msgprint(__('Please select a customer first'));\r\n//                                     return { filters: { name: ['=', ''] } };\r\n//                                 }\r\n                                \r\n//                                 // Get available subcontracting orders (not used in any Sales Order)\r\n//                                 return {\r\n//                                     query: \"galaxynext.api.get_available_subcontracting_orders\",\r\n//                                     filters: {\r\n//                                         company: customer_company\r\n//                                     }\r\n//                                 };\r\n//                             }\r\n//                         }\r\n//                     ],\r\n                    \r\n//                     // ============================================\r\n//                     // PRIMARY ACTION: Load Data Button\r\n//                     // ============================================\r\n//                     primary_action_label: 'Load Data',\r\n//                     primary_action(values) {\r\n                        \r\n//                         // Step 1: Fetch complete Subcontracting Order document\r\n//                         frappe.call({\r\n//                             method: \"frappe.client.get\",\r\n//                             args: {\r\n//                                 doctype: \"Subcontracting Order\",\r\n//                                 name: values.subcontracting_order\r\n//                             },\r\n//                             callback(r) {\r\n//                                 let sco = r.message;\r\n\r\n//                                 // Step 2: Get supplier's company\r\n//                                 frappe.call({\r\n//                                     method: \"frappe.client.get_value\",\r\n//                                     args: {\r\n//                                         doctype: \"Supplier\",\r\n//                                         filters: { name: sco.supplier },\r\n//                                         fieldname: \"represents_company\"\r\n//                                     },\r\n//                                     callback(res) {\r\n//                                         // Validation: Supplier must have a company\r\n//                                         if (!res.message || !res.message.represents_company) {\r\n//                                             frappe.msgprint(__(\"Supplier company not found\"));\r\n//                                             return;\r\n//                                         }\r\n\r\n//                                         let supplier_company = res.message.represents_company;\r\n\r\n//                                         // Validation: Selected company must match supplier's company\r\n//                                         if (supplier_company !== values.selected_company) {\r\n//                                             frappe.msgprint(__(\"Selected company does not match the supplier company\"));\r\n//                                             return;\r\n//                                         }\r\n\r\n//                                         // ============================================\r\n//                                         // Step 3: Set Sales Order header fields\r\n//                                         // ============================================\r\n//                                         frm.set_value(\"company\", supplier_company);\r\n//                                         frm.set_value(\"customer\", values.customer);\r\n//                                         frm.set_value(\"po_no\", sco.name);  // Customer's PO Number = SC Order ID\r\n//                                         frm.set_value(\"delivery_date\", sco.schedule_date);\r\n                                        \r\n//                                         // Log full subcontracting data for debugging\r\n//                                         console.log(\"ðŸ“¦ Subcontracting Order Full Data:\", {\r\n//                                             subcontracting_order: sco.name,\r\n//                                             purchase_order: sco.purchase_order,\r\n//                                             job_worker: sco.supplier,\r\n//                                             job_worker_name: sco.supplier_name,\r\n//                                             job_worker_warehouse: sco.supplier_warehouse,\r\n//                                             company: sco.company,\r\n//                                             schedule_date: sco.schedule_date,\r\n//                                             items: sco.items\r\n//                                         });\r\n\r\n//                                         // ============================================\r\n//                                         // Step 4: Clear existing items and prepare to load new ones\r\n//                                         // ============================================\r\n//                                         frm.clear_table(\"items\");\r\n\r\n//                                         let items = sco.items || [];\r\n                                        \r\n//                                         // Check if items exist\r\n//                                         if (items.length === 0) {\r\n//                                             frappe.show_alert({\r\n//                                                 message: __(\"No items found in Subcontracting Order\"),\r\n//                                                 indicator: 'orange'\r\n//                                             });\r\n//                                             frm.refresh_fields();\r\n//                                             return;\r\n//                                         }\r\n\r\n//                                         let processed = 0;\r\n\r\n//                                         // ============================================\r\n//                                         // Step 5: Process each item from Subcontracting Order\r\n//                                         // ============================================\r\n//                                         items.forEach((item) => {\r\n//                                             // Get correct warehouse for this item and company\r\n//                                             frappe.call({\r\n//                                                 method: \"galaxynext.api.get_item_default_warehouse\",\r\n//                                                 args: {\r\n//                                                     item_code: item.item_code,\r\n//                                                     company: supplier_company\r\n//                                                 },\r\n//                                                 callback(wr) {\r\n//                                                     let warehouse = wr.message || item.warehouse;\r\n\r\n//                                                     // Add new item row to Sales Order\r\n//                                                     let row = frm.add_child(\"items\");\r\n//                                                     row.item_code = item.item_code;\r\n//                                                     row.item_name = item.item_name;\r\n//                                                     row.qty = item.qty;\r\n//                                                     row.uom = item.uom || item.stock_uom;\r\n//                                                     row.delivery_date = sco.schedule_date;\r\n//                                                     row.warehouse = warehouse;\r\n//                                                     row.rate = item.rate || item.amount || item.valuation_rate || 0;\r\n\r\n//                                                     processed++;\r\n\r\n//                                                     // ============================================\r\n//                                                     // Step 6: After all items loaded, refresh form\r\n//                                                     // ============================================\r\n//                                                     if (processed === items.length) {\r\n//                                                         // Refresh all fields to show loaded data\r\n//                                                         frm.refresh_field(\"company\");\r\n//                                                         frm.refresh_field(\"customer\");\r\n//                                                         frm.refresh_field(\"po_no\");\r\n//                                                         frm.refresh_field(\"delivery_date\");\r\n//                                                         frm.refresh_field(\"items\");\r\n                                                        \r\n//                                                         // Mark as loaded to prevent duplicate loading\r\n//                                                         frm._subcontracting_loaded = true;\r\n                                                        \r\n//                                                         // Show success message\r\n//                                                         frappe.show_alert({\r\n//                                                             message: __(\"{0} items loaded successfully from {1}\", [processed, sco.name]),\r\n//                                                             indicator: 'green'\r\n//                                                         });\r\n\r\n//                                                         // Log final loaded data for verification\r\n//                                                         console.log(\"âœ… Sales Order Data Loaded:\", {\r\n//                                                             company: frm.doc.company,\r\n//                                                             customer: frm.doc.customer,\r\n//                                                             po_no: frm.doc.po_no,\r\n//                                                             delivery_date: frm.doc.delivery_date,\r\n//                                                             items_count: frm.doc.items.length,\r\n//                                                             items: frm.doc.items\r\n//                                                         });\r\n//                                                     }\r\n//                                                 }\r\n//                                             });\r\n//                                         });\r\n//                                     }\r\n//                                 });\r\n//                             }\r\n//                         });\r\n\r\n//                         // Close dialog after processing\r\n//                         d.hide();\r\n//                     }\r\n//                 });\r\n\r\n//                 // Show the dialog\r\n//                 d.show();\r\n//             });\r\n//         }\r\n//     }\r\n// });\r\n\r\n\r\n\r\n// ------------------------------------------------working code ----------------------------------------------------\r\n\r\n// frappe.ui.form.on('Sales Order', {\r\n//     refresh(frm) {\r\n//         // ============================================\r\n//         // FEATURE 1: Make PO Number clickable to open Subcontracting Order\r\n//         // ============================================\r\n//         if (frm.doc.po_no && frm.doc.po_no.startsWith('SC-ORD-')) {\r\n//             // Make the field look clickable\r\n//             frm.fields_dict['po_no'].$wrapper.find('input').css('cursor', 'pointer');\r\n            \r\n//             // Add click event to open Subcontracting Order form\r\n//             frm.fields_dict['po_no'].$wrapper.off('click').on('click', function() {\r\n//                 frappe.set_route('Form', 'Subcontracting Order', frm.doc.po_no);\r\n//             });\r\n//         }\r\n\r\n//         // ============================================\r\n//         // FEATURE 2: Load From Subcontracting Button\r\n//         // Only show for new, unsaved Sales Orders\r\n//         // ============================================\r\n//         if (frm.doc.docstatus === 0 && frm.is_new()) {\r\n//             frm.add_custom_button(__('Load From Subcontracting'), function() {\r\n                \r\n//                 // Step 1: Check if data already loaded (prevent duplicate loading)\r\n//                 if (frm._subcontracting_loaded) {\r\n//                     frappe.msgprint({\r\n//                         title: __('Already Loaded'),\r\n//                         message: __('Data has already been loaded from Subcontracting Order. Please refresh the page to load again.'),\r\n//                         indicator: 'orange'\r\n//                     });\r\n//                     return;\r\n//                 }\r\n\r\n//                 // Step 2: Create dialog with 4 fields\r\n//                 let d = new frappe.ui.Dialog({\r\n//                     title: 'Select Company, Customer & Subcontracting Order',\r\n//                     fields: [\r\n//                         // ============================================\r\n//                         // FIELD 1: Company Selection\r\n//                         // ============================================\r\n//                         {\r\n//                             label: 'Select Company',\r\n//                             fieldname: 'selected_company',\r\n//                             fieldtype: 'Link',\r\n//                             options: 'Company',\r\n//                             reqd: 1,\r\n//                             onchange: () => {\r\n//                                 // When company changes, clear dependent fields\r\n//                                 d.set_value('customer', '');\r\n//                                 d.set_value('customer_company', '');\r\n//                                 d.set_value('subcontracting_order', '');\r\n                                \r\n//                                 // Update customer dropdown filter based on selected company\r\n//                                 d.fields_dict.customer.get_query = () => {\r\n//                                     let selected_company = d.get_value('selected_company');\r\n//                                     return {\r\n//                                         query: \"galaxynext.api.get_allowed_internal_customers\",\r\n//                                         filters: {\r\n//                                             company: selected_company\r\n//                                         }\r\n//                                     };\r\n//                                 };\r\n//                                 d.fields_dict.customer.refresh();\r\n//                             }\r\n//                         },\r\n                        \r\n//                         // ============================================\r\n//                         // FIELD 2: Internal Customer Selection\r\n//                         // Shows only customers allowed to transact with selected company\r\n//                         // ============================================\r\n//                         {\r\n//                             label: 'Internal Customer',\r\n//                             fieldname: 'customer',\r\n//                             fieldtype: 'Link',\r\n//                             options: 'Customer',\r\n//                             reqd: 1,\r\n//                             get_query: () => {\r\n//                                 let selected_company = d.get_value('selected_company');\r\n                                \r\n//                                 // Validate: Company must be selected first\r\n//                                 if (!selected_company) {\r\n//                                     frappe.msgprint(__('Please select a company first'));\r\n//                                     return { filters: { name: ['=', ''] } };\r\n//                                 }\r\n                                \r\n//                                 // Filter customers based on \"Allowed To Transact With\" table\r\n//                                 return {\r\n//                                     query: \"galaxynext.api.get_allowed_internal_customers\",\r\n//                                     filters: {\r\n//                                         company: selected_company\r\n//                                     }\r\n//                                 };\r\n//                             },\r\n//                             onchange: () => {\r\n//                                 let customer = d.get_value('customer');\r\n                                \r\n//                                 // Fetch and set customer's company\r\n//                                 if (customer) {\r\n//                                     frappe.call({\r\n//                                         method: \"frappe.client.get_value\",\r\n//                                         args: {\r\n//                                             doctype: \"Customer\",\r\n//                                             filters: { name: customer },\r\n//                                             fieldname: \"represents_company\"\r\n//                                         },\r\n//                                         callback(r) {\r\n//                                             if (r.message) {\r\n//                                                 d.set_value(\"customer_company\", r.message.represents_company);\r\n//                                             }\r\n//                                         }\r\n//                                     });\r\n//                                 }\r\n//                             }\r\n//                         },\r\n                        \r\n//                         // ============================================\r\n//                         // FIELD 3: Customer Company (Read-only)\r\n//                         // Auto-populated from customer's \"represents_company\" field\r\n//                         // ============================================\r\n//                         {\r\n//                             label: 'Customer Company',\r\n//                             fieldname: 'customer_company',\r\n//                             fieldtype: 'Link',\r\n//                             options: 'Company',\r\n//                             read_only: 1\r\n//                         },\r\n                        \r\n//                         // ============================================\r\n//                         // FIELD 4: Subcontracting Order Selection\r\n//                         // Shows only orders from customer's company that aren't used yet\r\n//                         // ============================================\r\n//                         {\r\n//                             label: 'Subcontracting Order',\r\n//                             fieldname: 'subcontracting_order',\r\n//                             fieldtype: 'Link',\r\n//                             options: 'Subcontracting Order',\r\n//                             reqd: 1,\r\n//                             get_query: () => {\r\n//                                 let customer_company = d.get_value(\"customer_company\");\r\n                                \r\n//                                 // Validate: Customer must be selected first\r\n//                                 if (!customer_company) {\r\n//                                     frappe.msgprint(__('Please select a customer first'));\r\n//                                     return { filters: { name: ['=', ''] } };\r\n//                                 }\r\n                                \r\n//                                 // Get available subcontracting orders (not used in any Sales Order)\r\n//                                 return {\r\n//                                     query: \"galaxynext.api.get_available_subcontracting_orders\",\r\n//                                     filters: {\r\n//                                         company: customer_company\r\n//                                     }\r\n//                                 };\r\n//                             }\r\n//                         }\r\n//                     ],\r\n                    \r\n//                     // ============================================\r\n//                     // PRIMARY ACTION: Load Data Button\r\n//                     // ============================================\r\n//                     primary_action_label: 'Load Data',\r\n//                     primary_action(values) {\r\n                        \r\n//                         // Step 1: Fetch complete Subcontracting Order document\r\n//                         frappe.call({\r\n//                             method: \"frappe.client.get\",\r\n//                             args: {\r\n//                                 doctype: \"Subcontracting Order\",\r\n//                                 name: values.subcontracting_order\r\n//                             },\r\n//                             callback(r) {\r\n//                                 let sco = r.message;\r\n\r\n//                                 // Step 2: Get supplier's company\r\n//                                 frappe.call({\r\n//                                     method: \"frappe.client.get_value\",\r\n//                                     args: {\r\n//                                         doctype: \"Supplier\",\r\n//                                         filters: { name: sco.supplier },\r\n//                                         fieldname: \"represents_company\"\r\n//                                     },\r\n//                                     callback(res) {\r\n//                                         // Validation: Supplier must have a company\r\n//                                         if (!res.message || !res.message.represents_company) {\r\n//                                             frappe.msgprint(__(\"Supplier company not found\"));\r\n//                                             return;\r\n//                                         }\r\n\r\n//                                         let supplier_company = res.message.represents_company;\r\n\r\n//                                         // Validation: Selected company must match supplier's company\r\n//                                         if (supplier_company !== values.selected_company) {\r\n//                                             frappe.msgprint(__(\"Selected company does not match the supplier company\"));\r\n//                                             return;\r\n//                                         }\r\n\r\n//                                         // ============================================\r\n//                                         // Step 3: Set Sales Order header fields\r\n//                                         // ============================================\r\n//                                         frm.set_value(\"company\", supplier_company);\r\n//                                         frm.set_value(\"customer\", values.customer);\r\n//                                         frm.set_value(\"po_no\", sco.name);  // Customer's PO Number = SC Order ID\r\n//                                         frm.set_value(\"po_date\", sco.transaction_date);  // Customer's PO Date\r\n//                                         frm.set_value(\"delivery_date\", sco.schedule_date);  // Delivery Date\r\n                                        \r\n//                                         // Log full subcontracting data for debugging\r\n//                                         console.log(\"ðŸ“¦ Subcontracting Order Full Data:\", {\r\n//                                             subcontracting_order: sco.name,\r\n//                                             purchase_order: sco.purchase_order,\r\n//                                             job_worker: sco.supplier,\r\n//                                             job_worker_name: sco.supplier_name,\r\n//                                             job_worker_warehouse: sco.supplier_warehouse,\r\n//                                             company: sco.company,\r\n//                                             schedule_date: sco.schedule_date,\r\n//                                             items: sco.items\r\n//                                         });\r\n\r\n//                                         // ============================================\r\n//                                         // Step 4: Clear existing items and prepare to load new ones\r\n//                                         // ============================================\r\n//                                         frm.clear_table(\"items\");\r\n\r\n//                                         let items = sco.items || [];\r\n                                        \r\n//                                         // Check if items exist\r\n//                                         if (items.length === 0) {\r\n//                                             frappe.show_alert({\r\n//                                                 message: __(\"No items found in Subcontracting Order\"),\r\n//                                                 indicator: 'orange'\r\n//                                             });\r\n//                                             frm.refresh_fields();\r\n//                                             return;\r\n//                                         }\r\n\r\n//                                         let processed = 0;\r\n\r\n//                                         // ============================================\r\n//                                         // Step 5: Process each item from Subcontracting Order\r\n//                                         // ============================================\r\n//                                         items.forEach((item) => {\r\n//                                             // Get correct warehouse for this item and company\r\n//                                             frappe.call({\r\n//                                                 method: \"galaxynext.api.get_item_default_warehouse\",\r\n//                                                 args: {\r\n//                                                     item_code: item.item_code,\r\n//                                                     company: supplier_company\r\n//                                                 },\r\n//                                                 callback(wr) {\r\n//                                                     let warehouse = wr.message || item.warehouse;\r\n\r\n//                                                     // Add new item row to Sales Order\r\n//                                                     let row = frm.add_child(\"items\");\r\n//                                                     row.item_code = item.item_code;\r\n//                                                     row.item_name = item.item_name;\r\n//                                                     row.qty = item.qty;\r\n//                                                     row.uom = item.uom || item.stock_uom;\r\n//                                                     row.delivery_date = sco.schedule_date;\r\n//                                                     row.warehouse = warehouse;\r\n//                                                     row.rate = item.rate || item.amount || item.valuation_rate || 0;\r\n\r\n//                                                     processed++;\r\n\r\n//                                                     // ============================================\r\n//                                                     // Step 6: After all items loaded, refresh form\r\n//                                                     // ============================================\r\n//                                                     if (processed === items.length) {\r\n//                                                         // Refresh all fields to show loaded data\r\n//                                                         frm.refresh_field(\"company\");\r\n//                                                         frm.refresh_field(\"customer\");\r\n//                                                         frm.refresh_field(\"po_no\");\r\n//                                                         frm.refresh_field(\"po_date\");\r\n//                                                         frm.refresh_field(\"delivery_date\");\r\n//                                                         frm.refresh_field(\"items\");\r\n                                                        \r\n//                                                         // Mark as loaded to prevent duplicate loading\r\n//                                                         frm._subcontracting_loaded = true;\r\n                                                        \r\n//                                                         // Show success message\r\n//                                                         frappe.show_alert({\r\n//                                                             message: __(\"{0} items loaded successfully from {1}\", [processed, sco.name]),\r\n//                                                             indicator: 'green'\r\n//                                                         });\r\n\r\n//                                                         // Log final loaded data for verification\r\n//                                                         console.log(\"âœ… Sales Order Data Loaded:\", {\r\n//                                                             company: frm.doc.company,\r\n//                                                             customer: frm.doc.customer,\r\n//                                                             po_no: frm.doc.po_no,\r\n//                                                             po_date: frm.doc.po_date,\r\n//                                                             delivery_date: frm.doc.delivery_date,\r\n//                                                             items_count: frm.doc.items.length,\r\n//                                                             items: frm.doc.items\r\n//                                                         });\r\n//                                                     }\r\n//                                                 }\r\n//                                             });\r\n//                                         });\r\n//                                     }\r\n//                                 });\r\n//                             }\r\n//                         });\r\n\r\n//                         // Close dialog after processing\r\n//                         d.hide();\r\n//                     }\r\n//                 });\r\n\r\n//                 // Show the dialog\r\n//                 d.show();\r\n//             });\r\n//         }\r\n//     }\r\n// });\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// frappe.ui.form.on('Sales Order', {\r\n//     refresh(frm) {\r\n//         // ============================================\r\n//         // FEATURE 1: Make PO Number clickable to open Subcontracting Order\r\n//         // ============================================\r\n//         if (frm.doc.po_no && frm.doc.po_no.startsWith('SC-ORD-')) {\r\n//             frm.fields_dict['po_no'].$wrapper.find('input').css('cursor', 'pointer');\r\n            \r\n//             frm.fields_dict['po_no'].$wrapper.off('click').on('click', function() {\r\n//                 frappe.set_route('Form', 'Subcontracting Order', frm.doc.po_no);\r\n//             });\r\n//         }\r\n\r\n//         // ============================================\r\n//         // FEATURE 2: Load From Subcontracting Button\r\n//         // ============================================\r\n//         if (frm.doc.docstatus === 0 && frm.is_new()) {\r\n//             frm.add_custom_button(__('Load From Subcontracting'), function() {\r\n                \r\n//                 if (frm._subcontracting_loaded) {\r\n//                     frappe.msgprint({\r\n//                         title: __('Already Loaded'),\r\n//                         message: __('Data has already been loaded from Subcontracting Order. Please refresh the page to load again.'),\r\n//                         indicator: 'orange'\r\n//                     });\r\n//                     return;\r\n//                 }\r\n\r\n//                 let d = new frappe.ui.Dialog({\r\n//                     title: 'Select Company, Customer & Subcontracting Order',\r\n//                     fields: [\r\n//                         {\r\n//                             label: 'Select Company',\r\n//                             fieldname: 'selected_company',\r\n//                             fieldtype: 'Link',\r\n//                             options: 'Company',\r\n//                             reqd: 1,\r\n//                             onchange: () => {\r\n//                                 d.set_value('customer', '');\r\n//                                 d.set_value('customer_company', '');\r\n//                                 d.set_value('subcontracting_order', '');\r\n                                \r\n//                                 d.fields_dict.customer.get_query = () => {\r\n//                                     let selected_company = d.get_value('selected_company');\r\n//                                     return {\r\n//                                         query: \"galaxynext.api.get_allowed_internal_customers\",\r\n//                                         filters: {\r\n//                                             company: selected_company\r\n//                                         }\r\n//                                     };\r\n//                                 };\r\n//                                 d.fields_dict.customer.refresh();\r\n//                             }\r\n//                         },\r\n//                         {\r\n//                             label: 'Internal Customer',\r\n//                             fieldname: 'customer',\r\n//                             fieldtype: 'Link',\r\n//                             options: 'Customer',\r\n//                             reqd: 1,\r\n//                             get_query: () => {\r\n//                                 let selected_company = d.get_value('selected_company');\r\n                                \r\n//                                 if (!selected_company) {\r\n//                                     frappe.msgprint(__('Please select a company first'));\r\n//                                     return { filters: { name: ['=', ''] } };\r\n//                                 }\r\n                                \r\n//                                 return {\r\n//                                     query: \"galaxynext.api.get_allowed_internal_customers\",\r\n//                                     filters: {\r\n//                                         company: selected_company\r\n//                                     }\r\n//                                 };\r\n//                             },\r\n//                             onchange: () => {\r\n//                                 let customer = d.get_value('customer');\r\n                                \r\n//                                 if (customer) {\r\n//                                     frappe.call({\r\n//                                         method: \"frappe.client.get_value\",\r\n//                                         args: {\r\n//                                             doctype: \"Customer\",\r\n//                                             filters: { name: customer },\r\n//                                             fieldname: \"represents_company\"\r\n//                                         },\r\n//                                         callback(r) {\r\n//                                             if (r.message) {\r\n//                                                 d.set_value(\"customer_company\", r.message.represents_company);\r\n//                                             }\r\n//                                         }\r\n//                                     });\r\n//                                 }\r\n//                             }\r\n//                         },\r\n//                         {\r\n//                             label: 'Customer Company',\r\n//                             fieldname: 'customer_company',\r\n//                             fieldtype: 'Link',\r\n//                             options: 'Company',\r\n//                             read_only: 1\r\n//                         },\r\n//                         {\r\n//                             label: 'Subcontracting Order',\r\n//                             fieldname: 'subcontracting_order',\r\n//                             fieldtype: 'Link',\r\n//                             options: 'Subcontracting Order',\r\n//                             reqd: 1,\r\n//                             get_query: () => {\r\n//                                 let customer_company = d.get_value(\"customer_company\");\r\n                                \r\n//                                 if (!customer_company) {\r\n//                                     frappe.msgprint(__('Please select a customer first'));\r\n//                                     return { filters: { name: ['=', ''] } };\r\n//                                 }\r\n                                \r\n//                                 return {\r\n//                                     query: \"galaxynext.api.get_available_subcontracting_orders\",\r\n//                                     filters: {\r\n//                                         company: customer_company\r\n//                                     }\r\n//                                 };\r\n//                             }\r\n//                         }\r\n//                     ],\r\n                    \r\n//                     primary_action_label: 'Load Data',\r\n//                     primary_action(values) {\r\n                        \r\n//                         frappe.call({\r\n//                             method: \"frappe.client.get\",\r\n//                             args: {\r\n//                                 doctype: \"Subcontracting Order\",\r\n//                                 name: values.subcontracting_order\r\n//                             },\r\n//                             callback(r) {\r\n//                                 let sco = r.message;\r\n\r\n//                                 frappe.call({\r\n//                                     method: \"frappe.client.get_value\",\r\n//                                     args: {\r\n//                                         doctype: \"Supplier\",\r\n//                                         filters: { name: sco.supplier },\r\n//                                         fieldname: \"represents_company\"\r\n//                                     },\r\n//                                     callback(res) {\r\n//                                         if (!res.message || !res.message.represents_company) {\r\n//                                             frappe.msgprint(__(\"Supplier company not found\"));\r\n//                                             return;\r\n//                                         }\r\n\r\n//                                         let supplier_company = res.message.represents_company;\r\n\r\n//                                         if (supplier_company !== values.selected_company) {\r\n//                                             frappe.msgprint(__(\"Selected company does not match the supplier company\"));\r\n//                                             return;\r\n//                                         }\r\n\r\n//                                         frm.set_value(\"company\", supplier_company);\r\n//                                         frm.set_value(\"customer\", values.customer);\r\n//                                         frm.set_value(\"po_no\", sco.name);\r\n//                                         frm.set_value(\"po_date\", sco.transaction_date);\r\n//                                         frm.set_value(\"delivery_date\", sco.schedule_date);\r\n                                        \r\n//                                         console.log(\"ðŸ“¦ Subcontracting Order Full Data:\", {\r\n//                                             subcontracting_order: sco.name,\r\n//                                             purchase_order: sco.purchase_order,\r\n//                                             job_worker: sco.supplier,\r\n//                                             job_worker_name: sco.supplier_name,\r\n//                                             job_worker_warehouse: sco.supplier_warehouse,\r\n//                                             company: sco.company,\r\n//                                             schedule_date: sco.schedule_date,\r\n//                                             items: sco.items\r\n//                                         });\r\n\r\n//                                         frm.clear_table(\"items\");\r\n\r\n//                                         let items = sco.items || [];\r\n                                        \r\n//                                         if (items.length === 0) {\r\n//                                             frappe.show_alert({\r\n//                                                 message: __(\"No items found in Subcontracting Order\"),\r\n//                                                 indicator: 'orange'\r\n//                                             });\r\n//                                             frm.refresh_fields();\r\n//                                             return;\r\n//                                         }\r\n\r\n//                                         let processed = 0;\r\n\r\n//                                         items.forEach((item) => {\r\n//                                             frappe.call({\r\n//                                                 method: \"galaxynext.api.get_item_default_warehouse\",\r\n//                                                 args: {\r\n//                                                     item_code: item.item_code,\r\n//                                                     company: supplier_company\r\n//                                                 },\r\n//                                                 callback(wr) {\r\n//                                                     let warehouse = wr.message || item.warehouse;\r\n\r\n//                                                     let row = frm.add_child(\"items\");\r\n//                                                     row.item_code = item.item_code;\r\n//                                                     row.item_name = item.item_name;\r\n//                                                     row.qty = item.qty;\r\n//                                                     row.uom = item.uom || item.stock_uom;\r\n//                                                     row.delivery_date = sco.schedule_date;\r\n//                                                     row.warehouse = warehouse;\r\n//                                                     row.rate = item.rate || item.amount || item.valuation_rate || 0;\r\n\r\n//                                                     processed++;\r\n\r\n//                                                     if (processed === items.length) {\r\n//                                                         frm.refresh_field(\"company\");\r\n//                                                         frm.refresh_field(\"customer\");\r\n//                                                         frm.refresh_field(\"po_no\");\r\n//                                                         frm.refresh_field(\"po_date\");\r\n//                                                         frm.refresh_field(\"delivery_date\");\r\n//                                                         frm.refresh_field(\"items\");\r\n                                                        \r\n//                                                         frm._subcontracting_loaded = true;\r\n                                                        \r\n//                                                         frappe.show_alert({\r\n//                                                             message: __(\"{0} items loaded successfully from {1}\", [processed, sco.name]),\r\n//                                                             indicator: 'green'\r\n//                                                         });\r\n\r\n//                                                         console.log(\"âœ… Sales Order Data Loaded:\", {\r\n//                                                             company: frm.doc.company,\r\n//                                                             customer: frm.doc.customer,\r\n//                                                             po_no: frm.doc.po_no,\r\n//                                                             po_date: frm.doc.po_date,\r\n//                                                             delivery_date: frm.doc.delivery_date,\r\n//                                                             items_count: frm.doc.items.length,\r\n//                                                             items: frm.doc.items\r\n//                                                         });\r\n//                                                     }\r\n//                                                 }\r\n//                                             });\r\n//                                         });\r\n//                                     }\r\n//                                 });\r\n//                             }\r\n//                         });\r\n\r\n//                         d.hide();\r\n//                     }\r\n//                 });\r\n\r\n//                 d.show();\r\n//             });\r\n//         }\r\n//     }\r\n// });\r\n\r\n\r\n\r\n\r\n\r\n// ---------------------------------------future code-server implement not done---------------------------------------\r\n\r\n\r\n\r\n\r\n\r\n\r\n// frappe.ui.form.on('Sales Order', {\r\n//     refresh(frm) {\r\n//         // ============================================\r\n//         // FEATURE 1: Make PO Number clickable to open Subcontracting Order\r\n//         // ============================================\r\n//         if (frm.doc.po_no && frm.doc.po_no.startsWith('SC-ORD-')) {\r\n//             frm.fields_dict['po_no'].$wrapper.find('input').css({\r\n//                 'cursor': 'pointer',\r\n//                 'color': '#007bff',\r\n//                 'text-decoration': 'underline'\r\n//             });\r\n            \r\n//             frm.fields_dict['po_no'].$wrapper.off('click').on('click', function() {\r\n//                 frappe.set_route('Form', 'Subcontracting Order', frm.doc.po_no);\r\n//             });\r\n//         }\r\n\r\n//         // ============================================\r\n//         // FEATURE 2: Load From Subcontracting Button\r\n//         // ============================================\r\n//         if (frm.doc.docstatus === 0) {\r\n//             // Remove existing button to prevent duplicates\r\n//             frm.remove_custom_button('Load From Subcontracting');\r\n            \r\n//             frm.add_custom_button(__('Load From Subcontracting'), function() {\r\n//                 // âœ… Check if data already loaded in this session\r\n//                 if (frm._subcontracting_loaded) {\r\n//                     frappe.msgprint({\r\n//                         title: __('Already Loaded'),\r\n//                         message: __('Data has already been loaded from Subcontracting Order.<br>Please <b>refresh</b> or <b>reload</b> the page to load again.'),\r\n//                         indicator: 'orange'\r\n//                     });\r\n//                     return;\r\n//                 }\r\n                \r\n//                 // âœ… Direct load - No confirmation needed\r\n//                 show_subcontracting_dialog(frm);\r\n//             });\r\n//         }\r\n//     }\r\n// });\r\n\r\n// // ============================================\r\n// // Main Dialog Function\r\n// // ============================================\r\n// function show_subcontracting_dialog(frm) {\r\n//     let d = new frappe.ui.Dialog({\r\n//         title: 'Select Company, Customer & Subcontracting Order',\r\n//         fields: [\r\n//             {\r\n//                 label: 'Select Company',\r\n//                 fieldname: 'selected_company',\r\n//                 fieldtype: 'Link',\r\n//                 options: 'Company',\r\n//                 reqd: 1,\r\n//                 onchange: () => {\r\n//                     // Clear dependent fields\r\n//                     d.set_value('customer', '');\r\n//                     d.set_value('customer_company', '');\r\n//                     d.set_value('subcontracting_order', '');\r\n                    \r\n//                     // Refresh customer field query\r\n//                     let selected_company = d.get_value('selected_company');\r\n//                     if (selected_company) {\r\n//                         d.fields_dict.customer.get_query = () => ({\r\n//                             query: \"galaxynext.api.get_allowed_internal_customers\",\r\n//                             filters: { company: selected_company }\r\n//                         });\r\n//                         d.fields_dict.customer.refresh();\r\n//                     }\r\n//                 }\r\n//             },\r\n//             {\r\n//                 label: 'Internal Customer',\r\n//                 fieldname: 'customer',\r\n//                 fieldtype: 'Link',\r\n//                 options: 'Customer',\r\n//                 reqd: 1,\r\n//                 get_query: () => {\r\n//                     let selected_company = d.get_value('selected_company');\r\n                    \r\n//                     if (!selected_company) {\r\n//                         frappe.msgprint({\r\n//                             title: __('Company Required'),\r\n//                             message: __('Please select a company first'),\r\n//                             indicator: 'orange'\r\n//                         });\r\n//                         return { filters: { name: ['=', ''] } };\r\n//                     }\r\n                    \r\n//                     return {\r\n//                         query: \"galaxynext.api.get_allowed_internal_customers\",\r\n//                         filters: { company: selected_company }\r\n//                     };\r\n//                 },\r\n//                 onchange: () => {\r\n//                     let customer = d.get_value('customer');\r\n                    \r\n//                     if (customer) {\r\n//                         // Clear subcontracting order when customer changes\r\n//                         d.set_value('subcontracting_order', '');\r\n                        \r\n//                         frappe.call({\r\n//                             method: \"frappe.client.get_value\",\r\n//                             args: {\r\n//                                 doctype: \"Customer\",\r\n//                                 filters: { name: customer },\r\n//                                 fieldname: \"represents_company\"\r\n//                             },\r\n//                             callback(r) {\r\n//                                 if (r.message && r.message.represents_company) {\r\n//                                     d.set_value(\"customer_company\", r.message.represents_company);\r\n                                    \r\n//                                     // Refresh subcontracting order field\r\n//                                     d.fields_dict.subcontracting_order.get_query = () => ({\r\n//                                         query: \"galaxynext.api.get_available_subcontracting_orders\",\r\n//                                         filters: { company: r.message.represents_company }\r\n//                                     });\r\n//                                     d.fields_dict.subcontracting_order.refresh();\r\n//                                 } else {\r\n//                                     frappe.msgprint({\r\n//                                         title: __('Error'),\r\n//                                         message: __('Customer company not found'),\r\n//                                         indicator: 'red'\r\n//                                     });\r\n//                                 }\r\n//                             },\r\n//                             error(err) {\r\n//                                 console.error(\"Error fetching customer company:\", err);\r\n//                                 frappe.msgprint({\r\n//                                     title: __('Error'),\r\n//                                     message: __('Failed to fetch customer company'),\r\n//                                     indicator: 'red'\r\n//                                 });\r\n//                             }\r\n//                         });\r\n//                     }\r\n//                 }\r\n//             },\r\n//             {\r\n//                 label: 'Customer Company',\r\n//                 fieldname: 'customer_company',\r\n//                 fieldtype: 'Link',\r\n//                 options: 'Company',\r\n//                 read_only: 1\r\n//             },\r\n//             {\r\n//                 label: 'Subcontracting Order',\r\n//                 fieldname: 'subcontracting_order',\r\n//                 fieldtype: 'Link',\r\n//                 options: 'Subcontracting Order',\r\n//                 reqd: 1,\r\n//                 get_query: () => {\r\n//                     let customer_company = d.get_value(\"customer_company\");\r\n                    \r\n//                     if (!customer_company) {\r\n//                         frappe.msgprint({\r\n//                             title: __('Customer Required'),\r\n//                             message: __('Please select a customer first'),\r\n//                             indicator: 'orange'\r\n//                         });\r\n//                         return { filters: { name: ['=', ''] } };\r\n//                     }\r\n                    \r\n//                     return {\r\n//                         query: \"galaxynext.api.get_available_subcontracting_orders\",\r\n//                         filters: { company: customer_company }\r\n//                     };\r\n//                 },\r\n//                 onchange: () => {\r\n//                     // Optional: Validate if SC Order is already used\r\n//                     let sc_order = d.get_value('subcontracting_order');\r\n//                     if (sc_order) {\r\n//                         frappe.call({\r\n//                             method: \"galaxynext.api.validate_subcontracting_order_usage\",\r\n//                             args: { subcontracting_order: sc_order },\r\n//                             callback(r) {\r\n//                                 if (r.message && r.message.is_used) {\r\n//                                     frappe.msgprint({\r\n//                                         title: __('Warning'),\r\n//                                         message: r.message.message,\r\n//                                         indicator: 'orange'\r\n//                                     });\r\n//                                 }\r\n//                             }\r\n//                         });\r\n//                     }\r\n//                 }\r\n//             }\r\n//         ],\r\n        \r\n//         primary_action_label: 'Load Data',\r\n//         primary_action(values) {\r\n//             load_subcontracting_data(frm, values, d);\r\n//         }\r\n//     });\r\n\r\n//     d.show();\r\n// }\r\n\r\n// // ============================================\r\n// // Data Loading Function with Batch API\r\n// // ============================================\r\n// function load_subcontracting_data(frm, values, dialog) {\r\n//     // Show loading indicator\r\n//     frappe.show_alert({\r\n//         message: __('Loading Subcontracting Order data...'),\r\n//         indicator: 'blue'\r\n//     }, 3);\r\n\r\n//     frappe.call({\r\n//         method: \"frappe.client.get\",\r\n//         args: {\r\n//             doctype: \"Subcontracting Order\",\r\n//             name: values.subcontracting_order\r\n//         },\r\n//         callback(r) {\r\n//             if (!r.message) {\r\n//                 frappe.msgprint({\r\n//                     title: __('Error'),\r\n//                     message: __('Subcontracting Order not found'),\r\n//                     indicator: 'red'\r\n//                 });\r\n//                 return;\r\n//             }\r\n            \r\n//             let sco = r.message;\r\n\r\n//             // Fetch supplier company\r\n//             frappe.call({\r\n//                 method: \"frappe.client.get_value\",\r\n//                 args: {\r\n//                     doctype: \"Supplier\",\r\n//                     filters: { name: sco.supplier },\r\n//                     fieldname: \"represents_company\"\r\n//                 },\r\n//                 callback(res) {\r\n//                     if (!res.message || !res.message.represents_company) {\r\n//                         frappe.msgprint({\r\n//                             title: __('Error'),\r\n//                             message: __(\"Supplier company not found for supplier: {0}\", [sco.supplier]),\r\n//                             indicator: 'red'\r\n//                         });\r\n//                         return;\r\n//                     }\r\n\r\n//                     let supplier_company = res.message.represents_company;\r\n\r\n//                     // Validate company match\r\n//                     if (supplier_company !== values.selected_company) {\r\n//                         frappe.msgprint({\r\n//                             title: __('Company Mismatch'),\r\n//                             message: __(\"Selected company ({0}) does not match the supplier company ({1})\", \r\n//                                 [values.selected_company, supplier_company]),\r\n//                             indicator: 'red'\r\n//                         });\r\n//                         return;\r\n//                     }\r\n\r\n//                     // Validate items exist\r\n//                     let items = sco.items || [];\r\n//                     if (items.length === 0) {\r\n//                         frappe.msgprint({\r\n//                             title: __('No Items'),\r\n//                             message: __(\"No items found in Subcontracting Order: {0}\", [sco.name]),\r\n//                             indicator: 'orange'\r\n//                         });\r\n//                         return;\r\n//                     }\r\n\r\n//                     // Set header fields\r\n//                     frm.set_value(\"company\", supplier_company);\r\n//                     frm.set_value(\"customer\", values.customer);\r\n//                     frm.set_value(\"po_no\", sco.name);\r\n//                     frm.set_value(\"po_date\", sco.transaction_date);\r\n//                     frm.set_value(\"delivery_date\", sco.schedule_date);\r\n                    \r\n//                     console.log(\"ðŸ“¦ Subcontracting Order Data:\", {\r\n//                         subcontracting_order: sco.name,\r\n//                         purchase_order: sco.purchase_order,\r\n//                         job_worker: sco.supplier,\r\n//                         company: sco.company,\r\n//                         schedule_date: sco.schedule_date,\r\n//                         items_count: items.length\r\n//                     });\r\n\r\n//                     // Clear existing items\r\n//                     frm.clear_table(\"items\");\r\n\r\n//                     // âœ… BATCH API: Fetch all warehouses in ONE call\r\n//                     let item_codes = items.map(item => item.item_code);\r\n                    \r\n//                     frappe.call({\r\n//                         method: \"galaxynext.api.get_multiple_item_warehouses\",\r\n//                         args: {\r\n//                             item_codes: item_codes,\r\n//                             company: supplier_company\r\n//                         },\r\n//                         callback(wr) {\r\n//                             let warehouse_map = wr.message || {};\r\n                            \r\n//                             console.log(\"ðŸ­ Warehouse Map:\", warehouse_map);\r\n                            \r\n//                             // Add all items at once\r\n//                             items.forEach((item) => {\r\n//                                 let row = frm.add_child(\"items\");\r\n//                                 row.item_code = item.item_code;\r\n//                                 row.item_name = item.item_name;\r\n//                                 row.description = item.description || item.item_name;\r\n//                                 row.qty = item.qty;\r\n//                                 row.uom = item.uom || item.stock_uom;\r\n//                                 row.delivery_date = sco.schedule_date;\r\n                                \r\n//                                 // Get warehouse from batch result\r\n//                                 row.warehouse = warehouse_map[item.item_code] || item.warehouse || '';\r\n                                \r\n//                                 // Set rate properly (not amount)\r\n//                                 row.rate = item.rate || 0;\r\n                                \r\n//                                 // Optional: Copy additional fields\r\n//                                 if (item.bom) row.bom_no = item.bom;\r\n//                                 if (item.brand) row.brand = item.brand;\r\n//                                 if (item.item_group) row.item_group = item.item_group;\r\n//                             });\r\n\r\n//                             // Refresh all fields at once\r\n//                             frm.refresh_field(\"company\");\r\n//                             frm.refresh_field(\"customer\");\r\n//                             frm.refresh_field(\"po_no\");\r\n//                             frm.refresh_field(\"po_date\");\r\n//                             frm.refresh_field(\"delivery_date\");\r\n//                             frm.refresh_field(\"items\");\r\n                            \r\n//                             // âœ… Mark as loaded - prevents reloading until refresh\r\n//                             frm._subcontracting_loaded = true;\r\n                            \r\n//                             // Success message\r\n//                             frappe.show_alert({\r\n//                                 message: __(\"âœ“ {0} items loaded successfully from {1}\", [items.length, sco.name]),\r\n//                                 indicator: 'green'\r\n//                             }, 5);\r\n\r\n//                             console.log(\"âœ… Sales Order Data Loaded:\", {\r\n//                                 company: frm.doc.company,\r\n//                                 customer: frm.doc.customer,\r\n//                                 po_no: frm.doc.po_no,\r\n//                                 items_count: frm.doc.items.length,\r\n//                                 total_qty: frm.doc.items.reduce((sum, i) => sum + (i.qty || 0), 0),\r\n//                                 reload_required_for_next_load: true\r\n//                             });\r\n                            \r\n//                             dialog.hide();\r\n//                         },\r\n//                         error(err) {\r\n//                             console.error(\"âŒ Batch warehouse fetch error:\", err);\r\n                            \r\n//                             // Fallback: Load items without warehouse optimization\r\n//                             frappe.msgprint({\r\n//                                 title: __('Warehouse Fetch Failed'),\r\n//                                 message: __('Loading items with default warehouses. You may need to update warehouses manually.'),\r\n//                                 indicator: 'orange'\r\n//                             });\r\n                            \r\n//                             items.forEach((item) => {\r\n//                                 let row = frm.add_child(\"items\");\r\n//                                 row.item_code = item.item_code;\r\n//                                 row.item_name = item.item_name;\r\n//                                 row.description = item.description || item.item_name;\r\n//                                 row.qty = item.qty;\r\n//                                 row.uom = item.uom || item.stock_uom;\r\n//                                 row.delivery_date = sco.schedule_date;\r\n//                                 row.warehouse = item.warehouse || '';\r\n//                                 row.rate = item.rate || 0;\r\n                                \r\n//                                 if (item.bom) row.bom_no = item.bom;\r\n//                             });\r\n                            \r\n//                             frm.refresh_field(\"items\");\r\n                            \r\n//                             // âœ… Mark as loaded even in fallback case\r\n//                             frm._subcontracting_loaded = true;\r\n                            \r\n//                             frappe.show_alert({\r\n//                                 message: __(\"{0} items loaded (warehouses may need manual update)\", [items.length]),\r\n//                                 indicator: 'orange'\r\n//                             }, 5);\r\n                            \r\n//                             dialog.hide();\r\n//                         }\r\n//                     });\r\n//                 },\r\n//                 error(err) {\r\n//                     console.error(\"âŒ Supplier company fetch error:\", err);\r\n//                     frappe.msgprint({\r\n//                         title: __('Error'),\r\n//                         message: __('Failed to fetch supplier company details'),\r\n//                         indicator: 'red'\r\n//                     });\r\n//                 }\r\n//             });\r\n//         },\r\n//         error(err) {\r\n//             console.error(\"âŒ Subcontracting Order fetch error:\", err);\r\n//             frappe.msgprint({\r\n//                 title: __('Error'),\r\n//                 message: __('Failed to fetch Subcontracting Order: {0}', [err.message || 'Unknown error']),\r\n//                 indicator: 'red'\r\n//             });\r\n//         }\r\n//     });\r\n// }\r\n\r\n\r\n// paramter api add in this code not implement in server pc\r\n\r\n\r\n// frappe.ui.form.on('Sales Order', {\r\n//     refresh(frm) {\r\n\r\n//         // ==========================================================\r\n//         // FEATURE 1: Make PO Number clickable to open Subcontracting Order\r\n//         // ==========================================================\r\n//         // If PO Number begins with \"SC-ORD-\", make the field clickable\r\n//         // so users can directly open the Subcontracting Order.\r\n//         if (frm.doc.po_no && frm.doc.po_no.startsWith('SC-ORD-')) {\r\n//             frm.fields_dict['po_no'].$wrapper.find('input').css('cursor', 'pointer');\r\n            \r\n//             frm.fields_dict['po_no'].$wrapper.off('click').on('click', function() {\r\n//                 frappe.set_route('Form', 'Subcontracting Order', frm.doc.po_no);\r\n//             });\r\n//         }\r\n\r\n//         // ==========================================================\r\n//         // FEATURE 2: Conditional \"Load From Subcontracting\" Button\r\n//         // ==========================================================\r\n//         // Show this button only when:\r\n//         //  - The document is in draft (docstatus 0)\r\n//         //  - The document is new (frm.is_new())\r\n//         if (frm.doc.docstatus === 0 && frm.is_new()) {\r\n            \r\n//             // Request server-side parameter to check if the feature is enabled\r\n//             frappe.call({\r\n//                 method: \"galaxynext.api.check_subcontracting_enabled\",\r\n//                 args: {\r\n//                     company: frm.doc.company || frappe.defaults.get_default(\"Company\")\r\n//                 },\r\n//                 callback(r) {\r\n\r\n//                     // Display button only if parameter returns TRUE\r\n//                     if (r.message && r.message.enabled) {\r\n                        \r\n//                         frm.add_custom_button(__('Load From Subcontracting'), function() {\r\n                            \r\n//                             // // Prevent duplicate data load in same session\r\n//                             // if (frm._subcontracting_loaded) {\r\n//                             //     frappe.msgprint({\r\n//                             //         title: __('Already Loaded'),\r\n//                             //         message: __('Data has already been loaded. Refresh the form to load again.'),\r\n//                             //         indicator: 'orange'\r\n//                             //     });\r\n//                             //     return;\r\n//                             // }\r\n                            \r\n//                              // âœ… FIX: Check if THIS SPECIFIC DOCUMENT has data loaded\r\n//                 // Use doc.po_no instead of form flag\r\n//                 if (frm.doc.po_no && frm.doc.po_no.startsWith('SC-ORD-')) {\r\n//                     frappe.msgprint({\r\n//                         title: __('Already Loaded'),\r\n//                         message: __('Data has already been loaded from Subcontracting Order. Please refresh the page to load again.'),\r\n//                         indicator: 'orange'\r\n//                     });\r\n//                     return;\r\n//                 }\r\n\r\n//                             // ==========================================================\r\n//                             // DIALOG: Select Company, Customer & Subcontracting Order\r\n//                             // ==========================================================\r\n//                             let d = new frappe.ui.Dialog({\r\n//                                 title: 'Select Company, Customer & Subcontracting Order',\r\n//                                 fields: [\r\n\r\n//                                     // ------------------------ COMPANY SELECT ------------------------\r\n//                                     {\r\n//                                         label: 'Select Company',\r\n//                                         fieldname: 'selected_company',\r\n//                                         fieldtype: 'Link',\r\n//                                         options: 'Company',\r\n//                                         reqd: 1,\r\n//                                         onchange: () => {\r\n//                                             d.set_value('customer', '');\r\n//                                             d.set_value('customer_company', '');\r\n//                                             d.set_value('subcontracting_order', '');\r\n                                            \r\n//                                             // Filter customers when company changes\r\n//                                             d.fields_dict.customer.get_query = () => {\r\n//                                                 let selected_company = d.get_value('selected_company');\r\n//                                                 return {\r\n//                                                     query: \"galaxynext.api.get_allowed_internal_customers\",\r\n//                                                     filters: { company: selected_company }\r\n//                                                 };\r\n//                                             };\r\n//                                             d.fields_dict.customer.refresh();\r\n//                                         }\r\n//                                     },\r\n\r\n//                                     // ------------------------ CUSTOMER SELECT ------------------------\r\n//                                     {\r\n//                                         label: 'Internal Customer',\r\n//                                         fieldname: 'customer',\r\n//                                         fieldtype: 'Link',\r\n//                                         options: 'Customer',\r\n//                                         reqd: 1,\r\n//                                         get_query: () => {\r\n//                                             let selected_company = d.get_value('selected_company');\r\n                                            \r\n//                                             if (!selected_company) {\r\n//                                                 frappe.msgprint(__('Please select a company first'));\r\n//                                                 return { filters: { name: ['=', ''] } };\r\n//                                             }\r\n                                            \r\n//                                             return {\r\n//                                                 query: \"galaxynext.api.get_allowed_internal_customers\",\r\n//                                                 filters: { company: selected_company }\r\n//                                             };\r\n//                                         },\r\n//                                         onchange: () => {\r\n//                                             let customer = d.get_value('customer');\r\n\r\n//                                             // Get customer company\r\n//                                             if (customer) {\r\n//                                                 frappe.call({\r\n//                                                     method: \"frappe.client.get_value\",\r\n//                                                     args: {\r\n//                                                         doctype: \"Customer\",\r\n//                                                         filters: { name: customer },\r\n//                                                         fieldname: \"represents_company\"\r\n//                                                     },\r\n//                                                     callback(r) {\r\n//                                                         if (r.message) {\r\n//                                                             d.set_value(\"customer_company\", r.message.represents_company);\r\n//                                                         }\r\n//                                                     }\r\n//                                                 });\r\n//                                             }\r\n//                                         }\r\n//                                     },\r\n\r\n//                                     // ------------------------ CUSTOMER COMPANY ------------------------\r\n//                                     {\r\n//                                         label: 'Customer Company',\r\n//                                         fieldname: 'customer_company',\r\n//                                         fieldtype: 'Link',\r\n//                                         options: 'Company',\r\n//                                         read_only: 1\r\n//                                     },\r\n\r\n//                                     // ------------------------ SUBCONTRACTING ORDER SELECT ------------------------\r\n//                                     {\r\n//                                         label: 'Subcontracting Order',\r\n//                                         fieldname: 'subcontracting_order',\r\n//                                         fieldtype: 'Link',\r\n//                                         options: 'Subcontracting Order',\r\n//                                         reqd: 1,\r\n//                                         get_query: () => {\r\n//                                             let customer_company = d.get_value(\"customer_company\");\r\n                                            \r\n//                                             if (!customer_company) {\r\n//                                                 frappe.msgprint(__('Please select a customer first'));\r\n//                                                 return { filters: { name: ['=', ''] } };\r\n//                                             }\r\n                                            \r\n//                                             return {\r\n//                                                 query: \"galaxynext.api.get_available_subcontracting_orders\",\r\n//                                                 filters: { company: customer_company }\r\n//                                             };\r\n//                                         }\r\n//                                     }\r\n//                                 ],\r\n                                \r\n//                                 // ==========================================================\r\n//                                 // PRIMARY ACTION: Load Data from Subcontracting Order\r\n//                                 // ==========================================================\r\n//                                 primary_action_label: 'Load Data',\r\n//                                 primary_action(values) {\r\n                                    \r\n//                                     // Fetch Subcontracting Order\r\n//                                     frappe.call({\r\n//                                         method: \"frappe.client.get\",\r\n//                                         args: {\r\n//                                             doctype: \"Subcontracting Order\",\r\n//                                             name: values.subcontracting_order\r\n//                                         },\r\n//                                         callback(r) {\r\n//                                             let sco = r.message;\r\n\r\n//                                             // Fetch supplier company\r\n//                                             frappe.call({\r\n//                                                 method: \"frappe.client.get_value\",\r\n//                                                 args: {\r\n//                                                     doctype: \"Supplier\",\r\n//                                                     filters: { name: sco.supplier },\r\n//                                                     fieldname: \"represents_company\"\r\n//                                                 },\r\n//                                                 callback(res) {\r\n//                                                     if (!res.message || !res.message.represents_company) {\r\n//                                                         frappe.msgprint(__(\"Supplier company not found\"));\r\n//                                                         return;\r\n//                                                     }\r\n\r\n//                                                     let supplier_company = res.message.represents_company;\r\n\r\n//                                                     // Validate company match\r\n//                                                     if (supplier_company !== values.selected_company) {\r\n//                                                         frappe.msgprint(__(\"Selected company does not match supplier company\"));\r\n//                                                         return;\r\n//                                                     }\r\n\r\n//                                                     // Update Sales Order header fields\r\n//                                                     frm.set_value(\"company\", supplier_company);\r\n//                                                     frm.set_value(\"customer\", values.customer);\r\n//                                                     frm.set_value(\"po_no\", sco.name);\r\n//                                                     frm.set_value(\"po_date\", sco.transaction_date);\r\n//                                                     // frm.set_value(\"delivery_date\", sco.schedule_date);\r\n//                                                     frm.set_value(\"delivery_date\", frappe.datetime.get_today());\r\n\r\n//                                                     // Clear previous items\r\n//                                                     frm.clear_table(\"items\");\r\n\r\n//                                                     let items = sco.items || [];\r\n                                                    \r\n//                                                     if (!items.length) {\r\n//                                                         frappe.show_alert({\r\n//                                                             message: __(\"No items found in Subcontracting Order\"),\r\n//                                                             indicator: 'orange'\r\n//                                                         });\r\n//                                                         return;\r\n//                                                     }\r\n\r\n//                                                     let processed = 0;\r\n\r\n//                                                     // ==========================================================\r\n//                                                     // LOAD EACH ITEM ROW\r\n//                                                     // ==========================================================\r\n//                                                     items.forEach((item) => {\r\n                                                        \r\n//                                                         // Get default warehouse for company\r\n//                                                         frappe.call({\r\n//                                                             method: \"galaxynext.api.get_item_default_warehouse\",\r\n//                                                             args: {\r\n//                                                                 item_code: item.item_code,\r\n//                                                                 company: supplier_company\r\n//                                                             },\r\n//                                                             callback(wr) {\r\n//                                                                 let warehouse = wr.message || item.warehouse;\r\n\r\n//                                                                 // Get default BOM\r\n//                                                                 frappe.call({\r\n//                                                                     method: \"frappe.client.get_value\",\r\n//                                                                     args: {\r\n//                                                                         doctype: \"Item\",\r\n//                                                                         filters: { name: item.item_code },\r\n//                                                                         fieldname: [\"default_bom\"]\r\n//                                                                     },\r\n//                                                                     callback(bom_res) {\r\n//                                                                         let bom_no = bom_res.message ? bom_res.message.default_bom : \"\";\r\n\r\n//                                                                         // Add item row\r\n//                                                                         let row = frm.add_child(\"items\");\r\n//                                                                         row.item_code = item.item_code;\r\n//                                                                         row.item_name = item.item_name;\r\n//                                                                         row.qty = item.qty;\r\n//                                                                         row.uom = item.uom || item.stock_uom;\r\n//                                                                         // row.delivery_date = sco.schedule_date;\r\n//                                                                         row.delivery_date = frappe.datetime.get_today();\r\n//                                                                         row.warehouse = warehouse;\r\n//                                                                         row.rate = item.rate || item.amount || item.valuation_rate || 0;\r\n                                                                        \r\n//                                                                         if (bom_no) {\r\n//                                                                             row.bom_no = bom_no;\r\n//                                                                         }\r\n\r\n//                                                                         processed++;\r\n\r\n//                                                                         // All rows loaded\r\n//                                                                         if (processed === items.length) {\r\n//                                                                             frm.refresh_field(\"items\");\r\n//                                                                             frm._subcontracting_loaded = true;\r\n\r\n//                                                                             frappe.show_alert({\r\n//                                                                                 message: __(\"{0} items loaded successfully from {1}\", [processed, sco.name]),\r\n//                                                                                 indicator: 'green'\r\n//                                                                             });\r\n//                                                                         }\r\n//                                                                     }\r\n//                                                                 });\r\n//                                                             }\r\n//                                                         });\r\n//                                                     });\r\n//                                                 }\r\n//                                             });\r\n//                                         }\r\n//                                     });\r\n\r\n//                                     d.hide();\r\n//                                 }\r\n//                             });\r\n\r\n//                             d.show();\r\n//                         });\r\n//                     }\r\n//                 }\r\n//             });\r\n//         }\r\n//     },\r\n\r\n//     // ==========================================================\r\n//     // FEATURE 3: Auto-update Delivery Date for All Items\r\n//     // ==========================================================\r\n//     // Whenever the Delivery Date is changed in the parent document,\r\n//     // update all item rows to match the same date.\r\n//     delivery_date(frm) {\r\n//         if (frm.doc.delivery_date && frm.doc.items?.length > 0) {\r\n            \r\n//             let updated_count = 0;\r\n\r\n//             frm.doc.items.forEach(item => {\r\n//                 if (item.delivery_date !== frm.doc.delivery_date) {\r\n//                     frappe.model.set_value(item.doctype, item.name, 'delivery_date', frm.doc.delivery_date);\r\n//                     updated_count++;\r\n//                 }\r\n//             });\r\n\r\n//             if (updated_count > 0) {\r\n//                 frm.refresh_field('items');\r\n//                 frappe.show_alert({\r\n//                     message: __('Delivery date updated for {0} items', [updated_count]),\r\n//                     indicator: 'blue'\r\n//                 });\r\n//             }\r\n//         }\r\n//     }\r\n// });\r\n\r\n\r\n\r\n\r\n\r\n\r\nfrappe.ui.form.on('Sales Order', {\r\n    refresh(frm) {\r\n        // ============================================\r\n        // FEATURE 1: Make PO Number clickable to open Subcontracting Order\r\n        // ============================================\r\n        if (frm.doc.po_no && frm.doc.po_no.startsWith('SC-ORD-')) {\r\n            frm.fields_dict['po_no'].$wrapper.find('input').css('cursor', 'pointer');\r\n            \r\n            frm.fields_dict['po_no'].$wrapper.off('click').on('click', function() {\r\n                frappe.set_route('Form', 'Subcontracting Order', frm.doc.po_no);\r\n            });\r\n        }\r\n\r\n        // ============================================\r\n        // FEATURE 2: Load From Subcontracting Button\r\n        // ============================================\r\n        if (frm.doc.docstatus === 0 && frm.is_new()) {\r\n            frm.add_custom_button(__('Load From Subcontracting'), function() {\r\n                \r\n                if (frm.doc.po_no && frm.doc.po_no.startsWith('SC-ORD-')) {\r\n                    frappe.msgprint({\r\n                        title: __('Already Loaded'),\r\n                        message: __('Data has already been loaded from Subcontracting Order. Please refresh the page to load again.'),\r\n                        indicator: 'orange'\r\n                    });\r\n                    return;\r\n                }\r\n\r\n                let d = new frappe.ui.Dialog({\r\n                    title: 'Select Company, Customer & Subcontracting Order',\r\n                    fields: [\r\n                        {\r\n                            label: 'Select Company',\r\n                            fieldname: 'selected_company',\r\n                            fieldtype: 'Link',\r\n                            options: 'Company',\r\n                            reqd: 1,\r\n                            onchange: () => {\r\n                                d.set_value('customer', '');\r\n                                d.set_value('customer_company', '');\r\n                                d.set_value('subcontracting_order', '');\r\n                                \r\n                                d.fields_dict.customer.get_query = () => {\r\n                                    let selected_company = d.get_value('selected_company');\r\n                                    return {\r\n                                        query: \"galaxynext.api.get_allowed_internal_customers\",\r\n                                        filters: {\r\n                                            company: selected_company\r\n                                        }\r\n                                    };\r\n                                };\r\n                                d.fields_dict.customer.refresh();\r\n                            }\r\n                        },\r\n                        {\r\n                            label: 'Internal Customer',\r\n                            fieldname: 'customer',\r\n                            fieldtype: 'Link',\r\n                            options: 'Customer',\r\n                            reqd: 1,\r\n                            get_query: () => {\r\n                                let selected_company = d.get_value('selected_company');\r\n                                \r\n                                if (!selected_company) {\r\n                                    frappe.msgprint(__('Please select a company first'));\r\n                                    return { filters: { name: ['=', ''] } };\r\n                                }\r\n                                \r\n                                return {\r\n                                    query: \"galaxynext.api.get_allowed_internal_customers\",\r\n                                    filters: {\r\n                                        company: selected_company\r\n                                    }\r\n                                };\r\n                            },\r\n                            onchange: () => {\r\n                                let customer = d.get_value('customer');\r\n                                \r\n                                if (customer) {\r\n                                    frappe.call({\r\n                                        method: \"frappe.client.get_value\",\r\n                                        args: {\r\n                                            doctype: \"Customer\",\r\n                                            filters: { name: customer },\r\n                                            fieldname: \"represents_company\"\r\n                                        },\r\n                                        flags: {\r\n                                            ignore_user_permissions: 1\r\n                                        },\r\n                                        callback(r) {\r\n                                            if (r.message) {\r\n                                                d.set_value(\"customer_company\", r.message.represents_company);\r\n                                            }\r\n                                        }\r\n                                    });\r\n                                }\r\n                            }\r\n                        },\r\n                        {\r\n                            label: 'Customer Company',\r\n                            fieldname: 'customer_company',\r\n                            fieldtype: 'Link',\r\n                            options: 'Company',\r\n                            read_only: 1\r\n                        },\r\n                        {\r\n                            label: 'Subcontracting Order',\r\n                            fieldname: 'subcontracting_order',\r\n                            fieldtype: 'Link',\r\n                            options: 'Subcontracting Order',\r\n                            reqd: 1,\r\n                            get_query: () => {\r\n                                let customer_company = d.get_value(\"customer_company\");\r\n                                \r\n                                if (!customer_company) {\r\n                                    frappe.msgprint(__('Please select a customer first'));\r\n                                    return { filters: { name: ['=', ''] } };\r\n                                }\r\n                                \r\n                                return {\r\n                                    query: \"galaxynext.api.get_available_subcontracting_orders\",\r\n                                    filters: {\r\n                                        company: customer_company\r\n                                    }\r\n                                };\r\n                            }\r\n                        }\r\n                    ],\r\n                    \r\n                    primary_action_label: 'Load Data',\r\n                    primary_action(values) {\r\n                        \r\n                        // ðŸš€ NEW: Use optimized batch API - àªàª• àªœ call àª®àª¾àª‚ àª¬àª§à«àª‚ àª®àª³à«‡ àª›à«‡!\r\n                        frappe.call({\r\n                            method: \"galaxynext.api.get_subcontracting_order_complete_data\",\r\n                            args: {\r\n                                subcontracting_order: values.subcontracting_order,\r\n                                company: values.selected_company\r\n                            },\r\n                            callback(r) {\r\n                                if (!r.message || !r.message.success) {\r\n                                    frappe.msgprint({\r\n                                        title: __('Error'),\r\n                                        message: r.message?.error || __('Failed to load SC Order data'),\r\n                                        indicator: 'red'\r\n                                    });\r\n                                    return;\r\n                                }\r\n\r\n                                let data = r.message;\r\n\r\n                                // Validate supplier company matches selected company\r\n                                if (data.supplier_company !== values.selected_company) {\r\n                                    frappe.msgprint({\r\n                                        title: __('Company Mismatch'),\r\n                                        message: __(\"Selected company does not match the supplier company\"),\r\n                                        indicator: 'red'\r\n                                    });\r\n                                    return;\r\n                                }\r\n\r\n                                // Set header fields\r\n                                frm.set_value(\"company\", data.supplier_company);\r\n                                frm.set_value(\"customer\", values.customer);\r\n                                frm.set_value(\"po_no\", data.subcontracting_order);\r\n                                frm.set_value(\"po_date\", data.transaction_date);\r\n                                frm.set_value(\"delivery_date\", frappe.datetime.get_today());\r\n\r\n                                console.log(\"ðŸ“¦ SC Order Complete Data Received:\", {\r\n                                    subcontracting_order: data.subcontracting_order,\r\n                                    supplier_company: data.supplier_company,\r\n                                    total_items: data.total_items,\r\n                                    items_with_service_rate: data.items_with_service_rate,\r\n                                    service_rate_map: data.service_rate_map\r\n                                });\r\n\r\n                                // Clear existing items\r\n                                frm.clear_table(\"items\");\r\n\r\n                                // Check if items exist\r\n                                if (!data.items || data.items.length === 0) {\r\n                                    frappe.show_alert({\r\n                                        message: __(\"No items found in Subcontracting Order\"),\r\n                                        indicator: 'orange'\r\n                                    });\r\n                                    frm.refresh_fields();\r\n                                    return;\r\n                                }\r\n\r\n                                // ðŸš€ Add all items - àª¬àª§à«àª‚ data already processed àª›à«‡!\r\n                                data.items.forEach((item) => {\r\n                                    let row = frm.add_child(\"items\");\r\n                                    row.item_code = item.item_code;\r\n                                    row.item_name = item.item_name;\r\n                                    row.qty = item.qty;\r\n                                    row.uom = item.uom;\r\n                                    row.delivery_date = frappe.datetime.get_today();\r\n                                    row.warehouse = item.warehouse;\r\n                                    row.rate = item.rate; // ðŸ’° Service Items àª®àª¾àª‚àª¥à«€ rate\r\n                                    \r\n                                    if (item.bom_no) {\r\n                                        row.bom_no = item.bom_no;\r\n                                    }\r\n\r\n                                    // Log each item for debugging\r\n                                    console.log(`âœ… ${item.item_code}: Rate=${item.rate}, HasServiceRate=${item.has_service_rate}, Warehouse=${item.warehouse}`);\r\n                                });\r\n\r\n                                // Refresh all fields at once\r\n                                frm.refresh_fields();\r\n                                \r\n                                // Show success message\r\n                                frappe.show_alert({\r\n                                    message: __(\"{0} items loaded successfully ({1} with service rates)\", \r\n                                        [data.total_items, data.items_with_service_rate]),\r\n                                    indicator: 'green'\r\n                                });\r\n\r\n                                console.log(\"âœ… Sales Order Final Data:\", {\r\n                                    company: frm.doc.company,\r\n                                    customer: frm.doc.customer,\r\n                                    po_no: frm.doc.po_no,\r\n                                    po_date: frm.doc.po_date,\r\n                                    delivery_date: frm.doc.delivery_date,\r\n                                    items_count: frm.doc.items.length,\r\n                                    items: frm.doc.items\r\n                                });\r\n                            }\r\n                        });\r\n\r\n                        d.hide();\r\n                    }\r\n                });\r\n\r\n                d.show();\r\n            });\r\n        }\r\n    },\r\n\r\n    // ============================================\r\n    // FEATURE 3: Auto-sync Delivery Date to all items\r\n    // ============================================\r\n    delivery_date: function(frm) {\r\n        if (frm.doc.delivery_date && frm.doc.items && frm.doc.items.length > 0) {\r\n            let updated_count = 0;\r\n            \r\n            frm.doc.items.forEach(function(item) {\r\n                if (item.delivery_date !== frm.doc.delivery_date) {\r\n                    frappe.model.set_value(item.doctype, item.name, 'delivery_date', frm.doc.delivery_date);\r\n                    updated_count++;\r\n                }\r\n            });\r\n\r\n            if (updated_count > 0) {\r\n                frm.refresh_field('items');\r\n                frappe.show_alert({\r\n                    message: __('Delivery date updated for {0} items', [updated_count]),\r\n                    indicator: 'blue'\r\n                });\r\n            }\r\n        }\r\n    }\r\n});\r\n\r\n\r\n\r\n// frappe.ui.form.on('Sales Order', {\r\n//     refresh(frm) {\r\n\r\n//         // ==========================================================\r\n//         // FEATURE 1: Make PO Number clickable to open Subcontracting Order\r\n//         // ==========================================================\r\n//         if (frm.doc.po_no && frm.doc.po_no.startsWith('SC-ORD-')) {\r\n//             frm.fields_dict['po_no'].$wrapper.find('input').css('cursor', 'pointer');\r\n\r\n//             frm.fields_dict['po_no'].$wrapper\r\n//                 .off('click')\r\n//                 .on('click', function () {\r\n//                     frappe.set_route('Form', 'Subcontracting Order', frm.doc.po_no);\r\n//                 });\r\n//         }\r\n\r\n//         // ==========================================================\r\n//         // FEATURE 2: Conditionally show \"Load From Subcontracting\" button\r\n//         // (Only for new Draft Sales Orders)\r\n//         // ==========================================================\r\n//         if (frm.doc.docstatus === 0 && frm.is_new()) {\r\n\r\n//             // Check if Subcontracting feature is enabled for the company\r\n//             frappe.call({\r\n//                 method: \"galaxynext.api.check_subcontracting_enabled\",\r\n//                 args: {\r\n//                     company: frm.doc.company || frappe.defaults.get_default(\"Company\")\r\n//                     // param_name: \"SUBCONTRACTING\"\r\n//                 },\r\n//                 callback(r) {\r\n\r\n//                     if (r.message && r.message.enabled) {\r\n\r\n//                         // Add custom button\r\n//                         frm.add_custom_button(__('Load From Subcontracting'), function () {\r\n\r\n//                             // Prevent loading data multiple times\r\n//                             if (frm.doc.po_no && frm.doc.po_no.startsWith('SC-ORD-')) {\r\n//                                 frappe.msgprint({\r\n//                                     title: __('Already Loaded'),\r\n//                                     message: __('Data has already been loaded from Subcontracting Order. Please refresh the page to load again.'),\r\n//                                     indicator: 'orange'\r\n//                                 });\r\n//                                 return;\r\n//                             }\r\n\r\n\r\n\r\n\r\n\r\n// frappe.ui.form.on('Sales Order', {\r\n//     refresh(frm) {\r\n\r\n//         // ==========================================================\r\n//         // FEATURE 1: Make PO Number clickable\r\n//         // ==========================================================\r\n//         if (frm.doc.po_no && frm.doc.po_no.startsWith('SC-ORD-')) {\r\n//             frm.fields_dict['po_no'].$wrapper.find('input').css('cursor', 'pointer');\r\n\r\n//             frm.fields_dict['po_no'].$wrapper\r\n//                 .off('click')\r\n//                 .on('click', function () {\r\n//                     frappe.set_route('Form', 'Subcontracting Order', frm.doc.po_no);\r\n//                 });\r\n//         }\r\n\r\n//         // ==========================================================\r\n//         // FEATURE 2: Show button only if SUBCONTRACTING enabled\r\n//         // ==========================================================\r\n//         if (frm.doc.docstatus === 0 && frm.is_new()) {\r\n\r\n//             let company = frm.doc.company || frappe.defaults.get_default(\"Company\");\r\n\r\n//             if (!company) {\r\n//                 console.warn(\"Company not set yet\");\r\n//                 return;\r\n//             }\r\n\r\n//             frappe.call({\r\n//                 method: \"galaxynext.api.check_parameter_enabled\",\r\n//                 args: {\r\n//                     company: company,\r\n//                     param_name: \"SUBCONTRACTING\"\r\n//                 },\r\n//                 callback(r) {\r\n\r\n//                     console.log(\"SUBCONTRACTING PARAM RESPONSE:\", r.message);\r\n\r\n//                     if (r.message && r.message.enabled) {\r\n\r\n//                         frm.add_custom_button(__('Load From Subcontracting'), function () {\r\n\r\n//                             if (frm.doc.po_no && frm.doc.po_no.startsWith('SC-ORD-')) {\r\n//                                 frappe.msgprint({\r\n//                                     title: __('Already Loaded'),\r\n//                                     message: __('Data already loaded from Subcontracting Order.'),\r\n//                                     indicator: 'orange'\r\n//                                 });\r\n//                                 return;\r\n//                             }\r\n//                             // ==========================================================\r\n//                             // DIALOG: Select Company, Customer & Subcontracting Order\r\n//                             // ==========================================================\r\n//                             let d = new frappe.ui.Dialog({\r\n//                                 title: 'Select Company, Customer & Subcontracting Order',\r\n//                                 fields: [\r\n\r\n//                                     // ------------------------ COMPANY ------------------------\r\n//                                     {\r\n//                                         label: 'Select Company',\r\n//                                         fieldname: 'selected_company',\r\n//                                         fieldtype: 'Link',\r\n//                                         options: 'Company',\r\n//                                         reqd: 1,\r\n//                                         onchange: () => {\r\n//                                             // Reset dependent fields on company change\r\n//                                             d.set_value('customer', '');\r\n//                                             d.set_value('customer_company', '');\r\n//                                             d.set_value('subcontracting_order', '');\r\n\r\n//                                             // Filter customers based on selected company\r\n//                                             d.fields_dict.customer.get_query = () => {\r\n//                                                 return {\r\n//                                                     query: \"galaxynext.api.get_allowed_internal_customers\",\r\n//                                                     filters: {\r\n//                                                         company: d.get_value('selected_company')\r\n//                                                     }\r\n//                                                 };\r\n//                                             };\r\n//                                             d.fields_dict.customer.refresh();\r\n//                                         }\r\n//                                     },\r\n\r\n//                                     // ------------------------ INTERNAL CUSTOMER ------------------------\r\n//                                     {\r\n//                                         label: 'Internal Customer',\r\n//                                         fieldname: 'customer',\r\n//                                         fieldtype: 'Link',\r\n//                                         options: 'Customer',\r\n//                                         reqd: 1,\r\n//                                         get_query: () => {\r\n//                                             let selected_company = d.get_value('selected_company');\r\n\r\n//                                             if (!selected_company) {\r\n//                                                 frappe.msgprint(__('Please select a company first'));\r\n//                                                 return { filters: { name: ['=', ''] } };\r\n//                                             }\r\n\r\n//                                             return {\r\n//                                                 query: \"galaxynext.api.get_allowed_internal_customers\",\r\n//                                                 filters: { company: selected_company }\r\n//                                             };\r\n//                                         },\r\n//                                         onchange: () => {\r\n//                                             let customer = d.get_value('customer');\r\n\r\n//                                             // Fetch customer's representing company\r\n//                                             if (customer) {\r\n//                                                 frappe.call({\r\n//                                                     method: \"frappe.client.get_value\",\r\n//                                                     args: {\r\n//                                                         doctype: \"Customer\",\r\n//                                                         filters: { name: customer },\r\n//                                                         fieldname: \"represents_company\"\r\n//                                                     },\r\n//                                                     callback(r) {\r\n//                                                         if (r.message) {\r\n//                                                             d.set_value(\"customer_company\", r.message.represents_company);\r\n//                                                         }\r\n//                                                     }\r\n//                                                 });\r\n//                                             }\r\n//                                         }\r\n//                                     },\r\n\r\n//                                     // ------------------------ CUSTOMER COMPANY (READ ONLY) ------------------------\r\n//                                     {\r\n//                                         label: 'Customer Company',\r\n//                                         fieldname: 'customer_company',\r\n//                                         fieldtype: 'Link',\r\n//                                         options: 'Company',\r\n//                                         read_only: 1\r\n//                                     },\r\n\r\n//                                     // ------------------------ SUBCONTRACTING ORDER ------------------------\r\n//                                     {\r\n//                                         label: 'Subcontracting Order',\r\n//                                         fieldname: 'subcontracting_order',\r\n//                                         fieldtype: 'Link',\r\n//                                         options: 'Subcontracting Order',\r\n//                                         reqd: 1,\r\n//                                         get_query: () => {\r\n//                                             let customer_company = d.get_value(\"customer_company\");\r\n\r\n//                                             if (!customer_company) {\r\n//                                                 frappe.msgprint(__('Please select a customer first'));\r\n//                                                 return { filters: { name: ['=', ''] } };\r\n//                                             }\r\n\r\n//                                             return {\r\n//                                                 query: \"galaxynext.api.get_available_subcontracting_orders\",\r\n//                                                 filters: { company: customer_company }\r\n//                                             };\r\n//                                         }\r\n//                                     }\r\n//                                 ],\r\n\r\n//                                 // ==========================================================\r\n//                                 // PRIMARY ACTION: Load data from Subcontracting Order\r\n//                                 // ==========================================================\r\n//                                 primary_action_label: 'Load Data',\r\n//                                 primary_action(values) {\r\n\r\n//                                     // Fetch selected Subcontracting Order\r\n//                                     frappe.call({\r\n//                                         method: \"frappe.client.get\",\r\n//                                         args: {\r\n//                                             doctype: \"Subcontracting Order\",\r\n//                                             name: values.subcontracting_order\r\n//                                         },\r\n//                                         callback(r) {\r\n//                                             let sco = r.message;\r\n\r\n//                                             console.log(\"=== FULL SUBCONTRACTING ORDER DATA ===\");\r\n//                                             console.log(\"Complete SCO Object:\", sco);\r\n//                                             console.log(\"SCO Name:\", sco.name);\r\n//                                             console.log(\"SCO Supplier:\", sco.supplier);\r\n//                                             console.log(\"SCO Transaction Date:\", sco.transaction_date);\r\n//                                             console.log(\"SCO Items:\", sco.items);\r\n//                                             console.log(\"SCO Service Items:\", sco.service_items);\r\n                                            \r\n//                                             if (sco.service_items && sco.service_items.length > 0) {\r\n//                                                 console.log(\"Service Items Details:\");\r\n//                                                 sco.service_items.forEach((si, idx) => {\r\n//                                                     console.log(`  Service Item ${idx + 1}:`, {\r\n//                                                         item_code: si.item_code,\r\n//                                                         item_name: si.item_name,\r\n//                                                         qty: si.qty,\r\n//                                                         rate: si.rate,\r\n//                                                         amount: si.amount\r\n//                                                     });\r\n//                                                 });\r\n//                                             }\r\n                                            \r\n//                                             if (sco.items && sco.items.length > 0) {\r\n//                                                 console.log(\"Main Items Details:\");\r\n//                                                 sco.items.forEach((item, idx) => {\r\n//                                                     console.log(`  Item ${idx + 1}:`, {\r\n//                                                         idx: item.idx,\r\n//                                                         item_code: item.item_code,\r\n//                                                         item_name: item.item_name,\r\n//                                                         qty: item.qty,\r\n//                                                         rate: item.rate,\r\n//                                                         amount: item.amount,\r\n//                                                         valuation_rate: item.valuation_rate,\r\n//                                                         warehouse: item.warehouse\r\n//                                                     });\r\n//                                                 });\r\n//                                             }\r\n\r\n//                                             // Fetch supplier's representing company\r\n//                                             frappe.call({\r\n//                                                 method: \"frappe.client.get_value\",\r\n//                                                 args: {\r\n//                                                     doctype: \"Supplier\",\r\n//                                                     filters: { name: sco.supplier },\r\n//                                                     fieldname: \"represents_company\"\r\n//                                                 },\r\n//                                                 callback(res) {\r\n\r\n//                                                     if (!res.message || !res.message.represents_company) {\r\n//                                                         frappe.msgprint(__(\"Supplier company not found\"));\r\n//                                                         return;\r\n//                                                     }\r\n\r\n//                                                     let supplier_company = res.message.represents_company;\r\n\r\n//                                                     // Validate selected company with supplier company\r\n//                                                     if (supplier_company !== values.selected_company) {\r\n//                                                         frappe.msgprint(__(\"Selected company does not match supplier company\"));\r\n//                                                         return;\r\n//                                                     }\r\n\r\n//                                                     // Set Sales Order header values\r\n//                                                     frm.set_value(\"company\", supplier_company);\r\n//                                                     frm.set_value(\"customer\", values.customer);\r\n//                                                     frm.set_value(\"po_no\", sco.name);\r\n//                                                     frm.set_value(\"po_date\", sco.transaction_date);\r\n//                                                     frm.set_value(\"delivery_date\", frappe.datetime.get_today());\r\n\r\n//                                                     // Clear existing items\r\n//                                                     frm.clear_table(\"items\");\r\n\r\n//                                                     let items = sco.items || [];\r\n//                                                     if (!items.length) {\r\n//                                                         frappe.show_alert({\r\n//                                                             message: __(\"No items found in Subcontracting Order\"),\r\n//                                                             indicator: 'orange'\r\n//                                                         });\r\n//                                                         return;\r\n//                                                     }\r\n\r\n//                                                     // ==========================================================\r\n//                                                     // Get service item rate (same rate applied to all items)\r\n//                                                     // ==========================================================\r\n//                                                     let service_rate = 0;\r\n//                                                     if (sco.service_items && sco.service_items.length > 0) {\r\n//                                                         service_rate = sco.service_items[0].rate || 0;\r\n//                                                     }\r\n\r\n//                                                     console.log(\"=== SUBCONTRACTING ORDER DATA ===\");\r\n//                                                     console.log(\"SCO Name:\", sco.name);\r\n//                                                     console.log(\"Service Rate:\", service_rate);\r\n//                                                     console.log(\"Total Items:\", items.length);\r\n//                                                     console.log(\"Items Before Sort:\", items.map(i => ({idx: i.idx, code: i.item_code, rate: i.rate})));\r\n\r\n//                                                     // ==========================================================\r\n//                                                     // Sort items by idx to maintain order\r\n//                                                     // ==========================================================\r\n//                                                     items.sort((a, b) => (a.idx || 0) - (b.idx || 0));\r\n                                                    \r\n//                                                     console.log(\"Items After Sort:\", items.map(i => ({idx: i.idx, code: i.item_code})));\r\n\r\n//                                                     let all_items_data = [];\r\n//                                                     let total_items = items.length;\r\n\r\n//                                                     // ==========================================================\r\n//                                                     // Load each item into Sales Order (with proper ordering)\r\n//                                                     // ==========================================================\r\n//                                                     items.forEach(item => {\r\n\r\n//                                                         // Get default warehouse for the company\r\n//                                                         frappe.call({\r\n//                                                             method: \"galaxynext.api.get_item_default_warehouse\",\r\n//                                                             args: {\r\n//                                                                 item_code: item.item_code,\r\n//                                                                 company: supplier_company\r\n//                                                             },\r\n//                                                             callback(wr) {\r\n\r\n//                                                                 let warehouse = wr.message || item.warehouse;\r\n\r\n//                                                                 // Get default BOM\r\n//                                                                 frappe.call({\r\n//                                                                     method: \"frappe.client.get_value\",\r\n//                                                                     args: {\r\n//                                                                         doctype: \"Item\",\r\n//                                                                         filters: { name: item.item_code },\r\n//                                                                         fieldname: [\"default_bom\"]\r\n//                                                                     },\r\n//                                                                     callback(bom_res) {\r\n\r\n//                                                                         let bom_no = bom_res.message ? bom_res.message.default_bom : \"\";\r\n\r\n//                                                                         // Use service rate as priority\r\n//                                                                         let item_rate =\r\n//                                                                             service_rate ||\r\n//                                                                             item.rate ||\r\n//                                                                             item.amount ||\r\n//                                                                             item.valuation_rate ||\r\n//                                                                             0;\r\n\r\n//                                                                         console.log(`Item ${item.idx}: ${item.item_code}`);\r\n//                                                                         console.log(`  - Service Rate: ${service_rate}`);\r\n//                                                                         console.log(`  - Item Rate: ${item.rate}`);\r\n//                                                                         console.log(`  - Final Rate: ${item_rate}`);\r\n//                                                                         console.log(`  - Warehouse: ${warehouse}`);\r\n//                                                                         console.log(`  - BOM: ${bom_no}`);\r\n\r\n//                                                                         // Store item data with idx\r\n//                                                                         all_items_data.push({\r\n//                                                                             idx: item.idx,\r\n//                                                                             item_code: item.item_code,\r\n//                                                                             item_name: item.item_name,\r\n//                                                                             qty: item.qty,\r\n//                                                                             uom: item.uom || item.stock_uom,\r\n//                                                                             warehouse: warehouse,\r\n//                                                                             rate: item_rate,\r\n//                                                                             bom_no: bom_no\r\n//                                                                         });\r\n\r\n//                                                                         // Once all items collected, add them in order\r\n//                                                                         if (all_items_data.length === total_items) {\r\n//                                                                             console.log(\"=== ALL ITEMS COLLECTED ===\");\r\n//                                                                             console.log(\"Total Collected:\", all_items_data.length);\r\n//                                                                             console.log(\"Before Final Sort:\", all_items_data.map(i => ({idx: i.idx, code: i.item_code, rate: i.rate})));\r\n                                                                            \r\n//                                                                             // Sort by idx before adding\r\n//                                                                             all_items_data.sort((a, b) => (a.idx || 0) - (b.idx || 0));\r\n\r\n//                                                                             console.log(\"After Final Sort:\", all_items_data.map(i => ({idx: i.idx, code: i.item_code, rate: i.rate})));\r\n\r\n//                                                                             // Add all items in correct order\r\n//                                                                             all_items_data.forEach(item_data => {\r\n//                                                                                 let row = frm.add_child(\"items\");\r\n//                                                                                 row.item_code = item_data.item_code;\r\n//                                                                                 row.item_name = item_data.item_name;\r\n//                                                                                 row.qty = item_data.qty;\r\n//                                                                                 row.uom = item_data.uom;\r\n//                                                                                 row.delivery_date = frappe.datetime.get_today();\r\n//                                                                                 row.warehouse = item_data.warehouse;\r\n//                                                                                 row.rate = item_data.rate;\r\n\r\n//                                                                                 if (item_data.bom_no) {\r\n//                                                                                     row.bom_no = item_data.bom_no;\r\n//                                                                                 }\r\n//                                                                             });\r\n\r\n//                                                                             frm.refresh_field(\"items\");\r\n\r\n//                                                                             console.log(\"=== ITEMS ADDED TO SALES ORDER ===\");\r\n//                                                                             console.log(\"Success! Items loaded in correct order\");\r\n\r\n//                                                                             frappe.show_alert({\r\n//                                                                                 message: __(\"{0} items loaded successfully from {1}\", [all_items_data.length, sco.name]),\r\n//                                                                                 indicator: 'green'\r\n//                                                                             });\r\n//                                                                         }\r\n//                                                                     }\r\n//                                                                 });\r\n//                                                             }\r\n//                                                         });\r\n//                                                     });\r\n//                                                 }\r\n//                                             });\r\n//                                         }\r\n//                                     });\r\n\r\n//                                     d.hide();\r\n//                                 }\r\n//                             });\r\n\r\n//                             d.show();\r\n//                         });\r\n//                     }\r\n//                 }\r\n//             });\r\n//         }\r\n//     },\r\n\r\n//     // ==========================================================\r\n//     // FEATURE 3: Automatically update delivery date for all items\r\n//     // ==========================================================\r\n//     delivery_date(frm) {\r\n//         if (frm.doc.delivery_date && frm.doc.items?.length > 0) {\r\n\r\n//             let updated_count = 0;\r\n\r\n//             frm.doc.items.forEach(item => {\r\n//                 if (item.delivery_date !== frm.doc.delivery_date) {\r\n//                     frappe.model.set_value(\r\n//                         item.doctype,\r\n//                         item.name,\r\n//                         'delivery_date',\r\n//                         frm.doc.delivery_date\r\n//                     );\r\n//                     updated_count++;\r\n//                 }\r\n//             });\r\n\r\n//             if (updated_count > 0) {\r\n//                 frm.refresh_field('items');\r\n//                 frappe.show_alert({\r\n//                     message: __('Delivery date updated for {0} items', [updated_count]),\r\n//                     indicator: 'blue'\r\n//                 });\r\n//             }\r\n//         }\r\n//     }\r\n// });\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// frappe.ui.form.on('Sales Order', {\r\n//     refresh(frm) {\r\n\r\n//         // ==========================================================\r\n//         // FEATURE 1: Make PO Number clickable\r\n//         // ==========================================================\r\n//         if (frm.doc.po_no && frm.doc.po_no.startsWith('SC-ORD-')) {\r\n//             frm.fields_dict['po_no'].$wrapper.find('input').css('cursor', 'pointer');\r\n\r\n//             frm.fields_dict['po_no'].$wrapper\r\n//                 .off('click')\r\n//                 .on('click', function () {\r\n//                     frappe.set_route('Form', 'Subcontracting Order', frm.doc.po_no);\r\n//                 });\r\n//         }\r\n\r\n//         // ==========================================================\r\n//         // FEATURE 2: Show button only if SUBCONTRACTING enabled\r\n//         // FIXED: Removed frm.is_new() condition - button now shows for all draft documents\r\n//         // ==========================================================\r\n//         if (frm.doc.docstatus === 0) {  // Only check if Draft status\r\n\r\n//             let company = frm.doc.company || frappe.defaults.get_default(\"Company\");\r\n\r\n//             if (!company) {\r\n//                 console.warn(\"Company not set yet\");\r\n//                 return;\r\n//             }\r\n\r\n//             frappe.call({\r\n//                 method: \"galaxynext.api.check_parameter_enabled\",\r\n//                 args: {\r\n//                     company: company,\r\n//                     param_name: \"SUBCONTRACTING\"\r\n//                 },\r\n//                 callback(r) {\r\n\r\n//                     console.log(\"SUBCONTRACTING PARAM RESPONSE:\", r.message);\r\n\r\n//                     if (r.message && r.message.enabled) {\r\n\r\n//                         frm.add_custom_button(__('Load From Subcontracting'), function () {\r\n\r\n//                             if (frm.doc.po_no && frm.doc.po_no.startsWith('SC-ORD-')) {\r\n//                                 frappe.msgprint({\r\n//                                     title: __('Already Loaded'),\r\n//                                     message: __('Data already loaded from Subcontracting Order.'),\r\n//                                     indicator: 'orange'\r\n//                                 });\r\n//                                 return;\r\n//                             }\r\n//                             // ==========================================================\r\n//                             // DIALOG: Select Company, Customer & Subcontracting Order\r\n//                             // ==========================================================\r\n//                             let d = new frappe.ui.Dialog({\r\n//                                 title: 'Select Company, Customer & Subcontracting Order',\r\n//                                 fields: [\r\n\r\n//                                     // ------------------------ COMPANY ------------------------\r\n//                                     {\r\n//                                         label: 'Select Company',\r\n//                                         fieldname: 'selected_company',\r\n//                                         fieldtype: 'Link',\r\n//                                         options: 'Company',\r\n//                                         reqd: 1,\r\n//                                         onchange: () => {\r\n//                                             // Reset dependent fields on company change\r\n//                                             d.set_value('customer', '');\r\n//                                             d.set_value('customer_company', '');\r\n//                                             d.set_value('subcontracting_order', '');\r\n\r\n//                                             // Filter customers based on selected company\r\n//                                             d.fields_dict.customer.get_query = () => {\r\n//                                                 return {\r\n//                                                     query: \"galaxynext.api.get_allowed_internal_customers\",\r\n//                                                     filters: {\r\n//                                                         company: d.get_value('selected_company')\r\n//                                                     }\r\n//                                                 };\r\n//                                             };\r\n//                                             d.fields_dict.customer.refresh();\r\n//                                         }\r\n//                                     },\r\n\r\n//                                     // ------------------------ INTERNAL CUSTOMER ------------------------\r\n//                                     {\r\n//                                         label: 'Internal Customer',\r\n//                                         fieldname: 'customer',\r\n//                                         fieldtype: 'Link',\r\n//                                         options: 'Customer',\r\n//                                         reqd: 1,\r\n//                                         get_query: () => {\r\n//                                             let selected_company = d.get_value('selected_company');\r\n\r\n//                                             if (!selected_company) {\r\n//                                                 frappe.msgprint(__('Please select a company first'));\r\n//                                                 return { filters: { name: ['=', ''] } };\r\n//                                             }\r\n\r\n//                                             return {\r\n//                                                 query: \"galaxynext.api.get_allowed_internal_customers\",\r\n//                                                 filters: { company: selected_company }\r\n//                                             };\r\n//                                         },\r\n//                                         onchange: () => {\r\n//                                             let customer = d.get_value('customer');\r\n\r\n//                                             // Fetch customer's representing company\r\n//                                             if (customer) {\r\n//                                                 frappe.call({\r\n//                                                     method: \"frappe.client.get_value\",\r\n//                                                     args: {\r\n//                                                         doctype: \"Customer\",\r\n//                                                         filters: { name: customer },\r\n//                                                         fieldname: \"represents_company\"\r\n//                                                     },\r\n//                                                     callback(r) {\r\n//                                                         if (r.message) {\r\n//                                                             d.set_value(\"customer_company\", r.message.represents_company);\r\n//                                                         }\r\n//                                                     }\r\n//                                                 });\r\n//                                             }\r\n//                                         }\r\n//                                     },\r\n\r\n//                                     // ------------------------ CUSTOMER COMPANY (READ ONLY) ------------------------\r\n//                                     {\r\n//                                         label: 'Customer Company',\r\n//                                         fieldname: 'customer_company',\r\n//                                         fieldtype: 'Link',\r\n//                                         options: 'Company',\r\n//                                         read_only: 1\r\n//                                     },\r\n\r\n//                                     // ------------------------ SUBCONTRACTING ORDER ------------------------\r\n//                                     {\r\n//                                         label: 'Subcontracting Order',\r\n//                                         fieldname: 'subcontracting_order',\r\n//                                         fieldtype: 'Link',\r\n//                                         options: 'Subcontracting Order',\r\n//                                         reqd: 1,\r\n//                                         get_query: () => {\r\n//                                             let customer_company = d.get_value(\"customer_company\");\r\n\r\n//                                             if (!customer_company) {\r\n//                                                 frappe.msgprint(__('Please select a customer first'));\r\n//                                                 return { filters: { name: ['=', ''] } };\r\n//                                             }\r\n\r\n//                                             return {\r\n//                                                 query: \"galaxynext.api.get_available_subcontracting_orders\",\r\n//                                                 filters: { company: customer_company }\r\n//                                             };\r\n//                                         }\r\n//                                     }\r\n//                                 ],\r\n\r\n//                                 // ==========================================================\r\n//                                 // PRIMARY ACTION: Load data from Subcontracting Order\r\n//                                 // ==========================================================\r\n//                                 primary_action_label: 'Load Data',\r\n//                                 primary_action(values) {\r\n\r\n//                                     // Fetch selected Subcontracting Order\r\n//                                     frappe.call({\r\n//                                         method: \"frappe.client.get\",\r\n//                                         args: {\r\n//                                             doctype: \"Subcontracting Order\",\r\n//                                             name: values.subcontracting_order\r\n//                                         },\r\n//                                         callback(r) {\r\n//                                             let sco = r.message;\r\n\r\n//                                             console.log(\"=== FULL SUBCONTRACTING ORDER DATA ===\");\r\n//                                             console.log(\"Complete SCO Object:\", sco);\r\n//                                             console.log(\"SCO Name:\", sco.name);\r\n//                                             console.log(\"SCO Supplier:\", sco.supplier);\r\n//                                             console.log(\"SCO Transaction Date:\", sco.transaction_date);\r\n//                                             console.log(\"SCO Items:\", sco.items);\r\n//                                             console.log(\"SCO Service Items:\", sco.service_items);\r\n                                            \r\n//                                             if (sco.service_items && sco.service_items.length > 0) {\r\n//                                                 console.log(\"Service Items Details:\");\r\n//                                                 sco.service_items.forEach((si, idx) => {\r\n//                                                     console.log(`  Service Item ${idx + 1}:`, {\r\n//                                                         item_code: si.item_code,\r\n//                                                         item_name: si.item_name,\r\n//                                                         qty: si.qty,\r\n//                                                         rate: si.rate,\r\n//                                                         amount: si.amount\r\n//                                                     });\r\n//                                                 });\r\n//                                             }\r\n                                            \r\n//                                             if (sco.items && sco.items.length > 0) {\r\n//                                                 console.log(\"Main Items Details:\");\r\n//                                                 sco.items.forEach((item, idx) => {\r\n//                                                     console.log(`  Item ${idx + 1}:`, {\r\n//                                                         idx: item.idx,\r\n//                                                         item_code: item.item_code,\r\n//                                                         item_name: item.item_name,\r\n//                                                         qty: item.qty,\r\n//                                                         rate: item.rate,\r\n//                                                         amount: item.amount,\r\n//                                                         valuation_rate: item.valuation_rate,\r\n//                                                         warehouse: item.warehouse\r\n//                                                     });\r\n//                                                 });\r\n//                                             }\r\n\r\n//                                             // Fetch supplier's representing company\r\n//                                             frappe.call({\r\n//                                                 method: \"frappe.client.get_value\",\r\n//                                                 args: {\r\n//                                                     doctype: \"Supplier\",\r\n//                                                     filters: { name: sco.supplier },\r\n//                                                     fieldname: \"represents_company\"\r\n//                                                 },\r\n//                                                 callback(res) {\r\n\r\n//                                                     if (!res.message || !res.message.represents_company) {\r\n//                                                         frappe.msgprint(__(\"Supplier company not found\"));\r\n//                                                         return;\r\n//                                                     }\r\n\r\n//                                                     let supplier_company = res.message.represents_company;\r\n\r\n//                                                     // Validate selected company with supplier company\r\n//                                                     if (supplier_company !== values.selected_company) {\r\n//                                                         frappe.msgprint(__(\"Selected company does not match supplier company\"));\r\n//                                                         return;\r\n//                                                     }\r\n\r\n//                                                     // Set Sales Order header values\r\n//                                                     frm.set_value(\"company\", supplier_company);\r\n//                                                     frm.set_value(\"customer\", values.customer);\r\n//                                                     frm.set_value(\"po_no\", sco.name);\r\n//                                                     frm.set_value(\"po_date\", sco.transaction_date);\r\n//                                                     frm.set_value(\"delivery_date\", frappe.datetime.get_today());\r\n\r\n//                                                     // Clear existing items\r\n//                                                     frm.clear_table(\"items\");\r\n\r\n//                                                     let items = sco.items || [];\r\n//                                                     if (!items.length) {\r\n//                                                         frappe.show_alert({\r\n//                                                             message: __(\"No items found in Subcontracting Order\"),\r\n//                                                             indicator: 'orange'\r\n//                                                         });\r\n//                                                         return;\r\n//                                                     }\r\n\r\n//                                                     // ==========================================================\r\n//                                                     // Get service item rate (same rate applied to all items)\r\n//                                                     // ==========================================================\r\n//                                                     let service_rate = 0;\r\n//                                                     if (sco.service_items && sco.service_items.length > 0) {\r\n//                                                         service_rate = sco.service_items[0].rate || 0;\r\n//                                                     }\r\n\r\n//                                                     console.log(\"=== SUBCONTRACTING ORDER DATA ===\");\r\n//                                                     console.log(\"SCO Name:\", sco.name);\r\n//                                                     console.log(\"Service Rate:\", service_rate);\r\n//                                                     console.log(\"Total Items:\", items.length);\r\n//                                                     console.log(\"Items Before Sort:\", items.map(i => ({idx: i.idx, code: i.item_code, rate: i.rate})));\r\n\r\n//                                                     // ==========================================================\r\n//                                                     // Sort items by idx to maintain order\r\n//                                                     // ==========================================================\r\n//                                                     items.sort((a, b) => (a.idx || 0) - (b.idx || 0));\r\n                                                    \r\n//                                                     console.log(\"Items After Sort:\", items.map(i => ({idx: i.idx, code: i.item_code})));\r\n\r\n//                                                     let all_items_data = [];\r\n//                                                     let total_items = items.length;\r\n\r\n//                                                     // ==========================================================\r\n//                                                     // Load each item into Sales Order (with proper ordering)\r\n//                                                     // ==========================================================\r\n//                                                     items.forEach(item => {\r\n\r\n//                                                         // Get default warehouse for the company\r\n//                                                         frappe.call({\r\n//                                                             method: \"galaxynext.api.get_item_default_warehouse\",\r\n//                                                             args: {\r\n//                                                                 item_code: item.item_code,\r\n//                                                                 company: supplier_company\r\n//                                                             },\r\n//                                                             callback(wr) {\r\n\r\n//                                                                 let warehouse = wr.message || item.warehouse;\r\n\r\n//                                                                 // Get default BOM\r\n//                                                                 frappe.call({\r\n//                                                                     method: \"frappe.client.get_value\",\r\n//                                                                     args: {\r\n//                                                                         doctype: \"Item\",\r\n//                                                                         filters: { name: item.item_code },\r\n//                                                                         fieldname: [\"default_bom\"]\r\n//                                                                     },\r\n//                                                                     callback(bom_res) {\r\n\r\n//                                                                         let bom_no = bom_res.message ? bom_res.message.default_bom : \"\";\r\n\r\n//                                                                         // Use service rate as priority\r\n//                                                                         let item_rate =\r\n//                                                                             service_rate ||\r\n//                                                                             item.rate ||\r\n//                                                                             item.amount ||\r\n//                                                                             item.valuation_rate ||\r\n//                                                                             0;\r\n\r\n//                                                                         console.log(`Item ${item.idx}: ${item.item_code}`);\r\n//                                                                         console.log(`  - Service Rate: ${service_rate}`);\r\n//                                                                         console.log(`  - Item Rate: ${item.rate}`);\r\n//                                                                         console.log(`  - Final Rate: ${item_rate}`);\r\n//                                                                         console.log(`  - Warehouse: ${warehouse}`);\r\n//                                                                         console.log(`  - BOM: ${bom_no}`);\r\n\r\n//                                                                         // Store item data with idx\r\n//                                                                         all_items_data.push({\r\n//                                                                             idx: item.idx,\r\n//                                                                             item_code: item.item_code,\r\n//                                                                             item_name: item.item_name,\r\n//                                                                             qty: item.qty,\r\n//                                                                             uom: item.uom || item.stock_uom,\r\n//                                                                             warehouse: warehouse,\r\n//                                                                             rate: item_rate,\r\n//                                                                             bom_no: bom_no\r\n//                                                                         });\r\n\r\n//                                                                         // Once all items collected, add them in order\r\n//                                                                         if (all_items_data.length === total_items) {\r\n//                                                                             console.log(\"=== ALL ITEMS COLLECTED ===\");\r\n//                                                                             console.log(\"Total Collected:\", all_items_data.length);\r\n//                                                                             console.log(\"Before Final Sort:\", all_items_data.map(i => ({idx: i.idx, code: i.item_code, rate: i.rate})));\r\n                                                                            \r\n//                                                                             // Sort by idx before adding\r\n//                                                                             all_items_data.sort((a, b) => (a.idx || 0) - (b.idx || 0));\r\n\r\n//                                                                             console.log(\"After Final Sort:\", all_items_data.map(i => ({idx: i.idx, code: i.item_code, rate: i.rate})));\r\n\r\n//                                                                             // Add all items in correct order\r\n//                                                                             all_items_data.forEach(item_data => {\r\n//                                                                                 let row = frm.add_child(\"items\");\r\n//                                                                                 row.item_code = item_data.item_code;\r\n//                                                                                 row.item_name = item_data.item_name;\r\n//                                                                                 row.qty = item_data.qty;\r\n//                                                                                 row.uom = item_data.uom;\r\n//                                                                                 row.delivery_date = frappe.datetime.get_today();\r\n//                                                                                 row.warehouse = item_data.warehouse;\r\n//                                                                                 row.rate = item_data.rate;\r\n\r\n//                                                                                 if (item_data.bom_no) {\r\n//                                                                                     row.bom_no = item_data.bom_no;\r\n//                                                                                 }\r\n//                                                                             });\r\n\r\n//                                                                             frm.refresh_field(\"items\");\r\n\r\n//                                                                             console.log(\"=== ITEMS ADDED TO SALES ORDER ===\");\r\n//                                                                             console.log(\"Success! Items loaded in correct order\");\r\n\r\n//                                                                             frappe.show_alert({\r\n//                                                                                 message: __(\"{0} items loaded successfully from {1}\", [all_items_data.length, sco.name]),\r\n//                                                                                 indicator: 'green'\r\n//                                                                             });\r\n//                                                                         }\r\n//                                                                     }\r\n//                                                                 });\r\n//                                                             }\r\n//                                                         });\r\n//                                                     });\r\n//                                                 }\r\n//                                             });\r\n//                                         }\r\n//                                     });\r\n\r\n//                                     d.hide();\r\n//                                 }\r\n//                             });\r\n\r\n//                             d.show();\r\n//                         });\r\n//                     }\r\n//                 }\r\n//             });\r\n//         }\r\n//     },\r\n\r\n//     // ==========================================================\r\n//     // FEATURE 3: Automatically update delivery date for all items\r\n//     // ==========================================================\r\n//     delivery_date(frm) {\r\n//         if (frm.doc.delivery_date && frm.doc.items?.length > 0) {\r\n\r\n//             let updated_count = 0;\r\n\r\n//             frm.doc.items.forEach(item => {\r\n//                 if (item.delivery_date !== frm.doc.delivery_date) {\r\n//                     frappe.model.set_value(\r\n//                         item.doctype,\r\n//                         item.name,\r\n//                         'delivery_date',\r\n//                         frm.doc.delivery_date\r\n//                     );\r\n//                     updated_count++;\r\n//                 }\r\n//             });\r\n\r\n//             if (updated_count > 0) {\r\n//                 frm.refresh_field('items');\r\n//                 frappe.show_alert({\r\n//                     message: __('Delivery date updated for {0} items', [updated_count]),\r\n//                     indicator: 'blue'\r\n//                 });\r\n//             }\r\n//         }\r\n//     }\r\n// });\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "BOM",
  "enabled": 1,
  "modified": "2025-10-06 17:41:28.057974",
  "module": "galaxynext",
  "name": "fetch item parameter",
  "script": "// // frappe.ui.form.on(\"BOM\", {\r\n// //     item: function(frm) {\r\n// //         if (frm.doc.item) {\r\n// //             frappe.call({\r\n// //                 method: \"frappe.client.get\",\r\n// //                 args: {\r\n// //                     doctype: \"Item\",\r\n// //                     name: frm.doc.item\r\n// //                 },\r\n// //                 callback: function(r) {\r\n// //                     if (r.message) {\r\n// //                         let item_doc = r.message;\r\n\r\n// //                         // clear existing value\r\n// //                         frm.set_value(\"item_parameter\", \"\");\r\n\r\n// //                         // fetch child table (custom_item_parameters)\r\n// //                         if (item_doc.custom_item_parameters && item_doc.custom_item_parameters.length > 0) {\r\n// //                             let values = item_doc.custom_item_parameters.map(row => row.value).join(\", \");\r\n// //                             frm.set_value(\"item_parameter\", values);\r\n// //                         }\r\n// //                     }\r\n// //                 }\r\n// //             });\r\n// //         } else {\r\n// //             frm.set_value(\"item_parameter\", \"\");\r\n// //         }\r\n// //     }\r\n// // });\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// // value show code\r\n\r\n\r\n\r\n\r\n\r\n// // frappe.ui.form.on(\"BOM\", {\r\n// //     item: function(frm) {\r\n// //         if (frm.doc.item) {\r\n// //             // Method 1: Try to get the displayed value using a custom server call\r\n// //             frappe.call({\r\n// //                 method: \"frappe.client.get\",\r\n// //                 args: {\r\n// //                     doctype: \"Item\",\r\n// //                     name: frm.doc.item\r\n// //                 },\r\n// //                 callback: function(r) {\r\n// //                     frm.set_value(\"item_parameter\", \"\");\r\n                    \r\n// //                     if (r.message && r.message.custom_item_parameters) {\r\n// //                         // Find Design parameter\r\n// //                         let design_parameter = r.message.custom_item_parameters.find(row => \r\n// //                             row.parameter && row.parameter.toLowerCase() === 'design'\r\n// //                         );\r\n                        \r\n// //                         if (design_parameter) {\r\n// //                             // Try to resolve the actual display value\r\n// //                             // If the value is a code (like MM-09-2025-00031), we need to resolve it\r\n// //                             resolve_parameter_display_value(design_parameter.value, function(display_value) {\r\n// //                                 frm.set_value(\"item_parameter\", `Design: ${display_value}`);\r\n// //                                 frappe.show_alert({\r\n// //                                     message: `Design parameter: ${display_value}`,\r\n// //                                     indicator: 'green'\r\n// //                                 });\r\n// //                             });\r\n// //                         } else {\r\n// //                             frappe.show_alert({\r\n// //                                 message: 'No Design parameter found',\r\n// //                                 indicator: 'orange'\r\n// //                             });\r\n// //                         }\r\n// //                     }\r\n// //                 }\r\n// //             });\r\n// //         } else {\r\n// //             frm.set_value(\"item_parameter\", \"\");\r\n// //         }\r\n// //     }\r\n// // });\r\n\r\n// // // Helper function to resolve parameter display value\r\n// // function resolve_parameter_display_value(value, callback) {\r\n// //     // If value looks like a code (MM-09-2025-00031), try to resolve it\r\n// //     if (value && value.match(/MM-\\d{2}-\\d{4}-\\d{5}/)) {\r\n// //         // This might be a reference to another doctype\r\n// //         // Try common doctypes that might contain this pattern\r\n        \r\n// //         // Method 1: Check if it's an Item code\r\n// //         frappe.call({\r\n// //             method: \"frappe.client.get_value\",\r\n// //             args: {\r\n// //                 doctype: \"Item\",\r\n// //                 filters: {\"name\": value},\r\n// //                 fieldname: \"item_name\"\r\n// //             },\r\n// //             callback: function(r) {\r\n// //                 if (r.message && r.message.item_name) {\r\n// //                     callback(r.message.item_name);\r\n// //                 } else {\r\n// //                     // Method 2: Check if there's a custom doctype or field mapping\r\n// //                     // For now, let's try to extract a readable part or use as-is\r\n                    \r\n// //                     // Try to get a more readable version\r\n// //                     let readable_value = value.split('-').pop(); // Get last part\r\n// //                     if (readable_value === '00031') {\r\n// //                         callback('fabric'); // Hardcoded mapping - you might need to adjust this\r\n// //                     } else {\r\n// //                         callback(value); // Use original value if no mapping found\r\n// //                     }\r\n// //                 }\r\n// //             }\r\n// //         });\r\n// //     } else {\r\n// //         // Value is already in display format\r\n// //         callback(value || 'N/A');\r\n// //     }\r\n// // }\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// frappe.ui.form.on(\"BOM\", {\r\n//     item: function(frm) {\r\n//         if (!frm.doc.item) {\r\n//             frm.set_value(\"item_parameter\", \"\");\r\n//             return;\r\n//         }\r\n\r\n//         // Fetch Item with Parameters\r\n//         frappe.call({\r\n//             method: \"frappe.client.get\",\r\n//             args: {\r\n//                 doctype: \"Item\",\r\n//                 name: frm.doc.item\r\n//             },\r\n//             callback: function(r) {\r\n//                 if (!r.message) return;\r\n\r\n//                 let item = r.message;\r\n//                 let design_value = \"\";\r\n\r\n//                 // Find Design parameter from Item â†’ Item Parameters\r\n//                 if (item.custom_item_parameters && item.custom_item_parameters.length > 0) {\r\n//                     let design_param = item.custom_item_parameters.find(d =>\r\n//                         d.parameter && d.parameter.toLowerCase() === \"design import\"\r\n//                     );\r\n\r\n//                     if (design_param) {\r\n//                         // Resolve link value (MiscellaneousMst) â†’ human readable\r\n//                         frappe.call({\r\n//                             method: \"frappe.client.get_value\",\r\n//                             args: {\r\n//                                 doctype: \"MiscellaneousMst\",\r\n//                                 filters: { name: design_param.value },\r\n//                                 fieldname: \"value\"\r\n//                             },\r\n//                             callback: function(res) {\r\n//                                 if (res.message && res.message.value) {\r\n//                                     design_value = res.message.value;\r\n//                                 } else {\r\n//                                     design_value = design_param.value;\r\n//                                 }\r\n\r\n//                                 frm.set_value(\"item_parameter\", design_value);\r\n//                                 frappe.show_alert({\r\n//                                     message: `Design import: ${design_value}`,\r\n//                                     indicator: \"green\"\r\n//                                 });\r\n//                             }\r\n//                         });\r\n//                     } else {\r\n//                         frm.set_value(\"item_parameter\", \"\");\r\n//                         frappe.show_alert({\r\n//                             message: \"No Design parameter found\",\r\n//                             indicator: \"orange\"\r\n//                         });\r\n//                     }\r\n//                 }\r\n//             }\r\n//         });\r\n//     }\r\n// });\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// ----------------------------sujal working script \r\n\r\n\r\nfrappe.ui.form.on(\"BOM\", {\r\n    item: function(frm) {\r\n        if (!frm.doc.item) {\r\n            frm.set_value(\"item_parameter\", \"\");\r\n            return;\r\n        }\r\n        // Fetch Item with Parameters\r\n        frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: {\r\n                doctype: \"Item\",\r\n                name: frm.doc.item\r\n            },\r\n            callback: function(r) {\r\n                if (!r.message) return;\r\n                let item = r.message;\r\n                let design_value = \"\";\r\n                // Find Design parameter from Item â†’ Item Parameters\r\n                if (item.custom_item_parameters && item.custom_item_parameters.length > 0) {\r\n                    let design_param = item.custom_item_parameters.find(d =>\r\n                        d.parameter && d.parameter.toLowerCase() === \"design import\"\r\n                    );\r\n                    if (design_param) {\r\n                        // Resolve link value (MiscellaneousMst) â†’ human readable\r\n                        frappe.call({\r\n                            method: \"frappe.client.get_value\",\r\n                            args: {\r\n                                doctype: \"MiscellaneousMst\",\r\n                                filters: { name: design_param.value },\r\n                                fieldname: \"value\"\r\n                            },\r\n                            callback: function(res) {\r\n                                if (res.message && res.message.value) {\r\n                                    design_value = res.message.value;\r\n                                } else {\r\n                                    design_value = design_param.value;\r\n                                }\r\n                                frm.set_value(\"item_parameter\", design_value);\r\n                                frappe.show_alert({\r\n                                    message: `Design import: ${design_value}`,\r\n                                    indicator: \"green\"\r\n                                });\r\n                            }\r\n                        });\r\n                    } else {\r\n                        frm.set_value(\"item_parameter\", \"\");\r\n                        frappe.show_alert({\r\n                            message: \"No Design parameter found\",\r\n                            indicator: \"orange\"\r\n                        });\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n});\r\n\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "BOM",
  "enabled": 1,
  "modified": "2025-09-22 16:53:48.677721",
  "module": "",
  "name": "Get Original Tab Table detail",
  "script": "// // perfect code\r\n// frappe.ui.form.on('BOM', {\r\n//     get_details: function(frm) {\r\n//         frappe.call({\r\n//             method: 'frappe.client.get_list',\r\n//             args: {\r\n//                 doctype: 'Design Import',\r\n//                 fields: ['name'],\r\n//                 order_by: 'creation desc',\r\n//                 limit_page_length: 1\r\n//             },\r\n//             callback: function(r) {\r\n//                 if (r.message && r.message.length) {\r\n//                     let latest_import = r.message[0].name;\r\n\r\n//                     frappe.call({\r\n//                         method: 'frappe.client.get',\r\n//                         args: {\r\n//                             doctype: 'Design Import',\r\n//                             name: latest_import\r\n//                         },\r\n//                         callback: function(res) {\r\n//                             if (res.message) {\r\n//                                 add_colors_to_bom(frm, res.message.original_tab_table || []);\r\n//                             } else {\r\n//                                 frappe.msgprint('âŒ No data found in latest Design Import.');\r\n//                             }\r\n//                         }\r\n//                     });\r\n\r\n//                 } else {\r\n//                     frappe.msgprint(\"âš ï¸ No Design Import records found.\");\r\n//                 }\r\n//             }\r\n//         });\r\n//     }\r\n// });\r\n\r\n// function add_colors_to_bom(frm, color_rows) {\r\n//     if (!color_rows.length) {\r\n//         frappe.msgprint(\"âš ï¸ No rows found in Original Tab Table.\");\r\n//         return;\r\n//     }\r\n\r\n//     frm.clear_table(\"items\");\r\n\r\n//     let added_count = 0;\r\n\r\n//     color_rows.forEach((row) => {\r\n//         if (row.color_name) {\r\n//             let child = frm.add_child(\"items\");\r\n//             child.item_code = row.color_name;\r\n//             child.qty = 1;\r\n//             child.uom = \"Nos\";\r\n//             child.rate = 0;\r\n\r\n//             // fetch stock info\r\n//             frappe.db.get_value(\"Item\", row.color_name, \"is_stock_item\", (r) => {\r\n//                 if (r && r.is_stock_item !== undefined) {\r\n//                     frappe.model.set_value(child.doctype, child.name, \"is_stock_item\", r.is_stock_item);\r\n//                 }\r\n//             });\r\n\r\n//             added_count++;\r\n//         }\r\n//     });\r\n\r\n//     frm.refresh_field(\"items\");\r\n\r\n//     frappe.msgprint(`âœ… ${added_count} Color Samples added from latest Design Import.`);\r\n// }\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// // error\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// // frappe.ui.form.on('BOM', {\r\n// //     get_details: function(frm) {\r\n// //         frappe.call({\r\n// //             method: 'frappe.client.get_list',\r\n// //             args: {\r\n// //                 doctype: 'Design Import',\r\n// //                 fields: ['name'],\r\n// //                 order_by: 'creation desc',\r\n// //                 limit_page_length: 1\r\n// //             },\r\n// //             callback: function(r) {\r\n// //                 if (r.message && r.message.length) {\r\n// //                     let latest_import = r.message[0].name;\r\n// //                     frappe.call({\r\n// //                         method: 'frappe.client.get',\r\n// //                         args: {\r\n// //                             doctype: 'Design Import',\r\n// //                             name: latest_import\r\n// //                         },\r\n// //                         callback: function(res) {\r\n// //                             if (res.message) {\r\n// //                                 add_colors_to_bom(frm, res.message.original_tab_table || []);\r\n// //                             } else {\r\n// //                                 frappe.msgprint('âŒ No data found in latest Design Import.');\r\n// //                             }\r\n// //                         }\r\n// //                     });\r\n// //                 } else {\r\n// //                     frappe.msgprint(\"âš ï¸ No Design Import records found.\");\r\n// //                 }\r\n// //             }\r\n// //         });\r\n// //     }\r\n// // });\r\n\r\n// // function add_colors_to_bom(frm, color_rows) {\r\n// //     if (!color_rows.length) {\r\n// //         frappe.msgprint(\"âš ï¸ No rows found in Original Tab Table.\");\r\n// //         return;\r\n// //     }\r\n    \r\n// //     frm.clear_table(\"items\");\r\n// //     let added_count = 0;\r\n    \r\n// //     color_rows.forEach((row) => {\r\n// //         if (row.color_name) {\r\n// //             let child = frm.add_child(\"items\");\r\n// //             child.item_code = row.color_name;\r\n// //             child.qty = 1;\r\n// //             child.uom = \"Nos\";\r\n// //             child.rate = 0;\r\n            \r\n// //             // Fix: Use frappe.call instead of frappe.db.get_value for better compatibility\r\n// //             frappe.call({\r\n// //                 method: 'frappe.client.get_value',\r\n// //                 args: {\r\n// //                     doctype: 'Item',\r\n// //                     filters: {\r\n// //                         'name': row.color_name\r\n// //                     },\r\n// //                     fieldname: ['is_stock_item', 'stock_uom']\r\n// //                 },\r\n// //                 callback: function(r) {\r\n// //                     if (r.message) {\r\n// //                         if (r.message.is_stock_item !== undefined) {\r\n// //                             frappe.model.set_value(child.doctype, child.name, \"is_stock_item\", r.message.is_stock_item);\r\n// //                         }\r\n// //                         if (r.message.stock_uom) {\r\n// //                             frappe.model.set_value(child.doctype, child.name, \"uom\", r.message.stock_uom);\r\n// //                         }\r\n// //                     }\r\n// //                 }\r\n// //             });\r\n            \r\n// //             added_count++;\r\n// //         }\r\n// //     });\r\n    \r\n// //     frm.refresh_field(\"items\");\r\n// //     frappe.msgprint(`âœ… ${added_count} Color Samples added from latest Design Import.`);\r\n// // }\r\n\r\n\r\n\r\n\r\n\r\n// ---------------------------------sujal working script\r\n\r\n\r\n\r\n\r\n// Step 1: Debug Script - Find correct field name for Item Parameters\r\nfrappe.ui.form.on('BOM', {\r\n    debug_item_fields: function(frm) {\r\n        // First, let's check one of your items to find the correct field name\r\n        frappe.call({\r\n            method: 'frappe.client.get',\r\n            args: {\r\n                doctype: 'Item',\r\n                name: '300-HAND TUFTED-DESIGN 2-8X15-AE 08'  // Replace with any of your item codes\r\n            },\r\n            callback: function(r) {\r\n                if (r.message) {\r\n                    console.log(\"=== FULL ITEM DATA ===\");\r\n                    console.log(r.message);\r\n                    \r\n                    // Find all fields that might contain parameters\r\n                    let parameter_fields = [];\r\n                    Object.keys(r.message).forEach(key => {\r\n                        if (key.toLowerCase().includes('parameter')) {\r\n                            parameter_fields.push({\r\n                                field: key,\r\n                                data: r.message[key]\r\n                            });\r\n                        }\r\n                    });\r\n                    \r\n                    console.log(\"=== PARAMETER FIELDS FOUND ===\");\r\n                    console.log(parameter_fields);\r\n                    \r\n                    if (parameter_fields.length > 0) {\r\n                        parameter_fields.forEach(field => {\r\n                            console.log(`Field: ${field.field}`);\r\n                            console.log(`Data:`, field.data);\r\n                        });\r\n                    } else {\r\n                        console.log(\"âŒ No parameter fields found!\");\r\n                    }\r\n                } else {\r\n                    console.log(\"âŒ Item not found!\");\r\n                }\r\n            }\r\n        });\r\n    }\r\n});\r\n\r\n// Step 2: Modified Get Details Function with Dynamic Field Detection\r\nfrappe.ui.form.on('BOM', {\r\n    get_details: function(frm) {\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Design Import',\r\n                fields: ['name'],\r\n                order_by: 'creation desc',\r\n                limit_page_length: 1\r\n            },\r\n            callback: function(r) {\r\n                if (r.message && r.message.length) {\r\n                    let latest_import = r.message[0].name;\r\n                    frappe.call({\r\n                        method: 'frappe.client.get',\r\n                        args: {\r\n                            doctype: 'Design Import',\r\n                            name: latest_import\r\n                        },\r\n                        callback: function(res) {\r\n                            if (res.message) {\r\n                                add_colors_to_bom_with_shade_matching_v2(frm, res.message.original_tab_table || []);\r\n                            } else {\r\n                                frappe.msgprint('âŒ No data found in latest Design Import.');\r\n                            }\r\n                        }\r\n                    });\r\n                } else {\r\n                    frappe.msgprint(\"âš ï¸ No Design Import records found.\");\r\n                }\r\n            }\r\n        });\r\n    }\r\n});\r\n\r\n// Step 3: Enhanced function with better field detection\r\nfunction get_all_shade_items_v2(callback) {\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Item',\r\n            fields: ['name'],\r\n            limit_page_length: 0\r\n        },\r\n        callback: function(r) {\r\n            if (!r.message || r.message.length === 0) {\r\n                console.log(\"âŒ No items found\");\r\n                callback([]);\r\n                return;\r\n            }\r\n\r\n            console.log(`ðŸ“Š Total items to check: ${r.message.length}`);\r\n            let shade_items = [];\r\n            let processed = 0;\r\n\r\n            r.message.forEach((item, index) => {\r\n                frappe.call({\r\n                    method: 'frappe.client.get',\r\n                    args: {\r\n                        doctype: 'Item',\r\n                        name: item.name\r\n                    },\r\n                    callback: function(item_res) {\r\n                        processed++;\r\n                        \r\n                        if (item_res.message) {\r\n                            let item_doc = item_res.message;\r\n                            \r\n                            // Try multiple possible field names for item parameters\r\n                            let parameter_fields = [\r\n                                'custom_item_parameters',\r\n                                'item_parameters', \r\n                                'parameters',\r\n                                'item_parameter_table',\r\n                                'custom_parameters'\r\n                            ];\r\n                            \r\n                            let found_parameters = null;\r\n                            let used_field = '';\r\n                            \r\n                            // Check each possible field name\r\n                            for (let field of parameter_fields) {\r\n                                if (item_doc[field] && Array.isArray(item_doc[field]) && item_doc[field].length > 0) {\r\n                                    found_parameters = item_doc[field];\r\n                                    used_field = field;\r\n                                    break;\r\n                                }\r\n                            }\r\n                            \r\n                            if (found_parameters) {\r\n                                console.log(`âœ… Found parameters in item ${item.name} using field: ${used_field}`);\r\n                                \r\n                                // Find shade parameter\r\n                                let shade_param = found_parameters.find(param => \r\n                                    param.parameter && \r\n                                    param.parameter.toLowerCase().trim() === 'shade'\r\n                                );\r\n                                \r\n                                if (shade_param && shade_param.value) {\r\n                                    // If value is linked to MiscellaneousMst, get the actual value\r\n                                    frappe.call({\r\n                                        method: 'frappe.client.get_value',\r\n                                        args: {\r\n                                            doctype: 'MiscellaneousMst',\r\n                                            filters: { name: shade_param.value },\r\n                                            fieldname: 'value'\r\n                                        },\r\n                                        callback: function(misc_res) {\r\n                                            let final_shade_value = '';\r\n                                            \r\n                                            if (misc_res.message && misc_res.message.value) {\r\n                                                final_shade_value = misc_res.message.value;\r\n                                            } else {\r\n                                                final_shade_value = shade_param.value;\r\n                                            }\r\n                                            \r\n                                            shade_items.push({\r\n                                                name: item.name,\r\n                                                shade_value: final_shade_value.trim()\r\n                                            });\r\n                                            \r\n                                            console.log(`ðŸŽ¨ Found shade item: ${item.name} = ${final_shade_value}`);\r\n                                            \r\n                                            // If this is the last item, call callback\r\n                                            if (processed === r.message.length) {\r\n                                                console.log(`ðŸŽ¯ Total shade items found: ${shade_items.length}`);\r\n                                                console.log(\"Available shade values:\", shade_items.map(s => s.shade_value));\r\n                                                callback(shade_items);\r\n                                            }\r\n                                        }\r\n                                    });\r\n                                } else {\r\n                                    // No shade parameter found in this item\r\n                                    if (processed === r.message.length) {\r\n                                        console.log(`ðŸŽ¯ Total shade items found: ${shade_items.length}`);\r\n                                        console.log(\"Available shade values:\", shade_items.map(s => s.shade_value));\r\n                                        callback(shade_items);\r\n                                    }\r\n                                }\r\n                            } else {\r\n                                // No parameters found in this item\r\n                                if (processed === r.message.length) {\r\n                                    console.log(`ðŸŽ¯ Total shade items found: ${shade_items.length}`);\r\n                                    console.log(\"Available shade values:\", shade_items.map(s => s.shade_value));\r\n                                    callback(shade_items);\r\n                                }\r\n                            }\r\n                        } else {\r\n                            // Failed to get item details\r\n                            if (processed === r.message.length) {\r\n                                console.log(`ðŸŽ¯ Total shade items found: ${shade_items.length}`);\r\n                                console.log(\"Available shade values:\", shade_items.map(s => s.shade_value));\r\n                                callback(shade_items);\r\n                            }\r\n                        }\r\n                    }\r\n                });\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\n// Step 4: Enhanced matching function\r\nfunction add_colors_to_bom_with_shade_matching_v2(frm, color_rows) {\r\n    if (!color_rows.length) {\r\n        frappe.msgprint(\"âš ï¸ No rows found in Original Tab Table.\");\r\n        return;\r\n    }\r\n\r\n    console.log(\"=== DESIGN IMPORT COLOR ROWS ===\");\r\n    console.log(color_rows);\r\n\r\n    get_all_shade_items_v2(function(shade_items) {\r\n        if (shade_items.length === 0) {\r\n            frappe.msgprint(\"âŒ No Items found with 'Shade' parameter.\");\r\n            return;\r\n        }\r\n\r\n        frm.clear_table(\"items\");\r\n        let added_count = 0;\r\n        let not_matched = [];\r\n\r\n        color_rows.forEach((row) => {\r\n            if (row.color_name) {\r\n                let color_name = row.color_name.toString().trim();\r\n                console.log(`ðŸ” Looking for color: \"${color_name}\"`);\r\n                \r\n                // Find matching shade item\r\n                let matched_item = shade_items.find(shade_item => \r\n                    shade_item.shade_value.toLowerCase().trim() === color_name.toLowerCase().trim()\r\n                );\r\n\r\n                if (matched_item) {\r\n                    console.log(`âœ… Match found: ${color_name} â†’ ${matched_item.name}`);\r\n                    \r\n                    let child = frm.add_child(\"items\");\r\n                    child.item_code = matched_item.name;\r\n                    child.qty = 1;\r\n                    child.uom = \"Nos\";\r\n                    child.rate = 0;\r\n\r\n                    // Fetch stock info\r\n                    frappe.db.get_value(\"Item\", matched_item.name, \"is_stock_item\", (r) => {\r\n                        if (r && r.is_stock_item !== undefined) {\r\n                            frappe.model.set_value(child.doctype, child.name, \"is_stock_item\", r.is_stock_item);\r\n                        }\r\n                    });\r\n\r\n                    added_count++;\r\n                } else {\r\n                    console.log(`âŒ No match found for: \"${color_name}\"`);\r\n                    not_matched.push(color_name);\r\n                }\r\n            }\r\n        });\r\n\r\n        frm.refresh_field(\"items\");\r\n        \r\n        let message = `âœ… ${added_count} Items added with shade matching.`;\r\n        if (not_matched.length > 0) {\r\n            message += `\\nâš ï¸ No matching items found for: ${not_matched.join(', ')}`;\r\n        }\r\n        \r\n        frappe.msgprint(message);\r\n        \r\n        console.log(\"=== SUMMARY ===\");\r\n        console.log(`Added: ${added_count}`);\r\n        console.log(`Not matched:`, not_matched);\r\n        console.log(`Available shade values:`, shade_items.map(s => s.shade_value));\r\n    });\r\n}\r\n\r\n// Instructions for use:\r\n// 1. First run debug_item_fields to find correct field name\r\n// 2. Then use get_details as normal\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 0,
  "modified": "2025-12-30 12:43:55.110577",
  "module": "galaxynext",
  "name": "hide show",
  "script": "frappe.ui.form.on('Sales Order', {\r\n    refresh: function(frm) {\r\n        // àª¶àª°à«‚àª†àª¤àª®àª¾àª‚ hide\r\n        frm.toggle_display('finishing_instruction', false);\r\n        frm.$wrapper.find('.custom-finishing-header').remove();\r\n        frm.current_item_for_instruction = null;\r\n\r\n        // Hardcoded list àª•àª¾àª¢à«€ àª¨àª¾àª–à«‹ â†’ dynamic àª²àª¾àªµàªµà«àª‚ àª¹à«‹àª¯ àª¤à«‹ API àª¥à«€ àª²àª¾àªµà«‹\r\n        frm.standard_finishing_processes = [\r\n            'Washing', 'Latex', 'Jaali', 'Binding', 'Patti Morai',\r\n            'Clipping', 'Stretching', 'Fringes', 'Third Backing',\r\n            'Niwar', 'Final Finish', 'Area Rug/Wall to Wall'\r\n        ];\r\n    }\r\n});\r\n\r\nfrappe.ui.form.on('Sales Order Item', {\r\n    detail: function(frm, cdt, cdn) {\r\n        const item = locals[cdt][cdn];\r\n        if (!item) return;\r\n\r\n        frm.toggle_display('finishing_instruction', true);\r\n        frm.current_item_for_instruction = item.item_code;\r\n\r\n        // Header update\r\n        const wrapper = frm.fields_dict.finishing_instruction.$wrapper;\r\n        frm.$wrapper.find('.custom-finishing-header').remove();\r\n        wrapper.before(`\r\n            <div class=\"custom-finishing-header\" style=\"\r\n                font-weight:700;\r\n                font-size:14px;\r\n                margin:12px 0 6px;\r\n                padding: 10px 15px;\r\n                background: #f8f9fa;\r\n                border-left: 3px solid #007bff;\">\r\n                Finishing Instructions for Item: <span class=\"fi-item-code\">${item.item_code}</span>\r\n            </div>\r\n        `);\r\n\r\n        // ðŸ”‘ Add missing rows ONLY for this item\r\n        frm.standard_finishing_processes.forEach(process => {\r\n            let exists = (frm.doc.finishing_instruction || []).some(\r\n                row => row.reference_item === item.item_code && row.finish_process === process\r\n            );\r\n            if (!exists) {\r\n                let child = frm.add_child('finishing_instruction');\r\n                child.reference_item = item.item_code;\r\n                child.finish_process = process;\r\n                child.status = '';\r\n                child.value = '';\r\n            }\r\n        });\r\n\r\n        frm.refresh_field('finishing_instruction');\r\n\r\n        // ðŸ”‘ Show only rows of current item\r\n        setTimeout(() => {\r\n            let row_num = 1;\r\n            frm.fields_dict.finishing_instruction.grid.grid_rows.forEach(grid_row => {\r\n                if (grid_row.doc.reference_item === item.item_code) {\r\n                    grid_row.wrapper.show();\r\n                    grid_row.row_index.html(row_num++);\r\n                } else {\r\n                    grid_row.wrapper.hide();\r\n                }\r\n            });\r\n        }, 100);\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Inward_In-House Job",
  "enabled": 1,
  "modified": "2025-12-24 12:51:23.140832",
  "module": "galaxynext",
  "name": "Warehouse Fetch in Job Inward Child Table",
  "script": "frappe.ui.form.on('Job Inward_In-House Job', {\n\twarehouse_name : function(frm) {\n\t\tif(frm.doc.warehouse_name) {\n\t\t    frm.doc.table_duni.forEach(item => {\n\t\t        frappe.model.set_value(item.doctype, item.name, 'warehouse_name' , frm.doc.warehouse_name)\n\t\t    })\n\t\t}\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Inward_In-House Job",
  "enabled": 1,
  "modified": "2025-12-24 12:52:23.134342",
  "module": null,
  "name": "Auto Ganareted",
  "script": "frappe.ui.form.on('Job Inward_In-House Job', {\r\n    onload(frm) {\r\n        // à¤¸à¤¿à¤°à¥à¤«à¤¼ à¤¨à¤ document à¤ªà¤° à¤¹à¥€ series generate à¤•à¤°à¥‹\r\n        if (frm.is_new() && !frm.doc.amended_from) {\r\n            frappe.db.get_list('Job Inward_In-House Job', {\r\n                fields: ['jobinward_no'],\r\n                order_by: 'creation desc',\r\n                limit: 1\r\n            }).then(records => {\r\n                if (records.length) {\r\n                    let last_no = records[0].jobinward_no || \"00000/00\";\r\n                    let [num, year] = last_no.split('/');\r\n                    let next_num = String(parseInt(num) + 1).padStart(5, '0');\r\n                    let final_no = `${next_num}/${year}`;\r\n                    frm.set_value('jobinward_no', final_no);\r\n                    frm.set_df_property('jobinward_no', 'read_only', 1);\r\n                }\r\n            });\r\n        }\r\n    },\r\n    before_save(frm) {\r\n        set_from_series(frm);\r\n    },\r\n    before_submit(frm) {\r\n        set_from_series(frm);\r\n    }\r\n});\r\n\r\nfunction set_from_series(frm) {\r\n    // à¤…à¤—à¤° à¤¯à¥‡ amended doc à¤¹à¥ˆ à¤¤à¥‹ à¤ªà¥à¤°à¤¾à¤¨à¤¾ à¤¹à¥€ jobinward_no à¤°à¤¹à¤¨à¥‡ à¤¦à¥‹\r\n    if (frm.doc.amended_from) {\r\n        frappe.db.get_value(\"Job Inward_In-House Job\", frm.doc.amended_from, \"jobinward_no\")\r\n            .then(r => {\r\n                if (r.message && r.message.jobinward_no) {\r\n                    frm.set_value('jobinward_no', r.message.jobinward_no);\r\n                }\r\n            });\r\n    } else {\r\n        if (frm.doc.name && !frm.doc.__islocal) {\r\n            const final_no = build_no_from_name(frm.doc.name);\r\n            if (final_no) {\r\n                frm.set_value('jobinward_no', final_no);\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nfunction build_no_from_name(name) {\r\n    const m = name.match(/-(\\d{2})-(\\d{5})$/);\r\n    if (m) return `${m[2]}/${m[1]}`;\r\n    return null;\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Inward_In-House Job",
  "enabled": 1,
  "modified": "2025-12-24 12:53:25.857309",
  "module": null,
  "name": "Quantity validation for job inward",
  "script": "\r\nfrappe.ui.form.on('Job Inward_In-House Job', {\r\n    validate: function(frm) {\r\n        let sub_row = frm.doc.job_inward_item_detail || [];\r\n        let item_rows  = frm.doc.table_duni || [];\r\n        let TotalQuantity = 0;\r\n        let TotalSubQuantity=0;\r\n        let TotalRowWiseSubQty=0;\r\n        //MAIN ROW\r\n        for (let a=0;a<item_rows.length;a++){\r\n            TotalQuantity=0;\r\n            TotalSubQuantity=0;\r\n            if (item_rows[a].total_quantity>0){\r\n                TotalRowWiseSubQty=TotalSubQuantity;\r\n                TotalQuantity=TotalQuantity+item_rows[a].total_quantity;\r\n                \r\n                    //SUB ROW \r\n                    for (let i = 0; i < sub_row.length; i++) {\r\n                        let ProductName = \"\";\r\n                        ProductName=`${item_rows[a].product_type} - ${item_rows[a].product_name}`;\r\n                        // frappe.msgprint(ProductName);\r\n                        if (sub_row[i].reference_item === ProductName) {\r\n                            if (sub_row[i].quantity>0){\r\n                                TotalSubQuantity=TotalSubQuantity+sub_row[i].quantity-TotalRowWiseSubQty;\r\n                            }\r\n                        }\r\n                    }\r\n                    if (TotalQuantity<TotalSubQuantity){\r\n                     frappe.throw(\r\n                         __(\"Total Quantity-{0} || Total sub Quantity-{1} :1- Quantity Not More then Total Quantity\",[TotalQuantity,TotalSubQuantity])\r\n                    );\r\n                }\r\n                 if (TotalQuantity>TotalSubQuantity){\r\n                     frappe.throw(\r\n                        __(\"Total Quantity-{0} || Total sub Quantity-{1} :2- Quantity Not Below then Total Quantity\",[TotalQuantity,TotalSubQuantity])\r\n                    );\r\n                }\r\n            }\r\n            //  TotalRowWiseSubQty=item_rows[a].total_quantity;\r\n        }\r\n        // frappe.throw(__(\"Total Quantity: {0}\", [TotalQuantity]));\r\n                // if (TotalQuantity<TotalSubQuantity){\r\n                //      frappe.throw(\r\n                //          __(\"Total Quantity-{0} || Total sub Quantity-{1} :3- Quantity Not More then Total Quantity\",[TotalQuantity,TotalSubQuantity])\r\n                //     );\r\n                // }\r\n                //  if (TotalQuantity>TotalSubQuantity){\r\n                //      frappe.throw(\r\n                //         __(\"Total Quantity-{0} || Total sub Quantity-{1} :4- Quantity Not Below then Total Quantity\",[TotalQuantity,TotalSubQuantity])\r\n                //     );\r\n                // }\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Inward_In-House Job",
  "enabled": 1,
  "modified": "2025-12-24 12:56:40.710573",
  "module": null,
  "name": "unit",
  "script": "frappe.ui.form.on(\"Job Inward Item\", {\r\n    product_name: function(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n\r\n        if (row.product_name) {\r\n            frappe.db.get_value(\"Item\", row.product_name, \"stock_uom\").then(r => {\r\n                if (r.message && r.message.stock_uom) {\r\n                    frappe.model.set_value(cdt, cdn, \"unit\", r.message.stock_uom);\r\n\r\n                    // Sirf current row ka Unit disable karo\r\n                    let grid_row = frm.fields_dict.job_inward_item.grid.get_row(cdn);\r\n                    if (grid_row) {\r\n                        grid_row.toggle_editable(\"unit\", false);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    },\r\n\r\n    unit: function(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        if (row.unit) {\r\n            let grid_row = frm.fields_dict.job_inward_item.grid.get_row(cdn);\r\n            if (grid_row) {\r\n                grid_row.toggle_editable(\"unit\", false);\r\n            }\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Inward_In-House Job",
  "enabled": 0,
  "modified": "2025-12-24 14:30:30.122818",
  "module": null,
  "name": "Job Inword",
  "script": "frappe.ui.form.on('Job Inward_In-House Job', {\r\n    customer_name(frm) {\r\n        if (frm.doc.customer_name) {\r\n            frappe.call({\r\n                method: \"custom_app.api.address.get_primary_address\",\r\n                args: {\r\n                    customer_name: frm.doc.customer_name\r\n                },\r\n                callback: function (r) {\r\n                    if (r.message && r.message.address_line) {\r\n                        frm.set_value(\"address\", r.message.address_line);\r\n                    } else {\r\n                        frm.set_value(\"address\", \"\");\r\n                        frappe.msgprint(\"No primary address found for this customer.\");\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Inward_In-House Job",
  "enabled": 1,
  "modified": "2025-12-24 12:57:51.563253",
  "module": null,
  "name": "Job Inward companywise warehouse",
  "script": "frappe.ui.form.on('Job Inward_In-House Job', {\r\n    onload: function(frm) {\r\n        // Warehouse aur Product Name filters set karo\r\n        set_warehouse_query(frm);\r\n        set_product_name_query(frm);\r\n\r\n        // JobInward Type ka default set karo agar blank hai\r\n        if (!frm.doc.jobinward_type) {\r\n            frm.set_value('jobinward_type', 'Material Receipt');\r\n        }\r\n\r\n        // User ko change karne se roko\r\n        frm.set_df_property('jobinward_type', 'read_only', 1);\r\n\r\n        // Master (Cost Center) filter set karo\r\n        set_master_query(frm);\r\n    },\r\n\r\n    company: function(frm) {\r\n        set_warehouse_query(frm);\r\n        set_master_query(frm); // Company change par Master filter update karo\r\n    }\r\n});\r\n\r\n// âœ… Master field (Cost Center) filter by Company\r\nfunction set_master_query(frm) {\r\n    frm.set_query(\"master\", function() {\r\n        return {\r\n            filters: {\r\n                company: frm.doc.company\r\n            }\r\n        };\r\n    });\r\n}\r\n\r\nfunction set_warehouse_query(frm) {\r\n    // For Parent Warehouse Name\r\n    frm.set_query('warehouse_name', () => {\r\n        return {\r\n            filters: {\r\n                company: frm.doc.company\r\n            }\r\n        };\r\n    });\r\n\r\n    // For Child Table's Warehouse Name\r\n    frm.fields_dict.table_duni.grid.get_field('warehouse_name').get_query = function(doc, cdt, cdn) {\r\n        return {\r\n            filters: {\r\n                company: frm.doc.company\r\n            }\r\n        };\r\n    };\r\n}\r\n\r\n// ðŸ”¹ Product Name filter by Product Type\r\nfunction set_product_name_query(frm) {\r\n    frm.fields_dict.table_duni.grid.get_field('product_name').get_query = function(doc, cdt, cdn) {\r\n        const child = locals[cdt][cdn];\r\n        return {\r\n            filters: {\r\n                item_group: child.product_type\r\n            }\r\n        };\r\n    };\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Inward_In-House Job",
  "enabled": 1,
  "modified": "2025-12-24 12:58:37.971582",
  "module": null,
  "name": "Job Date",
  "script": "frappe.ui.form.on('Job Inward_In-House Job', {\r\n    onload: function(frm) {\r\n        // Agar inward_date khali ho to aaj ki date set karo\r\n        if (!frm.doc.inward_date) {\r\n            frm.set_value('inward_date', frappe.datetime.get_today());\r\n        }\r\n    },\r\n\r\n    challan_date(frm) {\r\n        const challanDate = frappe.datetime.str_to_obj(frm.doc.challan_date);\r\n        const inwardDate = frappe.datetime.str_to_obj(frm.doc.inward_date);\r\n\r\n        if (challanDate && inwardDate && inwardDate < challanDate) {\r\n            frappe.msgprint(__('Challan Date cannot be after Inward Date.'));\r\n            frm.set_value('challan_date', '');\r\n        }\r\n    },\r\n\r\n    validate(frm) {\r\n        const challanDate = frappe.datetime.str_to_obj(frm.doc.challan_date);\r\n        const inwardDate = frappe.datetime.str_to_obj(frm.doc.inward_date);\r\n\r\n        if (challanDate && inwardDate && inwardDate < challanDate) {\r\n            frappe.throw(__('Challan Date cannot be after Inward Date.'));\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Inward_In-House Job",
  "enabled": 1,
  "modified": "2025-12-24 13:00:01.487157",
  "module": null,
  "name": "Transfer Id Filter",
  "script": "frappe.ui.form.on('Job Inward_In-House Job', {\r\n    refresh: function(frm) {\r\n        set_transfer_id_filter(frm);\r\n    },\r\n    \r\n    onload: function(frm) {\r\n        set_transfer_id_filter(frm);\r\n    }\r\n});\r\n\r\nfunction set_transfer_id_filter(frm) {\r\n    frm.set_query('transfer_id', function() {\r\n        return {\r\n            filters: {\r\n                stock_entry_type: 'Send to Subcontractor',\r\n                docstatus: 1  // Only show submitted records\r\n            }\r\n        };\r\n    });\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Inward_In-House Job",
  "enabled": 1,
  "modified": "2025-12-24 13:00:46.278593",
  "module": null,
  "name": "click",
  "script": "// ---------- CONFIG ----------\r\nconst PARENT_DOCTYPE = \"Job Inward_In-House Job\";\r\nconst TABLE_FIELD = \"table_duni\";\r\nconst DETAIL_TABLE_FIELD = \"job_inward_item_detail\";\r\nconst EXISTING_BTN_FIELDNAME = \"btn_detail\";\r\nconst INJECT_CLASS = \"injected-detail-btn\";\r\n// -------------------------------------------------------------------------------\r\n\r\nlet current_item_reference = null;\r\nlet current_item_key = null;\r\n\r\nfrappe.ui.form.on(PARENT_DOCTYPE, {\r\n    onload(frm) {\r\n        frm.set_df_property(DETAIL_TABLE_FIELD, \"hidden\", 1);\r\n    },\r\n\r\n    refresh(frm) {\r\n        try {\r\n            const grid = frm.fields_dict[DETAIL_TABLE_FIELD].grid;\r\n            grid.df.cannot_add_rows = true;\r\n            grid.wrapper.find('.grid-add-row').hide();\r\n            prevent_auto_row_add_on_tab(frm, DETAIL_TABLE_FIELD);\r\n\r\n            const $wrapper = frm.fields_dict[DETAIL_TABLE_FIELD].$wrapper;\r\n            $wrapper.prev('.custom-table-header-box').remove();\r\n\r\n            if (current_item_key) {\r\n                const filtered_rows = frm.doc[DETAIL_TABLE_FIELD].filter(\r\n                    row => row.reference_item === current_item_key\r\n                );\r\n\r\n                frm._all_detail_rows = frm.doc[DETAIL_TABLE_FIELD];\r\n                frm.doc[DETAIL_TABLE_FIELD] = filtered_rows;\r\n\r\n                frm.refresh_field(DETAIL_TABLE_FIELD);\r\n\r\n                const $headerBox = $(`\r\n                    <div class=\"custom-table-header-box\" \r\n                          style=\"background:#f2f2f2;padding:10px 15px;margin:10px 0;\r\n                          border-radius:8px;font-weight:bold;font-size:14px;\">\r\n                        ${current_item_key}\r\n                     </div>\r\n                `);\r\n                $wrapper.before($headerBox);\r\n            }\r\n        } catch (e) {\r\n            console.warn(\"detail-table refresh warning:\", e);\r\n        }\r\n\r\n        add_injected_buttons(frm);\r\n        setTimeout(() => add_injected_buttons(frm), 250);\r\n        setTimeout(() => add_injected_buttons(frm), 900);\r\n\r\n        if (!frm.__detail_btn_observer && frm.fields_dict[TABLE_FIELD] && frm.fields_dict[TABLE_FIELD].grid) {\r\n            try {\r\n                const wrapperNode = frm.fields_dict[TABLE_FIELD].grid.wrapper[0];\r\n                if (wrapperNode) {\r\n                    const observer = new MutationObserver(() => {\r\n                        add_injected_buttons(frm);\r\n                    });\r\n                    observer.observe(wrapperNode, { childList: true, subtree: true });\r\n                    frm.__detail_btn_observer = observer;\r\n                }\r\n            } catch (e) {\r\n                console.warn(\"observer not created\", e);\r\n            }\r\n        }\r\n\r\n        // ðŸ‘‡ footer update on refresh\r\n        update_detail_table_footer(frm);\r\n    },\r\n\r\n    validate(frm) {\r\n        if (frm._all_detail_rows) {\r\n            frm.doc[DETAIL_TABLE_FIELD] = frm._all_detail_rows;\r\n            frm._all_detail_rows = null;\r\n        }\r\n\r\n        frm.doc[DETAIL_TABLE_FIELD] = frm.doc[DETAIL_TABLE_FIELD].filter(\r\n            row => row.quantity !== null && row.reference_item\r\n        );\r\n\r\n        let counterMap = {};\r\n        for (let row of frm.doc[DETAIL_TABLE_FIELD]) {\r\n            const ref = row.reference_item;\r\n            if (!counterMap[ref]) counterMap[ref] = 1;\r\n            row.idx = counterMap[ref]++;\r\n        }\r\n    }\r\n});\r\n\r\nfrappe.ui.form.on('Job Inward Item', {\r\n    btn_detail(frm, cdt, cdn) {\r\n        const row = locals[cdt][cdn];\r\n        show_item_detail_for_row(frm, row);\r\n    }\r\n});\r\n\r\nfunction add_injected_buttons(frm) {\r\n    if (!frm.fields_dict[TABLE_FIELD] || !frm.fields_dict[TABLE_FIELD].grid) return;\r\n    const $grid = $(frm.fields_dict[TABLE_FIELD].grid.wrapper);\r\n\r\n    $grid.find('.grid-row').each(function () {\r\n        const $row = $(this);\r\n        const rowname = $row.attr('data-name') || $row.attr('data-idx');\r\n        if (!rowname) return;\r\n\r\n        if ($row.find(`button[data-fieldname=\"${EXISTING_BTN_FIELDNAME}\"]`).length) {\r\n            return;\r\n        }\r\n\r\n        if ($row.find(`.${INJECT_CLASS}[data-rowname=\"${rowname}\"]`).length) return;\r\n\r\n        let $cell = $row.find(`td[data-fieldname=\"${EXISTING_BTN_FIELDNAME}\"]`);\r\n        if (!$cell.length) $cell = $row.find('td').last();\r\n\r\n        const $btn = $(`\r\n            <button class=\"btn btn-xs btn-default ${INJECT_CLASS}\" \r\n                     data-rowname=\"${rowname}\" title=\"Detail\" \r\n                     style=\"margin-left:6px;\">Detail</button>\r\n        `);\r\n        $cell.append($btn);\r\n    });\r\n\r\n    $grid.off('click', `.${INJECT_CLASS}`).on('click', `.${INJECT_CLASS}`, function (e) {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n        const rowname = $(this).data('rowname');\r\n\r\n        const child_rows = frm.doc[TABLE_FIELD] || [];\r\n        let rowdoc = child_rows.find(r => (r.name && r.name == rowname) || (r.idx && r.idx == Number(rowname)));\r\n        if (!rowdoc) {\r\n            rowdoc = child_rows[Number(rowname) - 1] || child_rows[0];\r\n        }\r\n        if (!rowdoc) {\r\n            frappe.msgprint(('Row not found.'));\r\n            return;\r\n        }\r\n\r\n        show_item_detail_for_row(frm, rowdoc);\r\n    });\r\n}\r\n\r\nfunction show_item_detail_for_row(frm, row) {\r\n    if (!row.total_pcs || row.total_pcs <= 0) {\r\n        frappe.msgprint(\"Total PCS must be greater than 0.\");\r\n        return;\r\n    }\r\n    if (!row.total_quantity || row.total_quantity <= 0) {\r\n        frappe.msgprint(\"Total Quantity must be greater than 0.\");\r\n        return;\r\n    }\r\n\r\n    if (frm.doc.docstatus === 1) {\r\n        const current_item_key_local = `${row.product_type || \"\"} - ${row.product_name || \"\"}`;\r\n        const all_rows = frm._all_detail_rows || frm.doc[DETAIL_TABLE_FIELD] || [];\r\n        const relevant_rows = all_rows.filter(r => r.reference_item === current_item_key_local);\r\n\r\n        if (relevant_rows.length === 0) {\r\n            frappe.msgprint(('No detail rows available for this item.'));\r\n            return;\r\n        }\r\n\r\n        let html = `<div style=\"max-height:400px;overflow:auto\">\r\n            <table class=\"table table-bordered\"><thead>\r\n                <tr><th>#</th><th>Quantity</th><th>Reference Item</th></tr>\r\n            </thead><tbody>`;\r\n\r\n        relevant_rows.forEach((r, idx) => {\r\n            html += `<tr>\r\n                <td>${idx + 1}</td>\r\n                <td>${(r.quantity || 0)}</td>\r\n                <td>${frappe.utils.escape_html(r.reference_item || '')}</td>\r\n            </tr>`;\r\n        });\r\n\r\n        html += `</tbody></table></div>`;\r\n\r\n        const d = new frappe.ui.Dialog({\r\n            title: __('Details for {0}', [current_item_key_local]),\r\n            fields: [\r\n                { fieldtype: 'HTML', fieldname: 'content' },\r\n                { fieldtype: 'Button', label: 'Run Action', fieldname: 'run_action' }\r\n            ]\r\n        });\r\n\r\n        d.fields_dict.content.$wrapper.html(html);\r\n\r\n        d.fields_dict.run_action.$input.on('click', function () {\r\n            frappe.msgprint((__('Action executed for {0}', [current_item_key_local])));\r\n        });\r\n\r\n        d.show();\r\n        return;\r\n    }\r\n\r\n    current_item_key = `${row.product_type || \"\"} - ${row.product_name || \"\"}`;\r\n    current_item_reference = {\r\n        total_pcs: row.total_pcs,\r\n        total_qty: row.total_quantity\r\n    };\r\n\r\n    const all_rows = frm._all_detail_rows || frm.doc[DETAIL_TABLE_FIELD] || [];\r\n    const relevant_rows = all_rows.filter(r => r.reference_item === current_item_key);\r\n    const remaining_rows = all_rows.filter(r => r.reference_item !== current_item_key);\r\n    frm.doc[DETAIL_TABLE_FIELD] = remaining_rows;\r\n\r\n    let rows_to_show = [];\r\n\r\n    if (relevant_rows.length > 0) {\r\n        rows_to_show = relevant_rows.slice(0, row.total_pcs);\r\n        while (rows_to_show.length < row.total_pcs) {\r\n            rows_to_show.push({ quantity: 0, reference_item: current_item_key });\r\n        }\r\n    } else {\r\n        for (let i = 0; i < row.total_pcs; i++) {\r\n            rows_to_show.push({ quantity: 0, reference_item: current_item_key });\r\n        }\r\n    }\r\n\r\n    for (let i = 0; i < rows_to_show.length; i++) {\r\n        const item = rows_to_show[i];\r\n        const new_row = frm.add_child(DETAIL_TABLE_FIELD);\r\n        new_row.quantity = item.quantity || 0;\r\n        new_row.reference_item = current_item_key;\r\n        new_row.idx = i + 1;\r\n    }\r\n\r\n    frm.set_df_property(DETAIL_TABLE_FIELD, \"hidden\", 0);\r\n    frm.refresh_field(DETAIL_TABLE_FIELD);\r\n    frm.trigger(\"refresh\");\r\n\r\n    // ðŸ‘‡ footer update after showing table\r\n    update_detail_table_footer(frm);\r\n}\r\n\r\nfrappe.ui.form.on('Job Inward Item Detail', {\r\n    quantity(frm, cdt, cdn) {\r\n        if (!current_item_reference) return;\r\n\r\n        const rows = frm.doc[DETAIL_TABLE_FIELD].filter(r => r.reference_item === current_item_key);\r\n        const total_entered = rows.reduce((sum, row) => sum + (row.quantity || 0), 0);\r\n        const is_last_row = rows[rows.length - 1].name === cdn;\r\n        const total_SubQty = rows.reduce((sum, r) => sum + (r.quantity || 0), 0);\r\n        if (is_last_row && total_entered !== current_item_reference.total_qty) {\r\n            frappe.msgprint(`âŒ Total Quantity must be exactly ${current_item_reference.total_qty}. You entered ${total_entered}.`);\r\n        }\r\n        //123456789\r\n         if (total_SubQty > current_item_reference.total_qty) {\r\n            frappe.msgprint(`LINE BY LINE âŒ Total Quantity must be exactly ${current_item_reference.total_qty}. You entered ${total_entered}.`);\r\n        }\r\n\r\n        // ðŸ‘‡ update footer live on change\r\n        update_detail_table_footer(frm);\r\n    },\r\n\r\n    job_inward_item_detail_add(frm, cdt, cdn) {\r\n        const rows = frm.doc[DETAIL_TABLE_FIELD] || [];\r\n        const allowed_rows = current_item_reference?.total_pcs || 0;\r\n\r\n//THIS SCRIPT IS FOR NO MORE THEN PCS IN SUBDETAIL VALIDATE\r\n        if (rows.length > allowed_rows) {\r\n            frm.get_field(DETAIL_TABLE_FIELD).grid.grid_rows[rows.length - 1].remove();\r\n            // frappe.msgprint(`âš  You cannot add more than ${allowed_rows} rows.`);\r\n        }\r\n    }\r\n});\r\n\r\nfunction prevent_auto_row_add_on_tab(frm, table_fieldname) {\r\n    setTimeout(() => {\r\n        try {\r\n            const grid = frm.fields_dict[table_fieldname].grid;\r\n            const wrapper = $(grid.wrapper);\r\n\r\n            wrapper.find('input').off('keydown.preventrowadd');\r\n\r\n            wrapper.on('keydown.preventrowadd', 'input', function (e) {\r\n                const isLastEditableInput = $(this).closest('tr').is(':last-child');\r\n                const isTab = e.key === \"Tab\" || e.which === 9;\r\n\r\n                if (isTab && isLastEditableInput) {\r\n                    const total_rows = frm.doc[table_fieldname]?.filter(row => row.reference_item === current_item_key)?.length || 0;\r\n                    const allowed_rows = current_item_reference?.total_pcs || 0;\r\n\r\n                    if (total_rows >= allowed_rows) {\r\n                        e.preventDefault();\r\n                        $(this).blur();\r\n                    }\r\n                }\r\n            });\r\n        } catch (e) {}\r\n    }, 300);\r\n}\r\n\r\n// ---------- NEW FUNCTION ---------- SUB DETAIL UNDER TOTAL QUANTI\r\nfunction update_detail_table_footer(frm) {\r\n    try {\r\n        const $wrapper = frm.fields_dict[DETAIL_TABLE_FIELD].$wrapper;\r\n\r\n        // purana footer hatado\r\n        $wrapper.next('.custom-table-footer-box').remove();\r\n\r\n        if (current_item_key) {\r\n            const rows = frm.doc[DETAIL_TABLE_FIELD].filter(\r\n                r => r.reference_item === current_item_key\r\n            );\r\n            const total_qty = rows.reduce((sum, r) => sum + (r.quantity || 0), 0);\r\n\r\n            const $footerBox = $(`\r\n                <div class=\"custom-table-footer-box\"\r\n                     style=\"background:#f9f9f9;padding:10px 15px;margin:10px 0;\r\n                            border-radius:8px;font-weight:bold;font-size:14px;\r\n                            text-align:right;\">\r\n                     Total Quantity: ${total_qty}\r\n                </div>\r\n            `);\r\n\r\n            $wrapper.after($footerBox);\r\n        }\r\n    } catch (e) {\r\n        console.warn(\"update footer failed:\", e);\r\n    }\r\n}",
  "view": "Form"
 }
]